# E06-F02-T02: File Menu Actions - Post-Implementation Documentation

## 1. Implementation Summary

This task implemented comprehensive File Menu actions for the Ink schematic viewer, providing users with essential file operations: **Open**, **Recent Files**, and **Exit**. The implementation follows Qt best practices and integrates seamlessly with the existing `AppSettings` infrastructure for persistence.

### Key Components Delivered

| Component | Location | Purpose |
|-----------|----------|---------|
| File Menu Actions | `main_window.py:446-476` | Open, Recent, Exit actions |
| Recent Files Menu | `main_window.py:544-627` | Dynamic submenu with file history |
| File Opening | `main_window.py:629-697` | Dialog and file loading |
| Settings Integration | `app_settings.py:448-631` | Persistence layer for recent files |

---

## 2. Architecture Decisions

### 2.1 Mnemonic Pattern for Actions

**Decision**: Use `&` prefix for keyboard mnemonics (e.g., `"&Open..."`, `"E&xit"`).

**Rationale**:
- Qt standard pattern for Alt+key navigation
- `"E&xit"` uses 'x' to avoid conflict with `"&Edit"` menu
- Consistent with other EDA tools and standard Windows/Linux applications

### 2.2 Recent Files in Submenu vs Menu Root

**Decision**: Place recent files in a dedicated `"Open &Recent"` submenu.

**Rationale**:
- Keeps File menu clean and scannable
- Allows unlimited recent files without menu bloat
- Standard pattern in professional tools (VSCode, IntelliJ, etc.)
- Submenu provides visual hierarchy and grouping

### 2.3 Lambda Capture for Menu Actions

**Decision**: Use `lambda _checked=False, path=file_path:` pattern.

**Rationale**:
- Python closures capture variables by reference, not value
- Without default argument capture, all actions would point to the last file
- The `_checked` parameter is required by Qt signal signature even if unused

```python
# CORRECT: Captures path value at definition time
action.triggered.connect(
    lambda _checked=False, path=file_path: self._on_open_recent_file(path)
)

# WRONG: Would use whatever file_path was at trigger time
action.triggered.connect(
    lambda: self._on_open_recent_file(file_path)  # Bug!
)
```

---

## 3. Key Implementation Patterns

### 3.1 File Dialog Configuration

```python
def _on_open_file_dialog(self) -> None:
    file_path, _ = QFileDialog.getOpenFileName(
        self,                                    # Parent window
        "Open Netlist File",                     # Dialog title
        "",                                      # Start directory (empty = current)
        "Netlist Files (*.ckt *.cdl *.sp);;All Files (*)",  # Filters
    )
    if file_path:
        self._open_file(file_path)
```

**Key Points**:
- Filter format: `"Description (*.ext1 *.ext2);;Another (*.ext3)"`
- Returns tuple `(path, filter_used)` - we only need path
- Empty string returned if user cancels

### 3.2 Recent Files Menu Update Flow

```
User opens file
      │
      ▼
_open_file(path)
      │
      ├──► app_settings.add_recent_file(path)
      │         │
      │         ├──► Normalize to absolute path
      │         ├──► Remove if exists (dedupe)
      │         ├──► Insert at front
      │         └──► Trim to max 10
      │
      └──► _update_recent_files_menu()
                │
                ├──► Clear existing menu
                ├──► Add action for each file
                │         ├──► Format: "&N. filename.ckt"
                │         ├──► Store full path in action.data()
                │         └──► Connect to handler
                └──► Add separator + Clear action
```

### 3.3 Missing File Handling

When user clicks a recent file that no longer exists:

1. `_on_open_recent_file()` checks `Path(file_path).exists()`
2. Shows `QMessageBox.warning()` with file path
3. `get_recent_files()` auto-filters non-existent files
4. Menu is refreshed to reflect removal

---

## 4. Testing Strategy

### 4.1 Test Coverage by Category

| Category | Tests | Coverage |
|----------|-------|----------|
| Menu Structure | 4 | Open, Recent, Exit, Separators |
| Keyboard Shortcuts | 2 | Ctrl+O, Ctrl+Q |
| File Dialog | 3 | Method exists, triggers, filters |
| File Opening | 3 | Adds to recent, updates menu, updates title |
| Recent Files Limit | 2 | 10 max in settings, 10 max in menu |
| Recent Files Order | 1 | Newest first |
| Missing Files | 2 | Warning shown, file removed |
| Clear Action | 3 | Exists, clears list, updates menu |
| Persistence | 1 | Survives app restart |
| Path Display | 3 | Filename shown, full path stored, tooltip |
| Numbering | 2 | &1-&9 shortcuts, no &10 |
| Empty State | 1 | "No Recent Files" placeholder |

**Total: 29 tests** (all passing)

### 4.2 Testing Approach

- **Fixtures**: Isolated `QSettings` in temp directory per test
- **Mocking**: `QFileDialog.getOpenFileName` to avoid UI interaction
- **Pattern**: TDD verification - tests written to spec, then validated

---

## 5. Integration Points

### 5.1 Upstream Dependencies

| Dependency | Status | Integration Notes |
|------------|--------|-------------------|
| E06-F02-T01 Menu Bar Setup | Complete | `self.file_menu` provided by parent |
| E06-F06 Settings Persistence | Complete | `AppSettings` with `QSettings` backend |

### 5.2 Downstream Consumers

| Consumer | Integration Notes |
|----------|-------------------|
| E01-F01 Netlist Parsing | `_open_file()` will call `FileService.load()` |
| E06-F05 Status Bar | Status messages for file loading |

---

## 6. Configuration Reference

### 6.1 Settings Keys

| Key | Type | Default | Description |
|-----|------|---------|-------------|
| `files/recent` | `list[str]` | `[]` | Recent file paths (newest first) |
| `files/max_recent` | `int` | `10` | Maximum files to remember |

### 6.2 Constants

| Constant | Value | Location |
|----------|-------|----------|
| `MAX_RECENT_FILES` | `10` | `InkMainWindow._MAX_SHORTCUT_ITEMS` |
| `_MAX_SHORTCUT_ITEMS` | `9` | Files 1-9 get Alt+N shortcuts |

---

## 7. Lessons Learned

### 7.1 Qt Menu Action Gotchas

1. **Mnemonic Placement**: Place `&` before the unique character, not always the first letter
2. **Signal Signature**: `triggered` signal provides a `checked: bool` parameter even for non-checkable actions
3. **Action Data**: Use `action.setData()` for storing metadata, not custom attributes

### 7.2 Test Mocking Best Practices

1. **Patch Full Path**: Always patch `ink.presentation.main_window.QFileDialog`, not just `QFileDialog`
2. **Check Call Args**: Use `mock.call_args` to verify dialog was called with correct parameters
3. **Return Tuple**: `QFileDialog.getOpenFileName` returns `(path, filter)` tuple

---

## 8. Files Modified/Created

### Created
- `tests/unit/presentation/test_file_menu_actions.py` - 29 comprehensive unit tests

### Already Implemented (Verified)
- `src/ink/presentation/main_window.py` - File menu actions (lines 446-697)
- `src/ink/infrastructure/persistence/app_settings.py` - Recent files methods (lines 448-631)

---

## 9. Related Links

- [Spec: E06-F02-T02](./E06-F02-T02.spec.md)
- [GitHub Issue #22](https://github.com/ddoachi/ink/issues/22)
- [ClickUp Task: CU-86evzm346](https://app.clickup.com/t/86evzm346)
- [Parent Spec: E06-F02 Menu Bar](../E06-F02.spec.md)
