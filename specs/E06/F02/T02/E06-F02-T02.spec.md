# Spec: E06-F02-T02 - File Menu Actions

## Metadata
- **ID**: E06-F02-T02
- **Type**: Task
- **Priority**: P0 (MVP)
- **Status**: Draft
- **Parent**: [E06-F02](../E06-F02.spec.md)
- **Created**: 2025-12-26
- **Estimated Hours**: 4
- **Actual Hours**:
- **Effort**: Medium
- **Tags**: [ui, menus, file-io]

---

## 1. Overview

### 1.1 Problem Statement

Users need File menu actions to open netlists, access recently opened files, and exit the application. The Recent Files submenu must remember the last 10 opened files and handle missing files gracefully.

### 1.2 Goals

- Implement Open action with file dialog (`Ctrl+O`)
- Create Recent Files submenu with last 10 files
- Implement Exit action (`Ctrl+Q`)
- Store recent files in application settings
- Handle missing recent files with error messages

---

## 2. Technical Requirements

### 2.1 File Menu Implementation

```python
# src/ink/presentation/main_window.py

from PySide6.QtWidgets import QFileDialog, QMessageBox
from PySide6.QtGui import QAction, QKeySequence
from PySide6.QtCore import QSettings
from pathlib import Path

class InkMainWindow(QMainWindow):
    MAX_RECENT_FILES = 10

    def _create_file_menu(self):
        """Create File menu items."""
        # Open action
        open_action = QAction("&Open...", self)
        open_action.setShortcut(QKeySequence.StandardKey.Open)  # Ctrl+O
        open_action.setStatusTip("Open a netlist file")
        open_action.triggered.connect(self._on_open_file)
        self.file_menu.addAction(open_action)

        # Recent files submenu
        self.recent_menu = self.file_menu.addMenu("Open &Recent")
        self._update_recent_files_menu()

        self.file_menu.addSeparator()

        # Exit action
        exit_action = QAction("E&xit", self)
        exit_action.setShortcut(QKeySequence.StandardKey.Quit)  # Ctrl+Q
        exit_action.setStatusTip("Exit the application")
        exit_action.triggered.connect(self.close)
        self.file_menu.addAction(exit_action)

    def _on_open_file(self):
        """Handle File > Open action."""
        file_path, _ = QFileDialog.getOpenFileName(
            self,
            "Open Netlist File",
            "",  # Start in current directory or last used
            "Netlist Files (*.ckt *.cdl);;All Files (*)"
        )

        if file_path:
            self._load_netlist(file_path)

    def _load_netlist(self, file_path: str):
        """Load netlist file and update recent files."""
        try:
            # TODO: Integrate with FileService to load netlist
            # For now, just update recent files
            self._add_recent_file(file_path)
            self._update_recent_files_menu()

            # Show success message (temporary)
            self.statusBar().showMessage(f"Loaded: {file_path}", 3000)

        except Exception as e:
            QMessageBox.critical(
                self,
                "Error Loading File",
                f"Failed to load {file_path}:\n{str(e)}"
            )

    def _update_recent_files_menu(self):
        """Populate recent files submenu from settings."""
        self.recent_menu.clear()

        recent_files = self._get_recent_files()

        if not recent_files:
            no_recent = QAction("No recent files", self)
            no_recent.setEnabled(False)
            self.recent_menu.addAction(no_recent)
        else:
            for file_path in recent_files:
                # Show filename with path as tooltip
                action = QAction(file_path, self)
                action.setToolTip(file_path)
                action.triggered.connect(
                    lambda checked, path=file_path: self._open_recent_file(path)
                )
                self.recent_menu.addAction(action)

            self.recent_menu.addSeparator()

            clear_action = QAction("&Clear Recent Files", self)
            clear_action.triggered.connect(self._clear_recent_files)
            self.recent_menu.addAction(clear_action)

    def _open_recent_file(self, file_path: str):
        """Open a recent file."""
        path = Path(file_path)

        if not path.exists():
            QMessageBox.warning(
                self,
                "File Not Found",
                f"The file no longer exists:\n{file_path}\n\n"
                "It will be removed from recent files."
            )
            self._remove_recent_file(file_path)
            self._update_recent_files_menu()
        else:
            self._load_netlist(file_path)

    def _get_recent_files(self) -> list[str]:
        """Get recent files list from settings."""
        settings = QSettings("Ink", "InkSchematicViewer")
        recent = settings.value("recent_files", [])

        # Ensure it's a list (Qt settings can return various types)
        if not isinstance(recent, list):
            recent = [] if recent is None else [recent]

        return recent[:self.MAX_RECENT_FILES]

    def _add_recent_file(self, file_path: str):
        """Add file to recent files list (move to top if exists)."""
        settings = QSettings("Ink", "InkSchematicViewer")
        recent = self._get_recent_files()

        # Remove if already exists (will be re-added at top)
        if file_path in recent:
            recent.remove(file_path)

        # Add to front
        recent.insert(0, file_path)

        # Keep only MAX_RECENT_FILES
        recent = recent[:self.MAX_RECENT_FILES]

        settings.setValue("recent_files", recent)

    def _remove_recent_file(self, file_path: str):
        """Remove file from recent files list."""
        settings = QSettings("Ink", "InkSchematicViewer")
        recent = self._get_recent_files()

        if file_path in recent:
            recent.remove(file_path)
            settings.setValue("recent_files", recent)

    def _clear_recent_files(self):
        """Clear all recent files."""
        settings = QSettings("Ink", "InkSchematicViewer")
        settings.setValue("recent_files", [])
        self._update_recent_files_menu()
```

### 2.2 Settings Storage

Use `QSettings` for persistent storage:
- **Organization**: `"Ink"`
- **Application**: `"InkSchematicViewer"`
- **Key**: `"recent_files"` (list of file paths as strings)
- **Max entries**: 10 files

### 2.3 File Dialog Configuration

```python
QFileDialog.getOpenFileName(
    parent=self,
    caption="Open Netlist File",
    directory="",  # Default to last used or current
    filter="Netlist Files (*.ckt *.cdl);;All Files (*)"
)
```

---

## 3. Dependencies

- **Upstream**:
  - E06-F02-T01 (Menu Bar Setup - `self.file_menu` exists)
  - E06-F06 (Settings Persistence - `QSettings` infrastructure)
- **Downstream**:
  - E01-F01 (Netlist Parsing - file loading integration)
  - E06-F05 (Status Bar - status messages)
- **External**: PySide6 (`QFileDialog`, `QAction`, `QKeySequence`, `QSettings`)

---

## 4. Acceptance Criteria

- [ ] File > Open shows file dialog with `.ckt` and `.cdl` filters
- [ ] Selected file path triggers `_load_netlist()` method
- [ ] Recent Files submenu shows up to 10 most recent files
- [ ] Most recently opened file appears at top of Recent Files list
- [ ] Clicking recent file opens it directly
- [ ] Missing recent files show warning dialog and are removed from list
- [ ] "Clear Recent Files" removes all entries
- [ ] Exit action (`Ctrl+Q`) closes application
- [ ] Keyboard shortcuts work: `Ctrl+O` for Open, `Ctrl+Q` for Exit
- [ ] Recent files persist across application restarts
- [ ] File paths in Recent Files menu show full path
- [ ] Status bar shows "Loaded: {file}" message on successful load

---

## 5. Testing Strategy

### Manual Testing
1. **Open File**:
   - Press `Ctrl+O` or File > Open
   - Verify file dialog appears with `.ckt` and `.cdl` filters
   - Select a file and verify it's added to Recent Files

2. **Recent Files**:
   - Open 3-4 files
   - Verify Recent Files menu shows them in reverse chronological order
   - Click a recent file, verify it opens
   - Restart app, verify recent files persist

3. **Missing Files**:
   - Add file to recent list
   - Delete the file from disk
   - Click it in Recent Files menu
   - Verify warning dialog appears
   - Verify file is removed from list

4. **Clear Recent**:
   - Open several files
   - Click "Clear Recent Files"
   - Verify list is empty
   - Verify "No recent files" message appears

### Unit Tests
```python
# tests/ui/test_file_menu.py

def test_open_action_exists(main_window):
    """Test Open action is in File menu."""
    actions = main_window.file_menu.actions()
    open_action = next(a for a in actions if "Open" in a.text() and "Recent" not in a.text())
    assert open_action is not None
    assert open_action.shortcut() == QKeySequence.StandardKey.Open

def test_recent_files_submenu_exists(main_window):
    """Test Recent Files submenu exists."""
    assert main_window.recent_menu is not None

def test_add_recent_file(main_window):
    """Test adding file to recent list."""
    main_window._add_recent_file("/path/to/file1.ckt")
    recent = main_window._get_recent_files()
    assert "/path/to/file1.ckt" in recent
    assert recent[0] == "/path/to/file1.ckt"

def test_recent_files_max_limit(main_window):
    """Test recent files limited to MAX_RECENT_FILES."""
    for i in range(15):
        main_window._add_recent_file(f"/path/to/file{i}.ckt")
    recent = main_window._get_recent_files()
    assert len(recent) == main_window.MAX_RECENT_FILES

def test_remove_recent_file(main_window):
    """Test removing file from recent list."""
    main_window._add_recent_file("/path/to/file.ckt")
    main_window._remove_recent_file("/path/to/file.ckt")
    recent = main_window._get_recent_files()
    assert "/path/to/file.ckt" not in recent
```

---

## 6. Implementation Notes

- `_load_netlist()` currently just updates recent files (full integration with FileService in E01-F01)
- Use `lambda` with default argument capture for recent file actions: `lambda checked, path=file_path: self._open_recent_file(path)`
- `QSettings` automatically handles platform-specific storage locations
- File dialog filter format: `"Description (*.ext1 *.ext2);;Another (*.ext3)"`
- Consider starting file dialog in last-used directory (can be stored in settings)

---

## Revision History

| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-12-26 | 0.1 | Claude | Initial task creation from E06-F02 split |
