# Pre-Implementation Documentation: E06-F02-T04 - View and Help Menus

## Overview

### Problem Context
Users need View menu controls to manage schematic zoom and panel visibility, plus Help menu access to keyboard shortcuts and application information. The View menu must provide intuitive controls for the schematic canvas (zoom in/out, fit view) and toggles for dock panels with automatic checkmark synchronization. The Help menu provides user assistance through a keyboard shortcuts reference and an About dialog.

### Scope
- Implement View menu with zoom controls (Zoom In, Zoom Out, Fit View)
- Add panel visibility toggles with automatic checkmark synchronization
- Implement Help menu with Keyboard Shortcuts dialog and About dialog
- Create KeyboardShortcutsDialog as separate dialog class
- Ensure zoom actions delegate to SchematicCanvas methods
- Use Qt's built-in dock widget toggle actions for panel visibility

### Related Specifications
- **Parent Feature**: E06-F02 (Menu System)
- **Upstream Dependencies**:
  - E06-F02-T01 (Menu Bar Setup - requires `self.view_menu`, `self.help_menu`)
  - E06-F01 (Main Window Shell - requires dock widgets)
  - E02-F02 (Schematic Canvas - basic canvas structure)
- **Downstream Dependencies**:
  - E02-F04 (Zoom and Pan - canvas zoom methods)

---

## Implementation Approach

### Architecture Integration

**Layer**: Presentation Layer
**Components**:
- `InkMainWindow` class (`src/ink/presentation/main_window.py`)
- `KeyboardShortcutsDialog` class (`src/ink/presentation/dialogs/shortcuts_dialog.py`)

The View and Help menus are pure UI concerns in the presentation layer. View menu actions delegate to SchematicCanvas and dock widgets, while Help menu shows informational dialogs.

### Key Components

```
InkMainWindow
├── _create_view_menu()           # Populate View menu (T01 stub)
│   ├── Zoom In action            # Delegates to canvas.zoom_in()
│   ├── Zoom Out action           # Delegates to canvas.zoom_out()
│   ├── Fit View action           # Delegates to canvas.fit_to_view()
│   ├── Hierarchy Panel toggle    # From dock.toggleViewAction()
│   ├── Property Panel toggle     # From dock.toggleViewAction()
│   └── Message Panel toggle      # From dock.toggleViewAction()
├── _create_help_menu()           # Populate Help menu (T01 stub)
│   ├── Keyboard Shortcuts action # Shows KeyboardShortcutsDialog
│   └── About Ink action          # Shows QMessageBox.about()
├── _on_zoom_in()                 # Handle zoom in
├── _on_zoom_out()                # Handle zoom out
├── _on_fit_view()                # Handle fit to view
├── _on_show_shortcuts()          # Show shortcuts dialog
└── _on_about()                   # Show about dialog

KeyboardShortcutsDialog (NEW)
├── __init__(parent)              # Initialize dialog
└── _get_shortcuts_html()         # Generate HTML content

Instance Variables:
├── self.hierarchy_toggle: QAction   # Panel toggle action
├── self.property_toggle: QAction    # Panel toggle action
└── self.message_toggle: QAction     # Panel toggle action
```

### Implementation Steps

1. **Implement `_create_view_menu()`**
   - Create Zoom In action with Ctrl+= shortcut
   - Create Zoom Out action with Ctrl+- shortcut
   - Create Fit View action with Ctrl+0 shortcut
   - Add separator
   - Get toggle actions from dock widgets
   - Customize toggle action text and status tips
   - Add toggle actions to menu

2. **Implement zoom handlers**
   - `_on_zoom_in()` - Delegate to `schematic_canvas.zoom_in()`
   - `_on_zoom_out()` - Delegate to `schematic_canvas.zoom_out()`
   - `_on_fit_view()` - Delegate to `schematic_canvas.fit_to_view()`
   - Add null checks for canvas existence

3. **Implement `_create_help_menu()`**
   - Create Keyboard Shortcuts action with F1 shortcut
   - Create About Ink action
   - Connect to handler methods

4. **Implement Help handlers**
   - `_on_show_shortcuts()` - Create and show KeyboardShortcutsDialog
   - `_on_about()` - Show QMessageBox.about() with app info

5. **Create KeyboardShortcutsDialog**
   - New file: `src/ink/presentation/dialogs/shortcuts_dialog.py`
   - QDialog subclass with QTextBrowser for shortcuts
   - HTML content with organized categories
   - Close button

---

## Key Design Decisions

### Decision 1: Panel Toggle Implementation

**Options Considered**:
1. **QDockWidget.toggleViewAction()** - Built-in Qt action
2. **Manual checkable actions** - Custom QAction with visibility tracking
3. **Toggle buttons in toolbar** - Separate from menu

**Chosen**: QDockWidget.toggleViewAction()

**Rationale**:
- Qt provides this specifically for this use case
- Automatic checkmark synchronization (no manual tracking)
- Automatically updates when dock visibility changes via other means (close button, etc.)
- Less code, fewer bugs
- Standard Qt pattern

**Implementation**:
```python
self.hierarchy_toggle = self.hierarchy_dock.toggleViewAction()
self.hierarchy_toggle.setText("&Hierarchy Panel")
self.hierarchy_toggle.setStatusTip("Show/hide hierarchy panel")
self.view_menu.addAction(self.hierarchy_toggle)
```

### Decision 2: Zoom Shortcut Keys

**Options Considered**:
1. **Ctrl+= / Ctrl+-** (QKeySequence.StandardKey)
2. **Ctrl++ / Ctrl+-** (explicit plus sign)
3. **Ctrl+Wheel** (mouse only)

**Chosen**: Ctrl+= / Ctrl+- (StandardKey.ZoomIn/ZoomOut)

**Rationale**:
- Qt StandardKey automatically handles platform differences
- `=` and `-` are on same keys as `+` and `-` (no Shift needed for zoom in)
- Standard across most applications
- Mouse wheel zoom is separate feature (E02-F04)

**Note**: Fit View uses Ctrl+0 (common convention, not a StandardKey)

### Decision 3: Keyboard Shortcuts Dialog Format

**Options Considered**:
1. **HTML in QTextBrowser** - Formatted text with tables
2. **QTableWidget** - Native table widget
3. **Plain text in QTextEdit** - Simple but unformatted

**Chosen**: HTML in QTextBrowser

**Rationale**:
- Easy to format with headers, tables, bold text
- QTextBrowser renders HTML well
- Simple to maintain (edit HTML string)
- More flexible than plain text
- Lighter than building table widget programmatically

**Structure**:
```html
<h2>Keyboard Shortcuts</h2>
<h3>Category</h3>
<table>
  <tr><td><b>Shortcut</b></td><td>Description</td></tr>
</table>
```

### Decision 4: About Dialog Implementation

**Options Considered**:
1. **QMessageBox.about()** - Qt built-in
2. **Custom QDialog** - Full control
3. **QMessageBox.information()** - Generic dialog

**Chosen**: QMessageBox.about()

**Rationale**:
- Designed specifically for About dialogs
- Platform-native styling
- Simple to implement
- Standard "About" icon (information icon)
- One-liner implementation

**Content**:
- App name and version
- Brief description
- Key features
- Technology stack
- Copyright notice

### Decision 5: Zoom Action Integration

**Options Considered**:
1. **Direct canvas method calls** - Immediate integration
2. **Placeholder with TODO** - Defer to E02-F04
3. **Disable actions** - Wait for canvas implementation

**Chosen**: Direct canvas method calls with null checks

**Rationale**:
- E02-F02 (Schematic Canvas) is likely complete
- Simple delegation, low risk
- Null checks prevent crashes if canvas not ready
- Better UX than disabled actions

**Implementation**:
```python
def _on_zoom_in(self):
    if self.schematic_canvas:
        self.schematic_canvas.zoom_in()
```

---

## Dependencies and Integration Points

### Upstream Dependencies

**E06-F02-T01 (Menu Bar Setup)**
- **Required**: `self.view_menu` and `self.help_menu` instance variables
- **Required**: `_create_view_menu()` and `_create_help_menu()` stub methods
- **Integration**: Replace stubs with full implementations

**E06-F01 (Main Window Shell)**
- **Required**: Dock widgets exist:
  - `self.hierarchy_dock: QDockWidget`
  - `self.property_dock: QDockWidget`
  - `self.message_dock: QDockWidget`
- **Integration**: Call `toggleViewAction()` on each dock

**E02-F02 (Schematic Canvas)**
- **Required**: `self.schematic_canvas` widget exists
- **Integration**: Call zoom methods (with null checks)

### Downstream Dependencies

**E02-F04 (Zoom and Pan)**
- **Future Integration**: SchematicCanvas must provide:
  - `zoom_in() -> None`
  - `zoom_out() -> None`
  - `fit_to_view() -> None`
- **If not ready**: Null checks prevent crashes, actions still callable

### External Dependencies

**PySide6 Modules**:
- `QAction` - Menu action items
- `QKeySequence` - Keyboard shortcuts
- `QMessageBox` - About dialog
- `QDialog` - Base for shortcuts dialog
- `QTextBrowser` - HTML display for shortcuts
- `QPushButton` - Close button in shortcuts dialog
- `QVBoxLayout` - Layout for shortcuts dialog

### Integration Points

1. **Zoom Flow**
   ```
   User presses Ctrl+=
     → _on_zoom_in()
     → if self.schematic_canvas:
     → schematic_canvas.zoom_in()
     → Canvas handles zoom transform
   ```

2. **Panel Toggle Flow**
   ```
   User clicks "Hierarchy Panel"
     → hierarchy_toggle.triggered (Qt signal)
     → Qt automatically toggles dock visibility
     → Checkmark auto-updates
   ```

3. **Shortcuts Dialog Flow**
   ```
   User presses F1
     → _on_show_shortcuts()
     → dialog = KeyboardShortcutsDialog(self)
     → dialog.exec()
     → User reads shortcuts, clicks Close
   ```

4. **About Dialog Flow**
   ```
   User clicks Help > About Ink
     → _on_about()
     → QMessageBox.about(self, title, html_content)
     → Dialog shows, user clicks OK
   ```

---

## Testing Strategy

### Unit Tests

**Location**: `tests/ui/test_view_menu.py`, `tests/ui/test_help_menu.py`

**Test Cases - View Menu**:
1. **Zoom Actions**
   - `test_zoom_in_action_exists` - Verify Zoom In with Ctrl+=
   - `test_zoom_out_action_exists` - Verify Zoom Out with Ctrl+-
   - `test_fit_view_action_exists` - Verify Fit View with Ctrl+0
   - `test_zoom_shortcuts` - Verify correct shortcuts assigned

2. **Panel Toggles**
   - `test_panel_toggles_exist` - Verify all three toggle actions exist
   - `test_panel_toggles_checkable` - Verify actions are checkable
   - `test_panel_toggle_syncs_with_visibility` - Hide dock, verify unchecked
   - `test_panel_toggle_text` - Verify custom text set correctly

**Test Cases - Help Menu**:
1. **Menu Structure**
   - `test_shortcuts_action_exists` - Verify action with F1
   - `test_about_action_exists` - Verify About action

2. **Dialogs**
   - `test_shortcuts_dialog_creation` - Verify dialog can be created
   - `test_shortcuts_dialog_content` - Verify HTML content generated
   - `test_about_dialog_called` - Mock QMessageBox.about, verify called

**Test Fixtures**:
```python
@pytest.fixture
def main_window_with_canvas(qtbot):
    """Create InkMainWindow with canvas and docks."""
    window = InkMainWindow()
    # Ensure all widgets initialized
    qtbot.addWidget(window)
    return window

@pytest.fixture
def shortcuts_dialog(qtbot):
    """Create KeyboardShortcutsDialog for testing."""
    dialog = KeyboardShortcutsDialog()
    qtbot.addWidget(dialog)
    return dialog
```

### Integration Tests

**Scenario 1: Panel Toggle Integration**
```python
def test_panel_toggle_integration(main_window, qtbot):
    """Test panel toggle action syncs with dock visibility."""
    # Initially visible
    main_window.hierarchy_dock.setVisible(True)
    assert main_window.hierarchy_toggle.isChecked()

    # Close via close button (not toggle action)
    main_window.hierarchy_dock.close()
    assert not main_window.hierarchy_toggle.isChecked()

    # Reopen via toggle action
    main_window.hierarchy_toggle.trigger()
    assert main_window.hierarchy_dock.isVisible()
    assert main_window.hierarchy_toggle.isChecked()
```

**Scenario 2: Zoom Action Integration** (if canvas ready)
```python
def test_zoom_action_integration(main_window, qtbot):
    """Test zoom actions call canvas methods."""
    # Mock canvas zoom methods
    zoom_in_called = False
    zoom_out_called = False
    fit_view_called = False

    def mock_zoom_in():
        nonlocal zoom_in_called
        zoom_in_called = True

    def mock_zoom_out():
        nonlocal zoom_out_called
        zoom_out_called = True

    def mock_fit_view():
        nonlocal fit_view_called
        fit_view_called = True

    main_window.schematic_canvas.zoom_in = mock_zoom_in
    main_window.schematic_canvas.zoom_out = mock_zoom_out
    main_window.schematic_canvas.fit_to_view = mock_fit_view

    # Trigger actions
    main_window._on_zoom_in()
    main_window._on_zoom_out()
    main_window._on_fit_view()

    # Verify calls
    assert zoom_in_called
    assert zoom_out_called
    assert fit_view_called
```

### Manual Testing Checklist

1. **Zoom Actions**
   - [ ] Press `Ctrl+=` - schematic zooms in
   - [ ] Press `Ctrl+-` - schematic zooms out
   - [ ] Press `Ctrl+0` - schematic fits to view
   - [ ] Click View > Zoom In - zooms in
   - [ ] Click View > Zoom Out - zooms out
   - [ ] Click View > Fit View - fits to view

2. **Panel Toggles**
   - [ ] Click View > Hierarchy Panel - toggles visibility
   - [ ] Verify checkmark when visible, no checkmark when hidden
   - [ ] Close Hierarchy Panel via X button
   - [ ] Verify checkmark disappears automatically
   - [ ] Reopen via View menu - verify checkmark reappears
   - [ ] Repeat for Property Panel and Message Panel

3. **Keyboard Shortcuts Dialog**
   - [ ] Press `F1` - dialog opens
   - [ ] Click Help > Keyboard Shortcuts - dialog opens
   - [ ] Verify all shortcuts listed and organized by category
   - [ ] Verify File, Edit, View, Canvas Interaction, Help sections
   - [ ] Verify formatting is clean and readable
   - [ ] Click Close button - dialog closes

4. **About Dialog**
   - [ ] Click Help > About Ink
   - [ ] Verify dialog shows:
     - [ ] App name "Ink - Incremental Schematic Viewer"
     - [ ] Version "0.1.0 (MVP)"
     - [ ] Description
     - [ ] Feature list
     - [ ] Technology stack
     - [ ] Copyright notice
   - [ ] Verify formatting looks good
   - [ ] Click OK - dialog closes

5. **Keyboard Shortcuts**
   - [ ] Test all View menu shortcuts work
   - [ ] Test F1 opens shortcuts dialog

---

## Risks and Considerations

### Risk 1: Schematic Canvas Not Ready

**Description**: E02-F04 zoom methods may not be implemented when this task completes

**Likelihood**: Medium

**Impact**: Low (zoom actions won't work)

**Mitigation**:
- Use null checks before calling canvas methods
- Actions remain in menu (better UX than removing)
- Integration is simple when E02-F04 completes
- Alternative: Add placeholder zoom methods to canvas that show status message

### Risk 2: Dock Widgets Not Initialized

**Description**: E06-F01 dock widgets may not exist when this task starts

**Likelihood**: Low

**Impact**: High (crashes on toggleViewAction() call)

**Mitigation**:
- Verify E06-F01 completion before starting
- Add defensive checks:
  ```python
  if hasattr(self, 'hierarchy_dock') and self.hierarchy_dock:
      self.hierarchy_toggle = self.hierarchy_dock.toggleViewAction()
  ```
- Test thoroughly

### Risk 3: Keyboard Shortcut Conflicts

**Description**: Ctrl+0 or F1 may conflict with other shortcuts

**Likelihood**: Low

**Impact**: Low (Qt handles focus)

**Mitigation**:
- Qt action system manages shortcut context
- Test with different widgets focused
- F1 is standard Help shortcut
- Ctrl+0 is standard Fit shortcut

### Risk 4: About Dialog Content Staleness

**Description**: Hardcoded version and features may become outdated

**Likelihood**: High (over time)

**Impact**: Low (cosmetic issue)

**Mitigation**:
- For MVP: Hardcode is acceptable
- Future enhancement: Read version from `pyproject.toml`
  ```python
  import tomllib
  with open("pyproject.toml", "rb") as f:
      config = tomllib.load(f)
  version = config["project"]["version"]
  ```
- Document in code comment for future maintainer

### Risk 5: HTML Rendering Inconsistencies

**Description**: QTextBrowser may render HTML differently on different platforms

**Likelihood**: Low

**Impact**: Very Low (minor visual differences)

**Mitigation**:
- Use simple HTML tags (h2, h3, table, tr, td, b)
- Avoid complex CSS
- Test on target platform (Linux)
- If issues arise, simplify HTML further

### Consideration 1: Shortcuts Dialog Extensibility

The shortcuts HTML is hardcoded. Consider future enhancements:
- Generate from action registry (discover shortcuts programmatically)
- Store in separate HTML file
- Make dialog resizable for long content

For MVP, hardcoded HTML is sufficient and easy to maintain.

### Consideration 2: Panel Toggle Order

The spec doesn't specify panel order in menu. Consider:
- Hierarchy, Property, Message (logical flow: navigation → details → logs)
- Alphabetical (easier to find)
- Usage frequency (most used first)

Chosen: Hierarchy, Property, Message (logical flow)

### Consideration 3: Zoom Levels

Not specified in this task, but consider for E02-F04:
- Min/max zoom limits
- Zoom step size
- Zoom to specific level (e.g., 100%, 200%)

View menu could show current zoom level in future enhancement.

### Consideration 4: Accessibility

Ensure keyboard accessibility:
- All actions have mnemonics (done via `&` in text)
- Keyboard shortcuts follow standards
- Dialogs navigable with keyboard
- Screen reader friendly (native Qt widgets handle this)

---

## Implementation Checklist

### Pre-Implementation
- [ ] Verify E06-F02-T01 (Menu Bar Setup) is complete
- [ ] Verify E06-F01 (Main Window Shell) dock widgets exist
- [ ] Check status of E02-F04 (Zoom and Pan) - coordinate if needed
- [ ] Review PySide6 QDockWidget.toggleViewAction() documentation
- [ ] Create `dialogs/` directory if it doesn't exist

### Implementation - View Menu
- [ ] Implement `_create_view_menu()` in main_window.py
- [ ] Add Zoom In action with StandardKey.ZoomIn
- [ ] Add Zoom Out action with StandardKey.ZoomOut
- [ ] Add Fit View action with Ctrl+0
- [ ] Add status tips to zoom actions
- [ ] Implement `_on_zoom_in()` with canvas delegation
- [ ] Implement `_on_zoom_out()` with canvas delegation
- [ ] Implement `_on_fit_view()` with canvas delegation
- [ ] Add null checks for canvas existence
- [ ] Add separator after zoom actions
- [ ] Get toggle actions from dock widgets
- [ ] Customize toggle action text and status tips
- [ ] Store toggle actions as instance variables

### Implementation - Help Menu
- [ ] Implement `_create_help_menu()` in main_window.py
- [ ] Add Keyboard Shortcuts action with F1
- [ ] Add About Ink action
- [ ] Add status tips to Help actions
- [ ] Implement `_on_show_shortcuts()`
- [ ] Implement `_on_about()` with QMessageBox.about()
- [ ] Write About dialog HTML content

### Implementation - Shortcuts Dialog
- [ ] Create `src/ink/presentation/dialogs/shortcuts_dialog.py`
- [ ] Create `KeyboardShortcutsDialog` class
- [ ] Implement `__init__()` with layout
- [ ] Add QTextBrowser widget
- [ ] Implement `_get_shortcuts_html()` method
- [ ] Write HTML content with all shortcuts organized by category
- [ ] Add Close button
- [ ] Set minimum dialog size (500x400)
- [ ] Add docstrings

### Testing
- [ ] Write unit tests for View menu structure
- [ ] Write unit tests for zoom actions
- [ ] Write unit tests for panel toggles
- [ ] Write unit tests for Help menu structure
- [ ] Write unit tests for shortcuts dialog
- [ ] Write integration test for panel toggle synchronization
- [ ] Write integration test for zoom action delegation (with mocks)
- [ ] Test keyboard shortcuts (Ctrl+=, Ctrl+-, Ctrl+0, F1)
- [ ] Test panel toggles with various show/hide methods
- [ ] Run all tests and verify they pass
- [ ] Perform complete manual testing checklist

### Documentation
- [ ] Add docstrings to all methods
- [ ] Add inline comments for non-obvious code
- [ ] Document integration points with E02-F04
- [ ] Add TODO comments if canvas methods not ready
- [ ] Document About dialog content structure

---

## Success Criteria

**Definition of Done**:
1. View menu contains Zoom In, Zoom Out, Fit View actions
2. View menu contains Hierarchy Panel, Property Panel, Message Panel toggles
3. Keyboard shortcuts work: Ctrl+=, Ctrl+-, Ctrl+0, F1
4. Panel toggles show checkmarks when panels visible
5. Checkmarks sync automatically with dock visibility changes
6. Zoom actions delegate to canvas methods (with null checks)
7. Help menu contains Keyboard Shortcuts and About actions
8. Keyboard Shortcuts dialog shows all shortcuts organized by category
9. About dialog shows app info, version, features, credits
10. KeyboardShortcutsDialog implemented in separate file
11. All unit and integration tests pass
12. Manual testing checklist complete
13. Code follows project style guidelines

**Acceptance Validation**:
- All acceptance criteria from spec are met
- Panel toggles sync correctly (test by closing via X button)
- Zoom actions work if canvas ready, don't crash if not
- Dialogs display correctly and are keyboard-navigable
- Ready for E02-F04 integration (zoom methods)
- Clean, maintainable code structure
