# Spec: E06-F03-T04 - Icon Resources and Theme Support

## Metadata
- **ID**: E06-F03-T04
- **Type**: Task
- **Priority**: P0 (MVP)
- **Status**: Draft
- **Parent**: [E06-F03](../E06-F03.spec.md)
- **Created**: 2025-12-26
- **Estimated Hours**: 4
- **Actual Hours**:
- **Effort**: Small
- **Tags**: [ui, icons, resources, theming, qt-resources]

---

## 1. Overview

### 1.1 Problem Statement

While Qt's `QIcon.fromTheme()` provides system icons on platforms with icon themes (Linux with GNOME/KDE), it may fail on systems without proper themes or fallback icons. To ensure consistent toolbar button appearance across all platforms and configurations, the application needs bundled fallback icons for all toolbar actions.

### 1.2 Goals

- Provide fallback SVG icons for all toolbar buttons
- Implement icon loading with theme-first, fallback-second strategy
- Support dark mode and light mode icon variants
- Create Qt resource file for bundled icons
- Ensure high-DPI (Retina) display compatibility
- Document icon sources and licenses

---

## 2. Technical Requirements

### 2.1 Icon Resource Structure

```
ink/
├── resources/
│   ├── icons/
│   │   ├── document-open.svg        # File operations
│   │   ├── edit-undo.svg            # Edit operations
│   │   ├── edit-redo.svg
│   │   ├── edit-find.svg            # Search
│   │   ├── zoom-in.svg              # View controls
│   │   ├── zoom-out.svg
│   │   └── zoom-fit-best.svg
│   └── resources.qrc                # Qt resource file
├── src/
│   └── ink/
│       └── presentation/
│           └── utils/
│               └── icon_provider.py  # Icon loading utility
```

### 2.2 Icon Provider Implementation

**Location**: `src/ink/presentation/utils/icon_provider.py`

```python
"""Icon loading utility with theme fallback support."""

from pathlib import Path
from PySide6.QtGui import QIcon
from PySide6.QtCore import QFile

class IconProvider:
    """Provides icons with system theme fallback to bundled resources."""

    # Icon name mapping (theme name -> resource path)
    ICON_MAP = {
        "document-open": ":/icons/document-open.svg",
        "edit-undo": ":/icons/edit-undo.svg",
        "edit-redo": ":/icons/edit-redo.svg",
        "edit-find": ":/icons/edit-find.svg",
        "zoom-in": ":/icons/zoom-in.svg",
        "zoom-out": ":/icons/zoom-out.svg",
        "zoom-fit-best": ":/icons/zoom-fit-best.svg",
    }

    @staticmethod
    def get_icon(name: str) -> QIcon:
        """
        Get icon by name with theme fallback.

        First attempts to load from system icon theme. If not available,
        falls back to bundled SVG resource.

        Args:
            name: Icon name (e.g., "document-open", "edit-undo")

        Returns:
            QIcon instance (may be null icon if both theme and resource fail)
        """
        # Try system theme first
        icon = QIcon.fromTheme(name)

        # Check if theme icon actually exists
        if not icon.isNull() and not icon.availableSizes():
            icon = QIcon()  # Reset to null if theme returned empty icon

        # Fallback to bundled resource if theme failed
        if icon.isNull():
            resource_path = IconProvider.ICON_MAP.get(name)
            if resource_path and QFile.exists(resource_path):
                icon = QIcon(resource_path)

        return icon

    @staticmethod
    def has_theme_icon(name: str) -> bool:
        """Check if system theme provides the icon."""
        icon = QIcon.fromTheme(name)
        return not icon.isNull() and len(icon.availableSizes()) > 0
```

### 2.3 Qt Resource File

**Location**: `resources/resources.qrc`

```xml
<!DOCTYPE RCC>
<RCC version="1.0">
    <qresource prefix="icons">
        <file>icons/document-open.svg</file>
        <file>icons/edit-undo.svg</file>
        <file>icons/edit-redo.svg</file>
        <file>icons/edit-find.svg</file>
        <file>icons/zoom-in.svg</file>
        <file>icons/zoom-out.svg</file>
        <file>icons/zoom-fit-best.svg</file>
    </qresource>
</RCC>
```

### 2.4 Resource Compilation

Add to `pyproject.toml` or build script:

```toml
# pyproject.toml
[tool.pyside6]
qrc-files = ["resources/resources.qrc"]
```

Or compile manually:

```bash
pyside6-rcc resources/resources.qrc -o src/ink/presentation/resources_rc.py
```

### 2.5 Resource Initialization

**Location**: `src/ink/presentation/app.py` or `main_window.py`

```python
# Import compiled resources (registers resources with Qt)
from ink.presentation import resources_rc  # type: ignore

class InkApplication(QApplication):
    def __init__(self, argv):
        super().__init__(argv)
        # Resources automatically registered on import
```

### 2.6 Update Main Window to Use Icon Provider

**Location**: `src/ink/presentation/main_window.py`

```python
from ink.presentation.utils.icon_provider import IconProvider

class InkMainWindow(QMainWindow):
    def _add_file_actions(self, toolbar: QToolBar):
        """Add file-related toolbar actions."""
        open_action = QAction(
            IconProvider.get_icon("document-open"),  # Use IconProvider
            "Open",
            self
        )
        # ... rest of setup ...

    def _add_edit_actions(self, toolbar: QToolBar):
        """Add edit-related toolbar actions."""
        self._undo_action = QAction(
            IconProvider.get_icon("edit-undo"),  # Use IconProvider
            "Undo",
            self
        )
        # ... rest of setup ...
```

### 2.7 Icon Specifications

| Icon Name | Purpose | Source | Size | Format |
|-----------|---------|--------|------|--------|
| `document-open` | Open file | Material Icons / Tabler Icons | 24x24 | SVG |
| `edit-undo` | Undo action | Material Icons / Tabler Icons | 24x24 | SVG |
| `edit-redo` | Redo action | Material Icons / Tabler Icons | 24x24 | SVG |
| `edit-find` | Search | Material Icons / Tabler Icons | 24x24 | SVG |
| `zoom-in` | Zoom in | Material Icons / Tabler Icons | 24x24 | SVG |
| `zoom-out` | Zoom out | Material Icons / Tabler Icons | 24x24 | SVG |
| `zoom-fit-best` | Fit view | Material Icons / Tabler Icons | 24x24 | SVG |

**Icon Requirements**:
- **Format**: SVG (vector, scalable for high-DPI)
- **Size**: 24x24px nominal, but scalable
- **Style**: Simple, monochrome (black or dark gray)
- **License**: MIT, Apache 2.0, or CC0 (permissive)
- **Source**: Material Icons, Tabler Icons, or Feather Icons recommended

### 2.8 Icon Sources

**Recommended icon sets**:

1. **Material Icons** (Apache 2.0): https://fonts.google.com/icons
2. **Tabler Icons** (MIT): https://tabler-icons.io/
3. **Feather Icons** (MIT): https://feathericons.com/
4. **Heroicons** (MIT): https://heroicons.com/

**Download locations**:
- Material Icons: Download individual SVGs from Google Fonts
- Tabler Icons: `npm install @tabler/icons` or download from GitHub
- Feather Icons: Download from website or GitHub releases

---

## 3. Dependencies

### 3.1 Upstream Dependencies
- **E06-F03-T01**: Toolbar Setup (icon provider used by toolbar)
- **E06-F03-T02**: View Control Tools (uses zoom icons)
- **E06-F03-T03**: File, Edit and Search Tools (uses file/edit/search icons)

### 3.2 External Dependencies
- PySide6: `QIcon`, `QFile`, `pyside6-rcc` (resource compiler)
- Icon set: Material Icons or Tabler Icons (bundled)

---

## 4. Acceptance Criteria

- [ ] 7 SVG icon files present in `resources/icons/` directory
- [ ] Icons sourced from permissively licensed icon set
- [ ] `resources.qrc` file lists all icon files
- [ ] `resources_rc.py` compiled from `.qrc` file
- [ ] `IconProvider` class implemented with `get_icon()` method
- [ ] `IconProvider.get_icon()` tries system theme first
- [ ] `IconProvider.get_icon()` falls back to bundled SVG if theme missing
- [ ] Main window uses `IconProvider` for all toolbar icons
- [ ] All toolbar buttons display icons on systems without icon themes
- [ ] Icons display correctly on high-DPI (Retina) displays
- [ ] Icons scale properly at different toolbar sizes
- [ ] Icons are monochrome and adapt to system theme colors
- [ ] `README.md` or `resources/icons/README.md` documents icon sources and licenses

---

## 5. Testing Strategy

### 5.1 Unit Tests

**Test file**: `tests/unit/presentation/utils/test_icon_provider.py`

```python
import pytest
from PySide6.QtGui import QIcon
from ink.presentation.utils.icon_provider import IconProvider

def test_icon_provider_returns_icon():
    """Test IconProvider returns QIcon instance."""
    icon = IconProvider.get_icon("document-open")
    assert isinstance(icon, QIcon)

def test_icon_provider_fallback():
    """Test IconProvider falls back to bundled resource."""
    # Use non-standard icon name that won't be in theme
    icon = IconProvider.get_icon("zoom-fit-best")
    assert not icon.isNull()

def test_icon_provider_unknown_icon():
    """Test IconProvider handles unknown icon gracefully."""
    icon = IconProvider.get_icon("nonexistent-icon")
    # Should return null icon, not crash
    assert isinstance(icon, QIcon)

def test_has_theme_icon():
    """Test has_theme_icon() detection."""
    # Common icon likely in theme
    has_open = IconProvider.has_theme_icon("document-open")
    # Result depends on system, but should not crash
    assert isinstance(has_open, bool)
```

### 5.2 Integration Tests

**Test file**: `tests/integration/ui/test_toolbar_icons.py`

```python
def test_all_toolbar_buttons_have_icons(main_window):
    """Test all toolbar buttons display icons."""
    toolbar = main_window.findChild(QToolBar, "MainToolBar")

    for action in toolbar.actions():
        if not action.isSeparator():
            icon = action.icon()
            assert not icon.isNull(), f"Action '{action.text()}' has no icon"

def test_icons_have_sizes(main_window):
    """Test icons have available sizes (not empty)."""
    toolbar = main_window.findChild(QToolBar, "MainToolBar")

    for action in toolbar.actions():
        if not action.isSeparator():
            icon = action.icon()
            sizes = icon.availableSizes()
            assert len(sizes) > 0, f"Action '{action.text()}' icon has no sizes"
```

### 5.3 Manual Testing

**Test on multiple platforms**:

1. **Linux with icon theme** (GNOME/KDE):
   - Verify icons load from system theme
   - Verify icons adapt to dark/light mode

2. **Linux without icon theme**:
   - Verify icons fall back to bundled SVGs
   - Verify all buttons display icons

3. **High-DPI display**:
   - Verify icons are crisp at 2x/3x scaling
   - Verify no pixelation or blurriness

4. **Different toolbar sizes**:
   - Change icon size via `toolbar.setIconSize(QSize(32, 32))`
   - Verify SVGs scale cleanly

**Visual checks**:
- All toolbar buttons have icons
- Icons are visually consistent (same style)
- Icons are recognizable and appropriate for actions
- Icons maintain aspect ratio when scaled

---

## 6. Implementation Notes

### 6.1 Icon Selection Guidelines

Choose icons that are:
- **Recognizable**: Match common conventions (magnifying glass for search, folder for open, etc.)
- **Consistent**: Same visual style across all icons
- **Simple**: Clear at small sizes (24x24px)
- **Monochrome**: Single color that adapts to theme

### 6.2 SVG Optimization

Before bundling, optimize SVGs:

```bash
# Install svgo (SVG optimizer)
npm install -g svgo

# Optimize SVG file
svgo icons/document-open.svg
```

Optimizations:
- Remove unnecessary metadata
- Simplify paths
- Remove comments and whitespace
- Keep `viewBox` attribute for proper scaling

### 6.3 Theme Color Adaptation

SVG icons should use `currentColor` for fill/stroke to adapt to theme:

```xml
<!-- Good: Adapts to theme -->
<svg viewBox="0 0 24 24">
  <path fill="currentColor" d="..."/>
</svg>

<!-- Bad: Fixed color -->
<svg viewBox="0 0 24 24">
  <path fill="#000000" d="..."/>
</svg>
```

### 6.4 Resource Compilation in Build Process

Add to build/CI script:

```bash
# Compile Qt resources before running application
pyside6-rcc resources/resources.qrc -o src/ink/presentation/resources_rc.py
```

Or use `setuptools` integration:

```python
# setup.py
from setuptools import setup
from setuptools.command.build_py import build_py

class BuildQtResources(build_py):
    def run(self):
        import subprocess
        subprocess.run([
            "pyside6-rcc",
            "resources/resources.qrc",
            "-o", "src/ink/presentation/resources_rc.py"
        ])
        super().run()

setup(
    cmdclass={'build_py': BuildQtResources},
    # ...
)
```

### 6.5 Icon License Documentation

Create `resources/icons/README.md`:

```markdown
# Toolbar Icons

## Source
All icons are from [Tabler Icons](https://tabler-icons.io/) version 2.x.

## License
MIT License - see [Tabler Icons License](https://github.com/tabler/tabler-icons/blob/master/LICENSE)

## Icons Used
- `document-open.svg` - File Open icon
- `edit-undo.svg` - Undo icon
- `edit-redo.svg` - Redo icon
- `edit-find.svg` - Search icon
- `zoom-in.svg` - Zoom In icon
- `zoom-out.svg` - Zoom Out icon
- `zoom-fit-best.svg` - Fit View icon (custom name for "arrows-maximize")

## Modifications
- Optimized with `svgo` to reduce file size
- Changed fill color to `currentColor` for theme adaptation
```

### 6.6 Future Enhancements

- Dynamic theme switching (light/dark mode variants)
- Additional icon sizes (16x16 for menus, 32x32 for large toolbars)
- Custom icon theme support
- User-configurable icon sets
- Animated icons for loading states

---

## Revision History

| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-12-26 | 0.1 | Claude | Initial task spec creation from E06-F03 split |
