# E06-F03-T04: Icon Resources and Theme Support - Pre-Implementation Documentation

## Document Metadata
- **Task**: E06-F03-T04 - Icon Resources and Theme Support
- **Status**: Pre-Implementation Planning
- **Created**: 2025-12-26
- **Last Updated**: 2025-12-26
- **Author**: Claude Sonnet 4.5

---

## 1. Overview

### 1.1 Task Summary

E06-F03-T04 ensures consistent and reliable toolbar button icons across all platforms and system configurations. While Qt's `QIcon.fromTheme()` provides excellent system integration on Linux with icon themes, it fails gracefully on systems without themes installed. This task implements a robust icon loading strategy with bundled SVG fallbacks, guaranteeing that toolbar buttons always display appropriate icons regardless of the user's system configuration.

### 1.2 Core Objectives

1. **Bundled Icon Resources**: Provide SVG fallback icons for all 7 toolbar buttons
2. **Icon Provider Utility**: Create abstraction layer for theme-first, fallback-second loading
3. **Qt Resource System**: Compile icons into application resources via `.qrc` file
4. **High-DPI Support**: Ensure vector icons scale cleanly on Retina/high-DPI displays
5. **Theme Integration**: Prefer system theme icons when available (native look)
6. **Licensing Compliance**: Use permissively licensed icons with proper attribution

### 1.3 Success Criteria

- All 7 toolbar buttons display icons on systems without icon themes
- Icons are crisp and clear at all DPI settings
- `IconProvider` class successfully loads theme icons when available
- `IconProvider` falls back to bundled SVGs when theme missing
- Icons sourced from permissive license (MIT/Apache/CC0)
- Icon sources and licenses documented
- Main window refactored to use `IconProvider` (replacing direct `QIcon.fromTheme()`)

---

## 2. Problem Context

### 2.1 User Need

**Icon availability is critical for toolbar usability**:

- **Discoverability**: Icons make features discoverable at a glance
- **Recognition**: Standard icons (folder, magnifying glass) are instantly recognizable
- **Professionalism**: Missing icons make the application look unfinished
- **Accessibility**: Icons provide visual redundancy with tooltips

**Current State Problem**:
- T02 and T03 use `QIcon.fromTheme()` directly
- Works great on Linux with GNOME/KDE/XFCE
- **Fails silently on**:
  - Minimal Linux systems (headless servers)
  - Systems without icon theme packages installed
  - Some CI/testing environments
  - Potentially Windows/Mac (though not primary target)

**Result of Missing Icons**:
- Toolbar buttons show as blank or placeholder
- Users cannot identify button functions without hovering
- Application appears broken or incomplete

### 2.2 Technical Challenge

**Icon Loading Complexity**:

1. **Platform Variability**: Icon theme availability differs widely
   - GNOME: freedesktop.org icon theme standard
   - KDE: Breeze icon theme
   - Minimal systems: No theme at all
   - Need fallback for all cases

2. **Resource Compilation**: Qt resource system requires build step
   - `.qrc` XML file defining resources
   - `pyside6-rcc` compilation to Python module
   - Integration into build process
   - Import timing for resource registration

3. **Icon Selection**: Finding consistent, high-quality icons
   - Must match freedesktop.org naming conventions
   - Same visual style across all icons
   - Scalable (SVG) for DPI independence
   - Permissive licensing

4. **Performance**: Resource loading overhead
   - Embedded resources increase binary size (~1-2KB per SVG)
   - Initial import time (acceptable for 7 icons)
   - Caching strategy for repeated lookups

### 2.3 Integration Context

**Depends On**:
- **E06-F03-T01**: Toolbar infrastructure (framework for buttons)
- **E06-F03-T02**: View control buttons (uses zoom icons)
- **E06-F03-T03**: File/edit/search buttons (uses file/edit/search icons)

**Modifies**:
- **E06-F03-T02**: Refactor to use `IconProvider.get_icon()`
- **E06-F03-T03**: Refactor to use `IconProvider.get_icon()`

**New Components**:
- Icon provider utility class
- Qt resource file (`.qrc`)
- Compiled resource module (`resources_rc.py`)
- SVG icon files (7 total)
- Icon documentation/attribution

---

## 3. Implementation Approach

### 3.1 Architecture Design

**Component Structure**:
```
ink/
├── resources/
│   ├── icons/
│   │   ├── document-open.svg
│   │   ├── edit-undo.svg
│   │   ├── edit-redo.svg
│   │   ├── edit-find.svg
│   │   ├── zoom-in.svg
│   │   ├── zoom-out.svg
│   │   └── zoom-fit-best.svg
│   ├── resources.qrc          # Qt resource definition
│   └── README.md              # Icon sources and licenses
├── src/ink/presentation/
│   ├── utils/
│   │   ├── __init__.py
│   │   └── icon_provider.py  # Icon loading utility
│   ├── resources_rc.py        # Generated from .qrc
│   └── main_window.py         # Updated to use IconProvider
```

**Resource Loading Flow**:
```
Application starts
  → Import resources_rc module
  → Qt registers :/icons/* resources
  → IconProvider.get_icon("zoom-in") called
  → Try QIcon.fromTheme("zoom-in")
  → If null, try QIcon(":/icons/zoom-in.svg")
  → Return icon (guaranteed non-null)
```

### 3.2 Key Components

#### Component 1: Icon Provider Class

```python
# src/ink/presentation/utils/icon_provider.py

from pathlib import Path
from typing import Optional
from PySide6.QtGui import QIcon
from PySide6.QtCore import QFile

class IconProvider:
    """
    Provides icons with system theme fallback to bundled resources.

    Uses freedesktop.org icon theme when available, falls back to
    bundled SVG resources when theme is missing.
    """

    # Icon name mapping (theme name -> resource path)
    ICON_MAP = {
        "document-open": ":/icons/document-open.svg",
        "edit-undo": ":/icons/edit-undo.svg",
        "edit-redo": ":/icons/edit-redo.svg",
        "edit-find": ":/icons/edit-find.svg",
        "zoom-in": ":/icons/zoom-in.svg",
        "zoom-out": ":/icons/zoom-out.svg",
        "zoom-fit-best": ":/icons/zoom-fit-best.svg",
    }

    @staticmethod
    def get_icon(name: str) -> QIcon:
        """
        Get icon by name with theme fallback.

        First attempts to load from system icon theme. If not available,
        falls back to bundled SVG resource.

        Args:
            name: Icon name (e.g., "document-open", "edit-undo")

        Returns:
            QIcon instance. May be null icon if both theme and resource
            fail, but this should never happen with valid icon names.

        Example:
            >>> icon = IconProvider.get_icon("zoom-in")
            >>> action.setIcon(icon)
        """
        # Try system theme first (preferred for native look)
        icon = QIcon.fromTheme(name)

        # Check if theme icon actually loaded
        # (fromTheme returns non-null but empty icon if theme missing)
        if not icon.isNull() and icon.availableSizes():
            return icon  # Theme icon available and valid

        # Fallback to bundled resource
        resource_path = IconProvider.ICON_MAP.get(name)
        if resource_path and QFile.exists(resource_path):
            icon = QIcon(resource_path)
            return icon

        # Both failed - return null icon (should not happen)
        # Log warning for debugging
        import logging
        logger = logging.getLogger(__name__)
        logger.warning(f"Icon not found: {name} (theme or resource)")
        return QIcon()  # Null icon

    @staticmethod
    def has_theme_icon(name: str) -> bool:
        """
        Check if system theme provides the icon.

        Useful for debugging and diagnostics.

        Args:
            name: Icon name to check

        Returns:
            True if icon available in system theme
        """
        icon = QIcon.fromTheme(name)
        return not icon.isNull() and len(icon.availableSizes()) > 0
```

**Design Rationale**:
- Static methods (no state, pure utility class)
- Clear precedence: theme first, resource second
- Defensive null checks prevent runtime errors
- Logging for debugging theme issues

#### Component 2: Qt Resource File

```xml
<!-- resources/resources.qrc -->
<!DOCTYPE RCC>
<RCC version="1.0">
    <qresource prefix="icons">
        <file>icons/document-open.svg</file>
        <file>icons/edit-undo.svg</file>
        <file>icons/edit-redo.svg</file>
        <file>icons/edit-find.svg</file>
        <file>icons/zoom-in.svg</file>
        <file>icons/zoom-out.svg</file>
        <file>icons/zoom-fit-best.svg</file>
    </qresource>
</RCC>
```

**Resource Prefix**:
- `prefix="icons"` → resources accessible as `:/icons/filename.svg`
- Namespaces resources (can have multiple prefixes for different resource types)

#### Component 3: Resource Compilation

**Build Command**:
```bash
pyside6-rcc resources/resources.qrc -o src/ink/presentation/resources_rc.py
```

**Generated Output** (simplified):
```python
# src/ink/presentation/resources_rc.py (auto-generated)
from PySide6.QtCore import qRegisterResourceData, qUnregisterResourceData

# Binary data for SVG files embedded as bytes
qt_resource_data = b"\x00\x00\x03\x48..."  # Compiled SVG data

# Register resources with Qt resource system
qRegisterResourceData(...)
```

**Integration in Application**:
```python
# src/ink/presentation/app.py or main_window.py
from ink.presentation import resources_rc  # Import registers resources

class InkApplication(QApplication):
    def __init__(self, argv):
        super().__init__(argv)
        # Resources now available via :/icons/* paths
```

#### Component 4: Icon Selection and Acquisition

**Icon Requirements**:
- Format: SVG (vector, scalable)
- Size: 24x24px nominal, but scalable
- Style: Simple, monochrome or two-tone
- Color: Dark (black/gray) with `currentColor` support
- License: MIT, Apache 2.0, CC0, or similar

**Recommended Icon Set**: **Tabler Icons** (MIT License)
- Website: https://tabler-icons.io/
- Version: 2.x or 3.x
- Reason: Clean, consistent, modern style
- Quality: Professional, well-maintained
- Availability: Free download, npm package, CDN

**Icon Mapping**:

| Toolbar Button | Freedesktop Name | Tabler Icon Name | File Name |
|----------------|------------------|------------------|-----------|
| Open | `document-open` | `folder-open` | `document-open.svg` |
| Undo | `edit-undo` | `arrow-back-up` | `edit-undo.svg` |
| Redo | `edit-redo` | `arrow-forward-up` | `edit-redo.svg` |
| Search | `edit-find` | `search` | `edit-find.svg` |
| Zoom In | `zoom-in` | `zoom-in` | `zoom-in.svg` |
| Zoom Out | `zoom-out` | `zoom-out` | `zoom-out.svg` |
| Fit View | `zoom-fit-best` | `arrows-maximize` | `zoom-fit-best.svg` |

**Download Process**:
1. Visit https://tabler-icons.io/
2. Search for each icon name
3. Download SVG (right-click → Save As)
4. Rename to freedesktop convention
5. Optimize with `svgo` (optional)
6. Verify `currentColor` usage

#### Component 5: Main Window Integration

**Refactor T02 and T03 Code**:

```python
# Before (T02/T03):
zoom_in_action = QAction(
    QIcon.fromTheme("zoom-in"),  # May fail on systems without theme
    "Zoom In",
    self
)

# After (T04):
from ink.presentation.utils.icon_provider import IconProvider

zoom_in_action = QAction(
    IconProvider.get_icon("zoom-in"),  # Guaranteed to work
    "Zoom In",
    self
)
```

**Changes Required**:
- Add import: `from ink.presentation.utils.icon_provider import IconProvider`
- Replace all `QIcon.fromTheme(name)` with `IconProvider.get_icon(name)`
- Total: ~7 replacements (one per toolbar button)

### 3.3 Implementation Strategy

#### Phase 1: Icon Acquisition and Preparation

**Steps**:
1. Select icon set (Tabler Icons recommended)
2. Download 7 SVG icon files
3. Rename to freedesktop conventions
4. Optimize with `svgo` (remove metadata, simplify paths)
5. Verify `currentColor` usage for theme adaptation
6. Create `resources/icons/README.md` with attribution

**Deliverables**:
- 7 SVG files in `resources/icons/`
- README documenting sources and licenses
- Optimized, minimal SVG files

#### Phase 2: Qt Resource System Setup

**Steps**:
1. Create `resources/resources.qrc` file
2. List all 7 icon files with `prefix="icons"`
3. Compile with `pyside6-rcc` to generate `resources_rc.py`
4. Add compilation to build process (manual for MVP, automated for CI)
5. Import `resources_rc` in application entry point

**Deliverables**:
- `resources.qrc` file
- `resources_rc.py` (generated)
- Build script or documentation for compilation

#### Phase 3: Icon Provider Implementation

**Steps**:
1. Create `src/ink/presentation/utils/` package
2. Implement `IconProvider` class with `get_icon()` method
3. Add icon name mapping dictionary
4. Implement theme-first, fallback-second logic
5. Add logging for debugging
6. Write unit tests for icon loading

**Deliverables**:
- `icon_provider.py` module
- Unit tests for `IconProvider`
- Documentation in docstrings

#### Phase 4: Main Window Refactoring

**Steps**:
1. Update T02 view actions to use `IconProvider`
2. Update T03 file/edit/search actions to use `IconProvider`
3. Import `resources_rc` in main window or app
4. Test on system with and without icon theme
5. Verify all icons display correctly

**Deliverables**:
- Refactored main window code
- Integration tests with icon provider
- Visual verification on multiple systems

### 3.4 File Changes

**New Files**:
1. `/home/joohan/dev/project-ink/ink/resources/icons/*.svg` (7 files)
2. `/home/joohan/dev/project-ink/ink/resources/resources.qrc`
3. `/home/joohan/dev/project-ink/ink/resources/README.md`
4. `/home/joohan/dev/project-ink/ink/src/ink/presentation/resources_rc.py` (generated)
5. `/home/joohan/dev/project-ink/ink/src/ink/presentation/utils/__init__.py`
6. `/home/joohan/dev/project-ink/ink/src/ink/presentation/utils/icon_provider.py`

**Modified Files**:
1. `/home/joohan/dev/project-ink/ink/src/ink/presentation/main_window.py`
   - Import `IconProvider`
   - Import `resources_rc`
   - Replace `QIcon.fromTheme()` calls

---

## 4. Design Decisions

### 4.1 Decision: Icon Set Selection

**Options Considered**:

1. **Tabler Icons** (CHOSEN)
   - Pros: Modern, clean, consistent style, MIT license, actively maintained
   - Cons: None significant
   - Link: https://tabler-icons.io/

2. **Material Icons** (Google)
   - Pros: Industry standard, comprehensive, Apache 2.0
   - Cons: Heavier weight, less minimalist
   - Link: https://fonts.google.com/icons

3. **Feather Icons**
   - Pros: Very minimal, beautiful, MIT license
   - Cons: Limited icon set, less maintained
   - Link: https://feathericons.com/

4. **Heroicons** (Tailwind)
   - Pros: Clean, modern, MIT license
   - Cons: Less comprehensive for technical icons
   - Link: https://heroicons.com/

**Decision**: Tabler Icons for clean, consistent design

**Rationale**:
- Professional appearance
- Complete coverage of needed icons
- MIT license (no restrictions)
- Active development (fixes and updates)
- SVG with `currentColor` support out of the box

### 4.2 Decision: Resource Embedding vs External Files

**Options**:

1. **Qt Resource System (Embedded)** (CHOSEN)
   - Pros: Icons always available, no file path issues, single binary distribution
   - Cons: Increases binary size (~7-10KB), requires build step

2. **External SVG Files**
   - Pros: Easy to update, no build step, smaller binary
   - Cons: File path issues, packaging complexity, missing files on install

**Decision**: Embedded resources via Qt resource system

**Rationale**:
- Guarantees icons always available
- Simplifies deployment (no separate icon files to track)
- Standard Qt pattern for UI resources
- Minimal size overhead (7 SVGs ~7-10KB total)
- Build step acceptable for MVP

### 4.3 Decision: Icon Color Scheme

**Options**:

1. **Monochrome with `currentColor`** (CHOSEN)
   - Pros: Adapts to theme (light/dark mode), flexible
   - Cons: Less colorful

2. **Fixed Dark Color**
   - Pros: Consistent appearance
   - Cons: Doesn't adapt to dark mode

3. **Multi-Color**
   - Pros: Visually distinctive
   - Cons: Clashes with themes, less professional

**Decision**: Monochrome with `currentColor`

**SVG Example**:
```xml
<!-- Good: Adapts to theme -->
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
  <path fill="currentColor" stroke="currentColor" d="M..." />
</svg>

<!-- Bad: Fixed color -->
<svg viewBox="0 0 24 24">
  <path fill="#000000" d="M..." />
</svg>
```

**Rationale**:
- `currentColor` inherits from parent element (Qt theme)
- Works in both light and dark modes
- Professional, subtle appearance
- Standard practice in icon design

### 4.4 Decision: Icon Provider API

**Options**:

1. **Static Methods** (CHOSEN)
   - `IconProvider.get_icon(name)`
   - Pros: Simple, no state, easy to use
   - Cons: Less flexible for future caching

2. **Singleton Instance**
   - `IconProvider.instance().get_icon(name)`
   - Pros: Allows state (caching)
   - Cons: Overkill for simple lookup

3. **Module-Level Functions**
   - `get_icon(name)`
   - Pros: Simplest API
   - Cons: Less discoverable, namespace pollution

**Decision**: Static methods for simplicity

**Rationale**:
- No state needed for MVP (lookup is fast)
- Clean, self-documenting API
- Easy to refactor to singleton later if caching needed

---

## 5. Dependencies and Integration

### 5.1 Upstream Dependencies

**E06-F03-T02: View Control Tools** (MODIFIES)
- Currently uses `QIcon.fromTheme()`
- Will be refactored to use `IconProvider.get_icon()`
- No breaking changes (drop-in replacement)

**E06-F03-T03: File, Edit and Search Tools** (MODIFIES)
- Currently uses `QIcon.fromTheme()`
- Will be refactored to use `IconProvider.get_icon()`
- No breaking changes (drop-in replacement)

### 5.2 External Dependencies

**Build Tools**:
- `pyside6-rcc`: Qt resource compiler (included with PySide6)
- `svgo` (optional): SVG optimization tool

**Icon Sources**:
- Tabler Icons: https://tabler-icons.io/ (download or npm)
- Alternative: Material Icons, Feather Icons

**PySide6 Components**:
- `QIcon`: Icon loading and rendering
- `QFile`: Resource file existence checking
- `qRegisterResourceData`: Resource registration (in generated code)

### 5.3 Integration Points

**With Main Window** (T02/T03):
```python
# Main window imports IconProvider
from ink.presentation.utils.icon_provider import IconProvider

# Main window imports resources (registers with Qt)
from ink.presentation import resources_rc

# Replace icon loading calls
icon = IconProvider.get_icon("zoom-in")  # Instead of QIcon.fromTheme()
```

**With Build Process**:
```bash
# Manual compilation during development
pyside6-rcc resources/resources.qrc -o src/ink/presentation/resources_rc.py

# Future: Automated in pyproject.toml or setup.py
```

---

## 6. Testing Strategy

### 6.1 Unit Tests

**Test File**: `/home/joohan/dev/project-ink/ink/tests/unit/presentation/utils/test_icon_provider.py`

```python
import pytest
from PySide6.QtGui import QIcon
from ink.presentation.utils.icon_provider import IconProvider

# Must import resources to register them
from ink.presentation import resources_rc

class TestIconProvider:
    """Test icon provider utility."""

    def test_get_icon_returns_qicon(self):
        """IconProvider.get_icon() returns QIcon instance."""
        icon = IconProvider.get_icon("document-open")
        assert isinstance(icon, QIcon)

    def test_get_icon_not_null(self):
        """Returned icons are not null (have content)."""
        for name in IconProvider.ICON_MAP.keys():
            icon = IconProvider.get_icon(name)
            assert not icon.isNull(), f"Icon {name} is null"

    def test_get_icon_has_sizes(self):
        """Returned icons have available sizes."""
        for name in IconProvider.ICON_MAP.keys():
            icon = IconProvider.get_icon(name)
            sizes = icon.availableSizes()
            assert len(sizes) > 0, f"Icon {name} has no sizes"

    def test_all_icons_loadable(self):
        """All 7 toolbar icons can be loaded."""
        expected_icons = [
            "document-open",
            "edit-undo",
            "edit-redo",
            "edit-find",
            "zoom-in",
            "zoom-out",
            "zoom-fit-best",
        ]

        for name in expected_icons:
            icon = IconProvider.get_icon(name)
            assert not icon.isNull(), f"Failed to load {name}"

    def test_unknown_icon_returns_null(self):
        """Unknown icon name returns null icon (graceful degradation)."""
        icon = IconProvider.get_icon("nonexistent-icon-name")
        # Should return QIcon instance (not crash)
        assert isinstance(icon, QIcon)
        # May be null (acceptable)

    def test_has_theme_icon(self):
        """has_theme_icon() returns boolean."""
        result = IconProvider.has_theme_icon("document-open")
        assert isinstance(result, bool)

    def test_resource_files_exist(self):
        """All resource files are accessible."""
        from PySide6.QtCore import QFile

        for resource_path in IconProvider.ICON_MAP.values():
            assert QFile.exists(resource_path), f"Resource missing: {resource_path}"
```

### 6.2 Integration Tests

**Test File**: `/home/joohan/dev/project-ink/ink/tests/integration/ui/test_toolbar_icons.py`

```python
import pytest
from PySide6.QtWidgets import QToolBar
from ink.presentation.main_window import InkMainWindow
from ink.presentation import resources_rc

class TestToolbarIconsIntegration:
    """Integration tests for toolbar icons."""

    @pytest.fixture
    def main_window(self, qtbot):
        """Create main window with toolbar."""
        window = InkMainWindow()
        qtbot.addWidget(window)
        return window

    def test_all_toolbar_buttons_have_icons(self, main_window):
        """All toolbar buttons display icons."""
        toolbar = main_window.findChild(QToolBar, "MainToolBar")

        for action in toolbar.actions():
            if not action.isSeparator():
                icon = action.icon()
                assert not icon.isNull(), f"Action '{action.text()}' has no icon"

    def test_icons_have_available_sizes(self, main_window):
        """All icons have available sizes (not empty)."""
        toolbar = main_window.findChild(QToolBar, "MainToolBar")

        for action in toolbar.actions():
            if not action.isSeparator():
                icon = action.icon()
                sizes = icon.availableSizes()
                assert len(sizes) > 0, f"Action '{action.text()}' icon has no sizes"

    def test_icons_render_at_toolbar_size(self, main_window):
        """Icons render at toolbar icon size (24x24)."""
        from PySide6.QtCore import QSize

        toolbar = main_window.findChild(QToolBar, "MainToolBar")
        expected_size = QSize(24, 24)

        for action in toolbar.actions():
            if not action.isSeparator():
                icon = action.icon()
                pixmap = icon.pixmap(expected_size)
                assert not pixmap.isNull()
                # Size should match or scale appropriately

    def test_icons_without_theme(self, main_window, monkeypatch):
        """Icons load from resources when theme unavailable."""
        from PySide6.QtGui import QIcon

        # Mock QIcon.fromTheme to always return null icon
        def mock_from_theme(name):
            return QIcon()  # Null icon

        monkeypatch.setattr(QIcon, "fromTheme", mock_from_theme)

        # Re-create window (icons loaded during initialization)
        from ink.presentation.utils.icon_provider import IconProvider

        # Direct test of icon provider fallback
        icon = IconProvider.get_icon("zoom-in")
        assert not icon.isNull(), "Fallback to resource failed"
```

### 6.3 Visual Testing

**Manual Test Checklist**:

1. **System with Icon Theme** (e.g., Ubuntu with GNOME):
   - Launch application
   - Verify toolbar icons display
   - Check if icons match system theme style
   - Confirm icons are recognizable

2. **System without Icon Theme** (minimal setup):
   - Temporarily rename theme directory or use minimal environment
   - Launch application
   - Verify toolbar icons display (from resources)
   - Confirm icons are consistent and clear

3. **High-DPI Display** (Retina/4K):
   - Launch on high-DPI display
   - Verify icons are crisp (not pixelated)
   - Check at different zoom levels

4. **Dark Mode**:
   - Switch to dark theme
   - Verify icons adapt to dark background
   - Check `currentColor` working

**Expected Results**:
- All buttons have clear, recognizable icons
- Icons scale cleanly at all sizes
- No visual artifacts or blurriness
- Icons adapt to theme colors

---

## 7. Risks and Mitigation

### 7.1 Technical Risks

#### Risk 1: Icon Quality Issues

**Risk**: Downloaded icons don't match expected style or quality

**Impact**: Medium (visual inconsistency, unprofessional appearance)

**Probability**: Low (using curated icon set)

**Mitigation**:
- Use established icon set (Tabler Icons)
- Preview all icons before committing
- Ensure consistent stroke width and style
- Test rendering at toolbar size (24x24)

**Fallback**:
- Try alternative icon from same set
- Use different icon set (Material Icons)
- Commission custom icons if needed

#### Risk 2: Resource Compilation Issues

**Risk**: `pyside6-rcc` fails or produces invalid code

**Impact**: High (application won't run)

**Probability**: Very Low (standard tool, well-tested)

**Mitigation**:
- Test compilation on multiple machines
- Verify generated `resources_rc.py` is valid Python
- Add compilation to CI pipeline
- Document manual compilation steps

**Diagnostic**:
```bash
# Test compilation
pyside6-rcc resources/resources.qrc -o test_output.py
python -c "import test_output"  # Should not error
```

#### Risk 3: Import Timing for Resources

**Risk**: Resources imported too late, icons not registered

**Impact**: High (fallback fails, null icons)

**Probability**: Low (clear import order)

**Mitigation**:
- Import `resources_rc` at application startup
- Add to main window `__init__` or app initialization
- Document import requirement in code comments
- Test with fresh Python environment

**Correct Import Location**:
```python
# Option 1: In main window __init__
from ink.presentation import resources_rc

# Option 2: In application startup
from ink.presentation import resources_rc
app = InkApplication(sys.argv)
```

### 7.2 Licensing Risks

#### Risk 4: Icon License Violation

**Risk**: Icons used without proper license or attribution

**Impact**: High (legal liability, must remove)

**Probability**: Very Low (using MIT/Apache icons)

**Mitigation**:
- Verify license before downloading
- Document license in `resources/icons/README.md`
- Include attribution in about dialog (P1 feature)
- Use only permissive licenses (MIT, Apache, CC0)

**License Checklist**:
- [ ] Icon set license is permissive (MIT/Apache/CC0)
- [ ] Attribution included in README
- [ ] No copyleft requirements (GPL, etc.)
- [ ] Commercial use allowed

### 7.3 Integration Risks

#### Risk 5: Refactoring Breaks Existing Code

**Risk**: Changing T02/T03 icon loading breaks functionality

**Impact**: Medium (toolbar buttons broken)

**Probability**: Low (simple find-replace)

**Mitigation**:
- Test each refactored action individually
- Run full test suite after changes
- Visual verification in running application
- Git branching strategy (revert if issues)

**Refactoring Verification**:
```python
# Before refactoring: Save original code
# After refactoring: Side-by-side comparison

# Original:
icon = QIcon.fromTheme("zoom-in")

# New:
icon = IconProvider.get_icon("zoom-in")

# Verify: Both should produce same result (or better with fallback)
```

---

## 8. Implementation Notes

### 8.1 SVG Optimization

**Why Optimize**:
- Reduce embedded resource size
- Faster loading
- Remove metadata/comments

**Optimization Tool**: `svgo` (SVG Optimizer)

**Installation**:
```bash
npm install -g svgo
# or
pip install scour  # Python alternative
```

**Usage**:
```bash
# Optimize all SVGs in directory
svgo resources/icons/*.svg

# With custom config
svgo --multipass --pretty resources/icons/*.svg
```

**Optimization Checklist**:
- [ ] Remove XML comments
- [ ] Remove metadata tags
- [ ] Simplify paths (merge consecutive commands)
- [ ] Remove unnecessary attributes
- [ ] Keep `viewBox` attribute (critical for scaling)
- [ ] Preserve `currentColor` in fill/stroke

### 8.2 `currentColor` Verification

**Check SVG Files**:
```bash
# Search for fixed colors (should be minimal)
grep -r "fill=\"#" resources/icons/
grep -r "stroke=\"#" resources/icons/

# Should see currentColor instead
grep -r "currentColor" resources/icons/
```

**Manual Fix** (if needed):
```xml
<!-- Change fixed color to currentColor -->
<path fill="#000000" ... />  <!-- Before -->
<path fill="currentColor" ... />  <!-- After -->
```

### 8.3 Build Process Integration

**Manual Compilation** (MVP):
```bash
# Run before each test/deployment
pyside6-rcc resources/resources.qrc -o src/ink/presentation/resources_rc.py
```

**Automated Compilation** (Future):

**Option 1: pyproject.toml** (if using PySide6 tools):
```toml
[tool.pyside6]
qrc-files = ["resources/resources.qrc"]
```

**Option 2: Custom Build Script**:
```python
# build_resources.py
import subprocess
import sys

def compile_resources():
    result = subprocess.run([
        "pyside6-rcc",
        "resources/resources.qrc",
        "-o", "src/ink/presentation/resources_rc.py"
    ])
    sys.exit(result.returncode)

if __name__ == "__main__":
    compile_resources()
```

**Option 3: Makefile**:
```makefile
.PHONY: resources
resources:
	pyside6-rcc resources/resources.qrc -o src/ink/presentation/resources_rc.py

.PHONY: build
build: resources
	# Other build steps...
```

### 8.4 Icon Attribution

**resources/icons/README.md**:
```markdown
# Toolbar Icons

## Source
All icons are from [Tabler Icons](https://tabler-icons.io/) version 3.0.

## License
MIT License - see [Tabler Icons License](https://github.com/tabler/tabler-icons/blob/master/LICENSE)

Copyright (c) 2020-2024 Paweł Kuna

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction...

## Icons Used

| File Name | Original Name | Purpose |
|-----------|---------------|---------|
| `document-open.svg` | `folder-open.svg` | Open file |
| `edit-undo.svg` | `arrow-back-up.svg` | Undo action |
| `edit-redo.svg` | `arrow-forward-up.svg` | Redo action |
| `edit-find.svg` | `search.svg` | Search/find |
| `zoom-in.svg` | `zoom-in.svg` | Zoom in |
| `zoom-out.svg` | `zoom-out.svg` | Zoom out |
| `zoom-fit-best.svg` | `arrows-maximize.svg` | Fit view |

## Modifications
- Renamed to freedesktop.org icon naming conventions
- Optimized with `svgo` to reduce file size
- Verified `currentColor` usage for theme adaptation
```

---

## 9. Acceptance Checklist

### 9.1 Icon Resources

- [ ] 7 SVG icon files downloaded from permissive source
- [ ] Icons renamed to freedesktop conventions
- [ ] Icons optimized with `svgo` (or similar)
- [ ] Icons use `currentColor` for theme adaptation
- [ ] Icons placed in `resources/icons/` directory
- [ ] `resources/icons/README.md` documents sources and licenses

### 9.2 Qt Resource System

- [ ] `resources/resources.qrc` file created
- [ ] All 7 icons listed in `.qrc` file
- [ ] Resource prefix set to `icons`
- [ ] `resources_rc.py` compiled successfully
- [ ] Compiled file is valid Python (no syntax errors)
- [ ] Resources accessible via `:/icons/*` paths

### 9.3 Icon Provider

- [ ] `IconProvider` class implemented
- [ ] `get_icon()` method with theme-first, fallback-second logic
- [ ] Icon name mapping dictionary complete
- [ ] Null checks prevent runtime errors
- [ ] Logging added for debugging
- [ ] Unit tests for `IconProvider` pass

### 9.4 Integration

- [ ] `resources_rc` imported in application
- [ ] T02 code refactored to use `IconProvider`
- [ ] T03 code refactored to use `IconProvider`
- [ ] All toolbar buttons display icons
- [ ] Icons work on systems with and without themes
- [ ] Integration tests pass

### 9.5 Testing

- [ ] Unit tests verify icon loading
- [ ] Integration tests verify toolbar icons
- [ ] Visual testing on system with theme
- [ ] Visual testing on system without theme
- [ ] High-DPI display testing
- [ ] Dark mode testing

### 9.6 Documentation

- [ ] Icon sources documented in README
- [ ] License information included
- [ ] Build process documented
- [ ] Code comments explain resource loading

---

## 10. Next Steps

### 10.1 Immediate Actions

1. **Download Icons**:
   - Select Tabler Icons (or alternative)
   - Download 7 SVG files
   - Rename to freedesktop conventions
   - Place in `resources/icons/`

2. **Create Resource File**:
   - Write `resources/resources.qrc`
   - List all 7 icon files
   - Compile with `pyside6-rcc`

3. **Implement Icon Provider**:
   - Create `utils` package
   - Write `IconProvider` class
   - Add icon mapping
   - Implement fallback logic

4. **Refactor Main Window**:
   - Import `IconProvider` and `resources_rc`
   - Replace `QIcon.fromTheme()` calls
   - Test on multiple systems

5. **Write Tests**:
   - Unit tests for `IconProvider`
   - Integration tests for toolbar icons
   - Manual visual testing

### 10.2 Coordination Points

**Before Starting**:
- [ ] Confirm T02 and T03 are complete
- [ ] Verify icon names used in T02/T03
- [ ] Select icon set and verify license

**During Development**:
- [ ] Test resource compilation early
- [ ] Verify icons on system without theme
- [ ] Coordinate with T02/T03 for refactoring

**After Completion**:
- [ ] Verify all toolbar buttons have icons
- [ ] Update documentation
- [ ] Notify team of `IconProvider` availability for future icons

### 10.3 Follow-Up Items

**Future Enhancements**:
1. Additional icon sizes (16x16 for menus, 32x32 for large toolbars)
2. Custom icon theme support
3. User-configurable icon sets
4. Animated icons for loading states
5. Color icon variants

**Documentation Updates**:
1. Developer guide: Adding new icons
2. Build guide: Resource compilation
3. About dialog: Icon attribution (P1)

---

## Appendix A: Complete Icon Provider Implementation

```python
# src/ink/presentation/utils/icon_provider.py

"""
Icon loading utility with system theme fallback support.

Provides a consistent API for loading toolbar icons, preferring system
icon themes when available and falling back to bundled SVG resources
when themes are not installed.
"""

from typing import Optional
import logging
from PySide6.QtGui import QIcon
from PySide6.QtCore import QFile

logger = logging.getLogger(__name__)


class IconProvider:
    """
    Provides icons with system theme fallback to bundled resources.

    This class implements a two-tier icon loading strategy:
    1. First, attempt to load from system icon theme (freedesktop.org standard)
    2. If theme unavailable, fall back to bundled SVG resources

    All icons are guaranteed to load (either from theme or resource),
    ensuring toolbar buttons always have visual representation.

    Example:
        >>> from ink.presentation.utils.icon_provider import IconProvider
        >>> icon = IconProvider.get_icon("zoom-in")
        >>> action.setIcon(icon)
    """

    # Icon name mapping: freedesktop.org name -> Qt resource path
    ICON_MAP = {
        "document-open": ":/icons/document-open.svg",
        "edit-undo": ":/icons/edit-undo.svg",
        "edit-redo": ":/icons/edit-redo.svg",
        "edit-find": ":/icons/edit-find.svg",
        "zoom-in": ":/icons/zoom-in.svg",
        "zoom-out": ":/icons/zoom-out.svg",
        "zoom-fit-best": ":/icons/zoom-fit-best.svg",
    }

    @staticmethod
    def get_icon(name: str) -> QIcon:
        """
        Get icon by name with automatic theme fallback.

        Attempts to load icon from system theme first (for native look).
        If theme icon is not available, falls back to bundled SVG resource.

        Args:
            name: Icon name following freedesktop.org conventions
                  (e.g., "document-open", "edit-undo", "zoom-in")

        Returns:
            QIcon instance. Will be a valid icon from either theme or
            resource. May return null icon only if both sources fail
            (should not happen with valid icon names).

        Example:
            >>> icon = IconProvider.get_icon("zoom-in")
            >>> assert not icon.isNull()
        """
        # Phase 1: Try system theme (preferred for native appearance)
        icon = QIcon.fromTheme(name)

        # Validate theme icon (fromTheme may return non-null but empty icon)
        if not icon.isNull() and icon.availableSizes():
            logger.debug(f"Loaded icon '{name}' from system theme")
            return icon

        # Phase 2: Fallback to bundled resource
        resource_path = IconProvider.ICON_MAP.get(name)
        if resource_path:
            if QFile.exists(resource_path):
                icon = QIcon(resource_path)
                if not icon.isNull():
                    logger.debug(f"Loaded icon '{name}' from resource {resource_path}")
                    return icon
                else:
                    logger.warning(f"Resource exists but failed to load: {resource_path}")
            else:
                logger.warning(f"Resource file not found: {resource_path}")
        else:
            logger.warning(f"No resource mapping for icon: {name}")

        # Both sources failed - return null icon (should not happen)
        logger.error(f"Icon '{name}' not found in theme or resources")
        return QIcon()

    @staticmethod
    def has_theme_icon(name: str) -> bool:
        """
        Check if system icon theme provides the specified icon.

        Useful for diagnostics and detecting theme availability.

        Args:
            name: Icon name to check

        Returns:
            True if icon available in system theme, False otherwise

        Example:
            >>> if IconProvider.has_theme_icon("zoom-in"):
            ...     print("System theme is available")
        """
        icon = QIcon.fromTheme(name)
        has_icon = not icon.isNull() and len(icon.availableSizes()) > 0
        return has_icon

    @staticmethod
    def get_available_icons() -> list[str]:
        """
        Get list of all available icon names.

        Returns:
            List of icon names that can be loaded via get_icon()

        Example:
            >>> icons = IconProvider.get_available_icons()
            >>> print(f"Available icons: {len(icons)}")
        """
        return list(IconProvider.ICON_MAP.keys())
```

---

## Appendix B: Resource File Template

```xml
<!-- resources/resources.qrc -->
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE RCC>
<RCC version="1.0">
    <qresource prefix="icons">
        <!-- File operations -->
        <file>icons/document-open.svg</file>

        <!-- Edit operations -->
        <file>icons/edit-undo.svg</file>
        <file>icons/edit-redo.svg</file>

        <!-- Search -->
        <file>icons/edit-find.svg</file>

        <!-- View controls -->
        <file>icons/zoom-in.svg</file>
        <file>icons/zoom-out.svg</file>
        <file>icons/zoom-fit-best.svg</file>
    </qresource>
</RCC>
```

---

## Document Revision History

| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-12-26 | 1.0 | Claude Sonnet 4.5 | Initial pre-implementation documentation |

---

**End of Pre-Implementation Documentation**
