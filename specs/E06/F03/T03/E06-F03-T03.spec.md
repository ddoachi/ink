# Spec: E06-F03-T03 - File, Edit and Search Tools

## Metadata
- **ID**: E06-F03-T03
- **Type**: Task
- **Priority**: P0 (MVP)
- **Status**: Draft
- **Parent**: [E06-F03](../E06-F03.spec.md)
- **Created**: 2025-12-26
- **Estimated Hours**: 5
- **Actual Hours**:
- **Effort**: Medium
- **Tags**: [ui, toolbar, file, edit, search, undo-redo]

---

## 1. Overview

### 1.1 Problem Statement

Users need quick access to file operations (Open), edit operations (Undo/Redo), and search functionality. These toolbar buttons must integrate with the application's command system, file dialogs, and search panels. Undo/Redo buttons require dynamic state management based on action history.

### 1.2 Goals

- Add Open File toolbar button with `Ctrl+O` shortcut
- Add Undo toolbar button with `Ctrl+Z` shortcut and dynamic enable/disable
- Add Redo toolbar button with `Ctrl+Shift+Z` shortcut and dynamic enable/disable
- Add Search toolbar button with `Ctrl+F` shortcut
- Integrate with file loading service
- Integrate with undo/redo command system
- Integrate with search panel
- Manage button state based on application state

---

## 2. Technical Requirements

### 2.1 File, Edit, and Search Actions Implementation

**Location**: `src/ink/presentation/main_window.py`

```python
from PySide6.QtGui import QAction, QIcon, QKeySequence
from PySide6.QtWidgets import QToolBar, QFileDialog

class InkMainWindow(QMainWindow):
    def _setup_toolbar(self):
        """Create main toolbar with action buttons."""
        # ... existing toolbar setup from T01 ...

        # File Group
        self._add_file_actions(self._toolbar)
        self._toolbar.addSeparator()

        # Edit Group
        self._add_edit_actions(self._toolbar)
        self._toolbar.addSeparator()

        # View Group (from T02)
        # self._add_view_actions(self._toolbar)
        # self._toolbar.addSeparator()

        # Search Group
        self._add_search_actions(self._toolbar)

    def _add_file_actions(self, toolbar: QToolBar):
        """Add file-related toolbar actions."""
        # Open file button
        open_action = QAction(
            QIcon.fromTheme("document-open"),
            "Open",
            self
        )
        open_action.setToolTip("Open netlist file (Ctrl+O)")
        open_action.setShortcut(QKeySequence.StandardKey.Open)
        open_action.triggered.connect(self._on_open_file)
        toolbar.addAction(open_action)

        # Store reference for potential state management
        self._open_action = open_action

    def _add_edit_actions(self, toolbar: QToolBar):
        """Add edit-related toolbar actions."""
        # Undo button
        self._undo_action = QAction(
            QIcon.fromTheme("edit-undo"),
            "Undo",
            self
        )
        self._undo_action.setToolTip("Undo expansion/collapse (Ctrl+Z)")
        self._undo_action.setShortcut(QKeySequence.StandardKey.Undo)
        self._undo_action.setEnabled(False)  # Initially disabled
        self._undo_action.triggered.connect(self._on_undo)
        toolbar.addAction(self._undo_action)

        # Redo button
        self._redo_action = QAction(
            QIcon.fromTheme("edit-redo"),
            "Redo",
            self
        )
        self._redo_action.setToolTip("Redo expansion/collapse (Ctrl+Shift+Z)")
        self._redo_action.setShortcut(QKeySequence.StandardKey.Redo)
        self._redo_action.setEnabled(False)  # Initially disabled
        self._redo_action.triggered.connect(self._on_redo)
        toolbar.addAction(self._redo_action)

    def _add_search_actions(self, toolbar: QToolBar):
        """Add search-related toolbar actions."""
        # Search button
        search_action = QAction(
            QIcon.fromTheme("edit-find"),
            "Search",
            self
        )
        search_action.setToolTip("Search cells/nets/pins (Ctrl+F)")
        search_action.setShortcut(QKeySequence.StandardKey.Find)
        search_action.triggered.connect(self._on_find)
        toolbar.addAction(search_action)

        # Store reference for potential state management
        self._search_action = search_action

    # Action Handlers
    def _on_open_file(self):
        """Handle open file action."""
        file_path, _ = QFileDialog.getOpenFileName(
            self,
            "Open Netlist File",
            "",
            "CDL Files (*.ckt *.cdl);;All Files (*)"
        )
        if file_path:
            # Integrate with file service (from E01)
            if hasattr(self, '_file_service'):
                self._file_service.load_design(file_path)

    def _on_undo(self):
        """Handle undo action."""
        if hasattr(self, '_expansion_service'):
            self._expansion_service.undo()
            self._update_undo_redo_state()

    def _on_redo(self):
        """Handle redo action."""
        if hasattr(self, '_expansion_service'):
            self._expansion_service.redo()
            self._update_undo_redo_state()

    def _on_find(self):
        """Handle search action."""
        # Toggle search panel visibility or focus search input
        if hasattr(self, '_search_panel'):
            if self._search_panel.isVisible():
                self._search_panel.focus_search_input()
            else:
                self._search_panel.show()
                self._search_panel.focus_search_input()

    def _update_undo_redo_state(self):
        """Update undo/redo button enabled state based on history."""
        if hasattr(self, '_expansion_service'):
            can_undo = self._expansion_service.can_undo()
            can_redo = self._expansion_service.can_redo()

            self._undo_action.setEnabled(can_undo)
            self._redo_action.setEnabled(can_redo)
```

### 2.2 State Management Integration

Undo/Redo buttons must dynamically update based on expansion history:

```python
# Connect to expansion service signals (if using Qt signals)
class InkMainWindow(QMainWindow):
    def _connect_signals(self):
        """Connect service signals to UI updates."""
        if hasattr(self, '_expansion_service'):
            # Assuming expansion service emits signals on state change
            self._expansion_service.history_changed.connect(
                self._update_undo_redo_state
            )
```

Alternatively, update state after each expansion/collapse operation.

### 2.3 Button Specifications

| Button | Icon Theme | Tooltip | Shortcut | Initial State |
|--------|-----------|---------|----------|---------------|
| Open | `document-open` | "Open netlist file (Ctrl+O)" | `Ctrl+O` | Enabled |
| Undo | `edit-undo` | "Undo expansion/collapse (Ctrl+Z)" | `Ctrl+Z` | Disabled |
| Redo | `edit-redo` | "Redo expansion/collapse (Ctrl+Shift+Z)" | `Ctrl+Shift+Z` | Disabled |
| Search | `edit-find` | "Search cells/nets/pins (Ctrl+F)" | `Ctrl+F` | Enabled |

### 2.4 Service Integration Points

**File Service** (from E01):
```python
# Expected interface
class FileService:
    def load_design(self, file_path: str) -> None:
        """Load design from CDL file."""
```

**Expansion Service** (from E04):
```python
# Expected interface
class ExpansionService:
    def undo(self) -> None:
        """Undo last expansion/collapse."""

    def redo(self) -> None:
        """Redo last undone expansion/collapse."""

    def can_undo(self) -> bool:
        """Check if undo is available."""

    def can_redo(self) -> bool:
        """Check if redo is available."""
```

**Search Panel** (from E05):
```python
# Expected interface
class SearchPanel(QDockWidget):
    def focus_search_input(self) -> None:
        """Focus search input field."""
```

---

## 3. Dependencies

### 3.1 Upstream Dependencies
- **E06-F03-T01**: Toolbar Setup (provides toolbar infrastructure)
- **E01**: File Loading (provides file service)
- **E04**: Interaction (provides expansion service with undo/redo)
- **E05**: Search (provides search panel)

### 3.2 Downstream Dependencies
- **E06-F03-T04**: Icon Resources (provides fallback icons)

### 3.3 External Dependencies
- PySide6: `QAction`, `QIcon`, `QKeySequence`, `QFileDialog`
- Icon theme: `document-open`, `edit-undo`, `edit-redo`, `edit-find`

---

## 4. Acceptance Criteria

- [ ] Open button appears in toolbar with open-file icon
- [ ] Undo button appears in toolbar with undo icon
- [ ] Redo button appears in toolbar with redo icon
- [ ] Search button appears in toolbar with search icon
- [ ] Undo button initially disabled
- [ ] Redo button initially disabled
- [ ] Open button always enabled
- [ ] Search button always enabled
- [ ] Tooltips display on hover with action name and shortcut
- [ ] `Ctrl+O` opens file dialog
- [ ] `Ctrl+Z` triggers undo when available
- [ ] `Ctrl+Shift+Z` triggers redo when available
- [ ] `Ctrl+F` shows/focuses search panel
- [ ] Clicking Open button shows file dialog
- [ ] File dialog filters for `.ckt` and `.cdl` files
- [ ] Selecting file in dialog loads design
- [ ] Clicking Undo button undoes last expansion/collapse
- [ ] Clicking Redo button redoes last undone action
- [ ] Undo button enables after first expansion/collapse
- [ ] Undo button disables when history empty
- [ ] Redo button enables after undo
- [ ] Redo button disables when no redo available
- [ ] Clicking Search button shows search panel
- [ ] Clicking Search button focuses search input if panel already visible

---

## 5. Testing Strategy

### 5.1 Unit Tests

**Test file**: `tests/unit/presentation/test_main_window.py`

```python
def test_file_edit_search_actions_created(main_window):
    """Test file, edit, and search actions are added to toolbar."""
    toolbar = main_window.findChild(QToolBar, "MainToolBar")
    actions = toolbar.actions()

    open_action = next((a for a in actions if a.text() == "Open"), None)
    undo_action = next((a for a in actions if a.text() == "Undo"), None)
    redo_action = next((a for a in actions if a.text() == "Redo"), None)
    search_action = next((a for a in actions if a.text() == "Search"), None)

    assert open_action is not None
    assert undo_action is not None
    assert redo_action is not None
    assert search_action is not None

def test_undo_redo_initial_state(main_window):
    """Test undo/redo buttons are initially disabled."""
    assert not main_window._undo_action.isEnabled()
    assert not main_window._redo_action.isEnabled()

def test_open_action_enabled(main_window):
    """Test open button is always enabled."""
    assert main_window._open_action.isEnabled()

def test_search_action_enabled(main_window):
    """Test search button is always enabled."""
    assert main_window._search_action.isEnabled()

def test_undo_action_triggered(main_window, mock_expansion_service):
    """Test undo action calls expansion service."""
    main_window._expansion_service = mock_expansion_service
    mock_expansion_service.can_undo.return_value = True
    main_window._undo_action.setEnabled(True)

    main_window._undo_action.trigger()
    mock_expansion_service.undo.assert_called_once()

def test_update_undo_redo_state(main_window, mock_expansion_service):
    """Test undo/redo buttons update based on service state."""
    main_window._expansion_service = mock_expansion_service

    # Undo available, redo not available
    mock_expansion_service.can_undo.return_value = True
    mock_expansion_service.can_redo.return_value = False
    main_window._update_undo_redo_state()

    assert main_window._undo_action.isEnabled()
    assert not main_window._redo_action.isEnabled()

    # Redo available, undo not available
    mock_expansion_service.can_undo.return_value = False
    mock_expansion_service.can_redo.return_value = True
    main_window._update_undo_redo_state()

    assert not main_window._undo_action.isEnabled()
    assert main_window._redo_action.isEnabled()
```

### 5.2 Integration Tests

**Test file**: `tests/integration/ui/test_toolbar_edit_actions.py`

```python
def test_open_file_dialog(qtbot, main_window, monkeypatch):
    """Test open button shows file dialog."""
    dialog_shown = False

    def mock_get_open_filename(*args, **kwargs):
        nonlocal dialog_shown
        dialog_shown = True
        return ("", "")  # Cancelled

    monkeypatch.setattr(QFileDialog, "getOpenFileName", mock_get_open_filename)

    # Trigger open action
    main_window._open_action.trigger()

    assert dialog_shown

def test_undo_redo_integration(app, main_window, expansion_service):
    """Test undo/redo buttons work with expansion service."""
    main_window._expansion_service = expansion_service

    # Perform expansion
    expansion_service.expand_cell("cell1")
    main_window._update_undo_redo_state()

    assert main_window._undo_action.isEnabled()
    assert not main_window._redo_action.isEnabled()

    # Undo
    main_window._undo_action.trigger()
    main_window._update_undo_redo_state()

    assert not main_window._undo_action.isEnabled()
    assert main_window._redo_action.isEnabled()

def test_search_panel_toggle(app, main_window, search_panel):
    """Test search button shows and focuses search panel."""
    main_window._search_panel = search_panel
    search_panel.hide()

    # First click shows panel
    main_window._search_action.trigger()
    assert search_panel.isVisible()

    # Second click focuses input
    main_window._search_action.trigger()
    # Verify focus on search input
```

### 5.3 Manual Testing

1. Launch application
2. Click Open button → verify file dialog appears
3. Select `.ckt` file → verify design loads
4. Verify Undo/Redo buttons are disabled
5. Perform expansion → verify Undo button enables
6. Click Undo → verify Redo button enables
7. Click Redo → verify expansion restored
8. Click Search → verify search panel appears
9. Click Search again → verify search input focused
10. Test keyboard shortcuts: `Ctrl+O`, `Ctrl+Z`, `Ctrl+Shift+Z`, `Ctrl+F`

---

## 6. Implementation Notes

### 6.1 Graceful Degradation

If services not yet implemented:
- Open button shows file dialog but doesn't load file
- Undo/Redo buttons remain disabled
- Search button does nothing (or shows placeholder message)

### 6.2 State Update Timing

Undo/Redo state should update:
1. After every expansion/collapse operation
2. After undo/redo operation completes
3. When design loaded (reset to disabled)
4. Via signal/slot connection if expansion service emits events

### 6.3 File Dialog Configuration

- **Title**: "Open Netlist File"
- **Filter**: "CDL Files (*.ckt *.cdl);;All Files (*)"
- **Default directory**: Last opened directory (persist via `QSettings`)
- **Multi-select**: Disabled (single file only for MVP)

### 6.4 Future Enhancements

- Recent files menu integration
- Undo/redo history list (dropdown menu)
- Search history dropdown
- Save/Save As toolbar buttons
- Export toolbar button

---

## Revision History

| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-12-26 | 0.1 | Claude | Initial task spec creation from E06-F03 split |
