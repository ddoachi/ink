# E06-F05-T02: Panel Layout Persistence - Post-Implementation Documentation

## Quick Reference

| Aspect | Details |
|--------|---------|
| **Spec ID** | E06-F05-T02 |
| **Title** | Panel Layout Persistence |
| **Status** | Completed |
| **TDD Approach** | 48 tests (36 unit for store + 12 unit for integration) |
| **Key Deliverables** | `PanelSettingsStore`, MainWindow integration, persistence round-trip |

## 1. What Was Built

### Core Components

1. **Panel Settings Store** (`src/ink/infrastructure/persistence/panel_settings_store.py`)
   - `PanelSettingsStore`: QSettings-based persistence for panel layout
   - `save_panel_state(state)`: Saves complete PanelState including Qt blobs
   - `load_panel_state()`: Reconstructs PanelState from saved settings
   - `has_saved_settings()`: Checks for existing panel state
   - `clear_panel_state()`: Resets to defaults

2. **MainWindow Integration** (`src/ink/presentation/main_window.py`)
   - Added `panel_settings_store` attribute
   - Added `_restore_panel_layout()` method for startup restoration
   - Added `_save_panel_layout()` method called from `closeEvent()`
   - Added public `reset_panel_layout()` method

3. **PanelStateManager Fix** (`src/ink/presentation/state/panel_state_manager.py`)
   - Added type validation in `restore_state()` for corrupted settings handling

## 2. Architecture Decisions

### Storage Structure
```
QSettings (geometry/panels groups)
├── geometry/
│   ├── window         # QByteArray from saveGeometry()
│   └── state          # QByteArray from saveState()
└── panels/
    ├── Hierarchy/
    │   ├── visible    # bool
    │   ├── area       # string (enum name)
    │   ├── is_floating # bool
    │   ├── geometry   # dict {width, height, x, y}
    │   └── tab_group  # optional string
    ├── Properties/
    │   └── ...
    └── Messages/
        └── ...
```

**Why This Structure?**
- Hierarchical QSettings groups for organized storage
- Qt blobs preserved for accurate complex layout restoration
- Structured panel metadata for queryability and migration support
- Enum names as strings for human-readable INI files

### Data Flow
```
┌─────────────┐     closeEvent()     ┌───────────────────┐
│ Application │ ─────────────────────▶ │ PanelStateManager │
│   Exit      │                       │ capture_state()   │
└─────────────┘                       └─────────┬─────────┘
                                                │
                                                ▼
┌─────────────┐     load_panel_state() ┌───────────────────┐
│ Application │ ◀───────────────────── │ PanelSettingsStore│
│   Start     │                        │ save_panel_state()│
└─────────────┘                        └───────────────────┘
                                                │
                                                ▼
                                       ┌───────────────────┐
                                       │    QSettings      │
                                       │   (persistent)    │
                                       └───────────────────┘
```

## 3. Key Implementation Details

### Graceful Error Handling
The implementation handles various error conditions:

1. **Missing Settings (First Run)**: Returns `None` from `load_panel_state()`, window uses default layout.

2. **Invalid Area Names**: Falls back to `DockArea.LEFT` if enum parsing fails.

3. **Missing Geometry Fields**: Uses zero defaults for missing width/height/x/y.

4. **Corrupted Type Data**: `restore_state()` validates `isinstance(qt_geometry, QByteArray)` before calling Qt methods.

5. **Incomplete Panel Data**: Panels without `visible` key are skipped during load.

### Type Safety with QSettings
QSettings.value() returns `object` type, requiring careful handling:

```python
# QSettings doesn't support dict type parameter
geometry_value = self.settings.value("geometry", {})
geometry_dict = geometry_value if isinstance(geometry_value, dict) else {}

# Explicit casting for primitive types (mypy compatibility)
visible = bool(self.settings.value("visible", True, type=bool))
```

## 4. Testing Strategy

### Unit Tests - PanelSettingsStore (36 tests)
- Initialization and attribute tests
- Save/load round-trip verification
- Individual panel info serialization
- Error handling for corrupted settings
- Clear functionality

### Unit Tests - MainWindow Integration (12 tests)
- `panel_settings_store` attribute existence
- `closeEvent()` saves panel state
- Panel visibility restoration
- `reset_panel_layout()` functionality
- PanelStateManager integration

## 5. Files Changed

| File | Change Type | Description |
|------|-------------|-------------|
| `src/ink/infrastructure/persistence/__init__.py` | Modified | Export `PanelSettingsStore` |
| `src/ink/infrastructure/persistence/panel_settings_store.py` | Added | Panel settings store implementation |
| `src/ink/presentation/main_window.py` | Modified | Integration with panel persistence |
| `src/ink/presentation/state/panel_state_manager.py` | Modified | Type validation in restore_state() |
| `pyproject.toml` | Modified | Added ANN001 to test ignores |
| `tests/unit/infrastructure/persistence/test_panel_settings_store.py` | Added | Store tests |
| `tests/unit/presentation/test_main_window_panel_persistence.py` | Added | Integration tests |

## 6. Usage Examples

### Automatic Persistence (Built-in)
Panel layout is automatically saved on window close and restored on next startup:

```python
# In main.py - persistence happens automatically
window = InkMainWindow(app_settings)
window.show()
# ... user modifies panel layout ...
# On close: layout is saved
# On next start: layout is restored
```

### Manual Reset
```python
# Reset panel layout to defaults
window.reset_panel_layout()
# Restart required for new layout to take effect
```

### Checking for Saved State
```python
store = PanelSettingsStore()
if store.has_saved_settings():
    print("Saved panel layout exists")
else:
    print("No saved layout - using defaults")
```

## 7. Gotchas and Lessons Learned

1. **QSettings Type Limitations**: Cannot use `type=dict` parameter - must load without type hint and validate manually.

2. **Key Collision with AppSettings**: Both `AppSettings` and `PanelSettingsStore` use `geometry/window` key. Type validation in `restore_state()` prevents crashes when types mismatch.

3. **Visibility in Hidden Windows**: `isVisible()` returns `False` for widgets in hidden windows. Tests must `show()` and `waitExposed()` window before checking visibility.

4. **Settings Sync**: Always call `sync()` after save/clear operations to ensure disk write before potential crash.

## 8. Relationship with Other Tasks

### Dependencies
- **E06-F05-T01**: Provides `PanelStateManager`, `PanelState`, and related data structures used for state capture/restore.

### Enabled Features
- **E06-F05-T03**: Settings migration - can use versioned schema with clear_panel_state() fallback.
- **View Menu**: Panel toggles now persist across sessions.
- **Settings Reset**: `reset_panel_layout()` method available for Help > Settings > Reset Panel Layout.
