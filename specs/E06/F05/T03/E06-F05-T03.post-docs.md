# E06-F05-T03: Panel Toggle Actions - Post-Implementation Documentation

## Quick Reference

| Aspect | Details |
|--------|---------|
| **Spec ID** | E06-F05-T03 |
| **Title** | Panel Toggle Actions |
| **Status** | Completed |
| **TDD Approach** | 31 tests (RED first, then GREEN) |
| **Key Deliverables** | View menu Panels submenu, toggle actions, keyboard shortcuts |

## 1. What Was Built

### Core Components

1. **Panels Submenu** (`View > Panels`)
   - Submenu with mnemonic `&Panels` for Alt+P keyboard access
   - Contains toggle actions for each panel
   - Separator before Reset Panel Layout action

2. **Toggle Actions** (using Qt's `toggleViewAction()`)
   - `hierarchy_toggle_action`: Toggle Hierarchy panel
   - `property_toggle_action`: Toggle Properties panel
   - `message_toggle_action`: Toggle Messages panel
   - `reset_panel_layout_action`: Restore default layout

3. **Keyboard Shortcuts**
   - `Ctrl+Shift+H`: Toggle Hierarchy panel
   - `Ctrl+Shift+P`: Toggle Properties panel
   - `Ctrl+Shift+M`: Toggle Messages panel
   - `Ctrl+Shift+R`: Reset panel layout

4. **Additional Behaviors**
   - Tooltips and status tips for all actions
   - Panel raise behavior when toggled visible
   - Automatic checkmark sync with panel visibility

## 2. Architecture Decisions

### Using Qt's toggleViewAction()

```
┌─────────────────────────────────────────────────────────────┐
│                  Qt's toggleViewAction()                     │
├─────────────────────────────────────────────────────────────┤
│  Automatic Features:                                         │
│  - Checkable action (shows checkmark when panel visible)     │
│  - Bidirectional sync (menu ↔ panel visibility)              │
│  - Action text matches dock widget window title              │
│  - No manual signal handling needed                          │
│                                                              │
│  What We Add:                                                │
│  - Keyboard shortcuts (setShortcut)                          │
│  - Tooltips (setToolTip)                                     │
│  - Status tips (setStatusTip)                                │
│  - Panel raise behavior (triggered signal handler)           │
└─────────────────────────────────────────────────────────────┘
```

**Why toggleViewAction()?**
- Qt provides built-in state synchronization
- Less code, fewer bugs from manual state management
- Standard Qt pattern used by many applications
- Action text automatically matches dock widget title

### Keyboard Shortcut Design

```
Ctrl+Shift+<Key> Pattern
    │     │    │
    │     │    └── First letter of panel name (H, P, M, R)
    │     └─────── Shift to avoid conflicts with standard shortcuts
    └───────────── Ctrl for modifier consistency
```

**Why Ctrl+Shift instead of Ctrl alone?**
- Ctrl alone reserved for standard actions (Save, Open, Quit)
- Ctrl+Shift is common for window/panel management
- Reduces risk of conflicts with future features

## 3. Key Implementation Details

### Method Structure

```python
def _create_view_menu(self) -> None:
    """Entry point - creates Panels submenu"""
    self.panels_menu = self.view_menu.addMenu("&Panels")
    self._setup_panel_toggle_actions()  # Add toggle actions
    self.panels_menu.addSeparator()     # Visual grouping
    self._setup_reset_panel_layout_action()

def _setup_panel_toggle_actions(self) -> None:
    """Configure toggle actions from dock widgets"""
    # Get action from dock widget, add shortcut/tooltip, add to menu
    self.hierarchy_toggle_action = self.hierarchy_dock.toggleViewAction()
    self.hierarchy_toggle_action.setShortcut("Ctrl+Shift+H")
    # ... tooltips, status tips
    self.panels_menu.addAction(self.hierarchy_toggle_action)

    # Connect raise behavior
    self._connect_panel_raise_behavior()

def _connect_panel_raise_behavior(self) -> None:
    """Raise panel to front when toggled visible"""
    def make_raise_handler(dock: QDockWidget) -> Callable[[bool], None]:
        def handler(checked: bool) -> None:
            if checked:
                dock.raise_()
        return handler

    self.hierarchy_toggle_action.triggered.connect(
        make_raise_handler(self.hierarchy_dock)
    )
```

### Reset Panel Layout

```python
def _reset_panel_layout(self) -> None:
    """Restore default dock configuration"""
    # For each dock:
    # 1. setFloating(False) - undock if floating
    # 2. addDockWidget(area, dock) - move to default area
    # 3. show() - ensure visible
```

## 4. Testing Strategy

### TDD Approach

1. **RED Phase**: Wrote 31 failing tests first
2. **GREEN Phase**: Implemented code to pass tests
3. **REFACTOR Phase**: Fixed lint/type issues

### Test Categories

| Category | Tests | Description |
|----------|-------|-------------|
| Panels Submenu | 3 | Submenu exists and accessible |
| Toggle Actions | 8 | Actions exist and are checkable |
| Menu Structure | 2 | Actions in menu with separator |
| Keyboard Shortcuts | 4 | Correct shortcuts assigned |
| Tooltips/Status Tips | 6 | Descriptive text configured |
| Action Behavior | 5 | Toggle, sync, visibility |
| Raise Behavior | 1 | Panel raised when shown |
| Integration | 2 | Works with PanelStateManager |

### Key Testing Insight

```python
# Qt widgets only return True for isVisible() when parent window is shown
def test_action_checked_when_panel_visible(self, main_window, qtbot):
    # MUST show window first for visibility to work
    main_window.show()
    qtbot.waitExposed(main_window)

    assert main_window.hierarchy_dock.isVisible()
    assert main_window.hierarchy_toggle_action.isChecked()
```

## 5. Files Changed

| File | Change Type | Description |
|------|-------------|-------------|
| `src/ink/presentation/main_window.py` | Modified | Added panel toggle actions |
| `tests/unit/presentation/test_panel_toggle_actions.py` | Added | 31 TDD tests |

### Lines of Code

- Implementation: ~140 lines added to `main_window.py`
- Tests: ~620 lines in `test_panel_toggle_actions.py`

## 6. Usage Examples

### Toggle Panel via Menu

```python
# User clicks View > Panels > Hierarchy
# Qt automatically:
# 1. Toggles dock visibility
# 2. Updates action checkmark
# 3. Triggers our raise handler (if showing)
```

### Toggle Panel via Keyboard

```python
# User presses Ctrl+Shift+H
# Same behavior as menu click
```

### Programmatic Toggle

```python
# Toggle via action
window.hierarchy_toggle_action.trigger()

# Or via panel state manager
window.panel_state_manager.toggle_panel("Hierarchy")
```

### Reset Layout

```python
# Via menu or Ctrl+Shift+R
window.reset_panel_layout_action.trigger()

# Restores: Hierarchy=Left, Properties=Right, Messages=Bottom
```

## 7. Gotchas and Lessons Learned

1. **toggleViewAction() Timing**: Must be called after dock widgets are created. Menu setup happens after dock setup in `__init__`.

2. **Qt Visibility in Tests**: `isVisible()` returns False if parent window isn't shown. Tests must call `window.show()` and `waitExposed()`.

3. **Lambda Closures**: When connecting signals with lambdas, use factory pattern to capture dock widget reference correctly:
   ```python
   # CORRECT: Factory captures dock by value
   def make_handler(dock):
       def handler(checked): dock.raise_()
       return handler

   # WRONG: Lambda captures dock by reference (last value)
   action.triggered.connect(lambda: dock.raise_())
   ```

4. **Type Hints for Nested Functions**: Must import `Callable` in `TYPE_CHECKING` block and annotate return type:
   ```python
   def make_raise_handler(dock: QDockWidget) -> Callable[[bool], None]:
   ```

## 8. Integration with Related Tasks

### Builds On

- **E06-F05-T01** (Panel State Management): Uses `panel_state_manager` for visibility tracking
- **E06-F02-T01** (Menu Bar Setup): Adds to existing View menu

### Enables

- **E06-F05-T04** (Default Layout Reset): `_reset_panel_layout()` can be reused
- Future toolbar panel buttons could reuse these actions

### Signal Flow

```
User Action (Menu/Keyboard)
         │
         ▼
toggleViewAction triggered
         │
         ▼
QDockWidget visibility changes
         │
         ▼
PanelStateManager receives visibilityChanged signal
         │
         ▼
manager.state.panels[name].visible updated
         │
         ▼
manager.panel_visibility_changed emitted
```
