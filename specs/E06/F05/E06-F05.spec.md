# Spec: E06-F05 - Panel Management

## Metadata
- **ID**: E06-F05
- **Type**: Feature
- **Priority**: P0 (MVP)
- **Status**: Draft
- **Parent**: [E06](../E06.spec.md)
- **Created**: 2025-12-26
- **Estimated Hours**:
- **Actual Hours**:
- **Effort**:
- **Tags**: []

---

## 1. Overview

### 1.1 Problem Statement

Users have varying workspace preferences and screen sizes, requiring customizable panel layouts. Panels must be dockable, floatable, resizable, and toggleable to accommodate different workflows. Panel state (visibility, size, position) must persist across sessions to maintain user preferences.

### 1.2 Goals

- Enable panel docking to left, right, and bottom areas
- Support floating panels as separate windows
- Allow panel tabbing (multiple panels in same area)
- Persist panel layout across application sessions
- Provide panel visibility toggles via View menu
- Enable panel resizing via splitter handles

---

## 2. User Stories

### US-E06-05: Panel Docking
**As a** circuit designer
**I want to** rearrange panels
**So that** I can customize my workspace

**Acceptance Criteria:**
- [ ] Panels can be docked left, right, bottom
- [ ] Panels can be floated as separate windows
- [ ] Panels can be tabbed together
- [ ] Layout persists across sessions

---

## 3. Technical Requirements

### 3.1 Dock Widget Configuration

```python
# src/ink/presentation/main_window.py (extension)

from PySide6.QtWidgets import QDockWidget
from PySide6.QtCore import Qt

class InkMainWindow(QMainWindow):
    def _setup_dock_widgets(self):
        """Create and configure all dockable panels."""
        # Hierarchy Panel (Left)
        self.hierarchy_dock = self._create_dock_widget(
            "Hierarchy",
            Qt.DockWidgetArea.LeftDockWidgetArea,
            allowed_areas=(
                Qt.DockWidgetArea.LeftDockWidgetArea |
                Qt.DockWidgetArea.RightDockWidgetArea
            )
        )
        self.hierarchy_panel = HierarchyPanel(self)
        self.hierarchy_dock.setWidget(self.hierarchy_panel)
        self.addDockWidget(Qt.DockWidgetArea.LeftDockWidgetArea, self.hierarchy_dock)

        # Property Panel (Right)
        self.property_dock = self._create_dock_widget(
            "Properties",
            Qt.DockWidgetArea.RightDockWidgetArea,
            allowed_areas=(
                Qt.DockWidgetArea.LeftDockWidgetArea |
                Qt.DockWidgetArea.RightDockWidgetArea
            )
        )
        self.property_panel = PropertyPanel(self)
        self.property_dock.setWidget(self.property_panel)
        self.addDockWidget(Qt.DockWidgetArea.RightDockWidgetArea, self.property_dock)

        # Message Panel (Bottom)
        self.message_dock = self._create_dock_widget(
            "Messages",
            Qt.DockWidgetArea.BottomDockWidgetArea,
            allowed_areas=Qt.DockWidgetArea.BottomDockWidgetArea
        )
        self.message_panel = MessagePanel(self)
        self.message_dock.setWidget(self.message_panel)
        self.addDockWidget(Qt.DockWidgetArea.BottomDockWidgetArea, self.message_dock)

        # Set initial sizes
        self._set_initial_dock_sizes()

    def _create_dock_widget(
        self,
        title: str,
        default_area: Qt.DockWidgetArea,
        allowed_areas: Qt.DockWidgetArea
    ) -> QDockWidget:
        """Create a configured dock widget."""
        dock = QDockWidget(title, self)
        dock.setObjectName(f"{title.replace(' ', '')}Dock")  # For persistence
        dock.setAllowedAreas(allowed_areas)

        # Enable all dock features
        dock.setFeatures(
            QDockWidget.DockWidgetFeature.DockWidgetClosable |
            QDockWidget.DockWidgetFeature.DockWidgetMovable |
            QDockWidget.DockWidgetFeature.DockWidgetFloatable
        )

        return dock

    def _set_initial_dock_sizes(self):
        """Set default panel sizes."""
        # Get window geometry
        width = self.width()
        height = self.height()

        # Hierarchy panel: 15% of width
        self.resizeDocks(
            [self.hierarchy_dock],
            [int(width * 0.15)],
            Qt.Orientation.Horizontal
        )

        # Property panel: 25% of width
        self.resizeDocks(
            [self.property_dock],
            [int(width * 0.25)],
            Qt.Orientation.Horizontal
        )

        # Message panel: 20% of height
        self.resizeDocks(
            [self.message_dock],
            [int(height * 0.20)],
            Qt.Orientation.Vertical
        )
```

### 3.2 Panel Features

| Feature | Hierarchy Panel | Property Panel | Message Panel |
|---------|----------------|----------------|---------------|
| Closable | Yes | Yes | Yes |
| Movable | Yes | Yes | Yes |
| Floatable | Yes | Yes | Yes |
| Allowed Areas | Left, Right | Left, Right | Bottom only |
| Default Area | Left | Right | Bottom |
| Initial Size | 15% width | 25% width | 20% height |

### 3.3 Panel Tabbing

```python
# Panels can be tabbed together by Qt automatically when dragged
# Example: User drags Property panel to Hierarchy area -> tabs created

# To programmatically tab panels:
def _tab_panels(self, dock1: QDockWidget, dock2: QDockWidget):
    """Tab two dock widgets together."""
    self.tabifyDockWidget(dock1, dock2)
    dock1.raise_()  # Bring to front
```

### 3.4 Panel Visibility Management

```python
# Toggle visibility via View menu (already implemented in E06-F02)
# QDockWidget.toggleViewAction() provides built-in toggle action

# Programmatic visibility control:
def show_hierarchy_panel(self):
    """Show hierarchy panel."""
    self.hierarchy_dock.show()
    self.hierarchy_dock.raise_()

def hide_hierarchy_panel(self):
    """Hide hierarchy panel."""
    self.hierarchy_dock.hide()

def toggle_hierarchy_panel(self):
    """Toggle hierarchy panel visibility."""
    if self.hierarchy_dock.isVisible():
        self.hierarchy_dock.hide()
    else:
        self.hierarchy_dock.show()
        self.hierarchy_dock.raise_()
```

### 3.5 State Persistence

Panel state (geometry, visibility, docking positions) persisted via E06-F06 (Settings Persistence):

```python
def save_panel_state(self):
    """Save current panel layout to QSettings."""
    settings = QSettings()
    settings.setValue("geometry/window", self.saveGeometry())
    settings.setValue("geometry/state", self.saveState())

def restore_panel_state(self):
    """Restore panel layout from QSettings."""
    settings = QSettings()
    geometry = settings.value("geometry/window")
    state = settings.value("geometry/state")

    if geometry:
        self.restoreGeometry(geometry)
    if state:
        self.restoreState(state)
```

### 3.6 Panel Resize Constraints

```python
# Set minimum sizes to prevent panels from becoming unusable
def _set_panel_constraints(self):
    """Set minimum sizes for panels."""
    self.hierarchy_panel.setMinimumWidth(150)
    self.property_panel.setMinimumWidth(200)
    self.message_panel.setMinimumHeight(100)
```

---

## 4. Dependencies

- **Upstream**:
  - E06-F01 (Main Window Shell - dock widget host)
  - E06-F06 (Settings Persistence - panel state storage)
- **Downstream**:
  - E04-F02 (Hierarchy Panel - hierarchy panel content)
  - E04-F03 (Property Panel - property panel content)
  - E05-F02 (Search Panel - message panel integration)
- **External**: PySide6 (`QDockWidget`, `QMainWindow` docking API)

---

## 5. Acceptance Criteria

- [ ] All three panels (hierarchy, properties, messages) are dockable widgets
- [ ] Panels can be dragged to different dock areas
- [ ] Panels can be undocked to float as separate windows
- [ ] Floating panels can be re-docked by dragging to dock areas
- [ ] Panels can be tabbed together when dragged to same area
- [ ] Tabbed panels show tab bar with panel titles
- [ ] Panel visibility toggles work from View menu
- [ ] Panel close button (X) hides panel, doesn't destroy it
- [ ] Splitters between panels are draggable
- [ ] Panel sizes persist across application restarts
- [ ] Panel visibility states persist across restarts
- [ ] Docked/floating state persists across restarts
- [ ] Minimum panel sizes prevent unusable layouts
- [ ] Double-clicking panel title bar toggles float/dock

---

## 6. Child Specs

| ID | Task | Status |
|----|------|--------|
| [E06-F05-T01](T01/E06-F05-T01.spec.md) | Panel State Management | Draft |
| [E06-F05-T02](T02/E06-F05-T02.spec.md) | Panel Layout Persistence | Draft |
| [E06-F05-T03](T03/E06-F05-T03.spec.md) | Panel Toggle Actions | Draft |
| [E06-F05-T04](T04/E06-F05-T04.spec.md) | Default Layout Reset | Draft |

---

## Revision History

| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-12-26 | 0.1 | Claude | Initial feature creation from E06 split |
