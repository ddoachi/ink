# E06-F05-T01: Panel State Management - Post-Implementation Documentation

## Quick Reference

| Aspect | Details |
|--------|---------|
| **Spec ID** | E06-F05-T01 |
| **Title** | Panel State Management |
| **Status** | Completed |
| **TDD Approach** | 74 total tests (55 unit + 19 integration) |
| **Key Deliverables** | `PanelStateManager`, data structures, MainWindow integration |

## 1. What Was Built

### Core Components

1. **Data Structures** (`src/ink/presentation/state/panel_state.py`)
   - `DockArea`: Enum mapping Qt dock areas with FLOATING value
   - `PanelGeometry`: Dataclass for size (width/height) and position (x/y)
   - `PanelInfo`: Complete panel metadata (name, visibility, area, floating, geometry, tab_group)
   - `PanelState`: Aggregate with panels dict and Qt state blobs

2. **State Manager** (`src/ink/presentation/state/panel_state_manager.py`)
   - `PanelStateManager`: QObject with reactive signal-based tracking
   - Signals: `state_changed`, `panel_visibility_changed`, `panel_area_changed`
   - Methods: `register_panel`, `capture_state`, `restore_state`, `show_panel`, `hide_panel`, `toggle_panel`

3. **MainWindow Integration** (`src/ink/presentation/main_window.py`)
   - Added `panel_state_manager` attribute
   - Registered Hierarchy, Properties, and Messages panels

## 2. Architecture Decisions

### Two-Tier State Storage
```
┌─────────────────────────────────────────────┐
│           PanelState (Structured)           │
│  - panels dict with PanelInfo objects       │
│  - Queryable at runtime                     │
│  - Serializable for inspection              │
├─────────────────────────────────────────────┤
│            Qt State Blobs                   │
│  - qt_state: QMainWindow.saveState()        │
│  - qt_geometry: QMainWindow.saveGeometry()  │
│  - Opaque but preserves complex layouts     │
└─────────────────────────────────────────────┘
```

**Why Both?** Qt's saveState() perfectly preserves dock arrangements but is opaque. Structured state enables runtime logic and API access.

### Signal Flow Pattern
```
QDockWidget Signal → Manager Handler → Update State → Emit Custom Signal
      │                    │                              │
      │                    ▼                              ▼
      │         _on_visibility_changed()     panel_visibility_changed
      │         _on_floating_changed()       state_changed
      │         _on_location_changed()       panel_area_changed
```

## 3. Key Implementation Details

### Panel Registration
When `register_panel(name, dock)` is called:
1. Store dock widget reference in `_dock_widgets` dict
2. Capture initial state into `PanelInfo`
3. Connect Qt signals to internal handlers

### Visibility Tracking in Headless Mode
Qt's `visibilityChanged` signal behaves differently without a visible window:
- `hide()` reliably emits `visibilityChanged(False)`
- `show()` may NOT emit signal if parent window isn't shown
- Tests adapted to verify via `isHidden()` flag instead

## 4. Testing Strategy

### Unit Tests (55 tests)
- Pure data structure tests with no Qt dependency
- Mocked Qt widgets for PanelStateManager tests
- Signal emission verification via MagicMock

### Integration Tests (19 tests)
- Real `QMainWindow` and `QDockWidget` instances
- Tests adapted for headless CI environment
- Focus on state consistency rather than visual behavior

## 5. Files Changed

| File | Change Type | Description |
|------|-------------|-------------|
| `src/ink/presentation/state/__init__.py` | Added | Package exports |
| `src/ink/presentation/state/panel_state.py` | Added | Data structures |
| `src/ink/presentation/state/panel_state_manager.py` | Added | State manager |
| `src/ink/presentation/main_window.py` | Modified | Integration |
| `tests/unit/presentation/state/__init__.py` | Added | Test package |
| `tests/unit/presentation/state/test_panel_state.py` | Added | Data structure tests |
| `tests/unit/presentation/state/test_panel_state_manager.py` | Added | Manager tests |
| `tests/integration/presentation/test_panel_state_integration.py` | Added | Integration tests |

## 6. Usage Examples

### Basic Panel Control
```python
# Get panel state manager
manager = window.panel_state_manager

# Toggle panel visibility
manager.toggle_panel("Hierarchy")

# Check if visible
if manager.state.is_panel_visible("Properties"):
    print("Properties panel is visible")

# Hide specific panel
manager.hide_panel("Messages")
```

### State Persistence
```python
# Capture state for saving
state = manager.capture_state()

# Later, restore state
manager.restore_state(saved_state)
```

### React to State Changes
```python
def on_visibility_changed(name: str, visible: bool) -> None:
    print(f"Panel {name} visibility: {visible}")

manager.panel_visibility_changed.connect(on_visibility_changed)
```

## 7. Gotchas and Lessons Learned

1. **Headless Qt Testing**: Qt signals behave differently when window isn't shown. Always test with `isHidden()` rather than `isVisible()`.

2. **Lambda Signal Closures**: When connecting signals with lambdas, capture variables by value (closure) to avoid stale references.

3. **State vs Layout**: `PanelState.panels` reflects logical state; Qt's opaque blob handles physical layout.

4. **Minimum Sizes**: Dock widgets need minimum sizes set on both dock AND contained widget.

## 8. Next Steps (E06-F05-T02, E06-F05-T03)

This task provides the foundation for:
- **E06-F05-T02**: State persistence to `AppSettings` using `capture_state()/restore_state()`
- **E06-F05-T03**: Settings migration handling for panel state format changes
- **E06-F02**: View menu toggle actions using `toggle_panel()` method
