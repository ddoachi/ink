# E06-F06-T04: Settings Migration & Reset - Post-Implementation Documentation

## 1. Implementation Summary

This task implemented a comprehensive settings migration framework and reset functionality for the Ink application. The implementation adds forward-compatible version tracking, sequential migration support, and user-friendly settings management through the UI.

### Key Deliverables

1. **Settings Migration Framework**: Version tracking with sequential migration support
2. **Reset Functionality**: Granular reset options for different settings categories
3. **Diagnostic Methods**: Tools for debugging and support
4. **UI Integration**: Help > Settings menu with confirmation dialogs

## 2. Technical Decisions

### 2.1 Migration Framework Design

**Decision**: Sequential migration with named methods (`_migrate_v0_to_v1`, etc.)

**Rationale**:
- Each migration is isolated and independently testable
- New migrations can be added without modifying existing ones
- Clear documentation of what changed in each version
- Follows the pattern used by Django, Rails, and other frameworks

**Alternative Considered**: Single migration method with version switching
- Rejected because it becomes unwieldy as versions accumulate
- Harder to test individual migration paths

### 2.2 Reset Without Auto-Restart

**Decision**: Show confirmation dialog and inform user to restart manually

**Rationale**:
- Auto-restart with `QProcess.startDetached()` has cross-platform issues
- Users may want to finish other tasks before restarting
- More predictable behavior across different launch methods (IDE, terminal, etc.)
- Matches behavior of other professional applications (VS Code, JetBrains IDEs)

### 2.3 Optional AppSettings in MainWindow

**Decision**: `app_settings` is an optional parameter in `InkMainWindow.__init__`

**Rationale**:
- Maintains backward compatibility with existing tests
- Window can function without settings (menu items just disabled)
- Enables testing window features independently of settings
- Follows dependency injection pattern for clean architecture

## 3. File Changes

| File | Change Type | Description |
|------|-------------|-------------|
| `src/ink/infrastructure/persistence/app_settings.py` | Modified | Added migration framework, reset methods, diagnostics |
| `src/ink/presentation/main_window.py` | Modified | Added Help > Settings menu with reset actions |
| `tests/unit/infrastructure/persistence/test_app_settings.py` | Modified | Added 17 new tests for migration/reset/diagnostics |
| `pyproject.toml` | Modified | Added PLC0415 to test file ignores |
| `specs/E06/F06/T04/E06-F06-T04.spec.md` | Modified | Updated acceptance criteria |

## 4. Architecture Impact

### 4.1 Layer Compliance

The implementation maintains clean architecture:

```
Presentation Layer (main_window.py)
    │
    │ Uses
    ▼
Infrastructure Layer (app_settings.py)
    │
    │ Wraps
    ▼
External (QSettings)
```

- MainWindow doesn't know about QSettings internals
- AppSettings provides a clean Python API
- No domain layer dependencies (pure infrastructure concern)

### 4.2 Dependency Direction

```
InkMainWindow → AppSettings (optional dependency)
              ↘ TYPE_CHECKING import (no runtime dependency when not used)
```

## 5. Testing Strategy

### 5.1 Test Categories Added

| Category | Tests | Coverage |
|----------|-------|----------|
| Migration Framework | 4 | Version tracking, sequential migration, no-op on current |
| Reset Functionality | 7 | Full reset, geometry reset, recent files reset, preservation |
| Diagnostics | 6 | Dictionary export, JSON export, QByteArray handling, corruption detection |

### 5.2 Test Isolation

All settings tests use the `isolated_settings` fixture that:
1. Creates a temporary directory
2. Redirects QSettings to use INI format in that directory
3. Clears any existing settings
4. Provides complete isolation between tests

## 6. API Reference

### 6.1 New AppSettings Methods

```python
# Migration
def get_settings_version(self) -> int
def _migrate_if_needed(self) -> None
def _migrate_settings(self, from_version: int, to_version: int) -> None

# Reset
def reset_all_settings(self) -> None
def reset_window_geometry(self) -> None
def reset_recent_files(self) -> None

# Diagnostics
def get_all_settings(self) -> dict[str, Any]
def export_settings(self, file_path: str) -> None
def is_corrupted(self) -> bool
```

### 6.2 MainWindow Changes

```python
# Constructor now accepts optional settings
def __init__(self, app_settings: AppSettings | None = None) -> None

# Menu structure:
# Help
#   └── Settings
#         ├── Reset Window Layout
#         ├── Clear Recent Files
#         ├── ───────────────────
#         ├── Reset All Settings...
#         ├── ───────────────────
#         └── Show Settings File Location
```

## 7. Future Considerations

### 7.1 Deferred Items

- **Corrupted Settings Startup Check**: Requires `main.py` entry point (not yet implemented in this project)
- **Auto-restart**: Could be added if a reliable cross-platform solution is found

### 7.2 Next Migration Example

When adding a new migration (e.g., renaming keys):

```python
# In app_settings.py
CURRENT_VERSION = 2  # Increment from 1

def _migrate_v1_to_v2(self) -> None:
    """Migrate from version 1 to version 2.

    Changes:
    - Rename "geometry/window" to "window/geometry"
    """
    if self.has_key("geometry/window"):
        value = self.get_value("geometry/window")
        self.set_value("window/geometry", value)
        self.remove_key("geometry/window")
```

## 8. Lessons Learned

1. **QByteArray to bytes conversion**: Use `.data()` method, not `bytes()` constructor
2. **QSettings type hints**: Return values from QSettings are `Any`, need explicit type conversion
3. **Test isolation for QSettings**: Always set custom path in fixture to avoid polluting real settings
4. **Menu action enabling**: Can enable/disable based on whether app_settings is provided

## 9. Related Specs

- **E06-F06-T01**: QSettings Infrastructure (prerequisite)
- **E06-F06-T02**: Window Geometry Persistence (uses reset_window_geometry)
- **E06-F06-T03**: Recent Files Management (uses reset_recent_files)
