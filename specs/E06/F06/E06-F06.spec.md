# Spec: E06-F06 - Settings Persistence

## Metadata
- **ID**: E06-F06
- **Type**: Feature
- **Priority**: P0 (MVP)
- **Status**: Draft
- **Parent**: [E06](../E06.spec.md)
- **Created**: 2025-12-26

---

## 1. Overview

### 1.1 Problem Statement

Users expect their workspace preferences to persist across application sessions. Without settings persistence, users must reconfigure panel layouts, window positions, and recent files every time they restart the application, leading to frustration and reduced productivity. A robust settings system is essential for professional tools.

### 1.2 Goals

- Persist window geometry (size, position) across sessions
- Save panel layout state (docked/floating, visibility, sizes)
- Maintain recent files list with maximum of 10 entries
- Store user preferences using Qt's `QSettings` platform-native storage
- Handle settings migration for future version upgrades
- Provide settings reset capability

---

## 2. User Stories

### US-E06-05: Panel Docking (Persistence Aspect)
**As a** circuit designer
**I want to** my panel layout to persist
**So that** I don't have to reconfigure my workspace every time

**Acceptance Criteria:**
- [ ] Layout persists across sessions

### US-E06-06: Recent Files
**As a** circuit designer
**I want to** quickly open recent files
**So that** I can resume work efficiently

**Acceptance Criteria:**
- [ ] Last 10 files remembered
- [ ] Recent files in File menu
- [ ] Click to open directly
- [ ] Missing files handled gracefully

---

## 3. Technical Requirements

### 3.1 Settings Architecture

```python
# src/ink/infrastructure/persistence/app_settings.py

from PySide6.QtCore import QSettings, QByteArray
from typing import List
from pathlib import Path

class AppSettings:
    """Application settings manager using QSettings."""

    # Settings keys
    KEY_WINDOW_GEOMETRY = "geometry/window"
    KEY_WINDOW_STATE = "geometry/state"
    KEY_RECENT_FILES = "files/recent"
    KEY_MAX_RECENT = "files/max_recent"
    KEY_SETTINGS_VERSION = "meta/version"

    # Constants
    CURRENT_VERSION = 1
    DEFAULT_MAX_RECENT = 10

    def __init__(self):
        # QSettings automatically uses platform-native storage
        # Linux: ~/.config/InkProject/Ink.conf
        # Windows: Registry HKEY_CURRENT_USER\Software\InkProject\Ink
        # macOS: ~/Library/Preferences/com.InkProject.Ink.plist
        self.settings = QSettings("InkProject", "Ink")
        self._migrate_if_needed()

    def _migrate_if_needed(self):
        """Migrate settings from older versions if needed."""
        stored_version = self.settings.value(self.KEY_SETTINGS_VERSION, 0, type=int)
        if stored_version < self.CURRENT_VERSION:
            self._migrate_settings(stored_version, self.CURRENT_VERSION)
            self.settings.setValue(self.KEY_SETTINGS_VERSION, self.CURRENT_VERSION)

    def _migrate_settings(self, from_version: int, to_version: int):
        """Perform settings migration between versions."""
        # Placeholder for future migrations
        # Example: Rename keys, convert formats, etc.
        pass

    # Window Geometry
    def save_window_geometry(self, geometry: QByteArray):
        """Save window geometry."""
        self.settings.setValue(self.KEY_WINDOW_GEOMETRY, geometry)

    def load_window_geometry(self) -> QByteArray | None:
        """Load window geometry."""
        return self.settings.value(self.KEY_WINDOW_GEOMETRY)

    def save_window_state(self, state: QByteArray):
        """Save window state (panel layout)."""
        self.settings.setValue(self.KEY_WINDOW_STATE, state)

    def load_window_state(self) -> QByteArray | None:
        """Load window state (panel layout)."""
        return self.settings.value(self.KEY_WINDOW_STATE)

    # Recent Files
    def add_recent_file(self, file_path: str):
        """Add file to recent files list."""
        recent = self.get_recent_files()

        # Remove if already exists (will re-add at front)
        if file_path in recent:
            recent.remove(file_path)

        # Add to front
        recent.insert(0, file_path)

        # Trim to max size
        max_recent = self.get_max_recent_files()
        recent = recent[:max_recent]

        # Save back
        self.settings.setValue(self.KEY_RECENT_FILES, recent)

    def get_recent_files(self) -> List[str]:
        """Get list of recent files."""
        files = self.settings.value(self.KEY_RECENT_FILES, [], type=list)

        # Filter out non-existent files
        existing_files = [f for f in files if Path(f).exists()]

        # Update settings if any files were removed
        if len(existing_files) < len(files):
            self.settings.setValue(self.KEY_RECENT_FILES, existing_files)

        return existing_files

    def clear_recent_files(self):
        """Clear recent files list."""
        self.settings.setValue(self.KEY_RECENT_FILES, [])

    def get_max_recent_files(self) -> int:
        """Get maximum number of recent files to remember."""
        return self.settings.value(
            self.KEY_MAX_RECENT,
            self.DEFAULT_MAX_RECENT,
            type=int
        )

    # Settings Management
    def reset_all_settings(self):
        """Reset all settings to defaults."""
        self.settings.clear()
        self.settings.setValue(self.KEY_SETTINGS_VERSION, self.CURRENT_VERSION)
        self.settings.setValue(self.KEY_MAX_RECENT, self.DEFAULT_MAX_RECENT)

    def get_settings_file_path(self) -> str:
        """Get path to settings file (for debugging/support)."""
        return self.settings.fileName()
```

### 3.2 Main Window Integration

```python
# src/ink/presentation/main_window.py (extension)

class InkMainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        self.app_settings = AppSettings()

        self._setup_window()
        self._setup_central_widget()
        self._setup_dock_widgets()
        self._setup_menus()
        self._setup_toolbar()
        self._setup_status_bar()

        # Restore saved state
        self._restore_settings()

    def _restore_settings(self):
        """Restore window geometry and panel state from settings."""
        geometry = self.app_settings.load_window_geometry()
        if geometry:
            self.restoreGeometry(geometry)

        state = self.app_settings.load_window_state()
        if state:
            self.restoreState(state)

    def closeEvent(self, event):
        """Handle application close - save settings."""
        self._save_settings()
        event.accept()

    def _save_settings(self):
        """Save window geometry and panel state to settings."""
        self.app_settings.save_window_geometry(self.saveGeometry())
        self.app_settings.save_window_state(self.saveState())

    def _on_open_file(self, file_path: str):
        """Handle file open - update recent files."""
        # ... existing file open logic ...

        # Add to recent files
        self.app_settings.add_recent_file(file_path)
        self._update_recent_files_menu()

    def _get_recent_files(self) -> List[str]:
        """Get recent files for menu population."""
        return self.app_settings.get_recent_files()

    def _clear_recent_files(self):
        """Clear recent files list."""
        self.app_settings.clear_recent_files()
        self._update_recent_files_menu()
```

### 3.3 Settings Storage Locations

| Platform | Storage Location |
|----------|-----------------|
| Linux | `~/.config/InkProject/Ink.conf` (INI format) |
| Windows | Registry: `HKEY_CURRENT_USER\Software\InkProject\Ink` |
| macOS | `~/Library/Preferences/com.InkProject.Ink.plist` |

### 3.4 Persisted Settings

```python
# Settings schema (logical structure)
{
    "meta": {
        "version": 1  # Settings format version
    },
    "geometry": {
        "window": QByteArray,  # Window size/position
        "state": QByteArray    # Dock widget layout
    },
    "files": {
        "recent": [            # Recent files list
            "/path/to/design1.ckt",
            "/path/to/design2.ckt",
            ...
        ],
        "max_recent": 10       # Max recent files to keep
    }
}
```

### 3.5 Settings Reset

```python
# Add to Help menu or File menu
def _on_reset_settings(self):
    """Reset all settings to defaults."""
    from PySide6.QtWidgets import QMessageBox

    reply = QMessageBox.question(
        self,
        "Reset Settings",
        "Reset all settings to defaults?\n\nThis will restart the application.",
        QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No
    )

    if reply == QMessageBox.StandardButton.Yes:
        self.app_settings.reset_all_settings()
        # Restart application
        QApplication.quit()
        QProcess.startDetached(QApplication.applicationFilePath())
```

---

## 4. Dependencies

- **Upstream**: None (foundational infrastructure)
- **Downstream**:
  - E06-F01 (Main Window Shell - window geometry)
  - E06-F02 (Menu System - recent files)
  - E06-F05 (Panel Management - panel state)
- **External**: PySide6 (`QSettings`, `QByteArray`)

---

## 5. Acceptance Criteria

- [ ] Window size and position persist across restarts
- [ ] Panel layout (docked/floating) persists across restarts
- [ ] Panel visibility states persist across restarts
- [ ] Panel sizes persist across restarts
- [ ] Recent files list shows up to 10 most recent files
- [ ] Recent files list maintains order (newest first)
- [ ] Non-existent files automatically removed from recent list
- [ ] Recent files list updated when file opened
- [ ] Settings stored in platform-native location
- [ ] Settings survive application crash (saved on close)
- [ ] Settings reset functionality works correctly
- [ ] Multiple instances of app share same settings
- [ ] Settings file path accessible for debugging

---

## 6. Child Specs

*To be created via `/spec_work E06-F06 --split tasks`*

| ID | Task | Status |
|----|------|--------|

---

## Revision History

| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-12-26 | 0.1 | Claude | Initial feature creation from E06 split |
