# E06-F06-T02: Window Geometry Persistence - Post-Implementation Documentation

## 1. Implementation Summary

| Aspect | Details |
|--------|---------|
| **Spec ID** | E06-F06-T02 |
| **Title** | Window Geometry Persistence |
| **Status** | Completed |
| **Implementation Date** | 2025-12-26 |
| **ClickUp Task** | CU-86evzm36r |

### What Was Built

Window geometry persistence feature that saves and restores the main window's size, position, and dock widget layout across application sessions using Qt's `QSettings` infrastructure.

### Key Components Modified

| File | Changes |
|------|---------|
| `src/ink/infrastructure/persistence/app_settings.py` | Added 6 new methods for geometry/state persistence |
| `src/ink/presentation/main_window.py` | Added optional `AppSettings` injection, restore/save logic |
| `tests/unit/infrastructure/persistence/test_window_geometry.py` | 24 unit tests (new file) |
| `tests/integration/presentation/test_window_geometry_persistence.py` | 15 integration tests (new file) |

---

## 2. Architecture Decisions

### 2.1 Optional Dependency Injection

**Decision**: Make `AppSettings` an optional constructor parameter for `InkMainWindow`.

**Rationale**:
- Backward compatibility with existing tests and code that creates `InkMainWindow()`
- Clean separation of concerns - window can exist without persistence
- Easier unit testing - can test window without settings infrastructure
- Follows dependency injection principle

```python
# Both work:
window = InkMainWindow()  # No persistence
window = InkMainWindow(app_settings=settings)  # With persistence
```

### 2.2 Geometry vs State Separation

**Decision**: Store window geometry and state separately using Qt's native format.

**Rationale**:
- `saveGeometry()`: Window position, size, maximized state, screen info
- `saveState()`: Dock widget positions, sizes, visibility, floating state
- Keeps data separate for potential partial restoration
- Uses Qt's built-in serialization (QByteArray) for cross-platform compatibility

### 2.3 Different Default Sizes

**Decision**: Use 1280x800 for geometry persistence mode, 1600x900 for no-persistence mode.

**Rationale**:
- 1600x900 is optimal for development/preview (larger canvas)
- 1280x800 is a safe first-run default that leaves room for user customization
- Differentiates "user never set preferences" from "user wants this size"

---

## 3. Implementation Details

### 3.1 AppSettings Extensions

Six new methods added to `AppSettings`:

```python
# Save operations
save_window_geometry(geometry: QByteArray) -> None
save_window_state(state: QByteArray) -> None

# Load operations (return None if not saved or invalid)
load_window_geometry() -> QByteArray | None
load_window_state() -> QByteArray | None

# Check operations
has_window_geometry() -> bool
has_window_state() -> bool
```

**Type Safety**: Load methods validate that stored data is actually `QByteArray`, returning `None` for corrupted or wrong-type data.

### 3.2 MainWindow Lifecycle

```
┌─────────────────────────────────────────────────────────────┐
│                     __init__()                               │
├─────────────────────────────────────────────────────────────┤
│  1. super().__init__()                                       │
│  2. Store app_settings reference                             │
│  3. _setup_window() - title, default size, flags            │
│  4. _setup_central_widget() - SchematicCanvas               │
│  5. _restore_geometry() - if app_settings provided          │
│     ├── Load saved geometry → restoreGeometry()             │
│     ├── If failed → _apply_default_geometry()               │
│     └── Load saved state → restoreState()                   │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                    closeEvent()                              │
├─────────────────────────────────────────────────────────────┤
│  1. _save_geometry()                                         │
│     ├── saveGeometry() → save_window_geometry()              │
│     ├── saveState() → save_window_state()                    │
│     └── sync() - Force write to disk                         │
│  2. event.accept() - Allow close                             │
└─────────────────────────────────────────────────────────────┘
```

### 3.3 Error Handling

- **Invalid geometry data**: Falls back to default size (1280x800) and centers window
- **Empty geometry data**: Same as invalid - uses defaults
- **No screen available**: Skip centering (defensive coding)
- **restoreGeometry() failure**: Uses default geometry
- **restoreState() failure**: Silently ignored (keeps default dock layout)

---

## 4. Testing Strategy

### 4.1 TDD Approach

Followed strict TDD (Red-Green-Refactor):
1. **RED**: Wrote 39 failing tests first
2. **GREEN**: Implemented minimal code to pass tests
3. **REFACTOR**: Fixed type errors, linting issues

### 4.2 Test Coverage

| Test Category | Count | Description |
|---------------|-------|-------------|
| AppSettings methods | 24 | Unit tests for all geometry methods |
| MainWindow integration | 15 | Integration tests for persistence behavior |
| **Total** | 39 | All pass |

### 4.3 Platform Limitation

Qt's `restoreGeometry()` doesn't work correctly in offscreen mode (headless testing). Tests verify:
- Geometry data is correctly saved and loaded
- Code paths are exercised
- Actual size restoration verified where possible

---

## 5. Key Learnings

### 5.1 Qt Geometry Quirks

- `saveGeometry()` returns `QByteArray` with platform-specific format
- Multi-monitor handling is automatic in Qt
- `restoreGeometry()` returns `bool` for success/failure
- Offscreen platform has geometry restoration limitations

### 5.2 Type Safety with QByteArray

- `QByteArray` doesn't implement `Sized` protocol for `len()`
- Use `.isEmpty()` instead of `len() > 0`
- Always validate type when loading from QSettings

### 5.3 closeEvent Importance

- `closeEvent()` is guaranteed to be called on normal close
- Must call `event.accept()` to allow close
- Sync settings immediately to survive potential crashes

---

## 6. Future Enhancements

| Enhancement | Priority | Notes |
|-------------|----------|-------|
| Maximized state memory | P1 | Track if user prefers maximized |
| Per-screen geometry | P2 | Different layouts for different monitors |
| State version migration | P2 | Handle layout changes between versions |
| Reset to defaults option | P2 | Menu action to clear saved geometry |

---

## 7. Related Specs

| Spec | Relationship |
|------|--------------|
| E06-F06-T01 | Upstream - Provides `AppSettings` infrastructure |
| E06-F06-T03 | Sibling - Recent files persistence (uses same pattern) |
| E06-F01-T01 | Sibling - Window shell (provides base `InkMainWindow`) |

---

## 8. Quick Reference

### Usage

```python
from ink.infrastructure.persistence.app_settings import AppSettings
from ink.presentation.main_window import InkMainWindow

# Create settings instance (typically in main.py)
settings = AppSettings()

# Create window with persistence
window = InkMainWindow(app_settings=settings)
window.show()

# Geometry saved automatically on close
```

### Key Settings Keys

```python
AppSettings.KEY_WINDOW_GEOMETRY = "geometry/window"
AppSettings.KEY_WINDOW_STATE = "geometry/state"
```

### Storage Location (Linux)

```
~/.config/InkProject/Ink.conf
```
