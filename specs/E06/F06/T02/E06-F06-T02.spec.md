---
id: E06-F06-T02
title: Window Geometry Persistence
type: Task
priority: P0 (MVP)
status: Draft
parent: E06-F06
created: 2025-12-26
estimated_hours: 3
actual_hours:
effort: Small
tags:
  - ui
  - persistence
  - geometry
---

# Spec: E06-F06-T02 - Window Geometry Persistence

## 1. Overview

### 1.1 Problem Statement

Users expect their window size, position, and panel layout to persist across application sessions. Without this, users must resize and rearrange their workspace every time they launch the application, reducing productivity and creating frustration.

### 1.2 Goals

- Save window geometry (size, position) on application close
- Restore window geometry on application startup
- Save dock widget layout state (panel positions, sizes, floating state)
- Restore dock widget state on startup
- Handle missing or invalid geometry data gracefully

---

## 2. Technical Requirements

### 2.1 AppSettings Extensions

Add window geometry methods to `AppSettings` class:

```python
# src/ink/infrastructure/persistence/app_settings.py

class AppSettings:
    # ... existing code ...

    def save_window_geometry(self, geometry: QByteArray):
        """Save window geometry.

        Args:
            geometry: Window geometry from QMainWindow.saveGeometry()
        """
        self.set_value(self.KEY_WINDOW_GEOMETRY, geometry)

    def load_window_geometry(self) -> QByteArray | None:
        """Load window geometry.

        Returns:
            Window geometry QByteArray or None if not saved
        """
        geometry = self.get_value(self.KEY_WINDOW_GEOMETRY)
        # QSettings returns QByteArray or None
        return geometry if isinstance(geometry, QByteArray) else None

    def save_window_state(self, state: QByteArray):
        """Save window state (dock widget layout).

        Args:
            state: Window state from QMainWindow.saveState()
        """
        self.set_value(self.KEY_WINDOW_STATE, state)

    def load_window_state(self) -> QByteArray | None:
        """Load window state (dock widget layout).

        Returns:
            Window state QByteArray or None if not saved
        """
        state = self.get_value(self.KEY_WINDOW_STATE)
        return state if isinstance(state, QByteArray) else None

    def has_window_geometry(self) -> bool:
        """Check if window geometry is saved.

        Returns:
            True if geometry exists
        """
        return self.has_key(self.KEY_WINDOW_GEOMETRY)

    def has_window_state(self) -> bool:
        """Check if window state is saved.

        Returns:
            True if state exists
        """
        return self.has_key(self.KEY_WINDOW_STATE)
```

### 2.2 Main Window Integration

Update `InkMainWindow` to use geometry persistence:

```python
# src/ink/presentation/main_window.py

from PySide6.QtWidgets import QMainWindow
from ink.infrastructure.persistence.app_settings import AppSettings

class InkMainWindow(QMainWindow):
    def __init__(self, app_settings: AppSettings):
        super().__init__()
        self.app_settings = app_settings

        # Setup UI components
        self._setup_window()
        self._setup_central_widget()
        self._setup_dock_widgets()
        self._setup_menus()
        self._setup_toolbar()
        self._setup_status_bar()

        # Restore saved geometry and state AFTER UI setup
        self._restore_geometry()

    def _restore_geometry(self):
        """Restore window geometry and state from settings."""
        # Restore geometry (size, position)
        geometry = self.app_settings.load_window_geometry()
        if geometry:
            self.restoreGeometry(geometry)
        else:
            # First run - set default size
            self.resize(1280, 800)
            # Center on screen
            self._center_on_screen()

        # Restore state (dock widget layout)
        state = self.app_settings.load_window_state()
        if state:
            self.restoreState(state)

    def _center_on_screen(self):
        """Center window on screen."""
        from PySide6.QtGui import QGuiApplication
        screen = QGuiApplication.primaryScreen().geometry()
        x = (screen.width() - self.width()) // 2
        y = (screen.height() - self.height()) // 2
        self.move(x, y)

    def closeEvent(self, event):
        """Handle application close - save geometry and state.

        Args:
            event: QCloseEvent
        """
        self._save_geometry()
        event.accept()

    def _save_geometry(self):
        """Save window geometry and state to settings."""
        self.app_settings.save_window_geometry(self.saveGeometry())
        self.app_settings.save_window_state(self.saveState())
        self.app_settings.sync()  # Force write to disk
```

### 2.3 Geometry Data Format

Qt's `saveGeometry()` and `saveState()` return `QByteArray` containing:

**Window Geometry** (`saveGeometry()`):
- Window size
- Window position on screen
- Screen number (for multi-monitor setups)
- Window flags and state (maximized, minimized, etc.)

**Window State** (`saveState()`):
- Dock widget positions (left, right, bottom, top)
- Dock widget sizes
- Dock widget visibility
- Dock widget floating state
- Toolbar positions
- Main window state version (for compatibility)

---

## 3. Implementation Details

### 3.1 Restoration Order

Critical: Restore in correct order:

```python
def __init__(self, app_settings):
    super().__init__()

    # 1. Create all widgets FIRST
    self._setup_window()
    self._setup_central_widget()
    self._setup_dock_widgets()  # Must exist before restoreState()
    self._setup_menus()
    self._setup_toolbar()

    # 2. THEN restore geometry/state
    self._restore_geometry()
```

### 3.2 Default Geometry

If no saved geometry exists (first run):

```python
# Default window size
DEFAULT_WIDTH = 1280
DEFAULT_HEIGHT = 800

# Default dock widget sizes (as ratios)
HIERARCHY_PANEL_WIDTH = 250
PROPERTY_PANEL_WIDTH = 300
MESSAGE_PANEL_HEIGHT = 150
```

### 3.3 Multi-Monitor Handling

Qt automatically handles multi-monitor scenarios:
- If saved position is off-screen (monitor removed), Qt moves window to visible area
- Screen resolution changes are handled gracefully

---

## 4. Testing Requirements

### 4.1 Manual Testing

1. **Basic Persistence**:
   - Resize window, close, reopen → size/position restored
   - Move window, close, reopen → position restored
   - Maximize window, close, reopen → maximized state restored

2. **Dock Widget State**:
   - Resize panel, close, reopen → panel size restored
   - Float panel, close, reopen → floating state restored
   - Hide panel, close, reopen → hidden state restored
   - Rearrange panels, close, reopen → arrangement restored

3. **Edge Cases**:
   - First run → default size and centered
   - Delete settings file → defaults restored
   - Change screen resolution → window fits on screen

### 4.2 Automated Tests

```python
# tests/integration/persistence/test_window_geometry.py

import pytest
from PySide6.QtWidgets import QApplication
from PySide6.QtCore import QByteArray
from ink.infrastructure.persistence.app_settings import AppSettings
from ink.presentation.main_window import InkMainWindow

class TestWindowGeometry:
    @pytest.fixture
    def app(self):
        """Create QApplication instance."""
        return QApplication.instance() or QApplication([])

    @pytest.fixture
    def settings(self, tmp_path):
        """Create temporary settings."""
        # Use temp location
        from PySide6.QtCore import QSettings
        QSettings.setPath(
            QSettings.Format.IniFormat,
            QSettings.Scope.UserScope,
            str(tmp_path)
        )
        return AppSettings()

    def test_save_load_geometry(self, app, settings):
        """Test saving and loading window geometry."""
        window = InkMainWindow(app_settings=settings)
        window.resize(800, 600)
        window.move(100, 100)

        # Save geometry
        settings.save_window_geometry(window.saveGeometry())

        # Create new window and restore
        new_window = InkMainWindow(app_settings=settings)
        # Geometry should be restored in __init__

        assert new_window.width() == 800
        assert new_window.height() == 600
        # Position check may vary by window manager

    def test_first_run_defaults(self, app, settings):
        """Test default geometry on first run."""
        assert not settings.has_window_geometry()

        window = InkMainWindow(app_settings=settings)

        # Should have default size
        assert window.width() == 1280
        assert window.height() == 800

    def test_invalid_geometry_ignored(self, app, settings):
        """Test that invalid geometry data is ignored."""
        # Set invalid geometry data
        settings.set_value(settings.KEY_WINDOW_GEOMETRY, "invalid")

        window = InkMainWindow(app_settings=settings)

        # Should fall back to defaults
        assert window.width() == 1280
        assert window.height() == 800
```

---

## 5. Acceptance Criteria

- [ ] `save_window_geometry()` and `load_window_geometry()` methods added to `AppSettings`
- [ ] `save_window_state()` and `load_window_state()` methods added to `AppSettings`
- [ ] Main window calls `_restore_geometry()` on startup
- [ ] Main window calls `_save_geometry()` on close
- [ ] Window size persists across restarts
- [ ] Window position persists across restarts
- [ ] Maximized state persists across restarts
- [ ] Dock widget positions persist across restarts
- [ ] Dock widget sizes persist across restarts
- [ ] Dock widget floating state persists across restarts
- [ ] Dock widget visibility persists across restarts
- [ ] First run uses default size (1280x800) and centers window
- [ ] Invalid geometry data handled gracefully (falls back to defaults)
- [ ] Multi-monitor scenarios handled (window stays on screen)
- [ ] Settings written to disk on application close

---

## 6. Dependencies

- **Upstream**: E06-F06-T01 (QSettings Infrastructure)
- **Downstream**: None
- **External**:
  - PySide6 (`QMainWindow.saveGeometry()`, `restoreGeometry()`)
  - PySide6 (`QMainWindow.saveState()`, `restoreState()`)

---

## 7. Notes

### 7.1 QMainWindow Geometry Methods

```python
# Save
geometry: QByteArray = window.saveGeometry()
state: QByteArray = window.saveState()

# Restore
window.restoreGeometry(geometry)  # Returns bool (success)
window.restoreState(state)        # Returns bool (success)
```

### 7.2 State Version

Qt's `saveState()` includes a version number for compatibility. By default it's 0. Can specify:

```python
state = window.saveState(version=1)
window.restoreState(state, version=1)
```

For MVP, use default version 0.

### 7.3 Timing

- **Save**: On `closeEvent()` (guaranteed to be called)
- **Restore**: After all widgets created in `__init__()`

---

## Revision History

| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-12-26 | 0.1 | Claude | Initial task creation from E06-F06 split |
