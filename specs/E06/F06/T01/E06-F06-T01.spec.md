---
id: E06-F06-T01
title: QSettings Infrastructure
type: Task
priority: P0 (MVP)
status: Draft
parent: E06-F06
created: 2025-12-26
estimated_hours: 4
actual_hours:
effort: Small
tags:
  - infrastructure
  - persistence
clickup_task_id: '86evzm36h'
---

# Spec: E06-F06-T01 - QSettings Infrastructure

## 1. Overview

### 1.1 Problem Statement

The application needs a centralized settings management system to persist user preferences across sessions. This task implements the core `AppSettings` class that provides a clean API over Qt's `QSettings` for platform-native storage.

### 1.2 Goals

- Create `AppSettings` class wrapping `QSettings`
- Define settings keys and constants
- Implement basic get/set methods for settings values
- Set up platform-native storage locations
- Provide settings file path access for debugging

---

## 2. Technical Requirements

### 2.1 File Location

```
src/ink/infrastructure/persistence/app_settings.py
```

### 2.2 AppSettings Class

```python
from PySide6.QtCore import QSettings, QByteArray
from typing import Any, List
from pathlib import Path

class AppSettings:
    """Application settings manager using QSettings.

    Provides centralized access to persisted application settings
    using Qt's platform-native storage mechanism.
    """

    # Settings keys - organized by category
    KEY_WINDOW_GEOMETRY = "geometry/window"
    KEY_WINDOW_STATE = "geometry/state"
    KEY_RECENT_FILES = "files/recent"
    KEY_MAX_RECENT = "files/max_recent"
    KEY_SETTINGS_VERSION = "meta/version"

    # Constants
    CURRENT_VERSION = 1
    DEFAULT_MAX_RECENT = 10

    def __init__(self):
        """Initialize settings with platform-native storage.

        Storage locations:
        - Linux: ~/.config/InkProject/Ink.conf
        - Windows: Registry HKEY_CURRENT_USER\\Software\\InkProject\\Ink
        - macOS: ~/Library/Preferences/com.InkProject.Ink.plist
        """
        self.settings = QSettings("InkProject", "Ink")

    def get_value(self, key: str, default: Any = None, value_type: type = None) -> Any:
        """Get a setting value.

        Args:
            key: Settings key
            default: Default value if key doesn't exist
            value_type: Expected type (for type conversion)

        Returns:
            Setting value or default
        """
        if value_type is not None:
            return self.settings.value(key, default, type=value_type)
        return self.settings.value(key, default)

    def set_value(self, key: str, value: Any):
        """Set a setting value.

        Args:
            key: Settings key
            value: Value to store
        """
        self.settings.setValue(key, value)

    def has_key(self, key: str) -> bool:
        """Check if a setting key exists.

        Args:
            key: Settings key

        Returns:
            True if key exists
        """
        return self.settings.contains(key)

    def remove_key(self, key: str):
        """Remove a setting key.

        Args:
            key: Settings key to remove
        """
        self.settings.remove(key)

    def get_all_keys(self) -> List[str]:
        """Get all setting keys.

        Returns:
            List of all keys
        """
        return self.settings.allKeys()

    def get_settings_file_path(self) -> str:
        """Get path to settings file (for debugging/support).

        Returns:
            Absolute path to settings file
        """
        return self.settings.fileName()

    def sync(self):
        """Force write settings to disk.

        Normally Qt handles this automatically, but this can be
        called to ensure settings are written immediately.
        """
        self.settings.sync()
```

### 2.3 Platform Storage Locations

The `QSettings` class automatically uses platform-native storage:

| Platform | Storage Location | Format |
|----------|-----------------|--------|
| Linux | `~/.config/InkProject/Ink.conf` | INI |
| Windows | `HKEY_CURRENT_USER\Software\InkProject\Ink` | Registry |
| macOS | `~/Library/Preferences/com.InkProject.Ink.plist` | plist |

### 2.4 Initial Settings

On first run, the settings file should be created with:

```python
def _initialize_defaults(self):
    """Initialize default settings on first run."""
    if not self.has_key(self.KEY_SETTINGS_VERSION):
        # First run - set defaults
        self.set_value(self.KEY_SETTINGS_VERSION, self.CURRENT_VERSION)
        self.set_value(self.KEY_MAX_RECENT, self.DEFAULT_MAX_RECENT)
        self.set_value(self.KEY_RECENT_FILES, [])
```

---

## 3. Implementation Details

### 3.1 Module Structure

```
src/ink/infrastructure/persistence/
├── __init__.py           # Export AppSettings
└── app_settings.py       # AppSettings implementation
```

### 3.2 Dependency Injection

The `AppSettings` instance should be created at application startup and injected into components that need it:

```python
# In main application setup
app_settings = AppSettings()

# Pass to main window
main_window = InkMainWindow(app_settings=app_settings)
```

---

## 4. Testing Requirements

### 4.1 Unit Tests

```python
# tests/unit/infrastructure/persistence/test_app_settings.py

import pytest
from PySide6.QtCore import QSettings
from ink.infrastructure.persistence.app_settings import AppSettings

class TestAppSettings:
    @pytest.fixture
    def settings(self, tmp_path):
        """Create temporary settings instance."""
        # Use custom location for testing
        QSettings.setPath(
            QSettings.Format.IniFormat,
            QSettings.Scope.UserScope,
            str(tmp_path)
        )
        return AppSettings()

    def test_set_get_value(self, settings):
        """Test basic set/get operations."""
        settings.set_value("test/key", "value")
        assert settings.get_value("test/key") == "value"

    def test_get_value_with_default(self, settings):
        """Test get with default value."""
        assert settings.get_value("nonexistent", "default") == "default"

    def test_get_value_with_type(self, settings):
        """Test type conversion."""
        settings.set_value("test/int", 42)
        assert settings.get_value("test/int", type=int) == 42

    def test_has_key(self, settings):
        """Test key existence check."""
        assert not settings.has_key("test/key")
        settings.set_value("test/key", "value")
        assert settings.has_key("test/key")

    def test_remove_key(self, settings):
        """Test key removal."""
        settings.set_value("test/key", "value")
        settings.remove_key("test/key")
        assert not settings.has_key("test/key")

    def test_get_all_keys(self, settings):
        """Test getting all keys."""
        settings.set_value("test/key1", "value1")
        settings.set_value("test/key2", "value2")
        keys = settings.get_all_keys()
        assert "test/key1" in keys
        assert "test/key2" in keys

    def test_settings_file_path(self, settings):
        """Test getting settings file path."""
        path = settings.get_settings_file_path()
        assert isinstance(path, str)
        assert len(path) > 0
```

---

## 5. Acceptance Criteria

- [ ] `AppSettings` class created in `src/ink/infrastructure/persistence/app_settings.py`
- [ ] All settings keys defined as class constants
- [ ] Generic `get_value()` and `set_value()` methods implemented
- [ ] Type conversion support in `get_value()`
- [ ] `has_key()`, `remove_key()`, `get_all_keys()` methods implemented
- [ ] `get_settings_file_path()` returns correct platform path
- [ ] `sync()` method forces write to disk
- [ ] Default values initialized on first run
- [ ] All unit tests pass
- [ ] Settings persist across QSettings instance recreation
- [ ] No hardcoded file paths (platform-native only)

---

## 6. Dependencies

- **Upstream**: None
- **Downstream**:
  - E06-F06-T02 (Window Geometry Persistence)
  - E06-F06-T03 (Recent Files Management)
  - E06-F06-T04 (Settings Migration & Reset)
- **External**: PySide6 (`QSettings`)

---

## 7. Notes

### 7.1 QSettings Behavior

- Settings are written automatically when the `QSettings` object is destroyed
- Can force immediate write with `sync()`
- Supports hierarchical keys using `/` separator
- Automatically handles type conversions for basic types

### 7.2 Testing Considerations

- Use temporary settings location for tests (avoid polluting user settings)
- Test on each platform if possible (Linux, Windows, macOS)
- Verify settings survive application restart

---

## Revision History

| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-12-26 | 0.1 | Claude | Initial task creation from E06-F06 split |
