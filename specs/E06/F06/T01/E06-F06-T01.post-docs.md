# Post-Implementation Learning Reference: E06-F06-T01 QSettings Infrastructure

## 1. Quick Summary

**What was built**: The `AppSettings` class providing a clean Python API over Qt's `QSettings` for platform-native settings storage.

**Key files created/modified**:
- `src/ink/infrastructure/persistence/app_settings.py` - Main implementation (317 lines)
- `src/ink/infrastructure/persistence/__init__.py` - Module exports
- `src/ink/infrastructure/__init__.py` - Layer package
- `tests/unit/infrastructure/persistence/test_app_settings.py` - 36 comprehensive tests

**TDD phases completed**:
- RED: 36 failing tests written first
- GREEN: Implementation to pass all tests
- REFACTOR: Code quality improvements, linting, type checking

---

## 2. Key Implementation Decisions

### Why QSettings?
- **Platform-native storage**: Automatically uses the correct storage mechanism per OS
  - Linux: `~/.config/InkProject/Ink.conf` (INI format)
  - Windows: Registry (`HKEY_CURRENT_USER\Software\InkProject\Ink`)
  - macOS: `~/Library/Preferences/com.InkProject.Ink.plist`
- **No file handling needed**: Qt handles serialization/deserialization
- **Hierarchical keys**: Natural organization with `/` separator

### Why wrap QSettings?
- **Type safety**: Added `value_type` parameter for explicit type conversion
- **Default initialization**: Consistent first-run behavior
- **Cleaner API**: Pythonic interface vs Qt's C++ style

### Key design patterns:
- **Hierarchical keys**: `geometry/window`, `files/recent`, `meta/version`
- **Class constants**: All keys defined as `KEY_*` class attributes
- **Default initialization**: `_initialize_defaults()` on first run only

---

## 3. Critical Code Patterns

### Get/Set with Type Conversion
```python
# Without type - returns whatever QSettings has
value = settings.get_value("key")

# With type conversion - ensures correct Python type
count = settings.get_value("files/max_recent", value_type=int)

# For QByteArray (window geometry) - ALWAYS specify type
geometry = settings.get_value(
    AppSettings.KEY_WINDOW_GEOMETRY,
    value_type=QByteArray
)
```

### First-Run Detection
```python
def _initialize_defaults(self) -> None:
    # Only initialize if no version key exists (first run)
    if not self.has_key(self.KEY_SETTINGS_VERSION):
        self.set_value(self.KEY_SETTINGS_VERSION, self.CURRENT_VERSION)
        self.set_value(self.KEY_MAX_RECENT, self.DEFAULT_MAX_RECENT)
        self.set_value(self.KEY_RECENT_FILES, [])
        self.sync()  # Force write immediately
```

### Test Isolation Pattern
```python
@pytest.fixture
def isolated_settings(tmp_path: Path) -> Generator[Path, None, None]:
    settings_path = tmp_path / "settings"
    settings_path.mkdir()

    # Configure QSettings to use temp path
    QSettings.setPath(
        QSettings.Format.IniFormat,
        QSettings.Scope.UserScope,
        str(settings_path),
    )

    # CRITICAL: Clear existing settings for isolation
    temp_settings = QSettings("InkProject", "Ink")
    temp_settings.clear()
    temp_settings.sync()

    yield settings_path
```

---

## 4. Gotchas and Lessons Learned

### QSettings Global State
- `QSettings.setPath()` affects ALL QSettings instances globally
- Must clear settings in test fixtures to ensure isolation
- Tests sharing the same organization/app name will conflict without clearing

### Type Conversion Quirks
- QSettings stores INI values as strings internally
- Without `value_type`, integers may return as strings
- Always use `value_type=int` for numeric values

### Raw Docstrings for Backslashes
```python
r"""Use raw docstrings when paths contain backslashes.
- Windows: HKEY_CURRENT_USER\Software\InkProject\Ink
"""
```

### Ruff Linting Strictness
- `Any` type disallowed by default (`ANN401`) - needed exception in pyproject.toml
- Unused fixture arguments need `# noqa: ARG001` comment
- Type imports should be in `if TYPE_CHECKING:` block

---

## 5. Testing Strategy

### Test Structure
```
TestAppSettingsClassConstants     # 7 tests - verify constants exist
TestAppSettingsInitialization     # 5 tests - QSettings setup, defaults
TestAppSettingsGetValue           # 8 tests - retrieval, type conversion
TestAppSettingsSetValue           # 4 tests - storage
TestAppSettingsHasKey             # 2 tests - existence checks
TestAppSettingsRemoveKey          # 2 tests - deletion
TestAppSettingsGetAllKeys         # 2 tests - key enumeration
TestAppSettingsGetSettingsFilePath# 2 tests - path retrieval
TestAppSettingsSync               # 2 tests - disk persistence
TestAppSettingsPersistence        # 2 tests - cross-instance persistence
```

### Key Test Patterns
1. **Fixture dependency for isolation**: `app_settings` depends on `isolated_settings`
2. **Direct instance creation for persistence tests**: Test across `AppSettings()` instances
3. **Type assertions**: Check both value AND type (`isinstance()`)

---

## 6. How to Use This Component

### Basic Usage
```python
from ink.infrastructure.persistence import AppSettings

# Create instance (defaults initialized on first run)
settings = AppSettings()

# Store values
settings.set_value("my/key", "value")
settings.set_value("my/number", 42)

# Retrieve values
value = settings.get_value("my/key")
number = settings.get_value("my/number", value_type=int)

# Check/remove
if settings.has_key("my/key"):
    settings.remove_key("my/key")
```

### For Window Geometry (E06-F06-T02)
```python
# Save geometry
settings.set_value(
    AppSettings.KEY_WINDOW_GEOMETRY,
    window.saveGeometry()
)

# Restore geometry
geometry = settings.get_value(
    AppSettings.KEY_WINDOW_GEOMETRY,
    value_type=QByteArray
)
if geometry:
    window.restoreGeometry(geometry)
```

---

## 7. Future Considerations

### Downstream tasks using this class:
- **E06-F06-T02**: Window Geometry Persistence
- **E06-F06-T03**: Recent Files Management
- **E06-F06-T04**: Settings Migration & Reset

### Potential improvements:
- Add signals for setting changes (reactive UI updates)
- Implement settings migration for version upgrades
- Add settings groups for organized access

---

## 8. Resources

- [Qt QSettings Documentation](https://doc.qt.io/qt-6/qsettings.html)
- [PySide6 QSettings](https://doc.qt.io/qtforpython-6/PySide6/QtCore/QSettings.html)
- [Spec E06-F06-T01](./E06-F06-T01.spec.md)
- [GitHub Issue #7](https://github.com/ddoachi/ink/issues/7)
