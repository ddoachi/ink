# E06-F06-T03: Recent Files Management - Post-Implementation Documentation

> **Quick Reference**: Implementation decisions, learnings, and patterns from E06-F06-T03

## 1. Implementation Summary

| Aspect | Value |
|--------|-------|
| **Spec ID** | E06-F06-T03 |
| **Title** | Recent Files Management |
| **Status** | Completed |
| **Implementation Date** | 2025-12-26 |
| **Primary Files Modified** | `app_settings.py`, `main_window.py` |
| **Test Files Added** | `test_recent_files.py`, `test_recent_files_menu.py` |
| **Lines of Code Added** | ~1,500 |
| **Test Count** | 48 tests (24 unit + 24 integration) |

## 2. Key Implementation Decisions

### 2.1 Dependency Injection for AppSettings

**Decision**: `InkMainWindow` receives `AppSettings` via constructor injection.

**Why**:
- Enables test isolation with temporary QSettings paths
- Follows dependency inversion principle
- Allows future flexibility for different settings backends

**Trade-off**: Requires updating all `InkMainWindow` instantiations to pass `AppSettings`.

```python
# Before (no dependency)
window = InkMainWindow()

# After (dependency injection)
settings = AppSettings()
window = InkMainWindow(settings)
```

### 2.2 Lazy File Existence Filtering

**Decision**: Non-existent files are filtered during `get_recent_files()`, not during storage.

**Why**:
- No background tasks needed to maintain list integrity
- Files deleted outside app are cleaned on next access
- Simpler implementation without file watchers

**Code location**: `app_settings.py:377-417`

### 2.3 Move-to-Front on Duplicate

**Decision**: Re-adding an existing file moves it to the front instead of creating duplicates.

**Why**:
- Most recently opened file should appear first
- Prevents list bloat with duplicates
- Matches user expectation from other applications

**Code location**: `app_settings.py:363-365`

### 2.4 Menu Rebuild Strategy

**Decision**: Entire recent files menu is rebuilt on each update.

**Why**:
- Simple and reliable (no state synchronization issues)
- Maximum 10 items makes performance negligible
- Avoids complex menu item update logic

**Trade-off**: Slightly less efficient than surgical updates, but negligible for small lists.

## 3. Patterns Used

### 3.1 Qt Signal-Lambda Capture Pattern

For connecting menu actions to file-specific handlers:

```python
action.triggered.connect(
    lambda _checked=False, path=file_path: self._on_open_recent_file(path)
)
```

**Why `path=file_path`**: Default argument captures current loop value, not reference.

### 3.2 QSettings Type Conversion

Explicit type specification for reliable value retrieval:

```python
result = self.get_value(
    self.KEY_MAX_RECENT,
    self.DEFAULT_MAX_RECENT,
    value_type=int,
)
return int(result) if result is not None else self.DEFAULT_MAX_RECENT
```

### 3.3 Test Isolation with QSettings

Temporary settings path for test isolation:

```python
QSettings.setPath(
    QSettings.Format.IniFormat,
    QSettings.Scope.UserScope,
    str(settings_path),
)
```

## 4. Testing Strategy

### 4.1 TDD Red-Green-Refactor

1. **RED**: Wrote 48 failing tests defining expected behavior
2. **GREEN**: Implemented code to pass all tests
3. **REFACTOR**: Cleaned up with lint/type checks

### 4.2 Test Categories

| Category | Count | Purpose |
|----------|-------|---------|
| Unit Tests | 24 | AppSettings methods in isolation |
| Integration Tests | 24 | MainWindow + AppSettings + Menu interaction |

### 4.3 Key Test Fixtures

```python
@pytest.fixture
def isolated_settings(tmp_path):
    """QSettings isolation for each test."""

@pytest.fixture
def temp_files(tmp_path):
    """15 temporary .ckt files for testing limits."""
```

## 5. Edge Cases Handled

| Edge Case | Handling |
|-----------|----------|
| Empty recent files list | Show "No Recent Files" placeholder |
| File deleted externally | Auto-removed on `get_recent_files()` |
| Duplicate file add | Move to front, no duplicate |
| Unicode in file path | Works correctly (tested) |
| Spaces in file path | Works correctly (tested) |
| Empty string in list | Filtered out |
| Max < 1 | Raises `ValueError` |
| 10+ files added | Trims to max, keeps newest |

## 6. Files Changed

### Source Files

| File | Changes |
|------|---------|
| `app_settings.py` | +195 lines: Recent files methods |
| `main_window.py` | +180 lines: Menu integration, constructor change |

### Test Files

| File | Description |
|------|-------------|
| `test_recent_files.py` | 24 unit tests for AppSettings |
| `test_recent_files_menu.py` | 24 integration tests for menu |
| `test_main_window.py` | Updated for new constructor |
| `test_main_window_canvas.py` | Updated for new constructor |

## 7. What I Would Do Differently

### 7.1 Consider Signals for Menu Updates

Instead of calling `_update_recent_files_menu()` directly, could use Qt signals:

```python
# Potential improvement
self.recent_files_changed = Signal()
self.recent_files_changed.connect(self._update_recent_files_menu)
```

**Why not done**: Simple direct call is sufficient for current scope.

### 7.2 File Existence Check Performance

For very large recent files lists, existence checks could be expensive. Could consider:
- Batch checking
- Caching existence status briefly

**Why not done**: Default max of 10 files makes this negligible.

## 8. Related Specs

| Spec | Relationship |
|------|--------------|
| E06-F06-T01 | Foundation: `AppSettings` class |
| E06-F06-T02 | Parallel: Window geometry persistence |
| E06-F01-T01 | Base: `InkMainWindow` shell |
| E06-F01-T02 | Base: Central widget setup |

## 9. Future Considerations

1. **File dialog last directory**: Store and restore last opened directory
2. **Pin files**: Allow pinning files to stay at top of recent list
3. **Categories**: Separate recently opened from recently created
4. **Thumbnails**: Show design preview thumbnails in menu

## 10. Verification Checklist

- [x] All 116 tests pass
- [x] No lint errors (ruff)
- [x] No type errors (mypy)
- [x] Constructor change backward compatible (with AppSettings)
- [x] Menu keyboard shortcuts work (Alt+1 through Alt+9)
- [x] Clear Recent Files removes all entries
- [x] Non-existent files auto-removed

---

**See Also**:
- [Spec](E06-F06-T03.spec.md)
- [Pre-Docs](E06-F06-T03.pre-docs.md)
- [Implementation Narrative](E06-F06-T03-implementation-narrative.md)
