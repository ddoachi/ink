---
id: E06-F04-T04
title: File and Object Count Display
type: Task
priority: P0 (MVP)
status: Draft
parent: E06-F04
created: 2025-12-26
estimated_hours: 3
actual_hours:
effort: Small
tags:
  - ui
  - statusbar
  - file
  - counts
clickup_task_id: '86evzm35k'
---

# Spec: E06-F04-T04 - File and Object Count Display

## 1. Overview

### 1.1 Problem Statement

Users need to see which file is currently loaded and how many objects are visible in the current schematic view. The status bar should display the loaded filename with full path in tooltip, and show real-time counts of visible cells and nets that update as the user expands/collapses the circuit hierarchy.

### 1.2 Goals

- Display current file name (base name only) in status bar
- Show full file path in tooltip on hover
- Display "No file loaded" when no file is open
- Show visible cell count and net count
- Update object counts automatically on expand/collapse operations
- Format counts clearly: "Cells: N / Nets: M"

---

## 2. Technical Requirements

### 2.1 File Status Update Method

**File**: `src/ink/presentation/main_window.py`

```python
from pathlib import Path

def update_file_status(self, file_path: str | None):
    """Update file name in status bar.

    Args:
        file_path: Absolute path to loaded file, or None if no file loaded
    """
    if file_path:
        file_name = Path(file_path).name
        self.file_label.setText(f"File: {file_name}")
        self.file_label.setToolTip(file_path)  # Full path on hover
    else:
        self.file_label.setText("No file loaded")
        self.file_label.setToolTip("")
```

### 2.2 Object Count Update Method

```python
def update_object_count_status(self, cell_count: int, net_count: int):
    """Update visible object counts in status bar.

    Args:
        cell_count: Number of currently visible/rendered cells
        net_count: Number of currently visible/rendered nets
    """
    self.object_count_label.setText(f"Cells: {cell_count} / Nets: {net_count}")
```

### 2.3 Signal Connections

```python
def _connect_status_signals(self):
    """Connect signals to status bar update methods."""
    # File loading from file service
    if hasattr(self, 'file_service'):
        self.file_service.file_loaded.connect(self.update_file_status)
        self.file_service.file_closed.connect(lambda: self.update_file_status(None))

    # View changes from expansion service
    if hasattr(self, 'expansion_service'):
        self.expansion_service.view_changed.connect(self._update_view_counts)

def _update_view_counts(self):
    """Query and update visible object counts from expansion state."""
    if hasattr(self, 'expansion_state') and self.expansion_state:
        cell_count = len(self.expansion_state.visible_cells)
        net_count = len(self.expansion_state.visible_nets)
        self.update_object_count_status(cell_count, net_count)
    else:
        self.update_object_count_status(0, 0)
```

### 2.4 Status Display Formats

| Field | Format | Example | Tooltip |
|-------|--------|---------|---------|
| File (loaded) | "File: {basename}" | "File: design.ckt" | Full path: "/home/user/project/design.ckt" |
| File (none) | "No file loaded" | "No file loaded" | Empty |
| Object counts | "Cells: N / Nets: M" | "Cells: 45 / Nets: 67" | None |

### 2.5 Update Triggers

| Trigger | Status Field | Data Source |
|---------|--------------|-------------|
| File opened | File name | File service `file_loaded` signal |
| File closed | File name (clear) | File service `file_closed` signal |
| Cell expanded | Object counts | Expansion state `view_changed` signal |
| Cell collapsed | Object counts | Expansion state `view_changed` signal |
| Initial load | Object counts | Expansion state after parsing |

---

## 3. Dependencies

- **Upstream**:
  - E06-F04-T01 (Status Bar Setup - `file_label`, `object_count_label` widgets)
  - E01-F02 (File Loading Service - `file_loaded`/`file_closed` signals)
  - E03-F01 (Expansion Service - `view_changed` signal)
  - E01-F01 (Design Model - `expansion_state` with visible cells/nets)
- **Downstream**: None
- **External**: `pathlib.Path`, PySide6 signals/slots

---

## 4. Acceptance Criteria

- [ ] `update_file_status()` method implemented
- [ ] `update_object_count_status()` method implemented
- [ ] `_update_view_counts()` helper method implemented
- [ ] File name displays base name only (not full path)
- [ ] Full file path shown in tooltip on file label hover
- [ ] "No file loaded" shown when file_path is None
- [ ] Object counts display format "Cells: N / Nets: M"
- [ ] File status updates when file loaded/closed
- [ ] Object counts update when cells expanded/collapsed
- [ ] Signal connections handle missing services gracefully
- [ ] Counts show 0 when expansion state not available
- [ ] Unit tests verify text formatting and path handling
- [ ] Integration tests verify signal connections

---

## 5. Testing Strategy

### 5.1 Manual Testing

```python
# Test checklist:
# 1. Launch app - verify "No file loaded" and "Cells: 0 / Nets: 0"
# 2. Open sample .ckt file - verify file name displays
# 3. Hover over file name - verify full path in tooltip
# 4. After file loads - verify cell/net counts update
# 5. Double-click cell to expand - verify counts increase
# 6. Collapse cell - verify counts decrease
# 7. Close file - verify "No file loaded" and counts reset to 0
```

### 5.2 Unit Tests

```python
# tests/unit/presentation/test_main_window_file_status.py

def test_update_file_status_with_path(main_window):
    """File status should show base name with full path tooltip."""
    file_path = "/home/user/project/design.ckt"
    main_window.update_file_status(file_path)

    assert main_window.file_label.text() == "File: design.ckt"
    assert main_window.file_label.toolTip() == file_path

def test_update_file_status_no_file(main_window):
    """File status should show 'No file loaded' when path is None."""
    main_window.update_file_status(None)

    assert main_window.file_label.text() == "No file loaded"
    assert main_window.file_label.toolTip() == ""

def test_update_object_count_status(main_window):
    """Object count status should format correctly."""
    main_window.update_object_count_status(45, 67)
    assert main_window.object_count_label.text() == "Cells: 45 / Nets: 67"

    main_window.update_object_count_status(0, 0)
    assert main_window.object_count_label.text() == "Cells: 0 / Nets: 0"

    main_window.update_object_count_status(1, 1)
    assert main_window.object_count_label.text() == "Cells: 1 / Nets: 1"
```

### 5.3 Integration Tests

```python
# tests/integration/presentation/test_file_status_integration.py

def test_file_loaded_signal_updates_status(main_window, file_service):
    """File loaded signal should update file status."""
    file_path = "/path/to/circuit.ckt"
    file_service.file_loaded.emit(file_path)

    assert main_window.file_label.text() == "File: circuit.ckt"
    assert main_window.file_label.toolTip() == file_path

def test_file_closed_signal_clears_status(main_window, file_service):
    """File closed signal should clear file status."""
    # Load file first
    file_service.file_loaded.emit("/path/to/circuit.ckt")

    # Close file
    file_service.file_closed.emit()

    assert main_window.file_label.text() == "No file loaded"
    assert main_window.file_label.toolTip() == ""

def test_view_changed_updates_counts(main_window, expansion_service, expansion_state):
    """View changed signal should update object counts."""
    # Setup expansion state with visible objects
    expansion_state.visible_cells = {f"cell{i}" for i in range(10)}
    expansion_state.visible_nets = {f"net{i}" for i in range(15)}
    main_window.expansion_state = expansion_state

    # Emit view changed
    expansion_service.view_changed.emit()

    assert main_window.object_count_label.text() == "Cells: 10 / Nets: 15"
```

---

## 6. Implementation Checklist

- [ ] Import `Path` from `pathlib`
- [ ] Implement `update_file_status(file_path: str | None)` method
- [ ] Implement `update_object_count_status(cell_count, net_count)` method
- [ ] Implement `_update_view_counts()` helper method
- [ ] Connect `file_service.file_loaded` signal
- [ ] Connect `file_service.file_closed` signal
- [ ] Connect `expansion_service.view_changed` signal
- [ ] Handle missing services gracefully (hasattr checks)
- [ ] Handle missing expansion_state gracefully
- [ ] Set tooltip with full path for file label
- [ ] Clear tooltip when no file loaded
- [ ] Write unit tests for file status formatting
- [ ] Write unit tests for object count formatting
- [ ] Write integration tests for signal connections
- [ ] Test with various file paths (absolute, different lengths)
- [ ] Test with large object counts (1000+ cells/nets)

---

## 7. Edge Cases

| Edge Case | Behavior |
|-----------|----------|
| Services not initialized | Skip signal connections, no errors |
| Expansion state is None | Show "Cells: 0 / Nets: 0" |
| File path with unicode characters | Display correctly (Path handles unicode) |
| Very long file name | Truncate in display, full name in tooltip |
| File closed before expansion | Counts reset to 0 |
| Large object counts (10,000+) | Display normally, no performance impact |
| Rapid expand/collapse | Show final count (Qt coalesces signals) |

---

## 8. Service Integration

**Expected Signals**:

```python
# src/ink/application/services/file_service.py
class FileService:
    file_loaded = Signal(str)  # Emits absolute file path
    file_closed = Signal()     # Emits when file closed

# src/ink/application/services/expansion_service.py
class ExpansionService:
    view_changed = Signal()    # Emits when visible cells/nets change
```

**Expected Expansion State**:

```python
# src/ink/domain/model/expansion_state.py
class ExpansionState:
    visible_cells: set[str]  # Set of visible cell IDs
    visible_nets: set[str]   # Set of visible net IDs
```

---

## Revision History

| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-12-26 | 0.1 | Claude | Initial task creation from E06-F04 split |
