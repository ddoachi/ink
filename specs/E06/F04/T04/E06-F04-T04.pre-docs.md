# E06-F04-T04 - File and Object Count Display: Pre-Implementation Documentation

## Document Information
- **Task**: E06-F04-T04 - File and Object Count Display
- **Status**: Pre-Implementation Planning
- **Created**: 2025-12-26
- **Last Updated**: 2025-12-26

---

## 1. Overview and Context

### 1.1 Problem Statement

When exploring large gate-level netlists through incremental expansion, users lose track of two critical pieces of context:
1. **File context**: Which netlist file is currently loaded
2. **View scope**: How many cells and nets are currently visible in the schematic

Without this information, users experience disorientation:
- Uncertainty about which design they're analyzing (especially when switching between files)
- No awareness of schematic complexity (is this a simple view or massive expansion?)
- Difficulty judging when to collapse to simplify the view
- Lost context when returning to the application after time away

This task implements dual status indicators: file name display (with full path tooltip) and real-time visible object counts that update as users expand/collapse the circuit hierarchy.

### 1.2 User Impact

**Current State**: Users lack file and scope awareness
- No indication of loaded file (must check window title or File menu)
- No feedback on schematic size after expansion operations
- Uncertainty about view complexity ("Is this 10 cells or 1000?")
- Manual counting required to understand selection vs total objects

**Target State**: Persistent file and object count display
- Immediate file context (which design is loaded)
- Full path available on hover (resolves ambiguous filenames)
- Real-time cell and net counts
- Confidence in view scope during exploration
- Professional appearance matching industry EDA tools

### 1.3 Success Criteria

Implementation is successful when:
- File name displays on status bar immediately after file load
- Full file path appears in tooltip on hover
- "No file loaded" shown when no file is open
- Object counts show "Cells: 0 / Nets: 0" on launch
- Counts update automatically within 100ms of expand/collapse
- Format is clear and consistent: "Cells: N / Nets: M"
- File status clears when file closed
- Counts reset to zero when file closed

---

## 2. Implementation Approach

### 2.1 High-Level Strategy

**Architecture**: Presentation layer component with multi-service integration

This task integrates with two application services:
1. **File Service**: Provides file load/close events
2. **Expansion Service**: Provides view change notifications

**Data Flow Diagram**:
```
File Service (Application Layer)
    ↓ file_loaded(path: str) signal
    ↓ file_closed() signal
Main Window (Presentation Layer)
    → update_file_status(file_path: str | None)
    → Update file_label text and tooltip

Expansion Service (Application Layer)
    ↓ view_changed() signal
Main Window (Presentation Layer)
    → _update_view_counts()
    → Query expansion_state.visible_cells/nets
    → update_object_count_status(cell_count, net_count)
    → Update object_count_label text
```

**Key Principle**: Reactive updates via signals
- Main window doesn't poll services
- Services emit signals on state changes
- Main window updates UI in response
- No business logic in presentation layer

### 2.2 Component Design

**Update Methods**:

1. **File Status Update**:
   ```python
   def update_file_status(self, file_path: str | None):
       """Update file name in status bar with tooltip."""
       if file_path:
           file_name = Path(file_path).name
           self.file_label.setText(f"File: {file_name}")
           self.file_label.setToolTip(file_path)  # Full path
       else:
           self.file_label.setText("No file loaded")
           self.file_label.setToolTip("")
   ```

2. **Object Count Update**:
   ```python
   def update_object_count_status(self, cell_count: int, net_count: int):
       """Update visible object counts in status bar."""
       self.object_count_label.setText(f"Cells: {cell_count} / Nets: {net_count}")
   ```

3. **View Count Helper**:
   ```python
   def _update_view_counts(self):
       """Query expansion state and update counts."""
       if hasattr(self, 'expansion_state') and self.expansion_state:
           cell_count = len(self.expansion_state.visible_cells)
           net_count = len(self.expansion_state.visible_nets)
           self.update_object_count_status(cell_count, net_count)
       else:
           self.update_object_count_status(0, 0)
   ```

**Signal Connections**:
```python
def _connect_status_signals(self):
    """Connect signals to status bar update methods."""
    # File loading
    if hasattr(self, 'file_service'):
        self.file_service.file_loaded.connect(self.update_file_status)
        self.file_service.file_closed.connect(
            lambda: self.update_file_status(None)
        )

    # View changes
    if hasattr(self, 'expansion_service'):
        self.expansion_service.view_changed.connect(self._update_view_counts)
```

### 2.3 Alternative Approaches Considered

**Alternative 1: Store counts in expansion service**
- **Approach**: Expansion service tracks and emits counts
- **Rejected**: Violates separation (service shouldn't know about UI needs)
- **Trade-off**: Simpler main window but couples service to presentation

**Alternative 2: Display total design counts instead of visible counts**
- **Approach**: Show all cells/nets in file, not just visible
- **Rejected**: Less useful (doesn't reflect current view scope)
- **Trade-off**: Simpler (no expansion state dependency) but lower value

**Alternative 3: Combined file and count widget**
- **Approach**: Single label "design.ckt: 45 cells, 67 nets"
- **Rejected**: Violates separation of concerns, cluttered display
- **Trade-off**: Saves space but less scannable

---

## 3. Key Design Decisions

### 3.1 File Name Display Format

**Decision**: Show base name only, full path in tooltip

**Display Examples**:
| File Path | Display | Tooltip |
|-----------|---------|---------|
| `/home/user/project/design.ckt` | "File: design.ckt" | "/home/user/project/design.ckt" |
| `/long/path/to/circuit_v2.ckt` | "File: circuit_v2.ckt" | "/long/path/to/circuit_v2.ckt" |
| `None` (no file) | "No file loaded" | "" (empty) |

**Rationale**:
- **Base name only**: Saves status bar space, eliminates path clutter
- **Full path tooltip**: Provides disambiguation when needed
- **"File: " prefix**: Clearly labels what the text represents
- **Tooltip on hover**: Standard UI pattern for showing truncated info

**Implementation**:
```python
file_name = Path(file_path).name  # Extract base name
self.file_label.setToolTip(file_path)  # Full path on hover
```

### 3.2 Object Count Format

**Decision**: Show separate cell and net counts with slash separator

**Format**: `"Cells: {cell_count} / Nets: {net_count}"`

**Examples**:
| Visible Cells | Visible Nets | Display |
|---------------|--------------|---------|
| 0 | 0 | "Cells: 0 / Nets: 0" |
| 1 | 1 | "Cells: 1 / Nets: 1" |
| 45 | 67 | "Cells: 45 / Nets: 67" |
| 1234 | 5678 | "Cells: 1234 / Nets: 5678" |

**Rationale**:
- **Separate counts**: Users care about both cells and nets independently
- **Slash separator**: Compact visual separator, conventional format
- **Labels ("Cells:", "Nets:")**: Explicit labeling eliminates ambiguity
- **No abbreviation**: "Cells" clearer than "C:", sufficient space available

**Alternative Considered**: Combined count or cell-only
- **Rejected**: Net count valuable for understanding schematic density

### 3.3 Visible vs Total Counts

**Decision**: Show visible (rendered) counts, not total design counts

**Rationale**:
- **Visible counts**: Reflect current view state (incremental exploration)
- **Matches user intent**: "How big is my current view?"
- **Dynamic updates**: Changes as user expands/collapses
- **Actionable**: User can gauge view complexity, decide when to collapse

**Alternative Considered**: Show total design counts
- **Rejected**: Static number, doesn't reflect incremental exploration paradigm
- **Trade-off**: Less dynamic but simpler (no expansion state dependency)

**Future Enhancement**: Show both visible and total
- Display: "Cells: 45 / 1200"
- Tooltip: "45 visible of 1200 total cells"

### 3.4 Update Triggers

**Decision**: Update on file load/close and expansion state changes

**File Status Triggers**:
| Event | Signal | Action |
|-------|--------|--------|
| File opened | `file_service.file_loaded` | Show file name, set tooltip |
| File closed | `file_service.file_closed` | Show "No file loaded", clear tooltip |

**Object Count Triggers**:
| Event | Signal | Action |
|-------|--------|--------|
| Cell expanded | `expansion_service.view_changed` | Query expansion state, update counts |
| Cell collapsed | `expansion_service.view_changed` | Query expansion state, update counts |
| File loaded (initial) | `expansion_service.view_changed` | Show initial counts (may be 0 or top-level cells) |
| File closed | Implicit (expansion state cleared) | Counts reset to 0 |

**Rationale**:
- **Signal-driven**: No polling, efficient reactive updates
- **Single signal for expansion**: `view_changed` covers all expansion/collapse cases
- **Query pattern**: Main window queries expansion state on demand (pull model)

---

## 4. Dependencies and Integration Points

### 4.1 Upstream Dependencies

**E06-F04-T01: Status Bar Setup**
- **Required**: `self.file_label`, `self.object_count_label` widgets exist
- **Contract**: Widgets created before signal connections
- **Risk**: Low - enforced by initialization order

**E01-F02: File Loading Service**
- **Required**: `FileService` class with `file_loaded` and `file_closed` signals
- **Contract**:
  - `file_loaded` emits absolute file path as string
  - `file_closed` emits with no parameters
- **Signal Signatures**:
  ```python
  file_loaded = Signal(str)  # Absolute path
  file_closed = Signal()
  ```
- **Risk**: Medium - File service may not be implemented in MVP

**E03-F01: Expansion Service**
- **Required**: `ExpansionService` class with `view_changed` signal
- **Contract**: Signal emitted whenever visible cells/nets change
- **Signal Signature**: `view_changed = Signal()`
- **Risk**: Medium - Expansion service may not emit signal consistently

**E01-F01: Design Model - Expansion State**
- **Required**: `ExpansionState` class with `visible_cells` and `visible_nets` attributes
- **Contract**:
  - `visible_cells: set[str]` - Set of visible cell IDs
  - `visible_nets: set[str]` - Set of visible net IDs
- **Risk**: Low - Core domain model, likely stable

### 4.2 Downstream Dependencies

None - this task is a terminal node (provides UI feedback only)

### 4.3 Integration Sequence

**Initialization Order**:
```python
InkMainWindow.__init__():
    1. Setup central widget (canvas)
    2. _setup_status_bar()  # Create widgets
    3. Setup services:
       a. file_service (E01-F02)
       b. expansion_service (E03-F01)
       c. expansion_state (E01-F01)
    4. _connect_status_signals()  # Connect all signals ← This task
```

**Critical Constraints**:
- Status bar widgets must exist before signal connections
- Services must be initialized before connection attempts
- `expansion_state` may be None initially (before file load)

### 4.4 Graceful Degradation Strategy

**Missing Services Handling**:
```python
def _connect_status_signals(self):
    # File service (may not exist in MVP)
    if hasattr(self, 'file_service'):
        self.file_service.file_loaded.connect(self.update_file_status)
        self.file_service.file_closed.connect(lambda: self.update_file_status(None))
    else:
        logger.warning("File service not available, file status disabled")

    # Expansion service (may not exist in MVP)
    if hasattr(self, 'expansion_service'):
        self.expansion_service.view_changed.connect(self._update_view_counts)
    else:
        logger.warning("Expansion service not available, count updates disabled")
```

**Missing Expansion State Handling**:
```python
def _update_view_counts(self):
    if hasattr(self, 'expansion_state') and self.expansion_state:
        # Query counts
    else:
        # Show zeros
        self.update_object_count_status(0, 0)
```

---

## 5. Testing Strategy

### 5.1 Unit Testing Approach

**Test File**: `/home/joohan/dev/project-ink/ink/tests/unit/presentation/test_main_window_file_status.py`

**Test Categories**:

1. **File Status Tests**:
   ```python
   def test_update_file_status_with_path(main_window):
       file_path = "/home/user/project/design.ckt"
       main_window.update_file_status(file_path)

       assert main_window.file_label.text() == "File: design.ckt"
       assert main_window.file_label.toolTip() == file_path

   def test_update_file_status_no_file(main_window):
       main_window.update_file_status(None)

       assert main_window.file_label.text() == "No file loaded"
       assert main_window.file_label.toolTip() == ""

   def test_update_file_status_unicode_path(main_window):
       file_path = "/home/用户/设计/circuit.ckt"
       main_window.update_file_status(file_path)

       assert main_window.file_label.text() == "File: circuit.ckt"
       assert main_window.file_label.toolTip() == file_path
   ```

2. **Object Count Tests**:
   ```python
   def test_update_object_count_status(main_window):
       main_window.update_object_count_status(45, 67)
       assert main_window.object_count_label.text() == "Cells: 45 / Nets: 67"

   def test_update_object_count_status_zeros(main_window):
       main_window.update_object_count_status(0, 0)
       assert main_window.object_count_label.text() == "Cells: 0 / Nets: 0"

   def test_update_object_count_status_large_numbers(main_window):
       main_window.update_object_count_status(9999, 12345)
       assert main_window.object_count_label.text() == "Cells: 9999 / Nets: 12345"
   ```

3. **Path Handling Tests**:
   ```python
   def test_file_status_extracts_basename(main_window):
       paths = [
           "/simple/path/file.ckt",
           "/very/long/nested/path/to/design.ckt",
           "C:\\Windows\\Path\\circuit.ckt",  # Windows path
       ]
       for path in paths:
           main_window.update_file_status(path)
           assert "File: " in main_window.file_label.text()
           assert "/" not in main_window.file_label.text()  # No path separators
   ```

### 5.2 Integration Testing Approach

**Test File**: `/home/joohan/dev/project-ink/ink/tests/integration/presentation/test_file_status_integration.py`

**Test Scenarios**:

1. **File Load Signal**:
   ```python
   def test_file_loaded_signal_updates_status(main_window, file_service):
       file_path = "/path/to/circuit.ckt"
       file_service.file_loaded.emit(file_path)

       assert main_window.file_label.text() == "File: circuit.ckt"
       assert main_window.file_label.toolTip() == file_path
   ```

2. **File Close Signal**:
   ```python
   def test_file_closed_signal_clears_status(main_window, file_service):
       # Load file first
       file_service.file_loaded.emit("/path/to/circuit.ckt")
       assert "circuit.ckt" in main_window.file_label.text()

       # Close file
       file_service.file_closed.emit()
       assert main_window.file_label.text() == "No file loaded"
       assert main_window.file_label.toolTip() == ""
   ```

3. **View Changed Signal**:
   ```python
   def test_view_changed_updates_counts(main_window, expansion_service, expansion_state):
       # Setup expansion state
       expansion_state.visible_cells = {f"cell{i}" for i in range(10)}
       expansion_state.visible_nets = {f"net{i}" for i in range(15)}
       main_window.expansion_state = expansion_state

       # Emit signal
       expansion_service.view_changed.emit()

       assert main_window.object_count_label.text() == "Cells: 10 / Nets: 15"
   ```

4. **Expansion State None Handling**:
   ```python
   def test_view_changed_with_no_expansion_state(main_window, expansion_service):
       main_window.expansion_state = None

       expansion_service.view_changed.emit()

       assert main_window.object_count_label.text() == "Cells: 0 / Nets: 0"
   ```

### 5.3 Manual Testing Checklist

**File Status**:
1. Launch app → verify "No file loaded"
2. Open sample .ckt file → verify base name displays
3. Hover over file name → verify full path in tooltip
4. Close file → verify "No file loaded" returns
5. Open file with long path → verify only basename shown
6. Open file with unicode characters → verify correct display

**Object Counts**:
1. After file load → verify counts update (may be 0 or initial cells)
2. Double-click cell to expand → verify counts increase
3. Expand multiple times → verify counts accumulate correctly
4. Collapse cell → verify counts decrease
5. Close file → verify counts reset to "Cells: 0 / Nets: 0"

**Integration**:
1. Load file, expand, check counts
2. Close file → verify both file and counts clear
3. Load different file → verify file name updates, counts reset

---

## 6. Risks and Considerations

### 6.1 Technical Risks

**Risk 1: Services Not Implemented**
- **Impact**: High - Feature cannot function without services
- **Probability**: High - MVP may not include all services
- **Mitigation**: Defensive `hasattr()` checks, graceful degradation
- **Fallback**: Static display ("No file loaded", "Cells: 0 / Nets: 0")

**Risk 2: Expansion State Synchronization**
- **Impact**: Medium - Counts may not reflect actual visible objects
- **Probability**: Medium - Race conditions, missed signals
- **Mitigation**:
  - Expansion service emits signal after state update (contract)
  - Main window queries state on demand (latest value)
  - Integration tests verify synchronization

**Risk 3: Path Handling Edge Cases**
- **Impact**: Low - Unusual paths may display incorrectly
- **Probability**: Low - `Path.name` handles most cases
- **Mitigation**: Test with various path formats (Windows, Unicode, spaces)

**Risk 4: Very Long Filenames**
- **Impact**: Low - Text truncation in status bar
- **Probability**: Low - Most filenames <50 characters
- **Mitigation**: Widget minimum width (200px) accommodates long names, full path in tooltip

### 6.2 UX Risks

**Risk 1: Users Want Total Counts Instead of Visible**
- **Impact**: Medium - Display doesn't match user expectations
- **Probability**: Medium - Depends on user mental model
- **Mitigation**: User testing, consider showing both visible/total if feedback indicates need

**Risk 2: Tooltip Not Discoverable**
- **Impact**: Low - Users don't find full path
- **Probability**: Medium - Tooltips require hover discovery
- **Mitigation**: Standard UI pattern, acceptable trade-off for space savings

**Risk 3: Count Updates Distracting**
- **Impact**: Low - Rapid count changes during expansion draw attention
- **Probability**: Low - Users expect feedback during operations
- **Mitigation**: Updates happen during user actions (expansion), feel responsive

### 6.3 Integration Risks

**Risk 1: Signal Connection Order**
- **Impact**: High - Signals connected before widgets exist → AttributeError
- **Probability**: Low - Initialization order enforced
- **Mitigation**: Call `_connect_status_signals()` after status bar and services setup

**Risk 2: Expansion State Lifetime**
- **Impact**: Medium - State may be destroyed while main window references it
- **Probability**: Low - State owned by design, lives with file
- **Mitigation**: Check `expansion_state` not None before accessing

**Risk 3: Signal Emission Gaps**
- **Impact**: Low - Counts stale if `view_changed` not emitted
- **Probability**: Low - Expansion service spec defines signal contract
- **Mitigation**: Integration tests verify signal emitted on expand/collapse

---

## 7. Performance Considerations

### 7.1 File Status Update Performance

**Operation Cost**: <1ms per update
- Path extraction: ~0.1ms - `Path(file_path).name`
- String formatting: ~0.1ms - `f"File: {file_name}"`
- setText() + setToolTip(): ~0.5ms

**Frequency**: Very low (file open/close events)
- Negligible impact on application performance

### 7.2 Object Count Update Performance

**Operation Cost**: <5ms per update
- Set length query: O(1) - `len(expansion_state.visible_cells)`
- Two length queries: ~0.1ms total
- String formatting: ~0.1ms
- setText(): ~0.5ms

**Frequency**: Variable (depends on expansion rate)
- Expand operation: Single update after operation completes
- Collapse operation: Single update after operation completes
- Not high-frequency (user-initiated actions)

**Scalability**:
| Visible Objects | Query Time | Notes |
|-----------------|------------|-------|
| 10 cells, 15 nets | <1ms | Typical small view |
| 100 cells, 150 nets | <1ms | Medium view |
| 1000 cells, 1500 nets | <1ms | Large view |

**Set length is O(1)**: Python set stores size, no iteration needed

### 7.3 Memory Overhead

**Per Update**: Negligible
- Temporary string allocations: ~100 bytes
- Strings garbage collected after setText()
- No persistent storage

---

## 8. Implementation Checklist

**Code Implementation**:
- [ ] Import `Path` from `pathlib` in `main_window.py`
- [ ] Implement `update_file_status(file_path: str | None)` method
- [ ] Add type hints for method signature (use `str | None`)
- [ ] Extract base name with `Path(file_path).name`
- [ ] Set text: `f"File: {file_name}"` or `"No file loaded"`
- [ ] Set tooltip with full path or empty string
- [ ] Add docstring for file status method
- [ ] Implement `update_object_count_status(cell_count: int, net_count: int)` method
- [ ] Format text: `f"Cells: {cell_count} / Nets: {net_count}"`
- [ ] Add docstring for count status method
- [ ] Implement `_update_view_counts()` helper method
- [ ] Check expansion_state existence and validity
- [ ] Query `len(expansion_state.visible_cells)` and `len(expansion_state.visible_nets)`
- [ ] Call `update_object_count_status()` with counts
- [ ] Extend `_connect_status_signals()` method
- [ ] Add `hasattr()` check for `file_service`
- [ ] Connect `file_service.file_loaded` signal
- [ ] Connect `file_service.file_closed` signal with lambda
- [ ] Add `hasattr()` check for `expansion_service`
- [ ] Connect `expansion_service.view_changed` signal
- [ ] Add logging for signal connections (debug level)

**Testing**:
- [ ] Write unit test for file status with path
- [ ] Write unit test for file status with None (no file)
- [ ] Write unit test for path extraction (basename only)
- [ ] Write unit test for tooltip setting
- [ ] Write unit test for object counts (various values)
- [ ] Write unit test for zero counts
- [ ] Write integration test for file_loaded signal
- [ ] Write integration test for file_closed signal
- [ ] Write integration test for view_changed signal
- [ ] Write integration test for expansion_state None handling
- [ ] Run manual testing checklist
- [ ] Test with unicode paths
- [ ] Test with very long filenames
- [ ] Test with large cell/net counts (1000+)

**Documentation**:
- [ ] Add docstrings to all three methods
- [ ] Document signal connections in `_connect_status_signals()` docstring
- [ ] Add inline comments for defensive checks
- [ ] Update class docstring if needed

**Code Review**:
- [ ] Verify `Path` import correct
- [ ] Check type hints use `str | None` (Python 3.10+ syntax)
- [ ] Confirm defensive `hasattr()` checks present
- [ ] Verify tooltip cleared when no file
- [ ] Check format strings match spec
- [ ] Peer review completed

---

## 9. Open Questions

### 9.1 Resolved Questions

**Q1: Show base name or full path in status bar?**
- **Answer**: Base name only, full path in tooltip
- **Rationale**: Saves space, provides disambiguation when needed
- **Decided**: 2025-12-26

**Q2: Visible counts or total design counts?**
- **Answer**: Visible counts (matches incremental exploration paradigm)
- **Rationale**: Reflects current view state, more actionable
- **Decided**: 2025-12-26

**Q3: Combined or separate cell/net counts?**
- **Answer**: Separate with slash separator: "Cells: N / Nets: M"
- **Rationale**: Both counts valuable, clear labeling
- **Decided**: 2025-12-26

**Q4: How to handle missing services?**
- **Answer**: Graceful degradation with `hasattr()` checks
- **Decided**: 2025-12-26

### 9.2 Outstanding Questions

**Q1: Should we show visible/total counts?**
- **Current**: Visible counts only
- **Future**: "Cells: 45 / 1200" (visible / total) if user feedback indicates need
- **Priority**: P1 - enhancement after MVP

**Q2: Should file label be clickable (e.g., to reveal in file manager)?**
- **Current**: Static display only
- **Future**: Click to open containing folder, copy path to clipboard
- **Priority**: P1 - enhancement after MVP

**Q3: Should large counts be abbreviated?**
- **Current**: Full numbers "Cells: 1234"
- **Future**: Abbreviated "Cells: 1.2K" for very large views
- **Priority**: Low - defer unless performance issues or user feedback

**Q4: Should counts include pins?**
- **Current**: Cells and nets only
- **Future**: "Cells: N / Nets: M / Pins: P"
- **Priority**: Low - pins less critical, would clutter display

---

## 10. References

- **Primary Spec**: `/home/joohan/dev/project-ink/ink/specs/E06/F04/T04/E06-F04-T04.spec.md`
- **Parent Feature**: `/home/joohan/dev/project-ink/ink/specs/E06/F04/E06-F04.spec.md`
- **Upstream Dependency**: `/home/joohan/dev/project-ink/ink/specs/E06/F04/T01/E06-F04-T01.spec.md`
- **File Service**: `/home/joohan/dev/project-ink/ink/specs/E01/F02/E01-F02.spec.md`
- **Expansion Service**: `/home/joohan/dev/project-ink/ink/specs/E03/F01/E03-F01.spec.md`
- **Design Model**: `/home/joohan/dev/project-ink/ink/specs/E01/F01/E01-F01.spec.md`
- **Python pathlib**: [pathlib.Path Documentation](https://docs.python.org/3/library/pathlib.html)
- **Qt Tooltips**: [QWidget.setToolTip](https://doc.qt.io/qt-6/qwidget.html#toolTip-prop)

---

## 11. Revision History

| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-12-26 | 1.0 | Claude | Initial pre-implementation documentation |
