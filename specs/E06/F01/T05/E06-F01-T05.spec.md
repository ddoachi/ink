---
id: E06-F01-T05
title: Integration Testing and Polish
type: Task
priority: P0 (MVP)
status: Draft
parent: E06-F01
created: 2025-12-26
estimated_hours: 3
actual_hours:
effort: Medium
tags:
  - testing
  - integration
  - qa
  - polish
---

# Spec: E06-F01-T05 - Integration Testing and Polish

## 1. Overview

### 1.1 Problem Statement
After implementing the main window components individually (T01-T04), we need comprehensive integration testing to verify all components work together correctly. Additionally, UI polish is needed to ensure professional appearance, consistent styling, and smooth user experience.

### 1.2 Goals
- Create integration test suite covering full main window
- Verify all components interact correctly
- Add UI polish: styling, spacing, visual consistency
- Test window geometry, dock behavior, and lifecycle
- Document known issues and workarounds
- Ensure acceptance criteria from parent spec are met

---

## 2. Technical Requirements

### 2.1 Integration Test Suite

**Location**: `tests/integration/presentation/test_main_window_integration.py`

```python
"""
Integration tests for main window assembly.

Tests that all components (window, canvas, docks) work together correctly.
"""

import pytest
from PySide6.QtWidgets import QApplication
from PySide6.QtCore import Qt, QTimer
from ink.presentation.main_window import InkMainWindow


@pytest.fixture(scope="module")
def qapp():
    """Create QApplication for Qt widgets."""
    app = QApplication.instance()
    if app is None:
        app = QApplication([])
    yield app


@pytest.fixture
def main_window(qapp):
    """Create main window for tests."""
    window = InkMainWindow()
    yield window
    window.close()


class TestMainWindowComponents:
    """Test main window component assembly."""

    def test_window_exists(self, main_window):
        """Test main window is created."""
        assert main_window is not None

    def test_window_title(self, main_window):
        """Test window has correct title."""
        assert main_window.windowTitle() == "Ink - Incremental Schematic Viewer"

    def test_window_size(self, main_window):
        """Test window has correct default size."""
        assert main_window.width() == 1600
        assert main_window.height() == 900

    def test_window_minimum_size(self, main_window):
        """Test window has correct minimum size."""
        min_size = main_window.minimumSize()
        assert min_size.width() == 1024
        assert min_size.height() == 768

    def test_central_widget_exists(self, main_window):
        """Test central widget is set."""
        assert main_window.centralWidget() is not None
        assert main_window.centralWidget() == main_window.schematic_canvas

    def test_all_docks_exist(self, main_window):
        """Test all dock widgets are created."""
        assert hasattr(main_window, 'hierarchy_dock')
        assert hasattr(main_window, 'property_dock')
        assert hasattr(main_window, 'message_dock')


class TestDockWidgetConfiguration:
    """Test dock widget setup and behavior."""

    def test_dock_positions(self, main_window):
        """Test docks are in correct areas."""
        assert main_window.dockWidgetArea(main_window.hierarchy_dock) == \
               Qt.DockWidgetArea.LeftDockWidgetArea
        assert main_window.dockWidgetArea(main_window.property_dock) == \
               Qt.DockWidgetArea.RightDockWidgetArea
        assert main_window.dockWidgetArea(main_window.message_dock) == \
               Qt.DockWidgetArea.BottomDockWidgetArea

    def test_dock_titles(self, main_window):
        """Test dock widgets have correct titles."""
        assert main_window.hierarchy_dock.windowTitle() == "Hierarchy"
        assert main_window.property_dock.windowTitle() == "Properties"
        assert main_window.message_dock.windowTitle() == "Messages"

    def test_docks_are_visible(self, main_window):
        """Test all docks are visible by default."""
        assert main_window.hierarchy_dock.isVisible()
        assert main_window.property_dock.isVisible()
        assert main_window.message_dock.isVisible()

    def test_docks_are_closable(self, main_window):
        """Test dock widgets can be closed."""
        # Test hierarchy dock
        main_window.hierarchy_dock.close()
        assert not main_window.hierarchy_dock.isVisible()

        # Re-show for other tests
        main_window.hierarchy_dock.show()
        assert main_window.hierarchy_dock.isVisible()


class TestWindowLifecycle:
    """Test window lifecycle and cleanup."""

    def test_window_can_be_shown(self, qapp):
        """Test window can be shown and closed."""
        window = InkMainWindow()
        window.show()
        assert window.isVisible()
        window.close()
        assert not window.isVisible()

    def test_window_deletion(self, qapp):
        """Test window can be deleted cleanly."""
        window = InkMainWindow()
        window.show()
        window.close()
        window.deleteLater()
        # Process events to trigger deletion
        qapp.processEvents()


class TestWindowGeometry:
    """Test window geometry behavior."""

    def test_window_can_be_resized(self, main_window):
        """Test window can be resized above minimum."""
        main_window.resize(1920, 1080)
        assert main_window.width() == 1920
        assert main_window.height() == 1080

    def test_window_respects_minimum_size(self, main_window):
        """Test window cannot be resized below minimum."""
        # Attempt to resize below minimum
        main_window.resize(800, 600)
        main_window.show()  # Size constraints apply when shown

        # Should be clamped to minimum
        assert main_window.width() >= 1024
        assert main_window.height() >= 768
```

### 2.2 UI Polish Requirements

**Styling improvements** (`src/ink/presentation/main_window.py`):

```python
def _setup_window(self):
    """Configure main window properties."""
    self.setWindowTitle("Ink - Incremental Schematic Viewer")
    self.resize(1600, 900)
    self.setMinimumSize(QSize(1024, 768))

    # Enable unified title and toolbar on macOS (future-proofing)
    self.setUnifiedTitleAndToolBarOnMac(True)

    # Set dock nesting enabled (allows complex layouts)
    self.setDockNestingEnabled(True)

    # Set animated docks for smooth transitions
    self.setAnimated(True)

    # Set stylesheet for consistent appearance
    self.setStyleSheet("""
        QMainWindow {
            background-color: #f5f5f5;
        }
        QDockWidget {
            titlebar-close-icon: url(close.png);
            titlebar-normal-icon: url(float.png);
        }
        QDockWidget::title {
            background-color: #e0e0e0;
            padding: 4px;
            border: 1px solid #c0c0c0;
        }
    """)
```

**Splitter styling** (for dock resize handles):

```python
def _setup_dock_widgets(self):
    """Create and configure dockable panels."""
    # ... existing dock creation ...

    # Style the dock splitters for better visibility
    self.setStyleSheet(self.styleSheet() + """
        QSplitter::handle {
            background-color: #d0d0d0;
        }
        QSplitter::handle:hover {
            background-color: #b0b0b0;
        }
        QSplitter::handle:horizontal {
            width: 2px;
        }
        QSplitter::handle:vertical {
            height: 2px;
        }
    """)
```

### 2.3 Manual Testing Checklist

Create testing documentation:

**Location**: `docs/testing/manual-testing-e06-f01.md`

```markdown
# Manual Testing Checklist: E06-F01 Main Window Shell

## Test Environment
- OS: Linux (X11 / Wayland)
- Display: 1080p / 1440p / 4K
- Window Manager: [GNOME / KDE / i3]

## Test Cases

### TC-01: Application Launch
- [ ] Run `python -m ink` from terminal
- [ ] Application launches without errors
- [ ] Window appears within 2 seconds
- [ ] Console shows startup log messages
- [ ] No error messages in console

### TC-02: Window Appearance
- [ ] Window title is "Ink - Incremental Schematic Viewer"
- [ ] Window size is approximately 1600x900
- [ ] Window decorations (title bar, borders) visible
- [ ] Minimize/maximize/close buttons present

### TC-03: Layout Structure
- [ ] Central area shows "Schematic Canvas Area" placeholder
- [ ] Left panel shows "Hierarchy Panel" placeholder
- [ ] Right panel shows "Property Panel" placeholder
- [ ] Bottom panel shows "Message Panel" placeholder

### TC-04: Dock Widget Operations
- [ ] Click hierarchy dock close button → panel hides
- [ ] Click property dock close button → panel hides
- [ ] Click message dock close button → panel hides
- [ ] Drag hierarchy dock title bar → dock undocks and floats
- [ ] Drag floating dock to left area → dock re-docks
- [ ] Drag dock splitter handles → panels resize

### TC-05: Window Controls
- [ ] Click minimize button → window minimizes to taskbar
- [ ] Click on taskbar icon → window restores
- [ ] Click maximize button → window fills screen
- [ ] Click maximize again → window restores to previous size
- [ ] Click close button → window closes, app exits

### TC-06: Resizing
- [ ] Drag window edges to resize → window resizes smoothly
- [ ] Try to resize below 1024x768 → window stops at minimum
- [ ] Resize above 1600x900 → panels adjust proportionally

### TC-07: Application Exit
- [ ] Close window via close button → app exits cleanly
- [ ] Console shows exit log message
- [ ] No zombie processes remain (check with `ps`)
```

### 2.4 Performance Testing

**Startup performance test**:

```python
# tests/performance/test_startup_time.py

import time
import pytest
from PySide6.QtWidgets import QApplication
from ink.presentation.main_window import InkMainWindow


@pytest.fixture(scope="module")
def qapp():
    app = QApplication.instance() or QApplication([])
    yield app


def test_window_creation_time(qapp, benchmark):
    """Benchmark main window creation time."""
    def create_window():
        window = InkMainWindow()
        window.deleteLater()
        return window

    result = benchmark(create_window)
    assert result is not None


def test_startup_time_under_2_seconds(qapp):
    """Verify startup meets 2-second requirement."""
    start = time.time()

    window = InkMainWindow()
    window.show()
    qapp.processEvents()  # Process show event

    elapsed = time.time() - start

    window.close()
    window.deleteLater()

    assert elapsed < 2.0, f"Startup took {elapsed:.2f}s, exceeds 2s limit"
```

---

## 3. Dependencies

### 3.1 Upstream
- Task E06-F01-T01: Window setup
- Task E06-F01-T02: Central widget
- Task E06-F01-T03: Dock widgets
- Task E06-F01-T04: Entry point

### 3.2 Downstream
- Enables subsequent E06 features (menu, toolbar, status bar)
- Foundation for Epic E02 (rendering)

### 3.3 External Dependencies
- pytest for testing
- pytest-qt for Qt testing
- pytest-benchmark for performance testing (optional)

---

## 4. Acceptance Criteria

### 4.1 Integration Testing
- [ ] All integration tests pass
- [ ] Test coverage > 85% for presentation layer
- [ ] No Qt warnings in test output
- [ ] Tests run in < 10 seconds

### 4.2 Manual Testing
- [ ] All manual test cases pass
- [ ] Tested on at least one Linux window manager
- [ ] No visual glitches or layout issues
- [ ] Dock operations smooth and responsive

### 4.3 Performance
- [ ] Application launches in < 2 seconds
- [ ] Window creation benchmark < 500ms
- [ ] No memory leaks in repeated create/destroy cycles

### 4.4 Visual Polish
- [ ] Consistent panel padding and margins
- [ ] Dock splitter handles visible and responsive
- [ ] Placeholder text clearly readable
- [ ] Professional appearance matching EDA tool standards

### 4.5 Parent Spec Validation
- [ ] All E06-F01 acceptance criteria met
- [ ] All user stories satisfied
- [ ] Technical requirements implemented
- [ ] Dependencies identified and documented

---

## 5. Implementation Notes

### 5.1 Testing Challenges

**Qt event loop in tests**:
- Qt widgets require `QApplication` to exist
- Use module-scoped `qapp` fixture to avoid repeated creation
- Call `processEvents()` to flush event queue in timing-sensitive tests

**Window visibility in tests**:
- Most tests don't need `window.show()` (layout works without display)
- Geometry constraints only apply when window is shown
- Use `QTest.qWaitForWindowExposed(window)` for tests requiring visible window

**Fixture cleanup**:
- Always close windows in test teardown
- Use `deleteLater()` to schedule Qt object deletion
- Process events after `deleteLater()` to trigger cleanup

### 5.2 UI Polish Considerations

**Stylesheet approach**:
- Keep stylesheets minimal for MVP
- Future: Move to separate `.qss` file for maintainability
- Test on both light and dark system themes

**Dock animations**:
- Qt's built-in animations are smooth on modern hardware
- Can be disabled via `setAnimated(False)` if performance issues

**Splitter handle visibility**:
- Default Qt splitter handles are subtle (1px)
- Custom styling makes them more discoverable
- Hover effect provides feedback

### 5.3 Known Issues and Workarounds

**Issue: Exact dock sizing on first show**
- Qt's dock layout is complex, initial sizes are approximate
- Workaround: Set minimum sizes, let user adjust
- Future: Use `QSplitter` or save/restore geometry (E06-F05)

**Issue: Wayland window decorations**
- Some Wayland compositors override window flags
- Workaround: Trust compositor's decoration choices
- Not a blocker, cosmetic only

**Issue: High DPI displays**
- Qt should handle automatically, but test on HiDPI
- May need: `QApplication.setAttribute(Qt.AA_EnableHighDpiScaling)`

### 5.4 Documentation Updates

After testing completion, update:
- **Parent spec (E06-F01)**: Mark acceptance criteria complete
- **Parent spec (E06-F01)**: Update child specs table with status
- **README.md**: Add screenshot of main window
- **Architecture docs**: Confirm presentation layer structure

---

## Revision History
| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-12-26 | 0.1 | Claude | Initial task creation from E06-F01 split |
