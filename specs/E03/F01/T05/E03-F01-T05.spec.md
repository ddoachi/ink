---
id: E03-F01-T05
title: N-Hop Configuration
type: Task
priority: P0 (MVP)
status: Draft
parent: E03-F01
created: 2025-12-26
estimated_hours: 6
actual_hours:
effort: Medium
tags:
  - ui
  - settings
  - configuration
  - ux
clickup_task_id: ''
---

# Spec: E03-F01-T05 - N-Hop Configuration

## 1. Overview

### 1.1 Problem Statement

While keyboard modifiers provide quick access to 1, 2, 3, and 5-hop expansion, users need a more flexible way to specify arbitrary hop counts and configure default expansion behavior. A settings dialog and context menu with custom hop input enables users to tailor expansion to their specific analysis needs.

### 1.2 Goals

- Provide UI for configuring default hop count (1-5)
- Allow custom N-hop input via dialog or context menu
- Support quick presets (1, 2, 3, 5 hops) in context menu
- Persist user preferences across sessions
- Validate hop count input (minimum 1, maximum configurable)
- Display current hop count setting in UI

---

## 2. Technical Requirements

### 2.1 Expansion Settings Dialog

**Location**: `src/ink/presentation/dialogs/expansion_settings_dialog.py`

```python
from PySide6.QtWidgets import (
    QDialog, QVBoxLayout, QHBoxLayout,
    QLabel, QSpinBox, QPushButton, QGroupBox
)
from PySide6.QtCore import Signal

class ExpansionSettingsDialog(QDialog):
    """Dialog for configuring expansion behavior"""

    settings_changed = Signal(dict)  # Emits updated settings

    def __init__(self, parent=None):
        super().__init__(parent)
        self.setWindowTitle("Expansion Settings")
        self._init_ui()
        self._load_settings()

    def _init_ui(self) -> None:
        """Initialize UI components"""
        layout = QVBoxLayout(self)

        # Default hop count setting
        hop_group = QGroupBox("Default Hop Count")
        hop_layout = QHBoxLayout(hop_group)

        hop_label = QLabel("Default hops:")
        self._hop_spinbox = QSpinBox()
        self._hop_spinbox.setMinimum(1)
        self._hop_spinbox.setMaximum(10)
        self._hop_spinbox.setValue(1)
        self._hop_spinbox.setToolTip("Default number of hops for double-click expansion")

        hop_layout.addWidget(hop_label)
        hop_layout.addWidget(self._hop_spinbox)
        hop_layout.addStretch()

        layout.addWidget(hop_group)

        # Keyboard modifier settings
        modifier_group = QGroupBox("Keyboard Modifier Overrides")
        modifier_layout = QVBoxLayout(modifier_group)

        modifier_layout.addWidget(QLabel("Shift: 2 hops"))
        modifier_layout.addWidget(QLabel("Ctrl: 3 hops"))
        modifier_layout.addWidget(QLabel("Shift+Ctrl: 5 hops"))
        modifier_layout.addWidget(QLabel("(Modifiers override default hop count)"))

        layout.addWidget(modifier_group)

        # Buttons
        button_layout = QHBoxLayout()
        ok_button = QPushButton("OK")
        cancel_button = QPushButton("Cancel")

        ok_button.clicked.connect(self.accept)
        cancel_button.clicked.connect(self.reject)

        button_layout.addStretch()
        button_layout.addWidget(ok_button)
        button_layout.addWidget(cancel_button)

        layout.addLayout(button_layout)

    def _load_settings(self) -> None:
        """Load settings from QSettings"""
        from PySide6.QtCore import QSettings
        settings = QSettings("Ink", "SchematicViewer")
        default_hops = settings.value("expansion/default_hops", 1, type=int)
        self._hop_spinbox.setValue(default_hops)

    def accept(self) -> None:
        """Save settings and close dialog"""
        self._save_settings()
        super().accept()

    def _save_settings(self) -> None:
        """Save settings to QSettings"""
        from PySide6.QtCore import QSettings
        settings = QSettings("Ink", "SchematicViewer")
        settings.setValue("expansion/default_hops", self._hop_spinbox.value())

        # Emit settings changed signal
        self.settings_changed.emit({
            "default_hops": self._hop_spinbox.value()
        })

    def get_default_hop_count(self) -> int:
        """Get configured default hop count"""
        return self._hop_spinbox.value()
```

### 2.2 Custom N-Hop Input Dialog

**Location**: `src/ink/presentation/dialogs/custom_hop_dialog.py`

```python
from PySide6.QtWidgets import QDialog, QVBoxLayout, QHBoxLayout, QLabel, QSpinBox, QPushButton

class CustomHopDialog(QDialog):
    """Simple dialog for entering custom hop count"""

    def __init__(self, direction: str, parent=None):
        """
        Args:
            direction: "fanin" or "fanout" for dialog title
        """
        super().__init__(parent)
        self.setWindowTitle(f"Expand {direction.capitalize()} - Custom Hops")
        self._hop_count = 1
        self._init_ui()

    def _init_ui(self) -> None:
        """Initialize UI"""
        layout = QVBoxLayout(self)

        # Hop count input
        input_layout = QHBoxLayout()
        input_layout.addWidget(QLabel("Number of hops:"))

        self._spinbox = QSpinBox()
        self._spinbox.setMinimum(1)
        self._spinbox.setMaximum(10)
        self._spinbox.setValue(1)
        input_layout.addWidget(self._spinbox)

        layout.addLayout(input_layout)

        # Buttons
        button_layout = QHBoxLayout()
        ok_button = QPushButton("OK")
        cancel_button = QPushButton("Cancel")

        ok_button.clicked.connect(self.accept)
        cancel_button.clicked.connect(self.reject)

        button_layout.addStretch()
        button_layout.addWidget(ok_button)
        button_layout.addWidget(cancel_button)

        layout.addLayout(button_layout)

    def get_hop_count(self) -> int:
        """Get entered hop count"""
        return self._spinbox.value()
```

### 2.3 Enhanced Context Menu with N-Hop Options

**Location**: `src/ink/presentation/canvas/schematic_canvas.py`

Update context menu to include custom hop option:

```python
from ink.presentation.dialogs.custom_hop_dialog import CustomHopDialog

class SchematicCanvas(QGraphicsView):
    # ... (previous code)

    def contextMenuEvent(self, event: QContextMenuEvent) -> None:
        """Show context menu with expansion options including custom N-hop"""
        pos = event.pos()
        item = self.itemAt(pos)

        if item is None:
            return

        menu = QMenu(self)

        if isinstance(item, (PinItem, NetItem, CellItem)):
            # Quick hop presets
            menu.addAction("Expand Fanout (1 hop)",
                          lambda: self._expand_from_item(item, "fanout", 1))
            menu.addAction("Expand Fanout (2 hops)",
                          lambda: self._expand_from_item(item, "fanout", 2))
            menu.addAction("Expand Fanout (3 hops)",
                          lambda: self._expand_from_item(item, "fanout", 3))
            menu.addAction("Expand Fanout (5 hops)",
                          lambda: self._expand_from_item(item, "fanout", 5))

            # Custom N-hop option
            custom_fanout_action = menu.addAction("Expand Fanout (N hops)...")
            custom_fanout_action.triggered.connect(
                lambda: self._expand_custom_hops(item, "fanout")
            )

            menu.addSeparator()

            # Same for fanin
            menu.addAction("Expand Fanin (1 hop)",
                          lambda: self._expand_from_item(item, "fanin", 1))
            menu.addAction("Expand Fanin (2 hops)",
                          lambda: self._expand_from_item(item, "fanin", 2))
            menu.addAction("Expand Fanin (3 hops)",
                          lambda: self._expand_from_item(item, "fanin", 3))
            menu.addAction("Expand Fanin (5 hops)",
                          lambda: self._expand_from_item(item, "fanin", 5))

            custom_fanin_action = menu.addAction("Expand Fanin (N hops)...")
            custom_fanin_action.triggered.connect(
                lambda: self._expand_custom_hops(item, "fanin")
            )

        menu.exec_(event.globalPos())

    def _expand_custom_hops(self, item, direction: str) -> None:
        """Show dialog for custom hop count input"""
        dialog = CustomHopDialog(direction=direction, parent=self)

        if dialog.exec() == QDialog.Accepted:
            hop_count = dialog.get_hop_count()
            self._expand_from_item(item, direction, hop_count)
```

### 2.4 Settings Integration in Main Window

**Location**: `src/ink/presentation/main_window.py`

Add menu item to open expansion settings:

```python
from ink.presentation.dialogs.expansion_settings_dialog import ExpansionSettingsDialog

class MainWindow(QMainWindow):
    def _create_menu_bar(self) -> None:
        """Create menu bar with settings"""
        menu_bar = self.menuBar()

        # Edit menu
        edit_menu = menu_bar.addMenu("&Edit")
        settings_action = edit_menu.addAction("&Preferences...")
        settings_action.triggered.connect(self._show_settings_dialog)

    def _show_settings_dialog(self) -> None:
        """Show expansion settings dialog"""
        dialog = ExpansionSettingsDialog(parent=self)
        dialog.settings_changed.connect(self._on_settings_changed)

        if dialog.exec() == QDialog.Accepted:
            # Settings were saved
            pass

    def _on_settings_changed(self, settings: dict) -> None:
        """Handle settings change"""
        default_hops = settings.get("default_hops", 1)
        self._canvas.set_default_hop_count(default_hops)
```

### 2.5 Settings Persistence

Use `QSettings` for cross-session persistence:

```python
from PySide6.QtCore import QSettings

class SettingsManager:
    """Centralized settings management"""

    ORGANIZATION = "Ink"
    APPLICATION = "SchematicViewer"

    @staticmethod
    def get_default_hop_count() -> int:
        """Get default hop count from settings"""
        settings = QSettings(SettingsManager.ORGANIZATION, SettingsManager.APPLICATION)
        return settings.value("expansion/default_hops", 1, type=int)

    @staticmethod
    def set_default_hop_count(hops: int) -> None:
        """Save default hop count to settings"""
        if hops < 1:
            raise ValueError("Hop count must be >= 1")

        settings = QSettings(SettingsManager.ORGANIZATION, SettingsManager.APPLICATION)
        settings.setValue("expansion/default_hops", hops)
```

---

## 3. Testing Requirements

### 3.1 Unit Tests

**Location**: `tests/unit/presentation/dialogs/test_expansion_settings_dialog.py`

Test settings dialog:
- [ ] Dialog initializes with default values
- [ ] Spinbox accepts valid range (1-10)
- [ ] Spinbox rejects invalid values (<1)
- [ ] OK button saves settings to QSettings
- [ ] Cancel button does not save settings
- [ ] `settings_changed` signal emitted on save

**Location**: `tests/unit/presentation/dialogs/test_custom_hop_dialog.py`

Test custom hop dialog:
- [ ] Dialog accepts hop count input
- [ ] `get_hop_count()` returns entered value
- [ ] OK button closes dialog with Accepted result
- [ ] Cancel button closes without returning value

### 3.2 Integration Tests

**Location**: `tests/integration/presentation/test_settings_persistence.py`

Test settings persistence:
- [ ] Settings saved in one session are loaded in next session
- [ ] Default hop count persists across application restarts
- [ ] Settings file created in correct location

### 3.3 UI Tests

Manual testing:
- [ ] Settings dialog accessible from Edit > Preferences menu
- [ ] Default hop count can be changed and persists
- [ ] Context menu shows 1, 2, 3, 5 hop options
- [ ] "N hops..." option opens custom hop dialog
- [ ] Custom hop count is applied correctly

---

## 4. Dependencies

- **Upstream**:
  - E03-F01-T02 (Expansion Trigger Handling) - receives hop count parameter
- **Downstream**:
  - User preferences and UX customization

---

## 5. Acceptance Criteria

- [ ] Settings dialog allows configuration of default hop count (1-10)
- [ ] Settings persist across application sessions using QSettings
- [ ] Context menu provides quick access to 1, 2, 3, 5-hop expansion
- [ ] Context menu includes "N hops..." option for custom input
- [ ] Custom hop dialog accepts integer input (1-10)
- [ ] Main window Edit menu includes Preferences action
- [ ] Settings dialog accessible via Edit > Preferences
- [ ] Default hop count applied to double-click expansion
- [ ] Keyboard modifiers override default hop count
- [ ] All unit tests pass with 90%+ coverage
- [ ] Settings changes take effect immediately without restart

---

## 6. Implementation Notes

### 6.1 Future Enhancements

Additional settings to consider:
- **Maximum hop limit**: Prevent accidentally expanding huge subgraphs
- **Animation settings**: Enable/disable animation, adjust duration
- **Default expansion direction**: Fanin, fanout, or both
- **Power/ground filtering**: Enable/disable VDD/VSS filtering
- **Performance mode**: Simplify rendering for large expansions

### 6.2 Validation

Add validation for hop count:
```python
def validate_hop_count(hops: int) -> int:
    """Validate and clamp hop count to acceptable range"""
    MIN_HOPS = 1
    MAX_HOPS = 10

    if hops < MIN_HOPS:
        return MIN_HOPS
    elif hops > MAX_HOPS:
        return MAX_HOPS
    return hops
```

### 6.3 Status Bar Feedback

Show current expansion settings in status bar:
```python
self.statusBar().showMessage(f"Expansion: {hop_count} hop(s)")
```

---

## Revision History

| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-12-26 | 0.1 | Claude | Initial task creation from E03-F01 split |
