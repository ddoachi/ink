# Pre-Implementation Documentation: E03-F01-T05 - N-Hop Configuration

## Overview

### Problem Context

While keyboard modifiers (Shift, Ctrl) provide quick access to common hop counts (1, 2, 3, 5), users need more flexible control over expansion behavior. Power users may want to set a different default hop count, configure custom hop values, or specify arbitrary hop counts for specific expansions. This task provides UI components and settings persistence to give users full control over expansion configuration.

### Scope

This task implements expansion configuration UI and persistence:
1. Settings dialog for configuring default hop count
2. Custom hop input dialog for arbitrary N-hop expansion
3. Enhanced context menu with hop presets and custom option
4. Settings persistence using `QSettings`
5. Integration with main window preferences menu
6. Settings manager for centralized configuration access

### Success Criteria

- Users can configure default hop count (1-10) via preferences dialog
- Settings persist across application sessions
- Context menu provides quick access to common hop presets (1, 2, 3, 5)
- Context menu includes "N hops..." option for custom input
- Custom hop dialog validates input range
- Settings changes apply immediately without restart
- Clean, intuitive UI following platform conventions

## Implementation Approach

### High-Level Strategy

1. **Settings Dialog**: Create standalone dialog for expansion preferences
2. **Custom Hop Dialog**: Simple dialog with spinbox for N-hop input
3. **Context Menu Enhancement**: Add hop presets and custom option to existing menu
4. **Settings Manager**: Centralized class for reading/writing settings via `QSettings`
5. **Main Window Integration**: Add preferences menu item, wire up dialogs
6. **Persistence**: Use Qt's `QSettings` for cross-platform settings storage

### Architecture Pattern

**Presentation Layer Components:**

```
MainWindow
    ↓ opens
ExpansionSettingsDialog
    ↓ saves to
QSettings (platform-specific storage)
    ↓ read by
SettingsManager
    ↓ provides to
SchematicCanvas
```

**Context Menu Flow:**

```
Right-click on item
  → Show context menu
  → User selects "Expand Fanout (N hops)..."
  → CustomHopDialog opens
  → User enters hop count
  → Canvas calls ExpansionService with custom hops
```

### Component Design

**ExpansionSettingsDialog:**
- Main preferences dialog
- Spinbox for default hop count
- Information about keyboard modifiers
- OK/Cancel buttons
- Saves to `QSettings` on accept

**CustomHopDialog:**
- Lightweight input dialog
- Spinbox for hop count (1-10)
- OK/Cancel buttons
- Returns hop count on accept

**SettingsManager:**
- Static utility class
- Centralizes settings keys and defaults
- Provides get/set methods for all settings
- Uses `QSettings` for persistence

## Key Design Decisions

### Decision 1: Settings Storage

**Chosen:** Qt's `QSettings` class

**Rationale:**
- Cross-platform (uses registry on Windows, .plist on macOS, .conf on Linux)
- Built into Qt, no additional dependencies
- Automatic type conversion
- Standard location per platform

**Storage Locations:**
- Windows: `HKEY_CURRENT_USER\Software\Ink\SchematicViewer`
- macOS: `~/Library/Preferences/com.Ink.SchematicViewer.plist`
- Linux: `~/.config/Ink/SchematicViewer.conf`

**Alternative Considered:** JSON file in home directory. Rejected due to platform inconsistency and manual path management.

### Decision 2: Settings Keys

**Chosen:** Hierarchical key structure with `expansion/` prefix

**Keys:**
- `expansion/default_hops`: int (default: 1)
- (Future) `expansion/max_hops`: int (default: 10)
- (Future) `expansion/enable_animation`: bool (default: true)

**Rationale:**
- Organizes related settings
- Allows future expansion without conflicts
- Clear, self-documenting names

### Decision 3: Hop Count Range

**Chosen:** Minimum 1, maximum 10

**Rationale:**
- Minimum 1: 0-hop expansion is meaningless
- Maximum 10: Prevents accidentally expanding huge subgraphs
- Configurable maximum if needed in future

**Validation:**
- Spinbox min/max constraints
- Additional validation in service layer
- Clamp out-of-range values to valid range

### Decision 4: Context Menu Structure

**Chosen:** Separate fanout/fanin sections with presets + custom

**Menu Structure:**
```
Expand Fanout (1 hop)
Expand Fanout (2 hops)
Expand Fanout (3 hops)
Expand Fanout (5 hops)
Expand Fanout (N hops)...
---
Expand Fanin (1 hop)
Expand Fanin (2 hops)
Expand Fanin (3 hops)
Expand Fanin (5 hops)
Expand Fanin (N hops)...
```

**Rationale:**
- Quick access to common values (1, 2, 3, 5)
- Custom option for flexibility
- Separated by direction for clarity
- Matches keyboard modifier mappings

**Alternative Considered:** Submenu for hop counts. Rejected due to extra clicks.

### Decision 5: Settings Dialog Location

**Chosen:** Edit > Preferences menu (cross-platform standard)

**Platform Variations:**
- Windows/Linux: Edit > Preferences
- macOS: App Menu > Preferences (Qt handles automatically)

**Rationale:**
- Standard location users expect
- Qt's `QMenuBar` handles platform differences
- Consistent with other applications

### Decision 6: Immediate vs Restart for Settings

**Chosen:** Settings apply immediately (no restart required)

**Implementation:**
- Dialog emits `settings_changed` signal on save
- Canvas/service update internal state on signal
- New expansions use updated settings

**Rationale:**
- Better UX (no restart friction)
- Settings are simple (just hop count)
- Easy to implement with signals

## Dependencies and Integration Points

### Upstream Dependencies

1. **E03-F01-T02 (Expansion Trigger Handling)** - CRITICAL
   - `SchematicCanvas` already has context menu and event handling
   - Will extend existing menu and add hop count parameter
   - Need to modify `_get_hop_count_from_modifiers()` to use default setting

2. **PySide6** - CRITICAL
   - `QSettings` for persistence
   - `QDialog`, `QSpinBox` for UI
   - `QMenu` for context menu

### Downstream Dependencies

1. **User Experience** - PRIMARY BENEFIT
   - Customizable workflow
   - Persistent preferences
   - Flexibility for different use cases

2. **Future Settings** - EXTENSIBILITY
   - Framework for adding more settings (animation, performance, etc.)
   - Centralized settings management

### Integration Challenges

**Challenge 1: Default Hop Count Override**
- Risk: Modifier keys and default setting may conflict
- Mitigation: Clear precedence (modifiers override default)
- Contingency: Document behavior in tooltips

**Challenge 2: Settings Migration**
- Risk: Future settings changes may break existing saved settings
- Mitigation: Use version key, provide defaults for missing keys
- Contingency: Add migration logic if needed

**Challenge 3: Platform Differences**
- Risk: `QSettings` behavior varies by platform
- Mitigation: Use Qt abstractions, test on multiple platforms
- Contingency: Add platform-specific handling if needed

## Testing Strategy

### Unit Tests (Presentation Layer)

**Test File:** `tests/unit/presentation/dialogs/test_expansion_settings_dialog.py`

**Test Categories:**

1. **Dialog Initialization**
   - Dialog initializes with default values
   - Spinbox range is correct (1-10)
   - Values loaded from `QSettings` on startup

2. **Dialog Interaction**
   - Spinbox accepts valid values
   - Spinbox rejects invalid values (<1, >10)
   - OK button saves settings to `QSettings`
   - Cancel button does not save settings
   - `settings_changed` signal emitted on save

3. **Settings Persistence**
   - Saved values persist to `QSettings`
   - Values loaded correctly in new dialog instance

**Mocking Strategy:**
- Mock `QSettings` to avoid real file I/O in unit tests
- Verify read/write calls and values

**Test File:** `tests/unit/presentation/dialogs/test_custom_hop_dialog.py`

**Test Categories:**

1. **Dialog Behavior**
   - Dialog accepts hop count input
   - `get_hop_count()` returns entered value
   - OK button closes with Accepted result
   - Cancel button closes with Rejected result
   - Spinbox range validated (1-10)

### Integration Tests

**Test File:** `tests/integration/presentation/test_settings_persistence.py`

**Test Scenarios:**

1. **Cross-Session Persistence**
   - Save setting in one session
   - Create new `QSettings` instance
   - Verify setting loaded correctly

2. **Default Values**
   - Clear all settings
   - Read default hop count
   - Verify defaults applied (1)

3. **Settings Manager**
   - `SettingsManager.get_default_hop_count()` returns correct value
   - `SettingsManager.set_default_hop_count()` saves correctly
   - Validation works (rejects <1)

**Test Data:** Use test-specific `QSettings` organization/application names to avoid polluting real settings.

### UI Tests (Manual)

**Test Scenarios:**

1. **Settings Dialog Workflow**
   - Open Edit > Preferences
   - Change default hop count to 3
   - Click OK
   - Verify new default used in expansions

2. **Custom Hop Dialog**
   - Right-click on pin
   - Select "Expand Fanout (N hops)..."
   - Enter 7
   - Verify 7-hop expansion occurs

3. **Context Menu Presets**
   - Right-click on pin
   - Select "Expand Fanout (2 hops)"
   - Verify 2-hop expansion
   - Verify faster than custom dialog

4. **Persistence**
   - Change default hop count
   - Restart application
   - Verify setting persisted

## Risks and Considerations

### Technical Risks

**Risk 1: Platform-Specific Settings Issues**
- Likelihood: Low (QSettings is mature)
- Impact: Medium (settings lost/corrupted)
- Mitigation: Test on Windows, macOS, Linux
- Contingency: Add fallback to JSON file if QSettings fails

**Risk 2: Settings File Corruption**
- Likelihood: Low
- Impact: Medium (user loses preferences)
- Mitigation: Use robust QSettings API, validate on read
- Contingency: Provide "Reset to Defaults" option

### UX Risks

**Risk 1: Settings Discoverability**
- Likelihood: Medium (users may not find preferences)
- Impact: Low (defaults are sensible)
- Mitigation: Add tooltip, help documentation
- Contingency: N/A (optional feature)

**Risk 2: Overwhelming Options**
- Likelihood: Low (only one setting for MVP)
- Impact: Low
- Mitigation: Keep dialog simple, organize future settings into tabs
- Contingency: N/A

### Implementation Risks

**Risk 1: Signal/Slot Connection Issues**
- Likelihood: Low
- Impact: Medium (settings don't apply)
- Mitigation: Test signal emission and reception
- Contingency: Debug with Qt signals inspector

## Open Questions

### Design Questions

1. **Maximum Hop Limit:** Should there be a separate setting for maximum allowed hops?
   - **Decision needed by:** Implementation phase
   - **Fallback:** Use hardcoded maximum (10) for MVP

2. **Warning on Large Expansions:** Should we warn if user requests expansion that might be large?
   - **Decision needed by:** After performance testing
   - **Fallback:** Add in P1 if users request

3. **Modifier Key Customization:** Should modifier-to-hop mapping be configurable?
   - **Decision needed by:** After MVP
   - **Fallback:** Hardcode for MVP, make configurable in P1 if requested

### Technical Questions

1. **Settings Organization:** Use single organization ("Ink") or include version?
   - **Resolution:** Use simple "Ink" / "SchematicViewer" for MVP

2. **Settings Location:** Should we provide UI to show settings file location?
   - **Resolution:** No for MVP, add in advanced preferences if requested

## Implementation Sequence

### Phase 1: Settings Manager (1 hour)
1. Create `SettingsManager` class in `src/ink/infrastructure/persistence/settings_manager.py`
2. Implement `get_default_hop_count()` and `set_default_hop_count()`
3. Define constants for organization, application, keys
4. Add validation

### Phase 2: Settings Dialog (2 hours)
1. Create `ExpansionSettingsDialog` in `src/ink/presentation/dialogs/expansion_settings_dialog.py`
2. Build UI with spinbox, labels, buttons
3. Implement `_load_settings()` and `_save_settings()`
4. Connect signals for OK/Cancel
5. Add `settings_changed` signal

### Phase 3: Custom Hop Dialog (1 hour)
1. Create `CustomHopDialog` in `src/ink/presentation/dialogs/custom_hop_dialog.py`
2. Build simple UI with spinbox and buttons
3. Implement `get_hop_count()` method

### Phase 4: Context Menu Enhancement (1 hour)
1. Extend `SchematicCanvas.contextMenuEvent()` from T02
2. Add hop preset actions (1, 2, 3, 5)
3. Add "N hops..." action that opens `CustomHopDialog`
4. Connect actions to `_expand_from_item()` with hop parameter

### Phase 5: Main Window Integration (30 min)
1. Add Edit menu to `MainWindow` if not exists
2. Add "Preferences..." action
3. Connect to `_show_settings_dialog()`
4. Implement dialog creation and signal handling

### Phase 6: Default Hop Application (30 min)
1. Modify `SchematicCanvas` to load default hop count on startup
2. Update `_get_hop_count_from_modifiers()` to use default
3. Handle `settings_changed` signal to update internal state

### Phase 7: Testing (2 hours)
1. Write unit tests for dialogs
2. Write unit tests for settings manager
3. Write integration tests for persistence
4. Manual UI testing on multiple platforms

**Total Estimate:** 6 hours (with buffer)

## Success Metrics

### Functional Metrics
- Settings dialog saves and loads correctly
- Custom hop dialog returns user input
- Context menu has all expected options
- Settings persist across sessions
- All unit tests pass (target: 15+ tests, 90%+ coverage)

### UX Metrics
- Settings discoverable via standard menu location
- Dialog layout clear and intuitive
- Changes apply immediately (no restart)

### Quality Metrics
- mypy passes
- All docstrings complete
- Consistent with Qt platform conventions

## Notes and Assumptions

### Assumptions
1. Qt's `QSettings` is available and functional
2. Users understand hop count concept (documented in help)
3. Default of 1-hop is sensible for most users
4. Range of 1-10 hops covers all practical use cases

### Out of Scope
- Advanced settings (animation, performance, appearance)
- Customizable modifier key mappings
- Import/export settings
- Settings profiles (power user, beginner, etc.)
- Cloud sync of settings

### Documentation Requirements
- Docstrings for all dialog classes and methods
- Settings keys documented in `SettingsManager`
- User help documentation for preferences
- Platform-specific notes for settings file location

### Future Enhancements

**P1 Candidates:**
- Animation enable/disable setting
- Maximum hop limit setting
- Default expansion direction (fanin/fanout/both)
- Power/ground filtering toggle
- Performance mode settings

**P2 Candidates:**
- Customizable modifier key mappings
- Color scheme preferences
- Font size preferences
- Layout algorithm selection
- Advanced routing options

### Coordination Needed
- Sync with T02 on context menu extension
- Sync with main window implementation for menu structure
- Sync with UX team on dialog layout and wording
- Sync with documentation team for help content
