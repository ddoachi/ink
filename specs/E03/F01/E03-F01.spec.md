# Spec: E03-F01 - Hop-Based Expansion

## Metadata
- **ID**: E03-F01
- **Type**: Feature
- **Priority**: P0 (MVP)
- **Status**: Draft
- **Parent**: [E03](../E03.spec.md)
- **Created**: 2025-12-26

---

## 1. Overview

### 1.1 Problem Statement

Gate-level netlists can contain hundreds of thousands of cells. Engineers need to explore connectivity incrementally, revealing logic step-by-step rather than viewing the entire netlist at once. Hop-based expansion allows controlled, incremental traversal of the netlist by expanding 1 or N hops in fanin or fanout direction from a selected point.

### 1.2 Goals

- Enable 1-hop expansion for immediate fanin/fanout exploration
- Support N-hop expansion (configurable depth) for deeper connectivity analysis
- Prevent duplicate expansion of already-visible cells
- Provide smooth animation for newly expanded elements
- Maintain acceptable performance for expansion operations (1-hop <100ms, 5-hop <500ms)

---

## 2. User Stories

### US-E03-01: Expand Fanout
**As a** circuit designer
**I want to** double-click a pin to expand its fanout
**So that** I can see what logic it drives

**Acceptance Criteria:**
- [ ] Double-click on output pin triggers expansion
- [ ] 1-hop expansion shows immediate fanout cells
- [ ] Newly expanded cells are positioned and routed
- [ ] Already visible cells are not duplicated
- [ ] Expansion animates smoothly

### US-E03-02: Expand Fanin
**As a** circuit designer
**I want to** expand the fanin of an input pin
**So that** I can trace the signal source

**Acceptance Criteria:**
- [ ] Right-click menu offers "Expand Fanin"
- [ ] Fanin expansion shows driver cells
- [ ] Multiple levels of fanin can be expanded sequentially

### US-E03-03: N-Hop Expansion
**As a** circuit designer
**I want to** expand multiple hops at once
**So that** I can quickly see deeper connectivity

**Acceptance Criteria:**
- [ ] Configurable hop count (1, 2, 3, or custom)
- [ ] N-hop expansion retrieves all cells within N hops
- [ ] Performance acceptable for N up to 5 hops

---

## 3. Technical Requirements

### 3.1 Graph Traversal API

```python
class GraphTraverser:
    def get_fanout(self, pin: Pin, hops: int = 1) -> Set[Cell]:
        """Get cells within N hops downstream of pin"""

    def get_fanin(self, pin: Pin, hops: int = 1) -> Set[Cell]:
        """Get cells within N hops upstream of pin"""
```

### 3.2 Expansion Algorithm

```
1. User triggers expansion on object X (pin, net, or cell)
2. Query graph for affected cells based on scope (fanin/fanout, hops)
3. Filter out already-visible cells
4. Calculate layout positions for new cells
5. Route new nets
6. Animate new elements into view
7. Record action in expansion history
```

### 3.3 Expansion Trigger Points

- **Double-click on output pin**: Expands fanout
- **Double-click on input pin**: Expands fanin
- **Double-click on net**: Expands both driver and loads
- **Double-click on cell**: Expands all connections (fanin + fanout)
- **Right-click context menu**: Offers directional expansion options

### 3.4 Duplicate Prevention

- Maintain `visible_cells: Set[str]` in ExpansionState
- Before adding cells to view, filter against visible_cells
- Only add cells not already in the set
- Update visible_cells after successful expansion

### 3.5 Performance Requirements

- 1-hop expansion completes in <100ms
- 5-hop expansion completes in <500ms
- Incremental layout updates to avoid full re-layout
- Background threading for graph queries if needed

---

## 4. Dependencies

- **Upstream**:
  - E01 (Data Model - graph traversal implementation)
  - E02 (Rendering - layout engine and net router)
- **Downstream**:
  - E03-F04 (Expansion State Management)
  - E04 (Interaction - undo/redo)

---

## 5. Acceptance Criteria

- [ ] 1-hop fanout expansion works from output pins
- [ ] 1-hop fanin expansion works from input pins
- [ ] N-hop expansion (2-5 hops) works in both directions
- [ ] No duplicate cells appear after any expansion sequence
- [ ] Newly expanded cells are properly positioned using Sugiyama layout
- [ ] Nets connecting new cells are routed orthogonally
- [ ] Expansion animates smoothly into view
- [ ] 1-hop expansion completes in <100ms
- [ ] 5-hop expansion completes in <500ms
- [ ] Right-click context menu offers directional expansion options
- [ ] Expansion actions are recorded for undo/redo

---

## 6. Child Specs

*To be created via `/spec_work E03-F01 --split tasks`*

| ID | Task | Status |
|----|------|--------|

---

## Revision History

| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-12-26 | 0.1 | Claude | Initial feature creation from E03 split |
