---
id: E03-F01-T02
title: Expansion Trigger Handling
type: Task
priority: P0 (MVP)
status: Draft
parent: E03-F01
created: 2025-12-26
estimated_hours: 6
actual_hours:
effort: Medium
tags:
  - application
  - event-handling
  - ui-integration
clickup_task_id: '86evzm2pa'
---

# Spec: E03-F01-T02 - Expansion Trigger Handling

## 1. Overview

### 1.1 Problem Statement

Users need intuitive interactions to trigger expansion operations. Double-clicking on schematic objects (pins, nets, cells) should initiate expansion based on the object type and direction. The system must translate UI events into expansion commands that orchestrate graph traversal, filtering, layout, and rendering.

### 1.2 Goals

- Handle double-click events on schematic objects
- Determine expansion direction based on object type (pin direction, net, cell)
- Provide right-click context menu for explicit direction control
- Delegate to expansion service for execution
- Support keyboard modifiers for expansion configuration (Shift for multi-hop)
- Maintain separation between presentation layer events and application logic

---

## 2. Technical Requirements

### 2.1 Event Handling in Presentation Layer

**Location**: `src/ink/presentation/canvas/schematic_canvas.py`

```python
from PySide6.QtWidgets import QGraphicsView
from PySide6.QtCore import Qt, QEvent
from PySide6.QtGui import QMouseEvent
from ink.application.services.expansion_service import ExpansionService

class SchematicCanvas(QGraphicsView):
    """Main schematic canvas with expansion event handling"""

    def __init__(self, expansion_service: ExpansionService):
        super().__init__()
        self._expansion_service = expansion_service
        self._default_hop_count = 1

    def mouseDoubleClickEvent(self, event: QMouseEvent) -> None:
        """Handle double-click for expansion trigger"""
        if event.button() != Qt.LeftButton:
            return

        # Get item at click position
        pos = event.pos()
        item = self.itemAt(pos)

        if item is None:
            return

        # Determine expansion parameters based on item type
        if isinstance(item, PinItem):
            self._handle_pin_expansion(item, event)
        elif isinstance(item, NetItem):
            self._handle_net_expansion(item, event)
        elif isinstance(item, CellItem):
            self._handle_cell_expansion(item, event)

    def _handle_pin_expansion(self, pin_item: PinItem, event: QMouseEvent) -> None:
        """
        Expand based on pin direction.

        - Output pin: expand fanout
        - Input pin: expand fanin
        - INOUT pin: expand both directions
        """
        pin = pin_item.pin_entity
        hop_count = self._get_hop_count_from_modifiers(event)

        if pin.direction == PinDirection.OUTPUT:
            self._expansion_service.expand_fanout(pin, hops=hop_count)
        elif pin.direction == PinDirection.INPUT:
            self._expansion_service.expand_fanin(pin, hops=hop_count)
        elif pin.direction == PinDirection.INOUT:
            self._expansion_service.expand_bidirectional(pin, hops=hop_count)

    def _handle_net_expansion(self, net_item: NetItem, event: QMouseEvent) -> None:
        """
        Expand net shows both driver and loads.

        - Expand driver (fanin of the net's source)
        - Expand loads (fanout of the net's sinks)
        """
        net = net_item.net_entity
        hop_count = self._get_hop_count_from_modifiers(event)

        self._expansion_service.expand_net(net, hops=hop_count)

    def _handle_cell_expansion(self, cell_item: CellItem, event: QMouseEvent) -> None:
        """
        Expand cell shows all connections (fanin + fanout).

        - Expand fanin on all input pins
        - Expand fanout on all output pins
        """
        cell = cell_item.cell_entity
        hop_count = self._get_hop_count_from_modifiers(event)

        self._expansion_service.expand_cell(cell, hops=hop_count)

    def _get_hop_count_from_modifiers(self, event: QMouseEvent) -> int:
        """
        Extract hop count from keyboard modifiers.

        - No modifier: use default (1 hop)
        - Shift: 2 hops
        - Ctrl: 3 hops
        - Shift+Ctrl: 5 hops
        """
        modifiers = event.modifiers()

        if modifiers == (Qt.ShiftModifier | Qt.ControlModifier):
            return 5
        elif modifiers == Qt.ControlModifier:
            return 3
        elif modifiers == Qt.ShiftModifier:
            return 2
        else:
            return self._default_hop_count
```

### 2.2 Context Menu for Explicit Direction

**Location**: `src/ink/presentation/canvas/schematic_canvas.py`

```python
from PySide6.QtWidgets import QMenu
from PySide6.QtCore import QPoint

class SchematicCanvas(QGraphicsView):
    # ... (previous methods)

    def contextMenuEvent(self, event: QContextMenuEvent) -> None:
        """Show context menu with expansion options"""
        pos = event.pos()
        item = self.itemAt(pos)

        if item is None:
            return

        menu = QMenu(self)

        if isinstance(item, (PinItem, NetItem, CellItem)):
            # Add expansion actions
            expand_fanout_action = menu.addAction("Expand Fanout (1 hop)")
            expand_fanin_action = menu.addAction("Expand Fanin (1 hop)")
            menu.addSeparator()
            expand_fanout_n_action = menu.addAction("Expand Fanout (N hops)...")
            expand_fanin_n_action = menu.addAction("Expand Fanin (N hops)...")

            # Connect actions
            expand_fanout_action.triggered.connect(
                lambda: self._expand_from_item(item, direction="fanout", hops=1)
            )
            expand_fanin_action.triggered.connect(
                lambda: self._expand_from_item(item, direction="fanin", hops=1)
            )
            # N-hop actions would open dialog (see T05)

        menu.exec_(event.globalPos())

    def _expand_from_item(self, item, direction: str, hops: int) -> None:
        """Execute expansion from context menu selection"""
        if isinstance(item, PinItem):
            pin = item.pin_entity
            if direction == "fanout":
                self._expansion_service.expand_fanout(pin, hops=hops)
            else:
                self._expansion_service.expand_fanin(pin, hops=hops)
        # Similar for NetItem and CellItem...
```

### 2.3 Expansion Service Interface

**Location**: `src/ink/application/services/expansion_service.py`

```python
from typing import Set
from ink.domain.model.cell import Cell
from ink.domain.model.pin import Pin
from ink.domain.model.net import Net
from ink.domain.services.graph_traverser import GraphTraverser

class ExpansionService:
    """Application service for expansion operations"""

    def __init__(self, graph_traverser: GraphTraverser):
        self._traverser = graph_traverser

    def expand_fanout(self, pin: Pin, hops: int = 1) -> Set[Cell]:
        """
        Expand fanout from a pin.

        Args:
            pin: Starting pin (typically output)
            hops: Number of hops to expand

        Returns:
            Set of newly expanded cells
        """
        # 1. Get cells from graph traversal (delegates to T01)
        # 2. Filter duplicates (delegates to T03)
        # 3. Trigger layout and render (delegates to T04)
        # 4. Record action for undo/redo
        pass

    def expand_fanin(self, pin: Pin, hops: int = 1) -> Set[Cell]:
        """Expand fanin from a pin"""
        pass

    def expand_bidirectional(self, pin: Pin, hops: int = 1) -> Set[Cell]:
        """Expand both fanin and fanout from an INOUT pin"""
        pass

    def expand_net(self, net: Net, hops: int = 1) -> Set[Cell]:
        """Expand driver and loads of a net"""
        pass

    def expand_cell(self, cell: Cell, hops: int = 1) -> Set[Cell]:
        """Expand all connections of a cell"""
        pass
```

---

## 3. Testing Requirements

### 3.1 Unit Tests

**Location**: `tests/unit/presentation/canvas/test_schematic_canvas_events.py`

Test event handling logic:
- [ ] Double-click on output pin triggers `expand_fanout()`
- [ ] Double-click on input pin triggers `expand_fanin()`
- [ ] Double-click on INOUT pin triggers `expand_bidirectional()`
- [ ] Double-click on net triggers `expand_net()`
- [ ] Double-click on cell triggers `expand_cell()`
- [ ] Shift modifier increases hop count to 2
- [ ] Ctrl modifier increases hop count to 3
- [ ] Shift+Ctrl modifier increases hop count to 5
- [ ] Right-click shows context menu with expansion options

**Location**: `tests/unit/application/services/test_expansion_service.py`

Test service methods:
- [ ] `expand_fanout()` calls `graph_traverser.get_fanout()`
- [ ] `expand_fanin()` calls `graph_traverser.get_fanin()`
- [ ] Service returns newly expanded cells
- [ ] Service records action for undo/redo

### 3.2 Integration Tests

**Location**: `tests/integration/presentation/test_expansion_integration.py`

Test UI to service integration:
- [ ] Double-click on pin in canvas triggers expansion service
- [ ] Context menu action triggers correct expansion
- [ ] Canvas updates after expansion completes

---

## 4. Dependencies

- **Upstream**:
  - E03-F01-T01 (Graph Traverser Service) - provides traversal logic
  - E02 (Rendering) - provides canvas and graphic items
- **Downstream**:
  - E03-F01-T03 (Duplicate Prevention) - filters results
  - E03-F01-T04 (Expansion Animation) - renders results
  - E04 (Interaction) - undo/redo integration

---

## 5. Acceptance Criteria

- [ ] Double-click on output pin expands fanout
- [ ] Double-click on input pin expands fanin
- [ ] Double-click on INOUT pin expands both directions
- [ ] Double-click on net expands driver and loads
- [ ] Double-click on cell expands all connections
- [ ] Right-click context menu provides explicit direction options
- [ ] Shift modifier triggers 2-hop expansion
- [ ] Ctrl modifier triggers 3-hop expansion
- [ ] Shift+Ctrl triggers 5-hop expansion
- [ ] `ExpansionService` methods correctly delegate to `GraphTraverser`
- [ ] Events are properly handled without blocking UI
- [ ] All unit tests pass with 90%+ coverage
- [ ] Integration tests confirm UI-to-service data flow

---

## 6. Implementation Notes

### 6.1 Event Flow Diagram

```
User Double-Click
       |
       v
SchematicCanvas.mouseDoubleClickEvent()
       |
       v
Identify item type (PinItem, NetItem, CellItem)
       |
       v
Determine expansion parameters (direction, hops)
       |
       v
ExpansionService.expand_fanout/fanin/etc()
       |
       v
GraphTraverser.get_fanout/get_fanin()
       |
       v
Filter duplicates (T03)
       |
       v
Layout + Animation (T04)
       |
       v
Update canvas
```

### 6.2 Modifier Key Configuration

Consider making modifier mappings configurable:

```python
# In settings or config
EXPANSION_MODIFIERS = {
    "default": 1,
    Qt.ShiftModifier: 2,
    Qt.ControlModifier: 3,
    Qt.ShiftModifier | Qt.ControlModifier: 5,
}
```

---

## Revision History

| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-12-26 | 0.1 | Claude | Initial task creation from E03-F01 split |
