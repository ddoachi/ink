# Pre-Implementation Documentation: E03-F01-T02 - Expansion Trigger Handling

## Overview

### Problem Context

Users need intuitive, efficient ways to trigger expansion operations while exploring gate-level netlists. The system must translate UI interactions (double-clicks, context menu selections, keyboard shortcuts) into expansion commands that orchestrate graph traversal, filtering, layout, and rendering. This task bridges the presentation layer (UI events) and the application layer (business logic).

### Scope

This task implements the event handling and application service layer for expansion:
1. Double-click event handling on schematic objects (pins, nets, cells)
2. Context menu with expansion direction options
3. Keyboard modifier support for multi-hop expansion
4. Application service (`ExpansionService`) to coordinate expansion workflow
5. Direction determination logic based on object type

### Success Criteria

- Double-click on pins, nets, and cells triggers correct expansion direction
- Context menu provides explicit control over expansion direction
- Keyboard modifiers (Shift, Ctrl, Shift+Ctrl) adjust hop count
- `ExpansionService` correctly delegates to downstream components
- Events handled without blocking UI
- Clean separation between presentation and application logic

## Implementation Approach

### High-Level Strategy

1. **Event Handler in Canvas**: Implement `mouseDoubleClickEvent()` and `contextMenuEvent()` in `SchematicCanvas`
2. **Object Type Dispatch**: Route events to appropriate handlers based on item type (PinItem, NetItem, CellItem)
3. **Direction Logic**: Determine expansion direction based on object properties (pin direction, net role, cell type)
4. **Modifier Extraction**: Parse keyboard modifiers to determine hop count
5. **Application Service**: Create `ExpansionService` to orchestrate traversal, filtering, layout, animation
6. **Dependency Injection**: Canvas receives `ExpansionService` via constructor

### Architecture Pattern

**Layered Architecture:**
```
Presentation Layer (SchematicCanvas)
    ↓ calls
Application Layer (ExpansionService)
    ↓ delegates to
Domain Services (GraphTraverser, LayoutEngine, NetRouter)
```

**Event Flow:**
```
User Double-Click
  → mouseDoubleClickEvent()
  → Identify item type
  → Determine direction/hops
  → ExpansionService.expand_fanout/fanin()
  → GraphTraverser (T01)
  → Filter duplicates (T03)
  → Layout + Animation (T04)
  → Update canvas
```

### Component Design

**SchematicCanvas** (Presentation):
- Handles Qt events
- Identifies clicked items
- Extracts modifiers
- Calls `ExpansionService` methods

**ExpansionService** (Application):
- Coordinates expansion workflow
- Delegates to domain services
- Records actions for undo/redo
- Returns newly expanded cells

## Key Design Decisions

### Decision 1: Direction Determination for Pins

**Logic:**
- Output pin → expand fanout (downstream)
- Input pin → expand fanin (upstream)
- INOUT pin → expand both directions (bidirectional)

**Rationale:**
- Matches user mental model (outputs drive, inputs are driven)
- INOUT requires special handling due to bidirectional nature
- Simple, predictable behavior

**Implementation:** Check `pin.direction` enum value.

### Decision 2: Direction Determination for Nets

**Problem:** Net has both driver and loads. Which direction to expand?

**Chosen:** Expand both driver and loads (bidirectional)

**Rationale:**
- Nets represent connectivity, user wants to see "what's connected to this net"
- Showing both sides provides complete picture
- Consistent with INOUT pin behavior

**Alternative Considered:** Expand only loads (fanout). Rejected as too limiting.

### Decision 3: Direction Determination for Cells

**Problem:** Cell has multiple input and output pins. Which direction?

**Chosen:** Expand all connections (fanin + fanout)

**Rationale:**
- Cell represents a logic gate, user wants to see "what's connected to this gate"
- Expanding all connections shows full context
- User can use pin-specific expansion for targeted exploration

**Alternative Considered:** Expand only fanout. Rejected as too restrictive.

### Decision 4: Keyboard Modifier Mapping

**Mapping:**
- No modifier: default hop count (1)
- Shift: 2 hops
- Ctrl: 3 hops
- Shift+Ctrl: 5 hops

**Rationale:**
- Progressive complexity (single modifier → 2-3 hops, dual modifier → 5 hops)
- Shift is easier to press → lower hop count
- Ctrl requires more intentionality → higher hop count
- 5-hop as maximum "quick access" (more requires dialog)

**Trade-offs:**
- Platform differences (Cmd on macOS)
- May need to make configurable (defer to T05)

### Decision 5: Context Menu vs Double-Click

**Strategy:**
- Double-click: Default behavior (direction inferred from object)
- Context menu: Explicit control (user chooses direction)

**Rationale:**
- Double-click for speed (most common case)
- Context menu for precision (when default isn't desired)
- Balances efficiency and control

**Implementation:** Context menu provides fanin/fanout options for all object types.

### Decision 6: Service Method Granularity

**Chosen:** Separate methods for each expansion type

```python
class ExpansionService:
    def expand_fanout(pin, hops)
    def expand_fanin(pin, hops)
    def expand_bidirectional(pin, hops)
    def expand_net(net, hops)
    def expand_cell(cell, hops)
```

**Rationale:**
- Clear intent (method name documents behavior)
- Type safety (accept correct entity type)
- Easier to test each case independently

**Alternative Considered:** Single `expand(entity, direction, hops)` method. Rejected due to weaker typing.

## Dependencies and Integration Points

### Upstream Dependencies

1. **E03-F01-T01 (Graph Traverser Service)** - CRITICAL
   - `ExpansionService` calls `GraphTraverser.get_fanout()` and `get_fanin()`
   - Must be implemented first
   - Need to verify protocol matches usage

2. **E02 (Rendering)** - CRITICAL
   - Provides `SchematicCanvas`, `PinItem`, `NetItem`, `CellItem` classes
   - Canvas must support mouse event handling
   - Items must expose entity references

3. **Domain Model (Cell, Pin, Net)** - CRITICAL
   - Entities used as parameters to service methods
   - Need stable interfaces

### Downstream Dependencies

1. **E03-F01-T03 (Duplicate Prevention)** - SEQUENTIAL
   - `ExpansionService` will call filtering logic
   - Need `ExpansionState` for visibility tracking
   - Integration happens within `expand_*()` methods

2. **E03-F01-T04 (Expansion Animation)** - SEQUENTIAL
   - `ExpansionService` triggers animation after layout
   - Need layout and routing results
   - May emit event or call canvas method

3. **E04 (Undo/Redo)** - FUTURE
   - `ExpansionService` must record actions
   - Command pattern integration (defer to E04 implementation)

### Integration Challenges

**Challenge 1: Entity References in Items**
- Risk: `PinItem`, `NetItem`, `CellItem` may not expose entity references
- Mitigation: Verify rendering layer design, add accessors if needed

**Challenge 2: Service Initialization**
- Risk: Dependency injection complexity (multiple services needed)
- Mitigation: Use composition root pattern in main window, inject via constructor

**Challenge 3: Event Handling Order**
- Risk: Multiple event handlers may conflict
- Mitigation: Use explicit event acceptance, prevent propagation when handled

## Testing Strategy

### Unit Tests (Presentation Layer)

**Test File:** `tests/unit/presentation/canvas/test_schematic_canvas_events.py`

**Test Categories:**

1. **Double-Click Routing**
   - Double-click on `PinItem` (output) calls `expand_fanout()`
   - Double-click on `PinItem` (input) calls `expand_fanin()`
   - Double-click on `PinItem` (INOUT) calls `expand_bidirectional()`
   - Double-click on `NetItem` calls `expand_net()`
   - Double-click on `CellItem` calls `expand_cell()`
   - Double-click on empty area does nothing

2. **Modifier Handling**
   - No modifier → 1 hop
   - Shift → 2 hops
   - Ctrl → 3 hops
   - Shift+Ctrl → 5 hops

3. **Context Menu**
   - Right-click on pin shows expansion options
   - Menu actions trigger correct service methods
   - Menu includes fanin and fanout options

**Mocking Strategy:**
- Mock `ExpansionService` to verify calls
- Use `QTest` for simulating mouse events
- Create fake graphic items with test entities

### Unit Tests (Application Layer)

**Test File:** `tests/unit/application/services/test_expansion_service.py`

**Test Categories:**

1. **Service Methods**
   - `expand_fanout()` calls `GraphTraverser.get_fanout()`
   - `expand_fanin()` calls `GraphTraverser.get_fanin()`
   - `expand_bidirectional()` calls both
   - `expand_net()` handles driver and loads
   - `expand_cell()` expands all connections

2. **Return Values**
   - Methods return newly expanded cells
   - Empty set when no new cells

3. **State Updates**
   - Service updates expansion state (integration with T03)

**Mocking Strategy:**
- Mock `GraphTraverser` with predefined results
- Mock `ExpansionState` to verify updates
- Use simple test entities

### Integration Tests

**Test File:** `tests/integration/presentation/test_expansion_integration.py`

**Test Scenarios:**

1. **End-to-End Expansion**
   - Create canvas with real service
   - Simulate double-click on pin item
   - Verify service called with correct parameters
   - Verify canvas updates (items added)

2. **Context Menu Integration**
   - Simulate right-click
   - Verify menu shown
   - Trigger menu action
   - Verify expansion occurs

**Test Data:** Use minimal synthetic design with 5-10 cells.

## Risks and Considerations

### Technical Risks

**Risk 1: UI Thread Blocking**
- Likelihood: Medium (expansion may be slow)
- Impact: High (frozen UI)
- Mitigation: Profile expansion operations, ensure <100ms for common case
- Contingency: Add progress dialog for multi-hop expansion, run in background thread

**Risk 2: Event Conflicts**
- Likelihood: Low
- Impact: Medium (unexpected behavior)
- Mitigation: Explicit event acceptance, clear precedence rules
- Contingency: Debug event propagation, add logging

**Risk 3: Service Dependency Complexity**
- Likelihood: Medium
- Impact: Medium (initialization complexity)
- Mitigation: Use dependency injection container or factory pattern
- Contingency: Simplify by creating services in main window

### Architectural Risks

**Risk 1: Tight Coupling to Qt**
- Likelihood: Low (by design)
- Impact: Low (Qt is platform choice)
- Mitigation: Keep business logic in application layer
- Contingency: N/A (Qt coupling acceptable in presentation layer)

**Risk 2: Service Interface Too Generic**
- Likelihood: Low
- Impact: Medium (flexibility vs simplicity)
- Mitigation: Start with specific methods, refactor if needed
- Contingency: Add generic `expand()` method later if beneficial

### UX Risks

**Risk 1: Direction Inference Confusion**
- Likelihood: Medium (users may not understand defaults)
- Impact: Low (context menu provides alternative)
- Mitigation: Add tooltips, status bar feedback
- Contingency: Make defaults configurable (T05)

**Risk 2: Modifier Discoverability**
- Likelihood: High (users won't know about modifiers)
- Impact: Low (context menu works)
- Mitigation: Document in help, show in status bar
- Contingency: Add keyboard shortcut hints in UI

## Open Questions

### UX Questions

1. **Modifier on macOS:** Should Cmd replace Ctrl on macOS?
   - **Decision needed by:** Before implementation
   - **Fallback:** Use Qt's platform-agnostic key handling

2. **Status Bar Feedback:** Should status bar show "Expanding fanout (2 hops)..." during operation?
   - **Decision needed by:** Implementation phase
   - **Fallback:** Add later if users request

3. **Expansion Limits:** Should there be a warning for large expansions (e.g., 5-hop expands 1000+ cells)?
   - **Decision needed by:** After performance testing
   - **Fallback:** Add confirmation dialog in T05

### Technical Questions

1. **Entity Access in Items:** Do graphic items already expose entity references?
   - **Resolution:** Review rendering layer implementation, add if needed

2. **Service Lifecycle:** Should `ExpansionService` be singleton or per-canvas?
   - **Resolution:** Decide based on multi-window support requirements (likely singleton)

3. **Undo/Redo Integration:** How to record expansion actions?
   - **Resolution:** Defer to E04, add command pattern integration later

## Implementation Sequence

### Phase 1: Application Service (2 hours)
1. Create `ExpansionService` class in `src/ink/application/services/expansion_service.py`
2. Implement `expand_fanout()`, `expand_fanin()`, `expand_bidirectional()`
3. Add `expand_net()`, `expand_cell()` convenience methods
4. Add dependency on `GraphTraverser` (protocol)

### Phase 2: Canvas Event Handling (2 hours)
1. Add `mouseDoubleClickEvent()` to `SchematicCanvas`
2. Implement item type dispatch logic
3. Add `_handle_pin_expansion()`, `_handle_net_expansion()`, `_handle_cell_expansion()`
4. Implement modifier extraction in `_get_hop_count_from_modifiers()`

### Phase 3: Context Menu (1 hour)
1. Add `contextMenuEvent()` to `SchematicCanvas`
2. Build menu with fanin/fanout options
3. Connect menu actions to `_expand_from_item()` helper
4. Add quick hop presets (1, 2, 3, 5)

### Phase 4: Service Integration (1 hour)
1. Update `SchematicCanvas` constructor to accept `ExpansionService`
2. Wire up dependency injection in main window
3. Test end-to-end flow

### Phase 5: Testing (3 hours)
1. Write unit tests for service methods
2. Write unit tests for event handling
3. Write integration tests
4. Manual UI testing

**Total Estimate:** 6 hours (with buffer for debugging)

## Success Metrics

### Functional Metrics
- All unit tests pass (target: 20+ tests, 90%+ coverage)
- All integration tests pass
- All expansion types work correctly (fanout, fanin, bidirectional, net, cell)

### Performance Metrics
- Event handling latency: <50ms from click to service call
- No UI freezing during expansion

### Quality Metrics
- mypy type checking passes
- All docstrings complete
- Code review approved

## Notes and Assumptions

### Assumptions
1. `SchematicCanvas` exists in presentation layer
2. Graphic items (`PinItem`, `NetItem`, `CellItem`) expose entity references
3. `GraphTraverser` protocol is available from T01
4. Qt event system works as expected

### Out of Scope
- Undo/redo integration (defer to E04)
- Custom hop count dialog (handled by T05)
- Expansion settings persistence (handled by T05)
- Multi-selection expansion (future enhancement)

### Documentation Requirements
- Docstrings for all service methods
- Event handling flow diagram
- Modifier key reference
- Integration guide for canvas

### Coordination Needed
- Sync with E02 on graphic item interfaces
- Sync with T01 on `GraphTraverser` protocol
- Sync with T03 on `ExpansionState` integration
- Sync with T04 on animation trigger mechanism
