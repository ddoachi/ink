# Spec: E03-F04 - Expansion State Management

## Metadata
- **ID**: E03-F04
- **Type**: Feature
- **Priority**: P0 (MVP)
- **Status**: Draft
- **Parent**: [E03](../E03.spec.md)
- **Created**: 2025-12-26
- **Estimated Hours**:
- **Actual Hours**:
- **Effort**:
- **Tags**: []

---

## 1. Overview

### 1.1 Problem Statement

Incremental expansion and collapse operations must maintain consistent state to prevent duplicate elements, enable undo/redo, and support efficient view updates. The system needs to track which cells and nets are currently visible, record the history of expansion actions, and provide a clean API for state queries and mutations.

### 1.2 Goals

- Maintain accurate tracking of visible cells and nets
- Record expansion/collapse actions for undo/redo support
- Prevent duplicate expansion of already-visible elements
- Support efficient state queries (is cell visible, what was last action, etc.)
- Provide state persistence for session save/load (future)

---

## 2. User Stories

### US-E03-08: State Consistency
**As a** developer
**I want to** maintain consistent expansion state
**So that** the UI accurately reflects the current view

**Acceptance Criteria:**
- [ ] visible_cells set is always in sync with rendered cells
- [ ] visible_nets set is always in sync with rendered nets
- [ ] State updates are atomic (all or nothing)

### US-E03-09: History Tracking
**As a** developer
**I want to** record all expansion/collapse actions
**So that** undo/redo can restore previous states

**Acceptance Criteria:**
- [ ] Each action is recorded with timestamp and affected cells
- [ ] History supports 100+ actions without performance degradation
- [ ] History can be traversed forward and backward

---

## 3. Technical Requirements

### 3.1 Expansion State Model

```python
@dataclass
class ExpansionState:
    """Manages the current state of expanded/visible elements"""

    visible_cells: Set[str]      # Cell IDs currently visible
    visible_nets: Set[str]       # Net IDs currently visible
    expansion_history: List[ExpansionAction]  # For undo/redo

    def add_cells(self, cells: Set[str]) -> None:
        """Add cells to visible set"""

    def remove_cells(self, cells: Set[str]) -> None:
        """Remove cells from visible set"""

    def is_visible(self, cell_id: str) -> bool:
        """Check if cell is currently visible"""

    def record_action(self, action: ExpansionAction) -> None:
        """Record action in history"""

    def get_new_cells(self, candidates: Set[str]) -> Set[str]:
        """Filter candidates to only new (not visible) cells"""
```

### 3.2 Expansion Action Model

```python
@dataclass
class ExpansionAction:
    """Represents a single expansion or collapse action"""

    type: Literal["expand", "collapse"]
    cells_affected: Set[str]      # Cells added or removed
    nets_affected: Set[str]       # Nets added or removed
    timestamp: datetime
    trigger: str                  # What triggered this action
    direction: Optional[str]      # "fanin", "fanout", or None
    hops: Optional[int]           # For hop-based expansion

    def undo(self, state: ExpansionState) -> None:
        """Reverse this action"""

    def redo(self, state: ExpansionState) -> None:
        """Reapply this action"""
```

### 3.3 State Lifecycle

**Initialization:**
```python
state = ExpansionState(
    visible_cells=set(),
    visible_nets=set(),
    expansion_history=[]
)
```

**During Expansion:**
```python
# 1. Query for cells to expand
candidate_cells = graph_traverser.get_fanout(pin, hops=1)

# 2. Filter to only new cells
new_cells = state.get_new_cells(candidate_cells)

# 3. Add to state
state.add_cells(new_cells)

# 4. Record action
action = ExpansionAction(
    type="expand",
    cells_affected=new_cells,
    nets_affected=new_nets,
    timestamp=datetime.now(),
    trigger="double_click_pin",
    direction="fanout",
    hops=1
)
state.record_action(action)
```

**During Collapse:**
```python
# 1. Validate safe to collapse
safe_cells = {c for c in selected_cells if is_safe_to_collapse(c, state)}

# 2. Remove from state
state.remove_cells(safe_cells)

# 3. Record action
action = ExpansionAction(
    type="collapse",
    cells_affected=safe_cells,
    nets_affected=removed_nets,
    timestamp=datetime.now(),
    trigger="keyboard_delete"
)
state.record_action(action)
```

### 3.4 Performance Considerations

- Use `set` for O(1) membership testing
- Limit history to configurable max (default 100 actions)
- Trim old history when limit reached (keep recent actions)
- Consider weak references for large cell objects

### 3.5 Thread Safety

- ExpansionState must be thread-safe for background expansion
- Use locks or make state immutable with copy-on-write
- Ensure atomic updates (no partial state changes visible)

---

## 4. Dependencies

- **Upstream**:
  - E01 (Data Model - cell and net identifiers)
- **Downstream**:
  - E03-F01 (Hop-Based Expansion - uses state for duplicate prevention)
  - E03-F02 (Collapse Functionality - uses state for safety validation)
  - E03-F03 (Semantic Boundary Expansion - uses state)
  - E04 (Interaction - uses history for undo/redo)
  - E05 (Session Persistence - serializes state for save/load)

---

## 5. Acceptance Criteria

- [ ] ExpansionState class implemented with all required methods
- [ ] ExpansionAction dataclass defined with type, cells, nets, timestamp
- [ ] visible_cells set prevents duplicate expansion
- [ ] visible_nets set tracks net visibility
- [ ] expansion_history records all actions
- [ ] History supports 100+ actions without performance issues
- [ ] get_new_cells() correctly filters already-visible cells
- [ ] is_visible() returns correct state
- [ ] State updates are atomic
- [ ] Thread-safe state access (if needed)
- [ ] Action recording includes all necessary metadata
- [ ] Undo/redo can traverse history correctly

---

## 6. Child Specs

| ID | Task | Status |
|----|------|--------|
| [E03-F04-T01](T01/E03-F04-T01.spec.md) | ExpansionState Aggregate Core | Draft |
| [E03-F04-T02](T02/E03-F04-T02.spec.md) | Undo/Redo State Navigation | Draft |
| [E03-F04-T03](T03/E03-F04-T03.spec.md) | Expansion State Events | Draft |

---

## Revision History

| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-12-26 | 0.1 | Claude | Initial feature creation from E03 split |
