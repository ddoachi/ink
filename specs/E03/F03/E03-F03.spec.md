---
id: E03-F03
title: Semantic Boundary Expansion
type: Feature
priority: P1
status: Draft
parent: E03
created: 2025-12-26
estimated_hours:
actual_hours:
effort:
tags: []
---

# Spec: E03-F03 - Semantic Boundary Expansion

## 1. Overview

### 1.1 Problem Statement

When analyzing combinational logic cones, engineers often want to expand until they reach a meaningful boundary (latch, flip-flop, or top-level port) rather than expanding a fixed number of hops. Hop-based expansion may stop in the middle of combinational logic or expand too far into sequential elements. Semantic boundary expansion provides a more natural stopping point based on circuit topology.

### 1.2 Goals

- Enable expansion to the nearest sequential element (latch/FF) boundary
- Support expansion to top-level input/output ports
- Work in both fanin and fanout directions
- Respect user-configurable latch/FF identification patterns
- Provide clear visual indication of boundary elements

---

## 2. User Stories

### US-E03-05: Semantic Boundary Expansion (P1)
**As a** circuit designer
**I want to** expand to the nearest latch or port
**So that** I can see the full combinational cone

**Acceptance Criteria:**
- [ ] "Expand to Boundary" option in context menu
- [ ] Expansion stops at cells marked as sequential
- [ ] Expansion stops at top-level ports
- [ ] Works for both fanin and fanout directions

### US-E03-07: Configure Latch Patterns
**As a** circuit designer
**I want to** configure which cell types are considered sequential
**So that** boundary expansion works correctly for my design

**Acceptance Criteria:**
- [ ] Settings dialog allows configuring latch/FF patterns
- [ ] Default patterns match common naming conventions
- [ ] Patterns support wildcards (e.g., `*LATCH*`, `*DFF*`, `*FF*`)
- [ ] Changes apply immediately to future expansions

---

## 3. Technical Requirements

### 3.1 Latch Identification

Based on PRD ยง3.3:
- Latch identification based on cell type naming patterns (configurable)
- Default patterns: `*LATCH*`, `*DFF*`, `*FF*`
- Wildcard matching using fnmatch or regex
- Case-insensitive matching

```python
class SequentialDetector:
    def __init__(self, patterns: List[str] = None):
        self.patterns = patterns or ["*LATCH*", "*DFF*", "*FF*"]

    def is_sequential(self, cell: Cell) -> bool:
        """Check if cell is a sequential element"""
        cell_type = cell.cell_type.upper()
        return any(fnmatch(cell_type, pattern.upper())
                   for pattern in self.patterns)
```

### 3.2 Graph Traversal API

```python
class GraphTraverser:
    def get_cone_to_boundary(self, pin: Pin, direction: str) -> Set[Cell]:
        """Get all cells to nearest sequential/port boundary

        Args:
            pin: Starting pin
            direction: "fanin" or "fanout"

        Returns:
            Set of cells in combinational cone up to boundary
        """
```

### 3.3 Boundary Detection Algorithm

```
1. Start from selected pin/net/cell
2. Traverse graph in specified direction (fanin/fanout)
3. For each cell encountered:
   a. Check if cell is sequential (using SequentialDetector)
   b. Check if cell connects to top-level port
   c. If boundary found: add cell but stop traversing through it
   d. If not boundary: add cell and continue traversal
4. Return all cells in combinational cone
```

### 3.4 Boundary Types

**Sequential Boundaries:**
- Flip-flops (DFF, DFFR, etc.)
- Latches (LATCH)
- Memory elements
- Identified by configurable naming patterns

**Port Boundaries:**
- Top-level input ports (for fanin direction)
- Top-level output ports (for fanout direction)
- Inout ports (both directions)

### 3.5 Configuration

**Expansion Settings Dialog (PRD ยง5.4):**
- Default expansion mode dropdown: [Hop-based | Boundary-based]
- Latch/FF identification patterns (text area with one pattern per line)
- "Stop at ports" checkbox
- "Stop at sequential" checkbox
- Preview showing which cells match current patterns

---

## 4. Dependencies

- **Upstream**:
  - E01 (Data Model - cell type information, port information)
  - E03-F01 (Hop-Based Expansion - shares core expansion logic)
  - E03-F04 (Expansion State Management)
- **Downstream**:
  - E04 (Interaction - undo/redo)

---

## 5. Acceptance Criteria

- [ ] "Expand to Boundary" option appears in right-click context menu
- [ ] Fanout expansion stops at sequential cells and output ports
- [ ] Fanin expansion stops at sequential cells and input ports
- [ ] Default latch/FF patterns match common naming conventions
- [ ] Expansion Settings dialog allows configuring patterns
- [ ] Pattern changes apply immediately
- [ ] Wildcard patterns work correctly (e.g., `*LATCH*`, `*DFF*`)
- [ ] Case-insensitive pattern matching
- [ ] Boundary cells are included in expansion (visible but not traversed)
- [ ] Visual distinction for boundary cells (different color/style)
- [ ] Expansion completes in reasonable time (<1s for typical cones)
- [ ] Boundary expansion is recorded for undo/redo

---

## 6. Child Specs

*To be created via `/spec_work E03-F03 --split tasks`*

| ID | Task | Status |
|----|------|--------|

---

## Revision History

| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-12-26 | 0.1 | Claude | Initial feature creation from E03 split |
