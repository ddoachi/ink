# E03-F02-T04 - Context Menu Integration: Pre-Implementation Documentation

## Document Information
- **Task**: E03-F02-T04 - Context Menu Integration
- **Status**: Pre-Implementation Planning
- **Created**: 2025-12-26
- **Last Updated**: 2025-12-26

---

## 1. Overview

### 1.1 Task Summary

This task integrates collapse functionality into the application's context menu system, providing users with intuitive right-click access to collapse operations. It implements both single-cell collapse and subtree collapse menu options, with intelligent enabling/disabling based on the current selection and expansion state.

Context menus are a primary interaction pattern for power users, making this task critical for workflow efficiency.

### 1.2 Problem Context

While keyboard shortcuts (Delete/Backspace) provide quick access to collapse, users need discoverable, contextual access to collapse operations:

1. **Discoverability**: New users won't know keyboard shortcuts exist
2. **Context-Aware Actions**: Menu should show/hide options based on what's possible
3. **Multiple Collapse Modes**: Users need access to both single-cell and subtree collapse
4. **Visual Feedback**: Menu labels should indicate what will happen (e.g., "Collapse 3 cells")
5. **Consistency**: Collapse actions should appear in both context menu and Edit menu

The context menu serves as both a discovery mechanism and a primary interaction point for cell operations.

### 1.3 Success Criteria

- Right-click on cell shows context menu with collapse options
- "Collapse" menu item enabled when cells are selected
- "Collapse Subtree" menu item enabled when selected cells have expansion children
- Keyboard shortcuts displayed in menu labels
- Menu integrates smoothly with existing actions (Expand, Properties, etc.)
- Multi-cell selection supported for batch collapse
- Menu appearance consistent with application theme

---

## 2. Implementation Approach

### 2.1 Context Menu Structure

**Cell Context Menu Hierarchy**:
```
┌─────────────────────────────────────┐
│ Collapse                    Delete  │  ← Single cell collapse
│ Collapse Subtree      Shift+Delete  │  ← Subtree collapse
├─────────────────────────────────────┤
│ Expand Fanout...                    │  ← Existing expansion actions
│ Expand Fanin...                     │
│ Expand to Boundary...               │
├─────────────────────────────────────┤
│ Properties...                       │  ← Existing property actions
│ Highlight Connections               │
│ Trace Path...                       │
└─────────────────────────────────────┘
```

**Design Rationale**:
- Collapse actions at top (most destructive, should be visible)
- Separator between collapse and expand (opposite operations)
- Expansion actions grouped together
- Properties/analysis actions at bottom

### 2.2 Menu Item State Logic

**Collapse Action**:
```python
# Enabled if:
selected_cells = canvas.get_selected_cells()
can_collapse = len(selected_cells) > 0

collapse_action.setEnabled(can_collapse)
```

**Collapse Subtree Action**:
```python
# Enabled if:
# 1. At least one cell is selected
# 2. At least one selected cell has expansion children

has_children = any(
    expansion_state_repo.get_expansion_children(cell_id)
    for cell_id in selected_cells
)

collapse_subtree_action.setEnabled(has_children)
```

**Dynamic Labels** (Optional Enhancement):
```python
# Show count in label
if len(selected_cells) == 1:
    label = "Collapse"
else:
    label = f"Collapse ({len(selected_cells)} cells)"

collapse_action.setText(label)
```

### 2.3 Event Flow

**User Action → Collapse Execution**:
```
1. User right-clicks on CellItem
   ↓
2. SchematicCanvas.contextMenuEvent() triggered
   ↓
3. Identify item type (CellItem, NetItem, or empty canvas)
   ↓
4. If CellItem → _show_cell_context_menu()
   ↓
5. Create QMenu with actions
   ↓
6. Get selected cells (may include clicked cell + multi-selection)
   ↓
7. Enable/disable actions based on state
   ↓
8. Show menu at cursor position (menu.exec(global_pos))
   ↓
9. User clicks "Collapse"
   ↓
10. Action triggered → canvas.collapse_cells(selected_cells)
    ↓
11. CollapseService executes → returns CollapseResult
    ↓
12. Canvas animates collapse (from T03)
    ↓
13. Status message displayed
```

### 2.4 Multi-Selection Handling

**Challenge**: User may right-click on a cell that isn't currently selected.

**Solution**:
```python
def _show_cell_context_menu(self, cell_item: CellItem, global_pos: QPoint):
    selected_cells = self.get_selected_cells()

    # If clicked cell isn't in selection, treat it as single selection
    if cell_item.cell_id not in selected_cells:
        selected_cells = {cell_item.cell_id}

    # Now operate on selected_cells (includes clicked cell)
    # ...
```

**Rationale**:
- Matches standard UX behavior (e.g., file explorers)
- Allows quick action on single cell without deselecting others first
- Preserves multi-selection when right-clicking within selection

### 2.5 Edit Menu Integration

**Main Menu Bar**:
```
File  Edit  View  Tools  Help
      │
      ├── Undo           Ctrl+Z
      ├── Redo           Ctrl+Shift+Z
      ├──────────────────────────
      ├── Select All     Ctrl+A
      ├── Deselect All   Ctrl+Shift+A
      ├──────────────────────────
      ├── Collapse       Delete
      └── Collapse Subtree Shift+Delete
```

**Dynamic Enabling**:
```python
# Connect to selection change signal
canvas.selectionChanged.connect(self._update_menu_state)

def _update_menu_state(self):
    selected = self.canvas.get_selected_cells()

    # Enable collapse if any cells selected
    self.collapse_action.setEnabled(len(selected) > 0)

    # Enable collapse subtree if any selected cells have children
    has_children = any(
        self.canvas._has_expansion_children(cell_id)
        for cell_id in selected
    )
    self.collapse_subtree_action.setEnabled(has_children)
```

---

## 3. Key Design Decisions

### 3.1 Menu Placement: Context Menu vs Edit Menu vs Both

**Decision**: Provide collapse actions in BOTH context menu and Edit menu

**Rationale**:
- Context menu: Convenient, contextual, right-click workflow
- Edit menu: Discoverable, shows keyboard shortcuts, standard location
- Both: Accommodates different user preferences (mouse users vs keyboard users)

**Alternative**: Context menu only
- Simpler implementation
- Less discoverable for keyboard users

**Alternative**: Edit menu only
- More consistent with desktop conventions
- Slower for mouse-driven workflows

**Trade-offs**:
- Pro: Maximum accessibility and discoverability
- Pro: Follows platform conventions (most apps have both)
- Con: Slight duplication in implementation (acceptable)

### 3.2 Action Enabling Strategy: Strict vs Permissive

**Decision**: Strict enabling - disable actions when they can't succeed

**Rationale**:
- Prevents frustrating failure feedback ("Cannot collapse, no cells selected")
- Provides visual affordance (grayed out = not available)
- Educates users about when actions are applicable

**Alternative**: Permissive - always enable, show error message on failure
- Simpler logic (no state checking)
- Frustrating user experience (have to try to find out it won't work)

**Alternative**: Hide actions instead of disabling
- Cleaner menu (no grayed items)
- Confusing (users wonder where action went)

**Trade-offs**:
- Pro: Clear visual feedback about action availability
- Pro: Reduces user errors and frustration
- Con: Requires state checking on every menu show

### 3.3 Subtree Collapse Visibility: Always Show vs Conditional

**Decision**: Always show "Collapse Subtree", enable/disable based on state

**Rationale**:
- Consistent menu layout (items don't appear/disappear)
- Educates users that subtree collapse exists
- Grayed state explains when it's applicable

**Alternative**: Only show if applicable
- Cleaner menu when not needed
- Inconsistent layout (confusing)

**Trade-offs**:
- Pro: Discoverable - users learn about feature even if not currently applicable
- Pro: Consistent menu structure
- Con: Slightly more visual clutter

### 3.4 Menu Shortcuts Display: Show vs Hide

**Decision**: Display keyboard shortcuts in menu labels

**Rationale**:
- Educates users about shortcuts
- Follows platform conventions
- Encourages keyboard workflow adoption

**Alternative**: Don't show shortcuts
- Cleaner menu appearance
- Users must discover shortcuts elsewhere (help, docs)

**Trade-offs**:
- Pro: Users learn shortcuts organically through menu usage
- Pro: Consistent with all major applications
- Con: Slightly wider menu (negligible)

---

## 4. Dependencies and Integration Points

### 4.1 Upstream Dependencies

**E03-F02-T01 (Collapse Command)**:
- Requires `CollapseService` for execution
- Uses `CollapseResult` for feedback

**E03-F02-T02 (Subtree Collapse)**:
- Requires `CollapseSubtreeCommand`
- Uses `ExpansionStateRepository.get_expansion_children()`

**E03-F02-T03 (Collapse Visual Feedback)**:
- Uses `canvas.collapse_cells()` which handles animation
- Uses `canvas.collapse_subtree()` for subtree operations
- Warning dialogs triggered automatically by canvas

**E04 (Interaction System)**:
- Requires selection system (`canvas.get_selected_cells()`)
- Uses `CellItem` selection state

### 4.2 Downstream Integration

**User Workflows**:
- Right-click workflow: Select cells → right-click → choose collapse option
- Menu workflow: Select cells → Edit menu → Collapse
- Keyboard workflow: Select cells → press Delete (already implemented in T03)

**Future Features**:
- Collapse history (undo/redo) - E04
- Session persistence - may need to save which cells were collapsed
- Scripting/automation - context menu actions could be exposed to scripts

### 4.3 Integration Risks

**Risk**: Context menu conflicts with existing expansion menu

**Impact**: Low - Menu becomes too large, cluttered
**Probability**: Low - Collapse actions are distinct
**Mitigation**:
- Group logically with separators
- Consider sub-menu if menu becomes >10 items (defer to P1)

**Risk**: Selection state is inconsistent when menu is shown

**Impact**: Medium - Menu enables wrong actions
**Probability**: Low - Selection state is well-defined
**Mitigation**:
- Re-check state when menu is shown (not when created)
- Add defensive checks in action handlers

**Risk**: Keyboard shortcuts conflict with other actions

**Impact**: Medium - Shortcut doesn't work as expected
**Probability**: Low - Delete key is standard for remove/collapse
**Mitigation**:
- Document shortcuts clearly
- Make shortcuts configurable (P1)
- Test on different platforms

---

## 5. Testing Strategy

### 5.1 Manual Testing

**Context Menu Tests**:
- Right-click on cell → verify menu appears
- Verify "Collapse" action present
- Verify "Collapse Subtree" action present
- Verify shortcuts shown in labels (Delete, Shift+Delete)

**State Enabling Tests**:
- No selection → right-click → verify collapse disabled
- Select 1 cell → right-click → verify collapse enabled
- Select cell with no children → verify subtree disabled
- Select cell with children → verify subtree enabled

**Multi-Selection Tests**:
- Select 3 cells → right-click on one → verify all 3 collapse
- Right-click on unselected cell → verify only that cell collapses

**Edit Menu Tests**:
- Open Edit menu → verify Collapse actions present
- No selection → verify actions disabled
- Select cells → verify actions enabled

**Functional Tests**:
- Collapse via context menu → verify animation plays
- Collapse subtree via context menu → verify all descendants collapse
- Verify status messages appear

### 5.2 Automated Tests (UI Tests)

**Menu Creation Tests**:
```python
def test_context_menu_shows_collapse_actions(qtbot):
    canvas = create_test_canvas()
    cell_item = create_test_cell_item()

    # Simulate right-click
    menu = canvas._create_cell_context_menu(cell_item, QPoint(0, 0))

    # Verify actions exist
    actions = [a.text() for a in menu.actions()]
    assert "Collapse" in actions
    assert "Collapse Subtree" in actions

def test_collapse_action_disabled_no_selection(qtbot):
    canvas = create_test_canvas()
    # No selection
    canvas.scene().clearSelection()

    menu = canvas._create_cell_context_menu(cell_item, QPoint(0, 0))
    collapse_action = find_action(menu, "Collapse")

    assert not collapse_action.isEnabled()

def test_collapse_action_enabled_with_selection(qtbot):
    canvas = create_test_canvas()
    cell_item.setSelected(True)

    menu = canvas._create_cell_context_menu(cell_item, QPoint(0, 0))
    collapse_action = find_action(menu, "Collapse")

    assert collapse_action.isEnabled()
```

**Subtree Action Tests**:
```python
def test_subtree_action_disabled_no_children(qtbot):
    canvas = create_test_canvas()
    # Cell with no expansion children

    menu = canvas._create_cell_context_menu(cell_item, QPoint(0, 0))
    subtree_action = find_action(menu, "Collapse Subtree")

    assert not subtree_action.isEnabled()

def test_subtree_action_enabled_with_children(qtbot):
    # Setup: Expand cell A → B, C
    # So A has expansion children

    menu = canvas._create_cell_context_menu(cell_A_item, QPoint(0, 0))
    subtree_action = find_action(menu, "Collapse Subtree")

    assert subtree_action.isEnabled()
```

**Integration Tests**:
```python
def test_context_menu_collapse_triggers_service(qtbot, mocker):
    canvas = create_test_canvas()
    collapse_spy = mocker.spy(canvas.collapse_service, 'execute')

    # Simulate menu action
    canvas._on_collapse_menu_triggered(selected_cells={CellId("A")})

    # Verify service called
    assert collapse_spy.called
    assert CellId("A") in collapse_spy.call_args[0][0].cell_ids

def test_context_menu_collapse_shows_animation(qtbot):
    canvas = create_test_canvas()

    # Trigger collapse from menu
    canvas.collapse_cells({CellId("A")})

    # Wait for animation
    qtbot.wait(300)

    # Verify cell removed
    assert CellId("A") not in canvas._cell_items
```

### 5.3 Edge Cases

- Right-click on cell that's part of multi-selection
- Right-click on cell that's not selected (should operate on that cell only)
- Context menu shown during animation (should cancel animation)
- Collapse action on already-collapsed cell (should be grayed out - not in selection)
- Very long cell names in status message (should truncate gracefully)

### 5.4 Cross-Platform Testing

- Linux: Verify right-click behavior
- macOS: Verify right-click (Ctrl+click) behavior
- Windows: Verify right-click behavior
- Test keyboard shortcuts on all platforms (Delete key may behave differently)

---

## 6. Risks and Considerations

### 6.1 Technical Risks

**Risk**: Context menu positioning is incorrect on multi-monitor setups

**Impact**: Low - Menu appears on wrong monitor or off-screen
**Probability**: Low - Qt handles this, but edge cases exist
**Mitigation**:
- Use `menu.exec(global_pos)` which handles positioning
- Test on multi-monitor setups
- Fallback to cursor position if global_pos is invalid

**Risk**: Menu state becomes stale if selection changes while menu is open

**Impact**: Low - Menu shows outdated state
**Probability**: Low - Menu is modal (blocks other interactions)
**Mitigation**:
- Menu is modal, selection can't change
- If non-modal menu added later, re-check state on action trigger

**Risk**: Keyboard shortcuts conflict with system shortcuts

**Impact**: Medium - Shortcuts don't work
**Probability**: Medium - Delete key is often system-wide
**Mitigation**:
- Provide alternative shortcuts (Backspace)
- Make shortcuts configurable
- Document platform-specific issues

### 6.2 UX Risks

**Risk**: Users accidentally collapse when they meant to expand

**Impact**: Medium - Workflow disruption, requires undo
**Probability**: Low - Collapse and expand are separate menu sections
**Mitigation**:
- Clear visual separation in menu (separator line)
- Collapse at top, expand below (users read top-down)
- Undo support (E04) allows recovery

**Risk**: Users don't discover subtree collapse feature

**Impact**: Low - Useful feature goes unused
**Probability**: Medium - May not read menu carefully
**Mitigation**:
- Always show (even if disabled) for discoverability
- Tooltip explaining what subtree collapse does
- User guide documentation

**Risk**: Menu becomes too large with too many actions

**Impact**: Low - Overwhelming, hard to find desired action
**Probability**: Low - Currently ~8 actions planned
**Mitigation**:
- Limit to essential actions
- Use sub-menus if needed (P1)
- User testing to validate menu structure

### 6.3 Consistency Risks

**Risk**: Context menu and Edit menu become inconsistent

**Impact**: Medium - Confusing user experience
**Probability**: Medium - Two places to maintain
**Mitigation**:
- Share action objects between menus
- Single source of truth for enabling logic
- Integration tests verify both menus

**Risk**: Context menu style doesn't match application theme

**Impact**: Low - Visual inconsistency
**Probability**: Low - Qt handles theming
**Mitigation**:
- Use Qt style sheets consistently
- Test with different themes (dark/light)
- Provide custom styling if needed

---

## 7. Open Questions

### 7.1 Resolved Questions

**Q**: Should collapse be at top or bottom of context menu?
**A**: Top - most destructive actions typically at top (Delete in file browsers, etc.)

**Q**: Should we show cell count in menu label ("Collapse (3 cells)")?
**A**: No for MVP - adds complexity. Consider for P1 if user feedback indicates value.

**Q**: Should context menu be reusable or recreated each time?
**A**: Recreated - simpler state management, negligible performance cost.

### 7.2 Open Questions

**Q**: Should we add "Collapse All" option to Edit menu?
**A**: **Probably not** - contradicts incremental exploration philosophy. May reconsider if users request it for cleanup.

**Q**: Should collapse actions be in a sub-menu ("Collapse >") or top-level?
**A**: **Top-level for MVP** - more direct access. Sub-menu if menu becomes cluttered (>10 items).

**Q**: Should we show tooltip on hover over menu items?
**A**: **Nice to have, defer to P1**. Qt doesn't natively support menu item tooltips, requires custom implementation.

**Q**: Should we support customizable context menus?
**A**: **Defer to P1**. Fixed menu structure for MVP, make configurable if users request.

---

## 8. Implementation Checklist

### 8.1 Phase 1: Context Menu Structure
- [ ] Implement `contextMenuEvent()` override in `SchematicCanvas`
- [ ] Implement `_show_cell_context_menu()` method
- [ ] Create QMenu and add collapse actions
- [ ] Add keyboard shortcut labels to actions
- [ ] Test menu appears on right-click

### 8.2 Phase 2: Action State Logic
- [ ] Implement `get_selected_cells()` method
- [ ] Implement `_has_expansion_children()` helper method
- [ ] Add logic to enable/disable Collapse action
- [ ] Add logic to enable/disable Collapse Subtree action
- [ ] Test state logic with various selections

### 8.3 Phase 3: Action Handlers
- [ ] Connect Collapse action to `collapse_cells()`
- [ ] Implement `collapse_subtree()` method
- [ ] Handle multi-selection correctly
- [ ] Handle right-click on unselected cell
- [ ] Test collapse operations from menu

### 8.4 Phase 4: Edit Menu Integration
- [ ] Add Collapse actions to Edit menu in `MainWindow`
- [ ] Connect to same handlers as context menu
- [ ] Implement `_update_menu_state()` for dynamic enabling
- [ ] Connect to `selectionChanged` signal
- [ ] Test Edit menu actions

### 8.5 Phase 5: Polish and Testing
- [ ] Add status tips for menu actions
- [ ] Test on multiple platforms
- [ ] Test multi-selection scenarios
- [ ] Integration testing with collapse service
- [ ] Documentation and code review

---

## 9. References

- **Task Spec**: `/home/joohan/dev/project-ink/ink/specs/E03/F02/T04/E03-F02-T04.spec.md`
- **Feature Spec**: `/home/joohan/dev/project-ink/ink/specs/E03/F02/E03-F02.spec.md`
- **Epic Spec**: `/home/joohan/dev/project-ink/ink/specs/E03/E03.spec.md`
- **Qt Documentation**:
  - [QMenu](https://doc.qt.io/qt-6/qmenu.html)
  - [QAction](https://doc.qt.io/qt-6/qaction.html)
  - [QContextMenuEvent](https://doc.qt.io/qt-6/qcontextmenuevent.html)
- **Related Tasks**:
  - E03-F02-T01: Collapse Command Implementation (service)
  - E03-F02-T02: Subtree Collapse Logic (subtree operations)
  - E03-F02-T03: Collapse Visual Feedback (animation and dialogs)
  - E04: Interaction (selection system)

---

## 10. Revision History

| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-12-26 | 1.0 | Claude | Initial pre-implementation documentation |
