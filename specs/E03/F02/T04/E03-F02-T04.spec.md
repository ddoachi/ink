---
id: E03-F02-T04
title: Context Menu Integration
type: Task
priority: P0 (MVP)
status: Draft
parent: E03-F02
created: 2025-12-26
estimated_hours: 3
actual_hours:
effort: Small
tags:
  - collapse
  - context-menu
  - ui
  - interaction
---

# Spec: E03-F02-T04 - Context Menu Integration

## 1. Overview

### 1.1 Problem Statement
Users need an intuitive way to trigger collapse operations through right-click context menus on selected cells. The context menu should provide options for both single-cell collapse and subtree collapse, with appropriate enabling/disabling based on the current selection and expansion state.

### 1.2 Goals
- Add "Collapse" and "Collapse Subtree" options to cell context menu
- Enable/disable menu items based on selection validity
- Integrate with existing context menu system
- Provide keyboard shortcuts in menu labels
- Support multi-cell selection for batch collapse

---

## 2. Technical Requirements

### 2.1 File Structure

```
src/ink/presentation/
├── canvas/
│   └── schematic_canvas.py      # Add context menu actions
└── menus/
    └── cell_context_menu.py     # Cell right-click menu (new or extend existing)
```

### 2.2 Context Menu Actions

**File**: `src/ink/presentation/canvas/schematic_canvas.py` (additions)

```python
from PySide6.QtWidgets import QMenu
from PySide6.QtCore import QPoint, Qt
from PySide6.QtGui import QAction, QKeySequence

class SchematicCanvas(QGraphicsView):
    # ... existing code ...

    def contextMenuEvent(self, event: QContextMenuEvent) -> None:
        """Handle right-click context menu"""
        # Get item at mouse position
        pos = event.pos()
        scene_pos = self.mapToScenePos(pos)
        item = self.itemAt(pos)

        if isinstance(item, CellItem):
            self._show_cell_context_menu(item, event.globalPos())
        elif isinstance(item, NetItem):
            self._show_net_context_menu(item, event.globalPos())
        else:
            self._show_canvas_context_menu(event.globalPos())

    def _show_cell_context_menu(self, cell_item: CellItem, global_pos: QPoint) -> None:
        """Show context menu for cell"""
        menu = QMenu(self)

        # Get selected cells (may include the clicked cell + others)
        selected_cells = self.get_selected_cells()
        if cell_item.cell_id not in selected_cells:
            selected_cells = {cell_item.cell_id}

        # === Collapse Actions ===

        # Collapse (selected cells only)
        collapse_action = QAction("Collapse", menu)
        collapse_action.setShortcut(QKeySequence(Qt.Key.Key_Delete))
        collapse_action.triggered.connect(
            lambda: self.collapse_cells(selected_cells, force=False)
        )

        # Determine if any selected cells can be collapsed
        can_collapse = len(selected_cells) > 0
        collapse_action.setEnabled(can_collapse)

        menu.addAction(collapse_action)

        # Collapse Subtree (includes all descendants)
        collapse_subtree_action = QAction("Collapse Subtree", menu)
        collapse_subtree_action.setShortcut(QKeySequence("Shift+Delete"))
        collapse_subtree_action.triggered.connect(
            lambda: self.collapse_subtree(selected_cells, force=False)
        )

        # Enable if at least one cell has been expanded from (has children)
        has_children = any(
            self._has_expansion_children(cell_id)
            for cell_id in selected_cells
        )
        collapse_subtree_action.setEnabled(has_children)

        menu.addAction(collapse_subtree_action)

        menu.addSeparator()

        # === Expansion Actions (existing) ===
        expand_action = QAction("Expand Fanout...", menu)
        expand_action.triggered.connect(
            lambda: self._show_expansion_dialog(selected_cells, "fanout")
        )
        menu.addAction(expand_action)

        # ... other existing actions (properties, highlight, etc.) ...

        menu.exec(global_pos)

    def collapse_subtree(self, root_cell_ids: Set[CellId], force: bool = False) -> None:
        """Collapse subtree from root cells"""
        from ...application.commands.collapse_command import CollapseSubtreeCommand

        command = CollapseSubtreeCommand(root_cell_ids=root_cell_ids, force=force)
        result = self.collapse_service.execute_subtree(command)

        if not result.success:
            if result.skipped_cell_ids and not force:
                self._show_collapse_warning(result)
            else:
                self._show_status_message(result.message, error=True)
            return

        # Animate collapse
        self._animate_collapse(result)
        self._show_status_message(result.message)

    def _has_expansion_children(self, cell_id: CellId) -> bool:
        """Check if cell has any expansion children"""
        # Query expansion state repository
        children = self.expansion_state_repo.get_expansion_children(cell_id)
        return len(children) > 0

    def get_selected_cells(self) -> Set[CellId]:
        """Get currently selected cell IDs"""
        selected = set()
        for item in self.scene().selectedItems():
            if isinstance(item, CellItem):
                selected.add(item.cell_id)
        return selected
```

### 2.3 Menu Shortcuts Display

**File**: `src/ink/presentation/main_window.py` (additions)

```python
class MainWindow(QMainWindow):
    # ... existing code ...

    def _create_edit_menu(self) -> None:
        """Create Edit menu with collapse actions"""
        edit_menu = self.menuBar().addMenu("&Edit")

        # ... existing actions (Undo, Redo, Select All, etc.) ...

        edit_menu.addSeparator()

        # Collapse
        collapse_action = QAction("&Collapse", self)
        collapse_action.setShortcuts([
            QKeySequence(Qt.Key.Key_Delete),
            QKeySequence(Qt.Key.Key_Backspace)
        ])
        collapse_action.setStatusTip("Collapse selected cells")
        collapse_action.triggered.connect(self._on_collapse_triggered)
        edit_menu.addAction(collapse_action)
        self.collapse_action = collapse_action

        # Collapse Subtree
        collapse_subtree_action = QAction("Collapse &Subtree", self)
        collapse_subtree_action.setShortcut(QKeySequence("Shift+Delete"))
        collapse_subtree_action.setStatusTip("Collapse selected cells and all descendants")
        collapse_subtree_action.triggered.connect(self._on_collapse_subtree_triggered)
        edit_menu.addAction(collapse_subtree_action)
        self.collapse_subtree_action = collapse_subtree_action

        # Update enabled state based on selection
        self.canvas.selectionChanged.connect(self._update_menu_state)

    def _on_collapse_triggered(self) -> None:
        """Handle collapse action from menu"""
        selected = self.canvas.get_selected_cells()
        if selected:
            self.canvas.collapse_cells(selected)

    def _on_collapse_subtree_triggered(self) -> None:
        """Handle collapse subtree action from menu"""
        selected = self.canvas.get_selected_cells()
        if selected:
            self.canvas.collapse_subtree(selected)

    def _update_menu_state(self) -> None:
        """Update menu item enabled states based on selection"""
        selected = self.canvas.get_selected_cells()

        # Enable collapse if any cells selected
        has_selection = len(selected) > 0
        self.collapse_action.setEnabled(has_selection)

        # Enable collapse subtree if any selected cells have children
        has_children = any(
            self.canvas._has_expansion_children(cell_id)
            for cell_id in selected
        )
        self.collapse_subtree_action.setEnabled(has_children)
```

### 2.4 Context Menu Styling (Optional Enhancement)

```python
class CellContextMenu(QMenu):
    """Styled context menu for cells"""

    def __init__(self, parent=None):
        super().__init__(parent)
        self._setup_style()

    def _setup_style(self) -> None:
        """Apply consistent styling"""
        self.setStyleSheet("""
            QMenu {
                background-color: #2b2b2b;
                color: #cccccc;
                border: 1px solid #555555;
                padding: 4px;
            }
            QMenu::item {
                padding: 6px 25px 6px 20px;
            }
            QMenu::item:selected {
                background-color: #3d3d3d;
            }
            QMenu::separator {
                height: 1px;
                background-color: #555555;
                margin: 4px 0px;
            }
        """)
```

---

## 3. Dependencies

- **Upstream**:
  - E03-F02-T01 (Collapse Command) - provides collapse service
  - E03-F02-T02 (Subtree Collapse) - provides subtree collapse logic
  - E03-F02-T03 (Collapse Visual Feedback) - provides animation and warnings
  - E04 (Interaction) - requires selection system
- **Downstream**: None (final integration task)

---

## 4. Acceptance Criteria

- [ ] Right-click on cell shows context menu
- [ ] Context menu contains "Collapse" option
- [ ] Context menu contains "Collapse Subtree" option
- [ ] "Collapse" enabled only when cells are selected
- [ ] "Collapse Subtree" enabled only when selected cells have expansion children
- [ ] Keyboard shortcuts displayed in menu (Delete, Shift+Delete)
- [ ] Menu actions trigger appropriate collapse operations
- [ ] Multi-cell selection supported (collapse all selected)
- [ ] Context menu closes after action triggered
- [ ] Edit menu contains "Collapse" and "Collapse Subtree" actions
- [ ] Menu items update enabled state when selection changes
- [ ] Status tips shown in status bar when hovering over menu items
- [ ] Context menu positioned at mouse cursor location
- [ ] Menu appearance consistent with application theme

---

## Revision History

| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-12-26 | 0.1 | Claude | Initial task creation |
