# Spec: E03-F02 - Collapse Functionality

## Metadata
- **ID**: E03-F02
- **Type**: Feature
- **Priority**: P0 (MVP)
- **Status**: Draft
- **Parent**: [E03](../E03.spec.md)
- **Created**: 2025-12-26

---

## 1. Overview

### 1.1 Problem Statement

After exploring connectivity through expansion, users need a way to simplify the view by hiding previously expanded cells. This prevents the schematic from becoming cluttered and allows users to focus on specific areas of interest. Collapse functionality must intelligently handle dependencies to avoid orphaning connected cells.

### 1.2 Goals

- Enable collapsing (hiding) of previously expanded cells
- Provide smart collapse that preserves connectivity integrity
- Support both single-cell collapse and subtree collapse
- Offer keyboard shortcuts for efficient workflow
- Maintain view consistency after collapse operations

---

## 2. User Stories

### US-E03-04: Collapse Subtree
**As a** circuit designer
**I want to** collapse previously expanded cells
**So that** I can simplify the view

**Acceptance Criteria:**
- [ ] Right-click menu offers "Collapse"
- [ ] Collapse hides selected cells and their dependencies
- [ ] Cells connected to other visible cells remain visible
- [ ] Keyboard shortcut (Delete/Backspace) for collapse

### US-E03-06: Smart Collapse
**As a** circuit designer
**I want to** collapse only safe-to-hide cells
**So that** I don't break connectivity in the view

**Acceptance Criteria:**
- [ ] Cells with connections to other visible cells remain visible
- [ ] Warning shown if collapse would orphan cells
- [ ] Option to force collapse with confirmation

---

## 3. Technical Requirements

### 3.1 Collapse Algorithm

```
1. User selects cells to collapse
2. Identify cells safe to hide (not connected to other visible cells)
3. Calculate which nets become invisible
4. Animate elements out of view
5. Update layout to fill gaps (optional)
6. Record action in expansion history
```

### 3.2 Safety Validation

```python
def is_safe_to_collapse(cell: Cell, visible_cells: Set[str]) -> bool:
    """Check if cell can be safely hidden without breaking connectivity"""
    # Get all cells connected to this cell
    connected = get_connected_cells(cell)

    # Check if any connected cells (other than cell itself) are visible
    other_visible = connected.intersection(visible_cells) - {cell.id}

    # Safe to collapse if no other visible cells depend on it
    return len(other_visible) == 0
```

### 3.3 Collapse Modes

**Single Cell Collapse:**
- Hides only the selected cell
- Validates safety before hiding
- Shows warning if unsafe

**Subtree Collapse:**
- Identifies all cells that were expanded from the selected cell
- Recursively collapses child cells
- Uses dependency tracking from expansion history

### 3.4 UI Triggers

- **Right-click context menu**: "Collapse" option on selected cells
- **Keyboard shortcuts**: Delete or Backspace key
- **Menu action**: Edit > Collapse Selection

### 3.5 Visual Feedback

- Fade-out animation for collapsing cells (200-300ms)
- Smooth layout adjustment to fill gaps
- Status bar message: "Collapsed N cells"
- Undo notification: "Ctrl+Z to undo"

---

## 4. Dependencies

- **Upstream**:
  - E03-F01 (Hop-Based Expansion - must have expansion before collapse)
  - E03-F04 (Expansion State Management - tracks visible cells)
- **Downstream**:
  - E04 (Interaction - undo/redo for collapse actions)

---

## 5. Acceptance Criteria

- [ ] Right-click menu shows "Collapse" option on selected cells
- [ ] Keyboard shortcuts (Delete/Backspace) trigger collapse
- [ ] Collapse updates view in <100ms
- [ ] Safe-to-collapse validation prevents orphaned cells
- [ ] Warning dialog shown for unsafe collapse attempts
- [ ] Collapse animation fades out smoothly (200-300ms)
- [ ] Layout adjusts to fill gaps after collapse
- [ ] Collapsed cells are removed from visible_cells set
- [ ] Associated nets are hidden if no longer connected
- [ ] Collapse actions are recorded for undo/redo
- [ ] Status bar shows confirmation message
- [ ] Multiple cells can be collapsed simultaneously

---

## 6. Child Specs

*To be created via `/spec_work E03-F02 --split tasks`*

| ID | Task | Status |
|----|------|--------|

---

## Revision History

| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-12-26 | 0.1 | Claude | Initial feature creation from E03 split |
