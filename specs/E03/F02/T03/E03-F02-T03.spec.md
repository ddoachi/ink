---
id: E03-F02-T03
title: Collapse Visual Feedback
type: Task
priority: P0 (MVP)
status: Draft
parent: E03-F02
created: 2025-12-26
estimated_hours: 4
actual_hours:
effort: Small
tags:
  - collapse
  - animation
  - ui
  - presentation-layer
clickup_task_id: ''
---

# Spec: E03-F02-T03 - Collapse Visual Feedback

## 1. Overview

### 1.1 Problem Statement
When cells are collapsed, they should gracefully disappear from the view with visual feedback rather than instantly vanishing. This improves user experience by making the collapse operation feel smooth and intentional. The canvas must also adjust the layout to fill gaps left by collapsed cells.

### 1.2 Goals
- Implement fade-out animation for collapsing cells and nets
- Provide smooth layout adjustment after collapse
- Display status bar messages for collapse operations
- Show warning dialogs for unsafe collapse attempts
- Ensure collapse animation completes in <300ms
- Support canceling animation if user performs another action

---

## 2. Technical Requirements

### 2.1 File Structure

```
src/ink/presentation/
├── canvas/
│   ├── schematic_canvas.py      # Add collapse animation
│   ├── cell_item.py             # Add fade-out effect
│   └── net_item.py              # Add fade-out effect
└── dialogs/
    └── collapse_warning_dialog.py  # Warning for unsafe collapse
```

### 2.2 Canvas Collapse Handler

**File**: `src/ink/presentation/canvas/schematic_canvas.py` (additions)

```python
from PySide6.QtCore import QPropertyAnimation, QParallelAnimationGroup, QEasingCurve
from PySide6.QtWidgets import QGraphicsOpacityEffect
from ...application.services.collapse_service import CollapseService
from ...application.commands.collapse_command import CollapseCommand, CollapseResult

class SchematicCanvas(QGraphicsView):
    # ... existing code ...

    def __init__(self, collapse_service: CollapseService, ...):
        super().__init__()
        self.collapse_service = collapse_service
        self._collapse_animation: Optional[QParallelAnimationGroup] = None
        # ... existing initialization ...

    def collapse_cells(self, cell_ids: Set[CellId], force: bool = False) -> None:
        """Collapse selected cells with animation"""
        # Execute collapse command
        command = CollapseCommand(cell_ids=cell_ids, force=force)
        result = self.collapse_service.execute(command)

        if not result.success:
            # Show warning dialog for unsafe collapse
            if result.skipped_cell_ids and not force:
                self._show_collapse_warning(result)
            else:
                self._show_status_message(result.message, error=True)
            return

        # Animate cells and nets out
        self._animate_collapse(result)

        # Update status bar
        self._show_status_message(result.message)

    def _animate_collapse(self, result: CollapseResult) -> None:
        """Animate collapsing cells and nets with fade-out effect"""
        animation_group = QParallelAnimationGroup()

        # Collect items to animate
        items_to_remove = []

        # Animate cells
        for cell_id in result.collapsed_cell_ids:
            if cell_id in self._cell_items:
                cell_item = self._cell_items[cell_id]
                items_to_remove.append(cell_item)

                # Create fade-out animation
                opacity_effect = QGraphicsOpacityEffect()
                cell_item.setGraphicsEffect(opacity_effect)

                fade_animation = QPropertyAnimation(opacity_effect, b"opacity")
                fade_animation.setDuration(250)  # 250ms fade-out
                fade_animation.setStartValue(1.0)
                fade_animation.setEndValue(0.0)
                fade_animation.setEasingCurve(QEasingCurve.Type.InQuad)

                animation_group.addAnimation(fade_animation)

        # Animate nets
        for net_id in result.removed_net_ids:
            if net_id in self._net_items:
                net_item = self._net_items[net_id]
                items_to_remove.append(net_item)

                opacity_effect = QGraphicsOpacityEffect()
                net_item.setGraphicsEffect(opacity_effect)

                fade_animation = QPropertyAnimation(opacity_effect, b"opacity")
                fade_animation.setDuration(250)
                fade_animation.setStartValue(1.0)
                fade_animation.setEndValue(0.0)
                fade_animation.setEasingCurve(QEasingCurve.Type.InQuad)

                animation_group.addAnimation(fade_animation)

        # Remove items after animation completes
        animation_group.finished.connect(
            lambda: self._remove_items_after_animation(items_to_remove, result)
        )

        # Store reference to prevent garbage collection
        self._collapse_animation = animation_group
        animation_group.start()

    def _remove_items_after_animation(
        self,
        items: List[QGraphicsItem],
        result: CollapseResult
    ) -> None:
        """Remove items from scene after animation completes"""
        # Remove from scene
        for item in items:
            self.scene().removeItem(item)

        # Clean up item dictionaries
        for cell_id in result.collapsed_cell_ids:
            if cell_id in self._cell_items:
                del self._cell_items[cell_id]

        for net_id in result.removed_net_ids:
            if net_id in self._net_items:
                del self._net_items[net_id]

        # Optionally adjust layout to fill gaps
        # (Can be simple or deferred to next expansion/collapse)
        # For MVP, we may skip dynamic layout adjustment

        self._collapse_animation = None

    def _show_collapse_warning(self, result: CollapseResult) -> None:
        """Show warning dialog for unsafe collapse"""
        from ..dialogs.collapse_warning_dialog import CollapseWarningDialog

        dialog = CollapseWarningDialog(
            skipped_cells=result.skipped_cell_ids,
            parent=self
        )

        if dialog.exec() == CollapseWarningDialog.DialogCode.Accepted:
            # User confirmed force collapse
            self.collapse_cells(result.skipped_cell_ids, force=True)

    def _show_status_message(self, message: str, error: bool = False) -> None:
        """Display message in status bar"""
        # Emit signal or call main window's status bar
        # Implementation depends on application architecture
        self.status_message_requested.emit(message, error)
```

### 2.3 Collapse Warning Dialog

**File**: `src/ink/presentation/dialogs/collapse_warning_dialog.py`

```python
from PySide6.QtWidgets import (
    QDialog, QVBoxLayout, QLabel, QPushButton,
    QHBoxLayout, QDialogButtonBox
)
from PySide6.QtCore import Qt
from typing import Set
from ...domain.value_objects.identifiers import CellId

class CollapseWarningDialog(QDialog):
    """Warning dialog for unsafe collapse attempts"""

    def __init__(self, skipped_cells: Set[CellId], parent=None):
        super().__init__(parent)
        self.setWindowTitle("Collapse Warning")
        self.setModal(True)
        self.skipped_cells = skipped_cells

        self._setup_ui()

    def _setup_ui(self) -> None:
        """Setup dialog UI"""
        layout = QVBoxLayout(self)

        # Warning message
        warning_label = QLabel(
            f"Cannot safely collapse {len(self.skipped_cells)} cell(s).\n\n"
            "These cells are connected to other visible cells. "
            "Collapsing them may orphan connected cells.\n\n"
            "Do you want to force collapse anyway?"
        )
        warning_label.setWordWrap(True)
        layout.addWidget(warning_label)

        # Cell list (show first few)
        if len(self.skipped_cells) <= 5:
            cell_list = "\n".join(f"  • {cell_id}" for cell_id in self.skipped_cells)
        else:
            first_five = list(self.skipped_cells)[:5]
            cell_list = "\n".join(f"  • {cell_id}" for cell_id in first_five)
            cell_list += f"\n  ... and {len(self.skipped_cells) - 5} more"

        cells_label = QLabel(f"Affected cells:\n{cell_list}")
        cells_label.setStyleSheet("color: #666; font-family: monospace;")
        layout.addWidget(cells_label)

        # Buttons
        button_box = QDialogButtonBox()
        cancel_btn = button_box.addButton(QDialogButtonBox.StandardButton.Cancel)
        force_btn = button_box.addButton("Force Collapse", QDialogButtonBox.ButtonRole.AcceptRole)
        force_btn.setStyleSheet("background-color: #d9534f; color: white;")

        button_box.accepted.connect(self.accept)
        button_box.rejected.connect(self.reject)

        layout.addWidget(button_box)

        self.setMinimumWidth(400)
```

### 2.4 Keyboard Shortcut Integration

**File**: `src/ink/presentation/main_window.py` (additions)

```python
from PySide6.QtGui import QKeySequence, QAction

class MainWindow(QMainWindow):
    # ... existing code ...

    def _setup_shortcuts(self) -> None:
        """Setup keyboard shortcuts"""
        # ... existing shortcuts ...

        # Collapse shortcuts
        collapse_action = QAction("Collapse", self)
        collapse_action.setShortcuts([
            QKeySequence(Qt.Key.Key_Delete),
            QKeySequence(Qt.Key.Key_Backspace)
        ])
        collapse_action.triggered.connect(self._on_collapse_triggered)
        self.addAction(collapse_action)

    def _on_collapse_triggered(self) -> None:
        """Handle collapse keyboard shortcut"""
        selected_cells = self.canvas.get_selected_cells()
        if selected_cells:
            self.canvas.collapse_cells(selected_cells)
```

---

## 3. Dependencies

- **Upstream**:
  - E03-F02-T01 (Collapse Command) - provides `CollapseService` and `CollapseResult`
  - E02 (Schematic Rendering) - requires `SchematicCanvas`, `CellItem`, `NetItem`
- **Downstream**:
  - E04 (Interaction) - collapse integrated into selection and interaction system

---

## 4. Acceptance Criteria

- [ ] Collapse animation fades out cells over 200-300ms
- [ ] Collapse animation fades out associated nets
- [ ] Animation uses `QPropertyAnimation` with opacity effect
- [ ] Items removed from scene after animation completes
- [ ] Animation uses `InQuad` easing curve for smooth fade-out
- [ ] Status bar shows "Collapsed N cells" message on success
- [ ] Status bar shows error message on failure (red/warning color)
- [ ] Collapse warning dialog shown when collapse is unsafe
- [ ] Warning dialog lists affected cells (first 5 + count)
- [ ] "Force Collapse" button proceeds with unsafe collapse
- [ ] "Cancel" button aborts collapse operation
- [ ] Keyboard shortcuts (Delete/Backspace) trigger collapse
- [ ] Multiple cells can be collapsed simultaneously with single animation
- [ ] Animation can be interrupted if user performs another action
- [ ] No memory leaks from animation objects (proper cleanup)

---

## Revision History

| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-12-26 | 0.1 | Claude | Initial task creation |
