# E03-F02-T03 - Collapse Visual Feedback: Pre-Implementation Documentation

## Document Information
- **Task**: E03-F02-T03 - Collapse Visual Feedback
- **Status**: Pre-Implementation Planning
- **Created**: 2025-12-26
- **Last Updated**: 2025-12-26

---

## 1. Overview

### 1.1 Task Summary

This task implements the visual presentation layer for collapse operations. Rather than cells instantly vanishing when collapsed, they gracefully fade out with smooth animations. The task also provides user feedback through status messages and warning dialogs when collapse operations cannot proceed safely.

Good visual feedback transforms a potentially jarring operation (cells disappearing) into a smooth, professional user experience that builds confidence in the tool.

### 1.2 Problem Context

When cells are collapsed without animation, users experience several problems:

1. **Jarring Experience**: Instant disappearance is disorienting, users lose spatial context
2. **Lack of Feedback**: No indication that collapse succeeded or what was removed
3. **Error Confusion**: When collapse fails, users don't understand why
4. **Unintentional Actions**: Users may not notice they collapsed the wrong cells

Visual feedback solves these problems through:
- **Fade-out animations**: Smooth 250ms transition gives users time to track what's disappearing
- **Status messages**: Clear confirmation ("Collapsed 5 cells") or error indication
- **Warning dialogs**: Explain why unsafe collapse can't proceed and offer alternatives
- **Animation cancellation**: Allow users to interrupt if they realize they made a mistake

### 1.3 Success Criteria

- Collapse animation completes in 200-300ms (smooth but not sluggish)
- Animation runs at 60fps without frame drops
- Status messages appear immediately after animation completes
- Warning dialogs clearly explain safety issues and list affected cells
- Users can trigger collapse via keyboard shortcut (Delete/Backspace)
- Animation is cancellable if user performs another action

---

## 2. Implementation Approach

### 2.1 Animation Architecture

**Qt Animation Framework**:
- Use `QPropertyAnimation` for opacity fade-out
- Use `QGraphicsOpacityEffect` to control item transparency
- Use `QParallelAnimationGroup` to animate multiple items simultaneously
- Use `QEasingCurve.InQuad` for natural fade-out acceleration

**Animation Lifecycle**:
```
1. User triggers collapse
2. CollapseService.execute() returns CollapseResult
3. If failure → show error/warning dialog
4. If success → create animation group
5. For each cell/net in result:
   a. Apply QGraphicsOpacityEffect
   b. Create QPropertyAnimation (1.0 → 0.0 opacity)
   c. Add to animation group
6. Connect animation.finished → remove items from scene
7. Start animation
8. After animation → clean up references, update status bar
```

**Memory Management**:
- Store animation group reference in instance variable to prevent garbage collection
- Clear reference after animation completes
- Remove graphics effects after animation to avoid overhead

### 2.2 Fade-Out Animation Implementation

```python
def _animate_collapse(self, result: CollapseResult) -> None:
    animation_group = QParallelAnimationGroup()
    items_to_remove = []

    # Animate cells
    for cell_id in result.collapsed_cell_ids:
        cell_item = self._cell_items[cell_id]

        # Apply opacity effect
        opacity_effect = QGraphicsOpacityEffect()
        cell_item.setGraphicsEffect(opacity_effect)

        # Create fade animation
        fade = QPropertyAnimation(opacity_effect, b"opacity")
        fade.setDuration(250)  # 250ms
        fade.setStartValue(1.0)
        fade.setEndValue(0.0)
        fade.setEasingCurve(QEasingCurve.Type.InQuad)

        animation_group.addAnimation(fade)
        items_to_remove.append(cell_item)

    # Same for nets...

    # Cleanup after animation
    animation_group.finished.connect(
        lambda: self._remove_items_after_animation(items_to_remove, result)
    )

    self._collapse_animation = animation_group
    animation_group.start()
```

**Design Choices**:
- **250ms duration**: Fast enough to feel responsive, slow enough to track
- **InQuad easing**: Accelerates at start, feels natural for disappearance
- **Parallel animation**: All items fade simultaneously (visually cleaner than sequential)

### 2.3 Warning Dialog Design

**Purpose**: Inform users why collapse failed and offer corrective actions.

**Dialog Content**:
```
┌─────────────────────────────────────────────┐
│ Collapse Warning                        [X] │
├─────────────────────────────────────────────┤
│                                             │
│ Cannot safely collapse 3 cell(s).          │
│                                             │
│ These cells are connected to other visible │
│ cells. Collapsing them may orphan          │
│ connected cells.                            │
│                                             │
│ Affected cells:                             │
│   • Cell_A                                  │
│   • Cell_B                                  │
│   • Cell_C                                  │
│                                             │
│ Do you want to force collapse anyway?       │
│                                             │
│                 [Cancel] [Force Collapse]   │
└─────────────────────────────────────────────┘
```

**User Decisions**:
- **Cancel**: Abort collapse, return to schematic
- **Force Collapse**: Proceed with unsafe collapse (calls service with `force=True`)

**Implementation Details**:
- Modal dialog (blocks interaction with main window)
- Force Collapse button styled red (warning color)
- If >5 cells, show first 5 + count ("... and 15 more")
- Monospace font for cell names (easier to read)

### 2.4 Status Messages

**Success Messages**:
- "Collapsed 1 cell"
- "Collapsed 5 cells"
- "Collapsed 3 cells, skipped 2 (connected to other visible cells)"

**Error Messages**:
- "Cannot collapse invisible cells: {cell_ids}"
- "No cells can be safely collapsed. Use force=True to override."
- "No cells found in subtree(s)"

**Display Mechanism**:
- Emit signal from canvas: `status_message_requested.emit(message, is_error)`
- Main window catches signal and displays in status bar
- Error messages shown in red/warning color
- Messages auto-clear after 5 seconds

### 2.5 Keyboard Shortcuts

**Collapse Shortcuts**:
- `Delete` key → Collapse selected cells
- `Backspace` key → Collapse selected cells (Mac-friendly alternative)
- `Shift+Delete` → Collapse subtree (from T02)

**Implementation**:
```python
def _setup_shortcuts(self):
    collapse_action = QAction("Collapse", self)
    collapse_action.setShortcuts([
        QKeySequence(Qt.Key.Key_Delete),
        QKeySequence(Qt.Key.Key_Backspace)
    ])
    collapse_action.triggered.connect(self._on_collapse_triggered)
    self.addAction(collapse_action)

def _on_collapse_triggered(self):
    selected_cells = self.canvas.get_selected_cells()
    if selected_cells:
        self.canvas.collapse_cells(selected_cells)
```

---

## 3. Key Design Decisions

### 3.1 Animation Duration and Easing

**Decision**: 250ms fade-out with InQuad easing

**Rationale**:
- 250ms is perceptually smooth but doesn't feel sluggish
- InQuad easing (accelerates at start) mimics natural disappearance
- Shorter (<200ms) feels too abrupt
- Longer (>300ms) slows down workflow

**Alternative**: 500ms with OutQuad (starts fast, decelerates)
- More dramatic effect
- Too slow for frequent operations

**Alternative**: No animation (instant removal)
- Fastest performance
- Jarring user experience, disorienting

**Trade-offs**:
- Pro: Balance between smoothness and speed
- Pro: Industry standard duration (matches macOS, Windows animations)
- Con: Power users may want to disable animations (defer to settings)

### 3.2 Parallel vs Sequential Animation

**Decision**: Parallel animation (all items fade simultaneously)

**Rationale**:
- Visually cleaner (entire region disappears together)
- Faster total time (250ms vs N * 250ms)
- Easier to track overall change

**Alternative**: Sequential animation (cascade effect)
- More dynamic, visually interesting
- Takes too long for large selections
- Harder to track what's disappearing

**Trade-offs**:
- Pro: Simple, predictable, fast
- Con: Less "fancy" (but this is a professional tool, not a game)

### 3.3 Warning Dialog vs Inline Messages

**Decision**: Modal warning dialog for unsafe collapse

**Rationale**:
- Forces user acknowledgment (can't miss it)
- Provides space to explain issue and list cells
- Clear action buttons (Cancel vs Force Collapse)
- Prevents accidental destructive actions

**Alternative**: Inline banner message
- Less disruptive to workflow
- Easy to dismiss without reading
- Doesn't provide action buttons

**Alternative**: Toast notification
- Non-blocking
- Too easy to miss for destructive operation

**Trade-offs**:
- Pro: Ensures user understands consequences
- Pro: Provides clear path forward (cancel or force)
- Con: Blocks workflow momentarily (acceptable for rare error case)

### 3.4 Animation Cancellation Strategy

**Decision**: Animation is interruptible - new user action cancels animation

**Rationale**:
- Responsive to user input (doesn't feel locked)
- Allows quick correction of mistakes
- Simple implementation (stop animation, remove items immediately)

**Alternative**: Animation must complete before next action
- Simpler state management
- Frustrating if user realizes mistake mid-animation

**Alternative**: Queue actions during animation
- Complex state machine
- Over-engineered for MVP

**Trade-offs**:
- Pro: Responsive, flexible user experience
- Con: Must handle partial animation states carefully

---

## 4. Dependencies and Integration Points

### 4.1 Upstream Dependencies

**E03-F02-T01 (Collapse Command)**:
- Provides `CollapseService` and `CollapseResult`
- Canvas calls `collapse_service.execute()`
- Result drives animation and status messages

**E02 (Schematic Rendering)**:
- Requires `SchematicCanvas` class
- Uses `CellItem` and `NetItem` graphics items
- Depends on Qt scene/view architecture

**Qt Framework**:
- `PySide6.QtCore.QPropertyAnimation`
- `PySide6.QtWidgets.QGraphicsOpacityEffect`
- `PySide6.QtCore.QParallelAnimationGroup`

### 4.2 Downstream Integration

**E03-F02-T04 (Context Menu Integration)**:
- Context menu triggers collapse via `canvas.collapse_cells()`
- Menu options lead to animation

**E04 (Interaction System)**:
- Keyboard shortcuts integrated into action system
- Selection state determines which cells to collapse

**Main Window**:
- Status bar displays messages from canvas
- Signal/slot connection for status updates

### 4.3 Integration Risks

**Risk**: Animation performance degrades with many cells (>50)

**Impact**: Medium - Sluggish animation, poor UX
**Probability**: Low - Typical collapse is <10 cells
**Mitigation**:
- Profile with large selections
- Consider disabling animation above threshold (>20 cells)
- Provide "Instant Collapse" option in settings

**Risk**: Graphics effects cause rendering artifacts

**Impact**: Low - Visual glitches during animation
**Probability**: Low - QGraphicsOpacityEffect is well-tested
**Mitigation**:
- Test on different platforms (Linux, macOS, Windows)
- Clear effects after animation completes
- Fallback to instant removal if effect fails

**Risk**: Memory leaks from animation objects

**Impact**: Medium - Memory growth over session
**Probability**: Low - Proper cleanup in finished handler
**Mitigation**:
- Store weak reference or clear after completion
- Profile memory usage during stress test
- Use Qt object lifetime management (parent/child)

---

## 5. Testing Strategy

### 5.1 Manual Testing

**Basic Animation**:
- Expand 5 cells, select 2, press Delete
- Verify smooth 250ms fade-out
- Verify cells removed from scene after animation
- Verify status bar shows "Collapsed 2 cells"

**Warning Dialog**:
- Create scenario with unsafe collapse (cell connected to external cell)
- Attempt collapse
- Verify warning dialog appears
- Verify cell names listed correctly
- Click Cancel → verify no cells collapsed
- Retry with Force Collapse → verify cells removed

**Keyboard Shortcuts**:
- Select cells, press Delete → verify collapse
- Select cells, press Backspace → verify collapse
- No selection, press Delete → verify nothing happens

**Performance**:
- Collapse 1 cell → measure animation time (<300ms)
- Collapse 10 cells → verify smooth animation
- Collapse 50 cells → check for frame drops

### 5.2 Automated Tests (UI Tests)

**Animation Tests**:
```python
def test_collapse_animation_duration(qtbot):
    canvas = create_test_canvas()
    cell_ids = {CellId("A"), CellId("B")}

    with qtbot.waitSignal(canvas.animation_finished, timeout=500):
        canvas.collapse_cells(cell_ids)

    # Verify animation took ~250ms
    assert 200 <= elapsed_time <= 350

def test_collapse_removes_items_after_animation(qtbot):
    canvas = create_test_canvas()
    initial_count = canvas.scene().items_count()

    canvas.collapse_cells({CellId("A")})
    qtbot.wait(300)  # Wait for animation

    assert canvas.scene().items_count() < initial_count
```

**Dialog Tests**:
```python
def test_warning_dialog_shows_affected_cells(qtbot):
    skipped = {CellId("A"), CellId("B")}
    dialog = CollapseWarningDialog(skipped_cells=skipped)

    assert "Cell_A" in dialog.text()
    assert "Cell_B" in dialog.text()

def test_warning_dialog_force_collapse_proceeds(qtbot):
    dialog = CollapseWarningDialog(skipped_cells={CellId("A")})

    # Simulate clicking "Force Collapse"
    with qtbot.waitSignal(dialog.accepted):
        dialog.accept()

    # Should trigger force collapse
```

**Status Message Tests**:
```python
def test_status_message_on_success(qtbot):
    canvas = create_test_canvas()

    with qtbot.waitSignal(canvas.status_message_requested) as blocker:
        canvas.collapse_cells({CellId("A")})

    message, is_error = blocker.args
    assert "Collapsed 1 cell" in message
    assert not is_error

def test_status_message_on_error(qtbot):
    canvas = create_test_canvas()

    with qtbot.waitSignal(canvas.status_message_requested) as blocker:
        canvas.collapse_cells({CellId("NonExistent")})

    message, is_error = blocker.args
    assert "Cannot collapse" in message
    assert is_error
```

### 5.3 Edge Cases

- Collapse while another animation is running (cancel previous)
- Collapse single cell vs multiple cells (same animation quality)
- Collapse with no visible cells (no-op, no crash)
- Dialog with >5 cells (shows "... and N more")
- Dialog with very long cell names (layout doesn't break)

### 5.4 Performance Profiling

```python
@pytest.mark.benchmark
def test_animation_creation_performance(benchmark):
    result = CollapseResult(
        collapsed_cell_ids=set(range(50)),
        removed_net_ids=set(range(50)),
        skipped_cell_ids=set(),
        success=True,
        message="Test"
    )

    # Animation setup should be fast (<50ms)
    benchmark(canvas._animate_collapse, result)
    assert benchmark.stats.mean < 0.05
```

---

## 6. Risks and Considerations

### 6.1 Technical Risks

**Risk**: QGraphicsOpacityEffect impacts rendering performance

**Impact**: Medium - Slow animations, frame drops
**Probability**: Low - Effects are GPU-accelerated on most systems
**Mitigation**:
- Profile on target hardware (especially older laptops)
- Provide "Reduce animations" setting
- Fallback to instant removal if performance poor

**Risk**: Animation cleanup fails, causing memory leaks

**Impact**: Medium - Memory growth over long sessions
**Probability**: Low - Qt manages effect lifetime
**Mitigation**:
- Clear `_collapse_animation` reference after completion
- Remove graphics effects after animation
- Memory profiling in stress tests

**Risk**: Animation interrupted by window resize/repaint

**Impact**: Low - Visual glitch during animation
**Probability**: Low - Qt handles this gracefully
**Mitigation**:
- Test animation during window operations
- Ensure animation continues during resize

### 6.2 UX Risks

**Risk**: 250ms animation feels too slow for power users

**Impact**: Low - Minor workflow slowdown
**Probability**: Medium - Power users prefer speed over polish
**Mitigation**:
- Provide "Instant Collapse" option in settings
- Consider keyboard modifier (Ctrl+Delete = instant)
- Defer to user feedback

**Risk**: Warning dialog is annoying for intentional unsafe collapse

**Impact**: Low - Extra click required
**Probability**: Low - Most collapses are safe
**Mitigation**:
- Clear explanation helps users understand
- "Force Collapse" button is prominent
- Consider "Don't show again" checkbox (risky, defer to P1)

**Risk**: Users miss status messages (too subtle)

**Impact**: Low - Lack of confirmation feedback
**Probability**: Medium - Status bar may not be visible
**Mitigation**:
- Make status bar prominent in UI design
- Consider brief toast notification as alternative
- Defer to user testing feedback

### 6.3 Platform-Specific Risks

**Risk**: Animation quality differs across platforms

**Impact**: Medium - Inconsistent user experience
**Probability**: Medium - Qt rendering varies by platform
**Mitigation**:
- Test on Linux, macOS, Windows
- Document platform differences
- Use platform-agnostic Qt features only

**Risk**: Keyboard shortcuts conflict with desktop environment

**Impact**: Low - Shortcut doesn't work
**Probability**: Medium - Delete key may be captured by system
**Mitigation**:
- Provide alternative shortcuts (Backspace)
- Make shortcuts configurable (P1)
- Document known conflicts

---

## 7. Open Questions

### 7.1 Resolved Questions

**Q**: Should animation be skippable (press key to finish immediately)?
**A**: Yes - any new user action cancels animation and proceeds immediately.

**Q**: Should we animate nets separately from cells?
**A**: No - animate in parallel for simplicity. Both fade together.

**Q**: What if collapse is triggered during expansion animation?
**A**: Cancel expansion animation, proceed with collapse.

### 7.2 Open Questions

**Q**: Should animation speed be configurable?
**A**: **Defer to P1**. Fixed 250ms for MVP, add setting if users request.

**Q**: Should we show animation preview before collapse?
**A**: **Likely no**. Preview adds complexity, animation itself is preview. Defer unless user testing shows need.

**Q**: Should status messages auto-clear or persist?
**A**: **Auto-clear after 5 seconds**. Keeps status bar clean for next operation.

**Q**: Should warning dialog remember "Force Collapse" choice?
**A**: **No for MVP**. Too risky - users may forget they enabled it. Consider for P1 with session-only persistence.

---

## 8. Implementation Checklist

### 8.1 Phase 1: Basic Animation
- [ ] Implement `_animate_collapse()` method in `SchematicCanvas`
- [ ] Create `QGraphicsOpacityEffect` for cells
- [ ] Create `QPropertyAnimation` with 250ms duration
- [ ] Use `QParallelAnimationGroup` for multiple items
- [ ] Test basic fade-out with single cell

### 8.2 Phase 2: Animation Cleanup
- [ ] Implement `_remove_items_after_animation()` handler
- [ ] Remove items from scene
- [ ] Clean up `_cell_items` and `_net_items` dictionaries
- [ ] Clear animation reference
- [ ] Test memory doesn't leak

### 8.3 Phase 3: Warning Dialog
- [ ] Create `CollapseWarningDialog` class
- [ ] Design layout with message and cell list
- [ ] Add Cancel and Force Collapse buttons
- [ ] Style Force Collapse button (red)
- [ ] Implement truncation for >5 cells
- [ ] Test dialog flow (cancel vs force)

### 8.4 Phase 4: Status Messages
- [ ] Add `status_message_requested` signal to canvas
- [ ] Implement `_show_status_message()` method
- [ ] Connect signal to main window status bar
- [ ] Test success and error messages
- [ ] Implement auto-clear after 5 seconds

### 8.5 Phase 5: Keyboard Shortcuts
- [ ] Add Delete key shortcut in main window
- [ ] Add Backspace key shortcut
- [ ] Implement `_on_collapse_triggered()` handler
- [ ] Get selected cells from canvas
- [ ] Call `collapse_cells()` method
- [ ] Test shortcuts work as expected

### 8.6 Phase 6: Integration and Polish
- [ ] Integration test with collapse service
- [ ] Test animation performance with 10, 50 cells
- [ ] Cross-platform testing (Linux, macOS, Windows)
- [ ] Documentation and code comments
- [ ] User acceptance testing

---

## 9. References

- **Task Spec**: `/home/joohan/dev/project-ink/ink/specs/E03/F02/T03/E03-F02-T03.spec.md`
- **Feature Spec**: `/home/joohan/dev/project-ink/ink/specs/E03/F02/E03-F02.spec.md`
- **Epic Spec**: `/home/joohan/dev/project-ink/ink/specs/E03/E03.spec.md`
- **Qt Documentation**:
  - [QPropertyAnimation](https://doc.qt.io/qt-6/qpropertyanimation.html)
  - [QGraphicsOpacityEffect](https://doc.qt.io/qt-6/qgraphicsopacityeffect.html)
  - [QParallelAnimationGroup](https://doc.qt.io/qt-6/qparallelanimationgroup.html)
- **Related Tasks**:
  - E03-F02-T01: Collapse Command Implementation (service integration)
  - E03-F02-T04: Context Menu Integration (UI trigger)
  - E02: Schematic Rendering (canvas and graphics items)

---

## 10. Revision History

| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-12-26 | 1.0 | Claude | Initial pre-implementation documentation |
