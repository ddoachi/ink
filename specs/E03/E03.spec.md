---
id: E03
title: Incremental Expansion
type: Epic
priority: P0 (MVP)
status: Draft
parent: PRD
prd_sections: ยง5.1 Basic Behavior, ยง5.2 Expansion Scope Control, ยง5.3 Collapse Functionality
created: 2025-12-26
estimated_hours:
actual_hours:
effort:
tags: []
---

# Spec: E03 - Incremental Expansion

## 1. Overview

This epic covers Ink's core differentiating feature - incremental exploration. Instead of rendering the entire netlist, users expand from points of interest, revealing connectivity step by step.

### 1.1 Problem Statement

Gate-level netlists can contain hundreds of thousands of cells. Rendering all of them at once is impractical. Engineers typically want to trace specific signals or understand local connectivity around a cell of interest.

### 1.2 Goals

- Enable hop-based expansion (1-hop, N-hop) for fanin/fanout traversal
- Support semantic boundary expansion (stop at latches/ports)
- Provide collapse functionality to hide previously expanded sections
- Prevent duplicate expansion of already-visible elements
- Maintain expansion history for undo/redo (see E04)

---

## 2. User Stories

### US-E03-01: Expand Fanout
**As a** circuit designer
**I want to** double-click a pin to expand its fanout
**So that** I can see what logic it drives

**Acceptance Criteria:**
- [ ] Double-click on output pin triggers expansion
- [ ] 1-hop expansion shows immediate fanout cells
- [ ] Newly expanded cells are positioned and routed
- [ ] Already visible cells are not duplicated
- [ ] Expansion animates smoothly

### US-E03-02: Expand Fanin
**As a** circuit designer
**I want to** expand the fanin of an input pin
**So that** I can trace the signal source

**Acceptance Criteria:**
- [ ] Right-click menu offers "Expand Fanin"
- [ ] Fanin expansion shows driver cells
- [ ] Multiple levels of fanin can be expanded sequentially

### US-E03-03: N-Hop Expansion
**As a** circuit designer
**I want to** expand multiple hops at once
**So that** I can quickly see deeper connectivity

**Acceptance Criteria:**
- [ ] Configurable hop count (1, 2, 3, or custom)
- [ ] N-hop expansion retrieves all cells within N hops
- [ ] Performance acceptable for N up to 5 hops

### US-E03-04: Collapse Subtree
**As a** circuit designer
**I want to** collapse previously expanded cells
**So that** I can simplify the view

**Acceptance Criteria:**
- [ ] Right-click menu offers "Collapse"
- [ ] Collapse hides selected cells and their dependencies
- [ ] Cells connected to other visible cells remain visible
- [ ] Keyboard shortcut (Delete/Backspace) for collapse

### US-E03-05: Semantic Boundary Expansion (P1)
**As a** circuit designer
**I want to** expand to the nearest latch or port
**So that** I can see the full combinational cone

**Acceptance Criteria:**
- [ ] "Expand to Boundary" option in context menu
- [ ] Expansion stops at cells marked as sequential
- [ ] Expansion stops at top-level ports
- [ ] Works for both fanin and fanout directions

---

## 3. Technical Requirements

### 3.1 Expansion State Model

```python
@dataclass
class ExpansionState:
    visible_cells: Set[str]      # Cell IDs currently visible
    visible_nets: Set[str]       # Net IDs currently visible
    expansion_history: List[ExpansionAction]  # For undo/redo

@dataclass
class ExpansionAction:
    type: Literal["expand", "collapse"]
    cells_affected: Set[str]
    timestamp: datetime
```

### 3.2 Graph Traversal API

```python
class GraphTraverser:
    def get_fanout(self, pin: Pin, hops: int = 1) -> Set[Cell]:
        """Get cells within N hops downstream of pin"""

    def get_fanin(self, pin: Pin, hops: int = 1) -> Set[Cell]:
        """Get cells within N hops upstream of pin"""

    def get_cone_to_boundary(self, pin: Pin, direction: str) -> Set[Cell]:
        """Get all cells to nearest sequential/port boundary"""
```

### 3.3 Expansion Algorithm

```
1. User triggers expansion on object X
2. Query graph for affected cells based on scope
3. Filter out already-visible cells
4. Calculate layout positions for new cells
5. Route new nets
6. Animate new elements into view
7. Record action in expansion history
```

### 3.4 Collapse Algorithm

```
1. User selects cells to collapse
2. Identify cells safe to hide (not connected to other visible cells)
3. Calculate which nets become invisible
4. Animate elements out of view
5. Update layout to fill gaps (optional)
6. Record action in expansion history
```

---

## 4. Dependencies

- **Upstream**:
  - E01 (Data Model - graph traversal)
  - E02 (Rendering - layout and display)
- **Downstream**: E04 (Interaction - undo/redo)

---

## 5. Risks & Mitigations

| Risk | Impact | Probability | Mitigation |
|------|--------|-------------|------------|
| Expansion causes layout thrashing | High | Medium | Incremental layout updates |
| Large N-hop expansion overwhelms | Medium | High | Limit default, show warning |
| Collapse orphans connected cells | Medium | Medium | Smart collapse with validation |

---

## 6. Acceptance Criteria (Epic Level)

- [ ] 1-hop expansion completes in <100ms
- [ ] 5-hop expansion completes in <500ms
- [ ] Collapse updates view in <100ms
- [ ] No duplicate cells after any expansion sequence
- [ ] Expansion history supports 100+ actions

---

## 7. Child Specs

| ID | Feature | Status |
|----|---------|--------|
| [E03-F01](F01/E03-F01.spec.md) | Hop-Based Expansion | Created |
| [E03-F02](F02/E03-F02.spec.md) | Collapse Functionality | Created |
| [E03-F03](F03/E03-F03.spec.md) | Semantic Boundary Expansion (P1) | Created |
| [E03-F04](F04/E03-F04.spec.md) | Expansion State Management | Created |

---

## Revision History

| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-12-26 | 0.1 | Claude | Initial epic creation from PRD split |
