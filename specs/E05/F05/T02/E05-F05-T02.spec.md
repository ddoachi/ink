# Spec: E05-F05-T02 - History UI Integration

## Metadata
- **ID**: E05-F05-T02
- **Type**: Task
- **Priority**: P0 (MVP)
- **Status**: Draft
- **Parent**: [E05-F05](../E05-F05.spec.md)
- **Created**: 2025-12-26
- **Estimated Hours**: 4
- **Actual Hours**:
- **Effort**: Small
- **Tags**: [presentation, ui]

---

## 1. Overview

### 1.1 Problem Statement
Need to integrate search history into the SearchPanel UI with a dropdown that displays recent queries and allows re-execution.

### 1.2 Goals
- Add history dropdown to SearchPanel
- Populate dropdown with recent searches
- Support click-to-execute from history
- Provide context menu for clearing history
- Update dropdown after each search
- Maintain clean, intuitive UX

---

## 2. Technical Requirements

### 2.1 SearchPanel Enhancement

**Location**: `src/ink/presentation/panels/search_panel.py`

```python
from PySide6.QtWidgets import QWidget, QComboBox, QMenu, QVBoxLayout, QHBoxLayout
from PySide6.QtCore import Qt, QPoint, Signal
from ink.application.services.search_service import SearchService
from ink.domain.services.search_history import SearchHistory


class SearchPanel(QWidget):
    """Search panel with integrated history dropdown"""

    search_executed = Signal(str)  # Emitted when search is executed

    def __init__(self, search_service: SearchService, search_history: SearchHistory):
        super().__init__()
        self._search_service = search_service
        self._history = search_history
        self._setup_ui()
        self._update_history_dropdown()

    def _setup_ui(self):
        """Setup UI layout with history dropdown"""
        layout = QVBoxLayout(self)

        # Search input row
        input_layout = QHBoxLayout()

        # Search input field (existing)
        self.search_input = QLineEdit()
        self.search_input.setPlaceholderText("Search cells, nets, ports...")
        self.search_input.returnPressed.connect(self._on_search_submitted)
        input_layout.addWidget(self.search_input)

        # Search button (existing)
        self.search_button = QPushButton("Search")
        self.search_button.clicked.connect(self._on_search_submitted)
        input_layout.addWidget(self.search_button)

        layout.addLayout(input_layout)

        # History dropdown
        history_layout = QHBoxLayout()
        history_label = QLabel("Recent:")
        history_layout.addWidget(history_label)

        self.history_dropdown = QComboBox()
        self.history_dropdown.setEditable(False)
        self.history_dropdown.setSizePolicy(QSizePolicy.Expanding, QSizePolicy.Fixed)
        self.history_dropdown.currentTextChanged.connect(self._on_history_selected)

        # Context menu for clear action
        self.history_dropdown.setContextMenuPolicy(Qt.CustomContextMenu)
        self.history_dropdown.customContextMenuRequested.connect(
            self._show_history_context_menu
        )

        history_layout.addWidget(self.history_dropdown)
        layout.addLayout(history_layout)

        # Results area (existing)
        # ...

    def _update_history_dropdown(self):
        """Refresh dropdown with recent queries"""
        # Block signals to prevent triggering search
        self.history_dropdown.blockSignals(True)

        self.history_dropdown.clear()

        # Add placeholder item
        self.history_dropdown.addItem("-- Recent Searches --")

        # Add recent queries
        recent_queries = self._history.get_recent(limit=10)
        if recent_queries:
            self.history_dropdown.addItems(recent_queries)

        # Set placeholder as current (index 0)
        self.history_dropdown.setCurrentIndex(0)

        self.history_dropdown.blockSignals(False)

    def _on_search_submitted(self):
        """Execute search from input field"""
        query = self.search_input.text().strip()
        if query:
            self._execute_search(query)

    def _execute_search(self, query: str):
        """
        Execute search and update history

        Args:
            query: Search query string
        """
        # Add to history (handles deduplication)
        self._history.add(query)

        # Update dropdown to reflect new history
        self._update_history_dropdown()

        # Execute search via service
        results = self._search_service.search(query)

        # Update results display (existing logic)
        self._display_results(results)

        # Emit signal
        self.search_executed.emit(query)

    def _on_history_selected(self, query: str):
        """
        Handle history dropdown selection

        Args:
            query: Selected query from dropdown
        """
        # Ignore placeholder selection
        if not query or query == "-- Recent Searches --":
            return

        # Populate search input
        self.search_input.setText(query)

        # Execute search
        self._execute_search(query)

        # Reset dropdown to placeholder
        self.history_dropdown.setCurrentIndex(0)

    def _show_history_context_menu(self, pos: QPoint):
        """
        Show context menu with clear history option

        Args:
            pos: Menu position
        """
        menu = QMenu(self)

        clear_action = menu.addAction("Clear History")
        clear_action.triggered.connect(self._clear_history)

        # Show menu at global position
        menu.exec_(self.history_dropdown.mapToGlobal(pos))

    def _clear_history(self):
        """Clear all search history"""
        # Clear history data
        self._history.clear()

        # Update dropdown
        self._update_history_dropdown()
```

### 2.2 UI Behavior Specifications

| Interaction | Behavior |
|-------------|----------|
| Dropdown shows placeholder | "-- Recent Searches --" when no selection |
| Click history item | Populates input field and executes search |
| After executing from history | Dropdown resets to placeholder |
| Right-click dropdown | Shows context menu with "Clear History" |
| Clear history action | Removes all entries, shows only placeholder |
| New search submitted | Dropdown updates automatically |
| Empty history | Shows only placeholder, no queries |

### 2.3 Visual Layout

```
┌─────────────────────────────────────────────────────┐
│ Search Panel                                         │
├─────────────────────────────────────────────────────┤
│ [Search input field...          ] [Search]          │
│ Recent: [-- Recent Searches --             ▼]       │
│                                                      │
│ Results:                                             │
│ ...                                                  │
└─────────────────────────────────────────────────────┘

Dropdown expanded:
┌─────────────────────────────────┐
│ -- Recent Searches --            │
├─────────────────────────────────┤
│ NAND2                            │
│ DFF.*                            │
│ clk_net                          │
│ input_port                       │
└─────────────────────────────────┘

Context menu (right-click):
┌─────────────────┐
│ Clear History   │
└─────────────────┘
```

---

## 3. Dependencies

- **Upstream**:
  - T01 (SearchHistory domain service)
  - E05-F01 (SearchPanel base implementation)
- **Downstream**: None

---

## 4. Acceptance Criteria

- [ ] History dropdown added to SearchPanel
- [ ] Dropdown positioned below search input
- [ ] Placeholder "-- Recent Searches --" shown at top
- [ ] Recent queries populated from SearchHistory
- [ ] Clicking history item executes search
- [ ] Clicking history item populates input field
- [ ] Dropdown updates after each search
- [ ] Dropdown resets to placeholder after history selection
- [ ] Right-click shows context menu
- [ ] "Clear History" menu action works
- [ ] Clearing history updates dropdown immediately
- [ ] Empty history shows only placeholder
- [ ] Signal blocking prevents unintended searches
- [ ] UI remains responsive during updates

---

## 5. Implementation Notes

### Testing Strategy
```python
# tests/ui/panels/test_search_panel_history.py

def test_history_dropdown_populated():
    """Dropdown should show recent searches"""

def test_click_history_executes_search():
    """Clicking history item should execute search"""

def test_dropdown_updates_after_search():
    """Dropdown should refresh after new search"""

def test_clear_history_context_menu():
    """Right-click should show clear option"""

def test_clear_history_empties_dropdown():
    """Clearing should remove all items"""
```

### Widget Hierarchy
```
SearchPanel (QWidget)
├── QVBoxLayout
│   ├── QHBoxLayout (search row)
│   │   ├── QLineEdit (search_input)
│   │   └── QPushButton (search_button)
│   ├── QHBoxLayout (history row)
│   │   ├── QLabel ("Recent:")
│   │   └── QComboBox (history_dropdown)
│   └── ... (results area)
```

---

## Revision History
| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-12-26 | 0.1 | Claude | Initial task creation |
