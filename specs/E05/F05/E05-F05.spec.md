# Spec: E05-F05 - Search History

## Metadata
- **ID**: E05-F05
- **Type**: Feature
- **Priority**: P0 (MVP)
- **Status**: Draft
- **Parent**: [E05](../E05.spec.md)
- **Created**: 2025-12-26
- **Estimated Hours**:
- **Actual Hours**:
- **Effort**:
- **Tags**: []

---

## 1. Overview

### 1.1 Problem Statement
Engineers often repeat the same searches during analysis sessions. Search history provides quick access to recent queries without retyping, improving workflow efficiency.

### 1.2 Goals
- Record recent search queries automatically
- Display search history in dropdown for quick access
- Limit history to last 10 searches
- Persist history across sessions
- Provide clear history management
- Support quick re-execution of historical queries

---

## 2. User Stories

### US-E05-05: Search History
**As a** circuit designer
**I want to** access previous searches
**So that** I can quickly repeat common queries

**Acceptance Criteria:**
- [ ] Last 10 searches saved
- [ ] History shown in dropdown
- [ ] Click history item to re-execute
- [ ] Clear history option available

---

## 3. Technical Requirements

### 3.1 Search History Manager

```python
class SearchHistory:
    """Manage search query history"""

    MAX_HISTORY_SIZE = 10

    def __init__(self, storage: HistoryStorage):
        self._storage = storage
        self._history: List[str] = []
        self._load()

    def add(self, query: str) -> None:
        """
        Add query to history

        Rules:
        - Ignore duplicate consecutive queries
        - Move duplicate to front if exists
        - Limit to MAX_HISTORY_SIZE entries
        - Persist to storage
        """

    def get_recent(self, limit: int = 10) -> List[str]:
        """Get recent queries (newest first)"""

    def clear(self) -> None:
        """Clear all history"""

    def remove(self, query: str) -> None:
        """Remove specific query from history"""

    def _load(self) -> None:
        """Load history from persistent storage"""

    def _save(self) -> None:
        """Save history to persistent storage"""
```

### 3.2 History Storage Interface

```python
class HistoryStorage(Protocol):
    """Storage backend for search history"""

    def load_history(self) -> List[str]:
        """Load search history from storage"""

    def save_history(self, queries: List[str]) -> None:
        """Save search history to storage"""
```

### 3.3 QSettings Implementation

```python
class QSettingsHistoryStorage:
    """Store search history in QSettings"""

    HISTORY_KEY = "search/history"

    def __init__(self):
        self._settings = QSettings("Ink", "SearchHistory")

    def load_history(self) -> List[str]:
        """Load from QSettings"""
        return self._settings.value(self.HISTORY_KEY, [], type=list)

    def save_history(self, queries: List[str]) -> None:
        """Save to QSettings"""
        self._settings.setValue(self.HISTORY_KEY, queries)
        self._settings.sync()
```

### 3.4 History Dropdown Integration

```python
class SearchPanel(QWidget):
    """Search panel with history dropdown"""

    def __init__(self, search_history: SearchHistory):
        self._history = search_history
        self._setup_ui()

    def _setup_ui(self):
        # History dropdown
        self.history_dropdown = QComboBox()
        self.history_dropdown.setEditable(False)
        self.history_dropdown.currentTextChanged.connect(self._on_history_selected)

        # Context menu for clear
        self.history_dropdown.setContextMenuPolicy(Qt.CustomContextMenu)
        self.history_dropdown.customContextMenuRequested.connect(self._show_history_menu)

    def _update_history_dropdown(self):
        """Refresh dropdown with recent queries"""
        self.history_dropdown.clear()
        self.history_dropdown.addItem("Recent Searches...")
        self.history_dropdown.addItems(self._history.get_recent())

    def _on_history_selected(self, query: str):
        """Re-execute selected historical query"""
        if query and query != "Recent Searches...":
            self.search_input.setText(query)
            self._execute_search(query)

    def _show_history_menu(self, pos: QPoint):
        """Show context menu with clear option"""
        menu = QMenu()
        clear_action = menu.addAction("Clear History")
        clear_action.triggered.connect(self._clear_history)
        menu.exec_(self.history_dropdown.mapToGlobal(pos))

    def _clear_history(self):
        """Clear all search history"""
        self._history.clear()
        self._update_history_dropdown()
```

### 3.5 History Management Rules

| Rule | Behavior |
|------|----------|
| Duplicate query | Move to front, don't add new entry |
| Consecutive duplicate | Ignore (don't re-add same query) |
| Max size exceeded | Remove oldest entry |
| Empty query | Don't add to history |
| Pattern vs exact | Treat as different queries |
| Case sensitivity | Treat as different queries |

---

## 4. Dependencies

- **Upstream**:
  - E05-F02 (Search Engine - provides search queries)
- **Downstream**:
  - E05-F01 (Search Panel UI - displays history dropdown)

---

## 5. Acceptance Criteria

- [ ] Search queries added to history automatically
- [ ] Last 10 queries stored (FIFO)
- [ ] Duplicate queries moved to front
- [ ] Consecutive duplicates ignored
- [ ] Empty queries not added to history
- [ ] History persists across application restarts
- [ ] History dropdown populated with recent queries
- [ ] Clicking history item re-executes search
- [ ] Context menu provides "Clear History" option
- [ ] Clearing history empties dropdown
- [ ] History stored in QSettings
- [ ] History updates immediately after search

---

## 6. Child Specs
*To be created via `/spec_work E05-F05 --split tasks`*

| ID | Task | Status |
|----|------|--------|

---

## Revision History
| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-12-26 | 0.1 | Claude | Initial feature creation from E05 split |
