---
id: E05-F04-T04
title: Auto-Expansion for Navigation
type: Task
priority: P0 (MVP)
status: Draft
parent: E05-F04
created: 2025-12-26
estimated_hours: 6
actual_hours:
effort: Medium-High
tags:
  - application
  - expansion
  - navigation
clickup_task_id: '86evzm320'
---

# Spec: E05-F04-T04 - Auto-Expansion for Navigation

## 1. Overview

### 1.1 Problem Statement
Implement intelligent auto-expansion strategies for navigating to objects that are not currently visible on the schematic canvas. The expansion must reveal the target object with appropriate context (connected cells, nets) while minimizing unnecessary expansion to maintain schematic readability.

### 1.2 Goals
- Expand cells to reveal target objects (cells, pins, nets, ports)
- Provide appropriate context (1-hop fanin/fanout for cells)
- Minimize over-expansion (avoid expanding entire netlist)
- Support different expansion strategies per object type
- Integrate with existing ExpansionService
- Complete expansion in < 150ms for 1-hop expansion
- Track expansion state to determine visibility

---

## 2. Technical Requirements

### 2.1 Expansion Service Visibility Tracking

**Location**: `src/ink/application/services/expansion_service.py`

**Updates to ExpansionService**:
```python
from typing import Union, Set
from ink.domain.model.cell import Cell
from ink.domain.model.pin import Pin
from ink.domain.model.net import Net
from ink.domain.model.port import Port


ObjectType = Union[Cell, Pin, Net, Port]


class ExpansionService:
    """
    Application service for managing schematic expansion.

    Tracks which cells are currently expanded/visible on canvas.
    """

    def __init__(self, design: Design):
        self._design = design
        self._expanded_cells: Set[CellId] = set()
        # ... existing initialization ...

    def is_visible(self, obj: ObjectType) -> bool:
        """
        Check if object is currently visible on canvas.

        Visibility rules:
        - Cell: Visible if cell ID in expanded set
        - Pin: Visible if parent cell is visible
        - Net: Visible if any connected pin's parent cell is visible
        - Port: Always considered visible (top-level)

        Args:
            obj: Domain entity to check

        Returns:
            True if object is currently expanded/visible
        """
        if isinstance(obj, Cell):
            return obj.id in self._expanded_cells

        elif isinstance(obj, Pin):
            return obj.parent_cell.id in self._expanded_cells

        elif isinstance(obj, Net):
            # Net is visible if any connected cell is visible
            for pin in obj.connected_pins:
                if pin.parent_cell.id in self._expanded_cells:
                    return True
            return False

        elif isinstance(obj, Port):
            # Ports are top-level, always visible
            return True

        return False

    def expand_cell(
        self,
        cell: Cell,
        hops: int = 1,
        direction: str = "both"
    ) -> None:
        """
        Expand cell with N-hop fanin/fanout.

        Args:
            cell: Cell to expand
            hops: Number of hops (0 = just cell, 1 = cell + neighbors)
            direction: "fanin", "fanout", or "both"
        """
        # Mark cell as expanded
        self._expanded_cells.add(cell.id)

        # Expand neighbors if hops > 0
        if hops > 0:
            neighbors = self._get_connected_cells(cell, hops, direction)
            for neighbor in neighbors:
                self._expanded_cells.add(neighbor.id)

        # Notify observers / update UI
        self._notify_expansion_changed()

    def _get_connected_cells(
        self,
        cell: Cell,
        hops: int,
        direction: str
    ) -> Set[Cell]:
        """
        Get cells connected to cell within N hops.

        Uses graph traversal service to find connected cells.

        Args:
            cell: Starting cell
            hops: Number of hops
            direction: "fanin", "fanout", or "both"

        Returns:
            Set of connected cells
        """
        # Delegate to graph traversal service
        # (Implementation depends on E03 Expansion specs)
        connected = set()

        if direction in ("fanin", "both"):
            fanin_cells = self._graph_traverser.get_fanin_cells(cell, hops)
            connected.update(fanin_cells)

        if direction in ("fanout", "both"):
            fanout_cells = self._graph_traverser.get_fanout_cells(cell, hops)
            connected.update(fanout_cells)

        return connected

    def collapse_cell(self, cell: Cell) -> None:
        """
        Collapse cell (hide from canvas).

        Args:
            cell: Cell to collapse
        """
        if cell.id in self._expanded_cells:
            self._expanded_cells.remove(cell.id)
            self._notify_expansion_changed()

    def get_expanded_cells(self) -> Set[CellId]:
        """Get set of currently expanded cell IDs"""
        return self._expanded_cells.copy()
```

### 2.2 Expansion Strategies for Navigation

**Implementation in Navigator** (from Task E05-F04-T01):

```python
class Navigator:
    """Navigator with intelligent auto-expansion strategies"""

    def _expand_to_object(self, obj: ObjectType) -> None:
        """
        Expand schematic to reveal object with appropriate context.

        Strategy by object type:
        - Cell: Expand cell + 1-hop neighbors for context
        - Pin: Expand parent cell only (pin is visible with cell)
        - Net: Expand all connected cells (net is visible with endpoints)
        - Port: Expand connected net (port connects to internal net)

        Args:
            obj: Domain entity to expand and reveal
        """
        if isinstance(obj, Cell):
            self._expand_cell_with_context(obj)

        elif isinstance(obj, Pin):
            self._expand_pin_with_context(obj)

        elif isinstance(obj, Net):
            self._expand_net_with_context(obj)

        elif isinstance(obj, Port):
            self._expand_port_with_context(obj)

    def _expand_cell_with_context(self, cell: Cell) -> None:
        """
        Expand cell with 1-hop context.

        Reveals:
        - Target cell
        - Immediate fanin cells (what drives this cell)
        - Immediate fanout cells (what this cell drives)

        Rationale: Shows cell in context of its connections,
        helping user understand why they searched for this cell.

        Args:
            cell: Cell to expand
        """
        # Expand cell with 1-hop neighbors
        self._expansion.expand_cell(cell, hops=1, direction="both")

    def _expand_pin_with_context(self, pin: Pin) -> None:
        """
        Expand pin's parent cell only.

        Reveals:
        - Parent cell (containing the pin)

        Rationale: Pin is visible once parent cell is expanded.
        No need for neighbor context since pin is detail-level view.

        Args:
            pin: Pin to expand
        """
        # Expand parent cell only (hops=0 means just the cell)
        self._expansion.expand_cell(pin.parent_cell, hops=0)

    def _expand_net_with_context(self, net: Net) -> None:
        """
        Expand all cells connected to net.

        Reveals:
        - All cells with pins connected to this net

        Rationale: Net is only visible when its endpoints are visible.
        Expand all connected cells to show full net path.

        Args:
            net: Net to expand
        """
        # Expand all cells connected to this net
        for pin in net.connected_pins:
            self._expansion.expand_cell(pin.parent_cell, hops=0)

    def _expand_port_with_context(self, port: Port) -> None:
        """
        Expand port's connected net.

        Reveals:
        - Internal net connected to port
        - Cells connected to that net (via net expansion)

        Rationale: Port is top-level I/O. Show what it connects to internally.

        Args:
            port: Port to expand
        """
        if port.connected_net:
            # Recursively expand the connected net
            self._expand_net_with_context(port.connected_net)
        else:
            self._logger.warning(f"Port {port.name} has no connected net")
```

### 2.3 Expansion State Management

**Requirement**: Track expanded cells to support visibility queries and undo/redo.

**Data Structure**:
```python
class ExpansionService:
    def __init__(self, design: Design):
        # Primary state: set of expanded cell IDs
        self._expanded_cells: Set[CellId] = set()

        # History for undo/redo (stack of expansion deltas)
        self._history: List[ExpansionDelta] = []
        self._history_index: int = -1


@dataclass
class ExpansionDelta:
    """Record of expansion change for undo/redo"""
    action: str  # "expand" or "collapse"
    cells: Set[CellId]
    timestamp: float
```

### 2.4 Performance Requirements

| Operation | Target | Notes |
|-----------|--------|-------|
| Visibility check | < 5ms | Set membership check |
| Expand cell (0-hop) | < 20ms | Single cell, no neighbors |
| Expand cell (1-hop) | < 150ms | Cell + ~10-50 neighbors |
| Expand net | < 100ms | ~5-10 connected cells |
| Total auto-expansion | < 150ms | For navigation workflow |

---

## 3. Dependencies

### 3.1 Upstream
- E03 (Expansion): Core expansion logic and graph traversal
- Domain model: `Cell`, `Pin`, `Net`, `Port`, `Design`
- Graph traversal service: `get_fanin_cells()`, `get_fanout_cells()`

### 3.2 Downstream
- Task E05-F04-T01: Uses `is_visible()` and `_expand_to_object()`
- E06-F01 (Undo/Redo): Uses expansion history for undo

### 3.3 External Dependencies
- Python standard library: `typing`, `dataclasses`, `logging`

---

## 4. Acceptance Criteria

### 4.1 Functional Requirements
- [ ] `is_visible()` correctly determines if objects are visible
- [ ] Cell is visible if in expanded set
- [ ] Pin is visible if parent cell is visible
- [ ] Net is visible if any connected cell is visible
- [ ] Port is always visible (top-level)
- [ ] `expand_cell()` adds cell to expanded set
- [ ] `expand_cell(hops=1)` expands cell + 1-hop neighbors
- [ ] `expand_cell(direction="fanin")` expands only fanin neighbors
- [ ] `expand_cell(direction="fanout")` expands only fanout neighbors
- [ ] `expand_cell(direction="both")` expands fanin + fanout neighbors
- [ ] Cell expansion strategy: 1-hop both directions
- [ ] Pin expansion strategy: parent cell only (0-hop)
- [ ] Net expansion strategy: all connected cells (0-hop each)
- [ ] Port expansion strategy: connected net (recursive)

### 4.2 Edge Cases
- [ ] Handle cell with no connections (0-hop expansion only)
- [ ] Handle net with no connected pins (no expansion)
- [ ] Handle port with no connected net (warning logged)
- [ ] Handle already-expanded cells (idempotent expansion)
- [ ] Handle concurrent expansion requests (sequential processing)

### 4.3 Performance
- [ ] Visibility check in < 5ms
- [ ] 0-hop expansion in < 20ms
- [ ] 1-hop expansion in < 150ms
- [ ] Net expansion (5-10 cells) in < 100ms
- [ ] Total navigation expansion in < 150ms

### 4.4 Testing
- [ ] Unit tests for `is_visible()` with all object types
- [ ] Unit tests for expansion strategies (cell, pin, net, port)
- [ ] Test 0-hop vs 1-hop expansion
- [ ] Test fanin/fanout/both directions
- [ ] Integration test with real graph traversal service
- [ ] Test expansion state tracking (expanded set)
- [ ] Test edge cases (no connections, no net, etc.)
- [ ] Performance tests with timing assertions
- [ ] 90%+ code coverage on expansion service updates

---

## 5. Implementation Notes

### 5.1 Design Decisions

**Why different strategies per object type?**
- Cell: Needs context (why this cell? what does it connect to?)
- Pin: Detail-level view, just need parent cell
- Net: Only visible when endpoints visible
- Port: Top-level I/O, show internal connections

**Why 1-hop for cells?**
- Balances context vs clutter
- Shows immediate connections (what drives/is driven)
- Matches user mental model ("show me this cell and what it connects to")
- Avoids expanding entire netlist for highly-connected cells

**Why 0-hop for pins?**
- Pin is part of cell (not independent entity)
- Once cell is visible, all pins are visible
- No need for neighbor context at pin level

**Why expand all connected cells for nets?**
- Net is visualization artifact (connects pins)
- Net only meaningful when endpoints are visible
- Expanding partial net path is confusing

**Why recursive expansion for ports?**
- Port connects to internal net
- Net connects to internal cells
- Recursive strategy reveals full connection path

### 5.2 Expansion State Design

**Why Set[CellId] for expanded cells?**
- O(1) membership check for visibility queries
- Simple add/remove for expand/collapse
- Easy to serialize for session save/load
- Memory efficient (only stores IDs, not full objects)

**Why track history as deltas?**
- Supports undo/redo without storing full state snapshots
- Delta = {action, cells} is compact
- Can replay deltas to reconstruct state

### 5.3 Visibility Rules

**Design tradeoff**: When is a net visible?
- **Option A**: Net visible if ALL connected cells visible
- **Option B**: Net visible if ANY connected cell visible âœ“

**Chosen**: Option B
- More forgiving (net appears sooner during expansion)
- Matches user expectation (partial net better than no net)
- Can still render net even if some endpoints off-screen

### 5.4 Testing Strategy

**Unit Tests** (`tests/unit/application/services/test_expansion_visibility.py`):
- Mock `Design` and graph traversal service
- Test visibility rules independently
- Test expansion strategies with mocked neighbors
- Verify expanded set updated correctly

**Integration Tests** (`tests/integration/application/test_auto_expansion.py`):
- Use real Design with sample netlist
- Real graph traversal service
- Verify end-to-end expansion workflow
- Measure performance with timing assertions

**Widget Tests** (optional, for visual verification):
- Render canvas before/after expansion
- Verify target object visible after expansion
- Check neighbor cells expanded correctly

---

## Revision History
| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-12-26 | 0.1 | Claude | Initial task creation from E05-F04 split |
