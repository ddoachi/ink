# Pre-Implementation Documentation: E05-F01-T01 - SearchPanel Widget Foundation

## Overview

### Problem Context
The search functionality requires a dedicated UI panel where users can input search queries, view results, and navigate to objects in the schematic. This task establishes the foundational widget infrastructure that will be extended by subsequent tasks for filtering, results display, history, and keyboard shortcuts.

### Goals
- Create a reusable `SearchPanel` widget following PySide6 best practices
- Establish signal/slot architecture for loose coupling with application services
- Integrate the panel into the main window layout without disrupting existing UI
- Provide foundation for incremental feature additions in T02-T05

### Scope
**In Scope:**
- Basic `SearchPanel` QWidget class structure
- Search input field with placeholder text
- Status label for result count feedback
- Signal infrastructure for search execution and panel lifecycle events
- Main window integration methods for show/hide functionality

**Out of Scope:**
- Type filter buttons (T02)
- Results list display (T03)
- Search history dropdown (T04)
- Keyboard shortcuts (T05)
- Actual search execution logic (E05-F02)

## Implementation Approach

### Architecture Pattern
The `SearchPanel` follows the **Presentation Layer** pattern from DDD/Clean Architecture:
- No business logic - purely UI concerns
- Emits signals for events, doesn't call application services directly
- Main window acts as coordinator, connecting panel signals to application services
- Widget is self-contained and reusable

### Component Design

#### SearchPanel Widget
```
SearchPanel (QWidget)
├── Search Input Row (QHBoxLayout)
│   ├── Label: "Search:"
│   └── QLineEdit (search_input)
├── Status Label (QLabel)
└── Placeholder comments for T02-T04 widgets
```

#### Signal Flow
```
User Action           SearchPanel Signal       Main Window Handler
───────────────────────────────────────────────────────────────────
Enter in input    →   search_executed(str)  →  _execute_search()
Panel closed      →   search_closed()       →  _on_search_closed()
Result clicked    →   result_selected(str)  →  _navigate_to_object()
```

### Integration Points

#### Main Window Layout
The panel needs to be integrated into the main window's bottom area. Implementation depends on existing layout structure:

**Option A: Bottom Dock Widget**
```python
self.search_dock = QDockWidget("Search", self)
self.search_dock.setWidget(self.search_panel)
self.addDockWidget(Qt.DockWidgetArea.BottomDockWidgetArea, self.search_dock)
self.search_dock.setVisible(False)
```

**Option B: Splitter Integration**
```python
# If main window uses QSplitter for layout
self.bottom_splitter.addWidget(self.search_panel)
self.search_panel.setVisible(False)
```

**Decision Required:** Determine existing main window layout structure before implementation.

#### File Structure
```
src/ink/presentation/panels/
├── __init__.py                  # Update to export SearchPanel
├── search_panel.py              # NEW: SearchPanel implementation
├── property_panel.py            # Existing
└── hierarchy_panel.py           # Existing
```

## Key Design Decisions

### 1. Signal vs Direct Method Calls
**Decision:** Use Qt signals for all cross-widget communication

**Rationale:**
- Loose coupling - panel doesn't know about application services
- Testability - can test panel in isolation with signal spies
- Extensibility - easy to add new signal handlers without modifying panel
- Qt best practice - leverages framework's event system

**Alternative Considered:** Direct method calls to application services
- Rejected: Creates tight coupling, harder to test

### 2. Status Label Update Pattern
**Decision:** Provide `set_status(count: int)` method with smart formatting

**Rationale:**
- Encapsulates status text formatting logic in widget
- Caller only needs to provide result count
- Consistent status messages (0 → "No results", 1 → "1 result found", N → "N results found")

**Alternative Considered:** Caller provides full status string
- Rejected: Duplicates formatting logic, inconsistent messages

### 3. Panel Visibility Default
**Decision:** Panel starts hidden, shown on demand via `Ctrl+F` (T05)

**Rationale:**
- Saves screen space for schematic canvas (primary UI)
- Aligns with standard search UX (VS Code, browsers)
- User explicitly opens when needed

**Alternative Considered:** Always visible
- Rejected: Takes up valuable vertical space

### 4. Search Trigger Behavior
**Decision:** Emit `search_executed` only on Enter key press, not on text change

**Rationale:**
- Prevents expensive search operations on every keystroke
- User controls when search executes
- Predictable behavior for incremental typing

**Alternative Considered:** Real-time search on text change
- Rejected: Performance concerns with large netlists, may implement in P1 with debouncing

## Dependencies and Integration Points

### Upstream Dependencies
1. **PySide6 Installation**: Verify `PySide6` is in `pyproject.toml` dependencies
2. **Main Window Structure**: Need to inspect existing main window layout to determine integration approach
3. **Testing Infrastructure**: Ensure `pytest-qt` is configured for Qt widget testing

### Downstream Consumers
This task provides foundation for:
- **T02 (Type Filter Buttons)**: Will add filter row to panel layout
- **T03 (Results List)**: Will add `QListWidget` to panel layout
- **T04 (History Dropdown)**: Will add dropdown to search input row
- **T05 (Keyboard Shortcuts)**: Will call `show_search_panel()` and `focus_search_input()` methods
- **E05-F02 (Search Engine)**: Will connect to `search_executed` signal
- **E05-F04 (Navigation)**: Will connect to `result_selected` signal

### Interface Contracts

#### SearchPanel Public API
```python
# Signals (emit only, consumers connect)
search_executed: Signal[str]      # Query string
result_selected: Signal[str]      # Object ID
search_closed: Signal[]           # No parameters

# Methods (called by main window)
set_status(count: int) -> None
focus_search_input() -> None
setVisible(visible: bool) -> None  # Inherited from QWidget
```

#### Main Window Public API (New Methods)
```python
show_search_panel() -> None
hide_search_panel() -> None
```

## Testing Strategy

### Unit Tests (Widget-Level)
**File:** `/home/joohan/dev/project-ink/ink/tests/ui/panels/test_search_panel.py`

**Test Categories:**
1. **Initialization Tests**: Verify default state (placeholder text, status label)
2. **Signal Tests**: Verify signals emit with correct parameters
3. **State Tests**: Verify `set_status()` updates label correctly
4. **Focus Tests**: Verify `focus_search_input()` sets focus and selects text

**Test Fixtures:**
```python
@pytest.fixture
def app():
    """QApplication instance required for Qt widgets."""
    return QApplication.instance() or QApplication([])

@pytest.fixture
def search_panel(app):
    """Fresh SearchPanel instance for each test."""
    return SearchPanel()
```

**Key Test Cases:**
- `test_search_panel_initialization`: Verify placeholder and default status
- `test_search_executed_signal`: Use `qtbot.waitSignal()` to verify signal emission
- `test_set_status_no_results`: Verify "No results" message
- `test_set_status_single_result`: Verify "1 result found" message
- `test_set_status_multiple_results`: Verify "N results found" message
- `test_focus_search_input`: Verify focus and text selection

### Integration Tests (Main Window Level)
**File:** `/home/joohan/dev/project-ink/ink/tests/ui/test_main_window.py`

**Test Categories:**
1. **Panel Integration**: Verify panel is properly integrated into main window
2. **Show/Hide**: Verify `show_search_panel()` and `hide_search_panel()` methods
3. **Signal Connections**: Verify main window connects to panel signals

**Key Test Cases:**
- `test_search_panel_exists`: Verify `main_window.search_panel` exists
- `test_show_search_panel`: Verify panel becomes visible and input focused
- `test_hide_search_panel`: Verify panel becomes hidden

### Manual Testing Checklist
- [ ] Panel appears in correct location when shown
- [ ] Panel hides without leaving empty space
- [ ] Search input accepts text entry
- [ ] Status label updates on `set_status()` calls
- [ ] Panel integrates visually with existing UI theme
- [ ] No layout issues when resizing window

## Risks and Considerations

### Risk 1: Main Window Layout Unknown
**Risk Level:** Medium

**Description:** The existing main window layout structure is not specified in the task. Integration approach depends on whether layout uses docks, splitters, or other container widgets.

**Mitigation:**
1. Inspect existing `main_window.py` implementation before starting
2. Document current layout structure in implementation notes
3. Choose integration approach that minimizes disruption to existing panels
4. Add TODO comments if layout needs refactoring

**Contingency:** If layout is complex, create a placeholder integration and file follow-up task for proper layout refactoring.

### Risk 2: Test Framework Setup
**Risk Level:** Low

**Description:** Qt widget testing requires `pytest-qt` plugin and `QApplication` instance.

**Mitigation:**
1. Verify `pytest-qt` is in `dev-dependencies` in `pyproject.toml`
2. Create reusable `app` fixture in conftest.py if not exists
3. Follow pytest-qt best practices for signal testing (`qtbot.waitSignal()`)

**Contingency:** If pytest-qt is not installed, add to dependencies and document in PR description.

### Risk 3: Signal Connection Timing
**Risk Level:** Low

**Description:** Signals must be connected before they emit, or events will be lost.

**Mitigation:**
1. Connect signals in main window's `__init__()` method after panel creation
2. Document signal connection order in implementation
3. Add assertion tests to verify signals are connected

**Contingency:** If timing issues occur, use deferred signal connection or event queuing.

### Risk 4: Focus Management
**Risk Level:** Low

**Description:** Focus management between search panel and canvas may conflict with existing focus policies.

**Mitigation:**
1. Document current focus behavior before changes
2. Test focus transitions (canvas → search → canvas)
3. Set explicit `FocusPolicy` on search input widget
4. Verify tab order is logical

**Contingency:** If focus conflicts occur, implement explicit focus handling in main window.

## Implementation Checklist

### Pre-Implementation
- [ ] Review existing `main_window.py` layout structure
- [ ] Verify PySide6 and pytest-qt dependencies installed
- [ ] Check if `panels/__init__.py` exists and review export pattern
- [ ] Review existing panel implementations (property_panel, hierarchy_panel) for consistency

### Implementation
- [ ] Create `src/ink/presentation/panels/search_panel.py`
- [ ] Implement `SearchPanel` class with `__init__()`, `_init_ui()`, `_connect_signals()`
- [ ] Add three signals: `search_executed`, `result_selected`, `search_closed`
- [ ] Implement `set_status(count: int)` method
- [ ] Implement `focus_search_input()` method
- [ ] Add placeholder comments for T02-T04 integration points
- [ ] Update `panels/__init__.py` to export `SearchPanel`

### Main Window Integration
- [ ] Import `SearchPanel` in `main_window.py`
- [ ] Add `_init_search_panel()` method
- [ ] Add `show_search_panel()` and `hide_search_panel()` methods
- [ ] Call `_init_search_panel()` in main window `__init__()`
- [ ] Document integration approach in code comments

### Testing
- [ ] Create `tests/ui/panels/test_search_panel.py`
- [ ] Implement all unit tests from spec (8 test cases)
- [ ] Create `tests/ui/test_main_window.py` if not exists
- [ ] Implement integration tests (3 test cases)
- [ ] Run tests: `uv run pytest tests/ui/panels/test_search_panel.py -v`
- [ ] Verify 100% coverage of `SearchPanel` class

### Validation
- [ ] All acceptance criteria met (9 items from spec)
- [ ] All tests passing
- [ ] No new linting errors (`uv run ruff check src/`)
- [ ] Type hints verified (`uv run mypy src/ink/presentation/panels/search_panel.py`)
- [ ] Manual testing checklist completed
- [ ] Code reviewed for consistency with existing panels

## Open Questions

1. **Main Window Layout**: What is the current layout structure? (Docks, splitters, fixed layout?)
   - **Action Required**: Inspect `main_window.py` before implementation

2. **Panel Position**: Should search panel be in bottom dock or integrated into existing panel area?
   - **Recommendation**: Bottom dock for independence from other panels
   - **Action Required**: Confirm with existing UI design

3. **Panel Sizing**: What should be the default height/size policy for the search panel?
   - **Recommendation**: Minimum height 200px, maximum 400px, expanding width
   - **Action Required**: Test with actual content in T03

4. **Theme Integration**: Are there existing Qt stylesheets or theme settings?
   - **Action Required**: Check for existing `.qss` files or theme configuration
   - **Recommendation**: Use system default theme for MVP, defer custom styling to P1

## Success Criteria

### Functional Requirements
- [ ] `SearchPanel` widget can be instantiated and displayed
- [ ] Search input accepts text and emits signal on Enter key
- [ ] Status label updates with correct formatting
- [ ] Panel can be shown/hidden programmatically
- [ ] Focus management works correctly

### Quality Requirements
- [ ] All unit tests passing (100% coverage of SearchPanel)
- [ ] All integration tests passing
- [ ] No type checking errors
- [ ] No linting warnings
- [ ] Consistent with existing panel implementations

### Documentation Requirements
- [ ] Code is well-commented, especially integration points
- [ ] Docstrings for all public methods
- [ ] Placeholder comments for T02-T04 extensions
- [ ] Implementation notes document any deviations from spec

## Future Considerations

### P1 Enhancements (Not in MVP)
- Add clear button (X) to search input
- Add loading spinner for async search operations
- Add search tips/syntax help tooltip
- Add keyboard shortcut hints in UI
- Custom theming and styling

### Technical Debt
- May need layout refactoring if main window structure is complex
- Signal connection management may need centralization if many panels added
- Consider creating base panel class if common patterns emerge

### Performance
- Current implementation is synchronous and lightweight
- No performance concerns for MVP scope
- Future considerations: Debounced text input, async search execution

## Related Documentation

- **Parent Feature**: [E05-F01 - Search Panel UI](../E05-F01.spec.md)
- **Architecture**: [Layer Architecture](../../../../docs/architecture/layer-architecture.md)
- **DDD Patterns**: [DDD Architecture](../../../../docs/architecture/ddd-architecture.md)
- **Project Guidelines**: [CLAUDE.md](../../../../CLAUDE.md)
- **PySide6 Signals**: https://doc.qt.io/qtforpython-6/overviews/signalsandslots.html
- **pytest-qt**: https://pytest-qt.readthedocs.io/
