---
id: E05-F01-T05
title: Keyboard Shortcuts Integration
type: Task
priority: P0 (MVP)
status: Draft
parent: E05-F01
created: 2025-12-26
estimated_hours: 2
actual_hours:
effort: Small
tags:
  - ui
  - keyboard
  - shortcuts
  - presentation-layer
clickup_task_id: ''
---

# Spec: E05-F01-T05 - Keyboard Shortcuts Integration

## 1. Overview

### 1.1 Problem Statement
Users need keyboard-first access to search functionality for fast workflow. The search panel must respond to `Ctrl+F` to open/focus, `Escape` to close, `Enter` to navigate to first result, and `Up/Down` for result navigation.

### 1.2 Goals
- Implement `Ctrl+F` shortcut to show and focus search panel
- Implement `Escape` to hide search panel
- Implement `Enter` in search input to navigate to first result
- Support `Up/Down` arrow keys in results list (native `QListWidget` behavior)
- Register shortcuts at main window level
- Prevent shortcut conflicts with other panels

---

## 2. Technical Requirements

### 2.1 Keyboard Shortcut Registration

**Location**: `/home/joohan/dev/project-ink/ink/src/ink/presentation/main_window.py`

```python
from PySide6.QtGui import QAction, QKeySequence
from PySide6.QtCore import Qt


class MainWindow(QMainWindow):
    """Main application window."""

    def _setup_shortcuts(self):
        """Register keyboard shortcuts."""
        # Search panel shortcuts
        self.search_shortcut = QAction("Open Search", self)
        self.search_shortcut.setShortcut(QKeySequence("Ctrl+F"))
        self.search_shortcut.triggered.connect(self._open_search_panel)
        self.addAction(self.search_shortcut)

        # Escape to close search (handled in search panel itself)

    def _open_search_panel(self):
        """Open search panel and focus input."""
        self.show_search_panel()
        self.search_panel.focus_search_input()
```

### 2.2 Search Panel Escape Key Handling

**Location**: `/home/joohan/dev/project-ink/ink/src/ink/presentation/panels/search_panel.py`

```python
from PySide6.QtCore import Qt, QEvent


class SearchPanel(QWidget):
    """Search panel widget for object search and navigation."""

    def __init__(self, parent=None):
        super().__init__(parent)
        self._init_ui()
        self._connect_signals()

        # Enable key event handling
        self.setFocusPolicy(Qt.FocusPolicy.StrongFocus)

    def keyPressEvent(self, event: QEvent):
        """Handle key press events."""
        if event.key() == Qt.Key.Key_Escape:
            self._on_close_requested()
            event.accept()
        else:
            super().keyPressEvent(event)

    def _on_close_requested(self):
        """Handle close request (Escape key or close button)."""
        self.search_closed.emit()
        self.setVisible(False)

    def _connect_signals(self):
        """Connect internal signals."""
        # ... existing connections ...

        # Enter key in search input navigates to first result
        self.search_input.returnPressed.connect(self._on_enter_pressed)

    def _on_enter_pressed(self):
        """Handle Enter key in search input."""
        query = self.search_input.text().strip()
        if query:
            # Execute search first
            self.search_executed.emit(query)

            # After results populate, navigate to first (requires delay or callback)
            # For MVP, just execute search; navigation handled by T03

    def navigate_to_first_result(self):
        """Navigate to first result (called after search completes)."""
        if self.results_list.count() > 0:
            self.select_first_result()
```

### 2.3 Escape Key Context Handling

**Location**: `/home/joohan/dev/project-ink/ink/src/ink/presentation/main_window.py`

```python
class MainWindow(QMainWindow):
    """Main application window."""

    def _connect_search_panel_signals(self):
        """Connect search panel signals."""
        self.search_panel.search_closed.connect(self._on_search_closed)

    def _on_search_closed(self):
        """Handle search panel close signal."""
        self.hide_search_panel()
        # Return focus to canvas or previous widget
        self.canvas.setFocus()
```

### 2.4 Results List Navigation

Results list keyboard navigation is native `QListWidget` behavior:
- `Up/Down` arrows navigate between results
- `Enter` activates selected result (emits `itemActivated` signal)
- `Page Up/Down` for fast scrolling

No additional implementation needed beyond connecting `itemActivated` signal (already done in T03).

---

## 3. Dependencies

- **Upstream**:
  - E05-F01-T01 (SearchPanel Widget) - must be completed first
  - E05-F01-T03 (Results List) - for first result navigation
- **Downstream**:
  - None (final UI integration task)

---

## 4. Acceptance Criteria

- [ ] `Ctrl+F` shortcut registered at main window level
- [ ] `Ctrl+F` shows search panel and focuses search input
- [ ] Search input is selected (text highlighted) when panel opens
- [ ] `Escape` key hides search panel
- [ ] `Escape` returns focus to canvas/previous widget
- [ ] `Enter` in search input executes search
- [ ] `Enter` in results list activates selected result
- [ ] `Up/Down` arrows navigate results list (native behavior)
- [ ] Shortcuts documented in user-facing help/tooltips
- [ ] No conflicts with existing keyboard shortcuts

---

## 5. Testing Requirements

### 5.1 Unit Tests

**Location**: `/home/joohan/dev/project-ink/ink/tests/ui/panels/test_search_panel.py`

```python
from PySide6.QtCore import Qt
from PySide6.QtTest import QTest


def test_escape_key_closes_panel(search_panel, qtbot):
    """Test Escape key hides search panel."""
    search_panel.setVisible(True)

    with qtbot.waitSignal(search_panel.search_closed, timeout=1000):
        QTest.keyPress(search_panel, Qt.Key.Key_Escape)

    assert not search_panel.isVisible()


def test_enter_key_executes_search(search_panel, qtbot):
    """Test Enter key in search input executes search."""
    search_panel.search_input.setText("test_query")

    with qtbot.waitSignal(search_panel.search_executed, timeout=1000) as blocker:
        QTest.keyPress(search_panel.search_input, Qt.Key.Key_Return)

    assert blocker.args[0] == "test_query"


def test_focus_search_input_selects_text(search_panel):
    """Test focus_search_input selects all text."""
    search_panel.search_input.setText("existing_text")
    search_panel.focus_search_input()

    assert search_panel.search_input.hasFocus()
    assert search_panel.search_input.selectedText() == "existing_text"
```

### 5.2 Integration Tests

**Location**: `/home/joohan/dev/project-ink/ink/tests/ui/test_main_window.py`

```python
from PySide6.QtGui import QKeySequence
from PySide6.QtTest import QTest


def test_ctrl_f_opens_search_panel(main_window, qtbot):
    """Test Ctrl+F shortcut opens search panel."""
    assert not main_window.search_panel.isVisible()

    # Simulate Ctrl+F
    QTest.keySequence(main_window, QKeySequence("Ctrl+F"))
    qtbot.wait(100)  # Allow event processing

    assert main_window.search_panel.isVisible()
    assert main_window.search_panel.search_input.hasFocus()


def test_escape_closes_search_panel(main_window, qtbot):
    """Test Escape key closes search panel."""
    main_window.show_search_panel()
    assert main_window.search_panel.isVisible()

    QTest.keyPress(main_window.search_panel, Qt.Key.Key_Escape)
    qtbot.wait(100)

    assert not main_window.search_panel.isVisible()


def test_search_panel_close_returns_focus(main_window, qtbot):
    """Test closing search returns focus to canvas."""
    main_window.show_search_panel()
    main_window.hide_search_panel()

    # Focus should return to canvas
    assert main_window.canvas.hasFocus()
```

---

## 6. Implementation Notes

### 6.1 Design Decisions

1. **Shortcut Registration**: Use `QAction` at main window level for global shortcuts
2. **Escape Handling**: Override `keyPressEvent()` in `SearchPanel` for context-specific handling
3. **Focus Management**: Return focus to canvas on close for seamless workflow
4. **Enter Behavior**: Execute search on Enter, not navigate (user may want to see results first)
5. **Native Navigation**: Leverage `QListWidget` built-in keyboard navigation

### 6.2 Keyboard Shortcuts Summary

| Shortcut | Context | Action |
|----------|---------|--------|
| `Ctrl+F` | Global (Main Window) | Open search panel and focus input |
| `Escape` | Search Panel | Close search panel |
| `Enter` | Search Input | Execute search |
| `Enter` | Results List | Navigate to selected result |
| `Up/Down` | Results List | Navigate results (native) |
| `Page Up/Down` | Results List | Fast scroll (native) |

### 6.3 Future Enhancements

- Add `Ctrl+Shift+F` for advanced search dialog
- Add `F3`/`Shift+F3` for next/previous result navigation
- Add `Ctrl+K` as alternative search shortcut (VS Code style)
- Add configurable shortcuts via settings panel
- Add keyboard shortcut hints in UI tooltips

---

## 7. Related Files

**Modified**:
- `/home/joohan/dev/project-ink/ink/src/ink/presentation/main_window.py`
- `/home/joohan/dev/project-ink/ink/src/ink/presentation/panels/search_panel.py`
- `/home/joohan/dev/project-ink/ink/tests/ui/panels/test_search_panel.py`
- `/home/joohan/dev/project-ink/ink/tests/ui/test_main_window.py`

---

## Revision History
| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-12-26 | 0.1 | Claude | Initial task creation from E05-F01 split |
