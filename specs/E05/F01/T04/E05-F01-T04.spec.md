---
id: E05-F01-T04
title: Search History Dropdown
type: Task
priority: P0 (MVP)
status: Draft
parent: E05-F01
created: 2025-12-26
estimated_hours: 3
actual_hours:
effort: Small
tags:
  - ui
  - history
  - presentation-layer
clickup_task_id: ''
---

# Spec: E05-F01-T04 - Search History Dropdown

## 1. Overview

### 1.1 Problem Statement
Users need quick access to recently executed searches to avoid retyping common queries. A history dropdown next to the search input provides one-click access to recent search terms.

### 1.2 Goals
- Add `QComboBox` dropdown next to search input for history
- Store last 10 search queries in history
- Populate search input when history item selected
- Persist history across application sessions (optional for MVP)
- Clear duplicate entries (keep most recent)

---

## 2. Technical Requirements

### 2.1 History Dropdown Integration

**Location**: `/home/joohan/dev/project-ink/ink/src/ink/presentation/panels/search_panel.py`

```python
from PySide6.QtWidgets import QComboBox
from collections import OrderedDict


class SearchPanel(QWidget):
    """Search panel widget for object search and navigation."""

    MAX_HISTORY_ITEMS = 10

    def __init__(self, parent=None):
        super().__init__(parent)
        self._search_history = OrderedDict()  # Preserves insertion order, fast lookup
        self._init_ui()
        self._connect_signals()

    def _init_ui(self):
        """Initialize UI components."""
        layout = QVBoxLayout(self)

        # Search input row
        search_row = QHBoxLayout()
        search_label = QLabel("Search:")
        self.search_input = QLineEdit()
        self.search_input.setPlaceholderText("Enter object name...")

        # History dropdown
        self.history_dropdown = QComboBox()
        self.history_dropdown.setPlaceholderText("History")
        self.history_dropdown.setMinimumWidth(100)
        self.history_dropdown.setSizeAdjustPolicy(
            QComboBox.SizeAdjustPolicy.AdjustToContents
        )

        search_row.addWidget(search_label)
        search_row.addWidget(self.search_input, stretch=1)
        search_row.addWidget(self.history_dropdown)

        layout.addLayout(search_row)

        # ... existing filter buttons ...
        # ... existing results list ...
        # ... existing status label ...

    def _connect_signals(self):
        """Connect internal signals."""
        # ... existing connections ...
        self.history_dropdown.currentTextChanged.connect(self._on_history_selected)

    def _on_search_triggered(self):
        """Handle search input enter key."""
        query = self.search_input.text().strip()
        if query:
            self._add_to_history(query)
            self.search_executed.emit(query)

    def _on_history_selected(self, text: str):
        """Handle history dropdown selection."""
        if text:
            self.search_input.setText(text)
            # Optionally auto-execute search
            # self.search_executed.emit(text)

    def _add_to_history(self, query: str):
        """Add query to search history, removing duplicates."""
        # Remove if already exists (to move to front)
        if query in self._search_history:
            del self._search_history[query]

        # Add to front (most recent)
        self._search_history[query] = None

        # Trim to max size
        if len(self._search_history) > self.MAX_HISTORY_ITEMS:
            # Remove oldest (first item)
            self._search_history.popitem(last=False)

        self._update_history_dropdown()

    def _update_history_dropdown(self):
        """Update history dropdown with current history."""
        self.history_dropdown.clear()

        # Add items in reverse order (most recent first)
        for query in reversed(self._search_history.keys()):
            self.history_dropdown.addItem(query)

        # Reset to placeholder
        self.history_dropdown.setCurrentIndex(-1)

    def get_search_history(self) -> list[str]:
        """Get search history as list (most recent first)."""
        return list(reversed(self._search_history.keys()))

    def load_history(self, history: list[str]):
        """Load search history from external source (e.g., settings)."""
        self._search_history.clear()

        # Add in reverse to preserve order
        for query in reversed(history[:self.MAX_HISTORY_ITEMS]):
            self._search_history[query] = None

        self._update_history_dropdown()

    def clear_history(self):
        """Clear all search history."""
        self._search_history.clear()
        self._update_history_dropdown()
```

### 2.2 History Persistence (Optional for MVP)

**Location**: `/home/joohan/dev/project-ink/ink/src/ink/presentation/main_window.py`

```python
from PySide6.QtCore import QSettings


class MainWindow(QMainWindow):
    """Main application window."""

    def _save_search_history(self):
        """Save search history to QSettings."""
        settings = QSettings("Ink", "SchematicViewer")
        history = self.search_panel.get_search_history()
        settings.setValue("search/history", history)

    def _load_search_history(self):
        """Load search history from QSettings."""
        settings = QSettings("Ink", "SchematicViewer")
        history = settings.value("search/history", [])
        if history:
            self.search_panel.load_history(history)

    def closeEvent(self, event):
        """Handle window close event."""
        self._save_search_history()
        super().closeEvent(event)
```

---

## 3. Dependencies

- **Upstream**:
  - E05-F01-T01 (SearchPanel Widget) - must be completed first
- **Downstream**:
  - None (standalone feature)

---

## 4. Acceptance Criteria

- [ ] History dropdown added next to search input
- [ ] Dropdown shows last 10 search queries
- [ ] Selecting history item populates search input
- [ ] New searches added to history automatically
- [ ] Duplicate searches moved to front (most recent)
- [ ] History limited to 10 items (oldest removed)
- [ ] `get_search_history()` returns history list
- [ ] `load_history()` loads history from external source
- [ ] `clear_history()` clears all history
- [ ] Dropdown shows placeholder "History" when empty
- [ ] History persists across sessions (optional for MVP)

---

## 5. Testing Requirements

### 5.1 Unit Tests

**Location**: `/home/joohan/dev/project-ink/ink/tests/ui/panels/test_search_panel.py`

```python
def test_history_dropdown_initialization(search_panel):
    """Test history dropdown initializes empty."""
    assert search_panel.history_dropdown.count() == 0
    assert search_panel.history_dropdown.placeholderText() == "History"


def test_add_to_history(search_panel):
    """Test searches added to history."""
    search_panel.search_input.setText("query1")
    search_panel._on_search_triggered()

    assert "query1" in search_panel.get_search_history()
    assert search_panel.history_dropdown.count() == 1


def test_history_duplicates_removed(search_panel):
    """Test duplicate searches moved to front."""
    search_panel.search_input.setText("query1")
    search_panel._on_search_triggered()

    search_panel.search_input.setText("query2")
    search_panel._on_search_triggered()

    search_panel.search_input.setText("query1")
    search_panel._on_search_triggered()

    history = search_panel.get_search_history()
    assert history == ["query1", "query2"]  # query1 moved to front
    assert search_panel.history_dropdown.count() == 2


def test_history_max_items(search_panel):
    """Test history limited to MAX_HISTORY_ITEMS."""
    for i in range(15):
        search_panel.search_input.setText(f"query{i}")
        search_panel._on_search_triggered()

    history = search_panel.get_search_history()
    assert len(history) == 10
    assert history[0] == "query14"  # Most recent
    assert "query0" not in history  # Oldest removed


def test_history_selection_populates_input(search_panel):
    """Test selecting history item populates search input."""
    search_panel.search_input.setText("test_query")
    search_panel._on_search_triggered()

    search_panel.history_dropdown.setCurrentIndex(0)

    assert search_panel.search_input.text() == "test_query"


def test_load_history(search_panel):
    """Test load_history method."""
    history = ["query1", "query2", "query3"]
    search_panel.load_history(history)

    assert search_panel.get_search_history() == history
    assert search_panel.history_dropdown.count() == 3


def test_clear_history(search_panel):
    """Test clear_history method."""
    search_panel.search_input.setText("query1")
    search_panel._on_search_triggered()

    search_panel.clear_history()

    assert search_panel.get_search_history() == []
    assert search_panel.history_dropdown.count() == 0


def test_history_order_most_recent_first(search_panel):
    """Test history dropdown shows most recent first."""
    search_panel.search_input.setText("old_query")
    search_panel._on_search_triggered()

    search_panel.search_input.setText("new_query")
    search_panel._on_search_triggered()

    # Dropdown index 0 should be most recent
    assert search_panel.history_dropdown.itemText(0) == "new_query"
    assert search_panel.history_dropdown.itemText(1) == "old_query"
```

---

## 6. Implementation Notes

### 6.1 Design Decisions

1. **Data Structure**: Use `OrderedDict` for O(1) duplicate removal and order preservation
2. **History Size**: Limit to 10 items to keep dropdown manageable
3. **Auto-execute**: Do NOT auto-execute search on history selection (user may want to edit)
4. **Persistence**: Use `QSettings` for cross-session persistence (optional for MVP)
5. **Duplicates**: Move duplicate to front instead of ignoring (shows recent usage)

### 6.2 UI Layout

```
┌─ Search Panel ─────────────────────────────────┐
│  Search: [___________] [History ▼]             │  ← NEW DROPDOWN
│           ^                ^                    │
│           search input     history dropdown    │
└────────────────────────────────────────────────┘
```

### 6.3 Future Enhancements

- Add "Clear History" button in dropdown menu
- Add search frequency counter (show most used first)
- Add history item deletion (right-click context menu)
- Add history search/filter for very long lists
- Add history export/import

---

## 7. Related Files

**Modified**:
- `/home/joohan/dev/project-ink/ink/src/ink/presentation/panels/search_panel.py`
- `/home/joohan/dev/project-ink/ink/src/ink/presentation/main_window.py` (optional persistence)
- `/home/joohan/dev/project-ink/ink/tests/ui/panels/test_search_panel.py`

---

## Revision History
| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-12-26 | 0.1 | Claude | Initial task creation from E05-F01 split |
