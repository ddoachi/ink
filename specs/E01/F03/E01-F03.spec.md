# Spec: E01-F03 - Graph Construction

## Metadata
- **ID**: E01-F03
- **Type**: Feature
- **Priority**: P0 (MVP)
- **Status**: Draft
- **Parent**: [E01](../E01.spec.md)
- **Created**: 2025-12-26

---

## 1. Overview

### 1.1 Problem Statement
After parsing CDL netlists and pin directions, Ink needs to build an efficient graph-based internal representation that enables fast connectivity queries for incremental schematic exploration. The graph must represent cells, pins, nets, and ports as nodes with net connectivity as edges, supporting O(1) or O(log n) lookups for real-time UI interactions.

### 1.2 Goals
- Build NetworkX-based graph representation from parsed netlist data
- Model cells, pins, nets, and ports as graph nodes with appropriate attributes
- Represent net connectivity as graph edges
- Enable efficient fanin/fanout queries for incremental expansion
- Provide O(1) hash-based lookup by name for UI responsiveness
- Design for future migration to rustworkx for performance optimization

---

## 2. User Stories

### US-E01-03: Query Cell Connectivity
**As a** circuit designer
**I want to** query which cells connect to a given net
**So that** I can trace signal paths through the design

**Acceptance Criteria:**
- [ ] API returns all cells connected to a specified net
- [ ] API returns all pins of a cell with their connected nets
- [ ] Query performance is O(1) or O(log n) for individual lookups

---

## 3. Technical Requirements

### 3.1 Graph Representation

**Library**: NetworkX (MVP), with migration path to rustworkx for performance

**Node Types**:
- **Cell Nodes**: Represent cell instances
- **Pin Nodes**: Represent pins on cells
- **Net Nodes**: Represent nets connecting pins
- **Port Nodes**: Represent top-level I/O ports

**Edge Types**:
- **Cell → Pin**: Cell contains pins
- **Pin → Net**: Pin connects to net
- **Net → Pin**: Net connects to multiple pins (multi-fanout)

### 3.2 Graph Architecture

**Location**: `src/ink/infrastructure/graph/networkx_adapter.py`

**Core Components**:
```python
class NetworkXGraphAdapter:
    """NetworkX-based graph implementation"""

    def __init__(self):
        self.graph = nx.MultiDiGraph()  # Directed multigraph
        self._cell_index: Dict[str, CellId] = {}
        self._net_index: Dict[str, NetId] = {}
        self._pin_index: Dict[str, PinId] = {}

    def add_cell(self, cell: Cell) -> None:
        """Add cell node to graph"""
        pass

    def add_net(self, net: Net) -> None:
        """Add net node to graph"""
        pass

    def add_pin(self, pin: Pin, cell: Cell) -> None:
        """Add pin node and link to cell and net"""
        pass

    def get_connected_cells(self, net_id: NetId) -> List[Cell]:
        """Get all cells connected to a net"""
        pass

    def get_cell_pins(self, cell_id: CellId) -> List[Pin]:
        """Get all pins of a cell"""
        pass

    def get_fanout(self, pin_id: PinId, hops: int = 1) -> List[Cell]:
        """Get fanout cells (downstream) from a pin"""
        pass

    def get_fanin(self, pin_id: PinId, hops: int = 1) -> List[Cell]:
        """Get fanin cells (upstream) to a pin"""
        pass
```

### 3.3 Domain Model Classes

From E01.spec.md Section 3.2:

```python
@dataclass
class Cell:
    name: str           # Instance name (e.g., "XI1")
    cell_type: str      # Cell type (e.g., "INV_X1")
    pins: List[Pin]     # Connected pins
    is_sequential: bool # Latch/FF flag

@dataclass
class Pin:
    name: str           # Pin name (e.g., "A", "Y")
    direction: PinDirection  # INPUT, OUTPUT, INOUT
    net: Net            # Connected net

@dataclass
class Net:
    name: str           # Net name
    connected_pins: List[Pin]  # All pins on this net

@dataclass
class Port:
    name: str           # Top-level port name
    direction: PinDirection
    net: Net
```

### 3.4 Graph Construction Process

1. **Parse CDL**: Extract subcircuit definitions and cell instances (E01-F01)
2. **Parse Pin Directions**: Load pin direction mapping (E01-F02)
3. **Build Graph**:
   - Create Net nodes for all unique net names
   - Create Cell nodes for all instances
   - Create Pin nodes for each cell pin with direction from mapping
   - Create Port nodes for top-level I/O
   - Link Pin → Net edges based on connectivity
   - Link Cell → Pin edges for containment

### 3.5 Indexing Strategy

**Hash-based Indices** for O(1) lookup:
```python
self._cell_index: Dict[str, CellId]    # name → CellId
self._net_index: Dict[str, NetId]      # name → NetId
self._pin_index: Dict[str, PinId]      # "{cell}.{pin}" → PinId
self._port_index: Dict[str, PortId]    # name → PortId
```

### 3.6 Query Performance Requirements

| Query Type | Complexity | Target Latency |
|------------|-----------|----------------|
| Get cell by name | O(1) | < 1ms |
| Get net by name | O(1) | < 1ms |
| Get cell pins | O(k) k=pin count | < 5ms |
| Get connected cells | O(k) k=pin count | < 10ms |
| Get fanout (1-hop) | O(k) k=fanout | < 10ms |
| Get fanin (1-hop) | O(k) k=fanin | < 10ms |

### 3.7 Memory Requirements

- **Target**: < 2GB for 100K cell netlist
- Use memory-efficient data structures
- Avoid duplicate string storage (intern common strings)

---

## 4. Dependencies

- **Upstream**:
  - E01-F01 (CDL Parser) - provides cell instances and connections
  - E01-F02 (Pin Direction Parser) - provides pin directions
- **Downstream**:
  - E02 (Schematic Rendering) - queries graph for visible objects
  - E03 (Incremental Expansion) - queries graph for fanin/fanout
  - E04 (Object Interaction) - queries graph for selection
  - E05 (Search) - queries graph for search results

---

## 5. Acceptance Criteria

- [ ] Build NetworkX graph from parsed CDL and pin direction data
- [ ] Graph contains Cell, Pin, Net, and Port nodes with correct attributes
- [ ] Graph edges correctly represent Cell→Pin and Pin→Net connectivity
- [ ] O(1) lookup by name for cells, nets, pins, ports
- [ ] API returns all cells connected to a specified net
- [ ] API returns all pins of a cell with their connected nets
- [ ] Fanout query returns downstream cells within N hops
- [ ] Fanin query returns upstream cells within N hops
- [ ] Query performance: < 10ms for single cell/net lookup on 100K cell netlist
- [ ] Memory usage: < 2GB for 100K cell netlist
- [ ] Graph adapter implements domain service interfaces (GraphTraverser protocol)
- [ ] 90%+ test coverage on graph module

---

## 6. Child Specs
*To be created via `/spec_work E01-F03 --split tasks`*

| ID | Task | Status |
|----|------|--------|

---

## Revision History
| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-12-26 | 0.1 | Claude | Initial feature creation from E01 split |
