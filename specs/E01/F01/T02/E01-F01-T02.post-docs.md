# Post-Implementation Documentation: E01-F01-T02 - Subcircuit Definition Parser

## Quick Reference

### What Was Built
A parser for `.SUBCKT`/`.ENDS` blocks in CDL files, consisting of:
1. **`SubcircuitDefinition`** - Immutable domain value object representing a cell type
2. **`SubcircuitParser`** - Infrastructure parser with stack-based nesting tracking

### Files Created/Modified

| File | Type | Purpose |
|------|------|---------|
| `src/ink/domain/value_objects/subcircuit.py` | New | Domain value object for subcircuit definitions |
| `src/ink/domain/value_objects/__init__.py` | Modified | Export `SubcircuitDefinition` |
| `src/ink/infrastructure/parsing/subcircuit_parser.py` | New | Parser for `.SUBCKT`/`.ENDS` blocks |
| `src/ink/infrastructure/parsing/__init__.py` | Modified | Export `SubcircuitParser` |
| `tests/unit/domain/value_objects/test_subcircuit.py` | New | 24 unit tests for value object |
| `tests/unit/infrastructure/parsing/test_subcircuit_parser.py` | New | 39 unit tests for parser |

### Key Design Decisions

1. **Immutable Value Object**: `SubcircuitDefinition` uses `@dataclass(frozen=True)` with custom `__init__` for validation
2. **Tuple Storage**: Ports stored as `tuple[str, ...]` instead of list for immutability
3. **Stack-Based Nesting**: Parser uses a simple Python list as a stack for tracking open blocks
4. **Last Definition Wins**: Duplicate cell names silently replace earlier definitions
5. **Case Sensitivity**: Cell and port names are case-sensitive (preserved exactly as in CDL)

### Usage Pattern

```python
from ink.infrastructure.parsing import CDLLexer, LineType, SubcircuitParser
from pathlib import Path

# Parse CDL file
lexer = CDLLexer(Path("design.ckt"))
parser = SubcircuitParser()

for token in lexer.tokenize():
    if token.line_type == LineType.SUBCKT:
        defn = parser.parse_subckt_line(token)
        print(f"Parsed: {defn.name} with ports {defn.ports}")
    elif token.line_type == LineType.ENDS:
        closed = parser.parse_ends_line(token)
        print(f"Closed: {closed}")

# Validate all blocks closed
parser.validate_complete()

# Retrieve definitions
inv = parser.get_definition("INV")
if inv:
    print(f"INV has {len(inv.ports)} ports")
```

---

## Implementation Summary

### Architecture Alignment

This implementation follows the project's DDD architecture:

- **Domain Layer**: `SubcircuitDefinition` is a pure value object with no external dependencies
- **Infrastructure Layer**: `SubcircuitParser` bridges the lexer and domain model
- **Dependency Direction**: Infrastructure depends on Domain, not the other way around

### Test Coverage

- **63 total tests** (24 domain + 39 parser)
- Tests cover: creation, validation, immutability, equality, hashability, nesting, errors, edge cases
- All tests pass with lint and type checking clean

### Integration Points

- **Upstream**: Receives `CDLToken` from `CDLLexer` (E01-F01-T01)
- **Downstream**: Provides definitions to Instance Parser (E01-F01-T03)

---

## Lessons Learned

### What Worked Well

1. **TDD Approach**: Writing tests first clarified the interface before implementation
2. **Frozen Dataclass**: Custom `__init__` with validation allowed both ease of use and strict invariants
3. **Stack Abstraction**: Simple list-based stack was sufficient for nesting depth in CDL files

### Challenges Encountered

1. **Frozen Dataclass with Custom Init**: Required `object.__setattr__` to set fields after validation
2. **Type Imports**: Using `TYPE_CHECKING` for parser imports to avoid circular dependencies
3. **Port Tuple vs List**: Tests initially expected list, but tuple is better for immutability

### Future Improvements

1. **Warning for Duplicate Definitions**: Currently silent replacement; could log a warning
2. **Context Line Tracking**: Could store first/last line numbers for better error messages
3. **Case-Insensitive Lookup**: Optional mode for case-insensitive cell name matching

---

## Related Specs

- **E01-F01-T01**: CDL Lexer (upstream - provides tokens)
- **E01-F01-T03**: Instance Parser (downstream - consumes definitions)
- **E01-F01-T05**: Parser Integration (orchestrates all parsers)
