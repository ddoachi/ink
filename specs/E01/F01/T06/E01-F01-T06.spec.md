---
id: E01-F01-T06
title: Net Classification Configuration
type: Task
priority: P1
status: Draft
parent: E01-F01
created: 2025-12-27
estimated_hours: 4-6
actual_hours:
effort: Medium
tags:
  - parsing
  - configuration
  - ui
  - dialog
clickup_task_id: '86evzu0k2'
---

# Spec: E01-F01-T06 - Net Classification Configuration

## 1. Overview

### 1.1 Problem Statement
Power and ground net names vary across different projects and PDKs (Process Design Kits). While E01-F01-T04 provides default patterns (VDD, VSS, etc.) and custom net name support via constructor, users need a way to configure these net names per-project through a configuration file and UI dialog.

### 1.2 Goals
- Define a YAML configuration file format for power/ground net names
- Store configuration per-project (in project directory)
- Provide a Qt dialog to edit the configuration
- Load configuration automatically when opening a project
- Support both exact net names and regex patterns

---

## 2. Technical Requirements

### 2.1 Configuration File Format

**Location**: `{project_root}/.ink/net_classification.yaml`

**Schema**:
```yaml
# Net Classification Configuration for Ink
# This file defines which nets are classified as power or ground

version: 1

power_nets:
  # Exact net names (case-insensitive)
  names:
    - AVDD
    - DVDD
    - VDD_CORE
    - VDD_IO
    - VDD_PLL

  # Regex patterns (in addition to defaults)
  # Default patterns: VDD[A-Z]*, VCC[A-Z]*, VPWR
  patterns:
    - "^VDDQ[0-9]*$"    # VDDQ0, VDDQ1, etc.
    - "^PWR_.*$"        # PWR_CORE, PWR_IO, etc.

ground_nets:
  # Exact net names (case-insensitive)
  names:
    - AVSS
    - DVSS
    - VSS_CORE
    - VSS_IO

  # Regex patterns (in addition to defaults)
  # Default patterns: VSS[A-Z]*, GND[A-Z]*, VGND
  patterns:
    - "^VSSQ[0-9]*$"    # VSSQ0, VSSQ1, etc.
    - "^GND_.*$"        # GND_CORE, GND_IO, etc.

# Optional: Override default patterns (false = use defaults + custom)
override_defaults: false
```

### 2.2 Implementation Details

**Configuration Loader** (`src/ink/infrastructure/config/net_classification_config.py`):
```python
from dataclasses import dataclass, field
from pathlib import Path
from typing import Optional
import yaml

@dataclass
class NetClassificationConfig:
    """Configuration for power/ground net classification."""

    power_names: list[str] = field(default_factory=list)
    power_patterns: list[str] = field(default_factory=list)
    ground_names: list[str] = field(default_factory=list)
    ground_patterns: list[str] = field(default_factory=list)
    override_defaults: bool = False

    @classmethod
    def load(cls, project_path: Path) -> "NetClassificationConfig":
        """Load configuration from project directory."""
        config_file = project_path / ".ink" / "net_classification.yaml"
        if not config_file.exists():
            return cls()  # Return defaults

        with open(config_file) as f:
            data = yaml.safe_load(f)

        return cls(
            power_names=data.get("power_nets", {}).get("names", []),
            power_patterns=data.get("power_nets", {}).get("patterns", []),
            ground_names=data.get("ground_nets", {}).get("names", []),
            ground_patterns=data.get("ground_nets", {}).get("patterns", []),
            override_defaults=data.get("override_defaults", False),
        )

    def save(self, project_path: Path) -> None:
        """Save configuration to project directory."""
        config_dir = project_path / ".ink"
        config_dir.mkdir(parents=True, exist_ok=True)

        config_file = config_dir / "net_classification.yaml"
        data = {
            "version": 1,
            "power_nets": {
                "names": self.power_names,
                "patterns": self.power_patterns,
            },
            "ground_nets": {
                "names": self.ground_names,
                "patterns": self.ground_patterns,
            },
            "override_defaults": self.override_defaults,
        }

        with open(config_file, "w") as f:
            yaml.dump(data, f, default_flow_style=False, sort_keys=False)
```

**Configuration Dialog** (`src/ink/presentation/dialogs/net_classification_dialog.py`):
```python
from PySide6.QtWidgets import (
    QDialog, QVBoxLayout, QHBoxLayout, QTabWidget,
    QListWidget, QLineEdit, QPushButton, QLabel,
    QGroupBox, QCheckBox, QDialogButtonBox,
)

class NetClassificationDialog(QDialog):
    """Dialog for editing power/ground net classification."""

    def __init__(self, config: NetClassificationConfig, parent=None):
        super().__init__(parent)
        self.config = config
        self.setWindowTitle("Net Classification Settings")
        self.setMinimumWidth(500)
        self._setup_ui()
        self._load_config()

    def _setup_ui(self):
        layout = QVBoxLayout(self)

        # Tab widget for Power/Ground
        tabs = QTabWidget()
        tabs.addTab(self._create_net_tab("power"), "Power Nets")
        tabs.addTab(self._create_net_tab("ground"), "Ground Nets")
        layout.addWidget(tabs)

        # Override defaults checkbox
        self.override_checkbox = QCheckBox("Override default patterns")
        layout.addWidget(self.override_checkbox)

        # Dialog buttons
        buttons = QDialogButtonBox(
            QDialogButtonBox.Ok | QDialogButtonBox.Cancel
        )
        buttons.accepted.connect(self.accept)
        buttons.rejected.connect(self.reject)
        layout.addWidget(buttons)

    def _create_net_tab(self, net_type: str) -> QWidget:
        """Create a tab for power or ground net configuration."""
        widget = QWidget()
        layout = QVBoxLayout(widget)

        # Names section
        names_group = QGroupBox("Net Names (exact match)")
        names_layout = QVBoxLayout(names_group)
        list_widget = QListWidget()
        setattr(self, f"{net_type}_names_list", list_widget)
        names_layout.addWidget(list_widget)

        # Add/Remove buttons for names
        btn_layout = QHBoxLayout()
        add_btn = QPushButton("Add")
        remove_btn = QPushButton("Remove")
        btn_layout.addWidget(add_btn)
        btn_layout.addWidget(remove_btn)
        names_layout.addLayout(btn_layout)

        layout.addWidget(names_group)

        # Patterns section (similar structure)
        patterns_group = QGroupBox("Regex Patterns")
        # ... similar implementation

        return widget

    def get_config(self) -> NetClassificationConfig:
        """Get the edited configuration."""
        # Extract values from UI and return updated config
        ...
```

### 2.3 Integration with NetNormalizer

**Enhanced NetNormalizer Factory** (`src/ink/infrastructure/parsing/net_normalizer.py`):
```python
@classmethod
def from_config(cls, config: NetClassificationConfig) -> "NetNormalizer":
    """Create NetNormalizer from configuration."""
    normalizer = cls(
        power_nets=config.power_names,
        ground_nets=config.ground_names,
    )

    # Add custom patterns if provided
    if config.power_patterns:
        normalizer.add_power_patterns(config.power_patterns)
    if config.ground_patterns:
        normalizer.add_ground_patterns(config.ground_patterns)

    if config.override_defaults:
        normalizer.clear_default_patterns()

    return normalizer
```

### 2.4 Menu Integration

Add to Edit menu or Settings menu:
- **Edit > Net Classification...** - Opens the configuration dialog

### 2.5 Testing Requirements

**Unit Tests**:
```python
def test_load_config_from_yaml():
    """Test loading configuration from YAML file."""

def test_save_config_to_yaml():
    """Test saving configuration to YAML file."""

def test_config_defaults_when_no_file():
    """Test that defaults are used when no config file exists."""

def test_dialog_displays_config():
    """Test that dialog displays current configuration."""

def test_dialog_saves_changes():
    """Test that dialog changes are saved to config."""

def test_normalizer_from_config():
    """Test creating NetNormalizer from config."""
```

---

## 3. Dependencies

- **Upstream**:
  - E01-F01-T04 (Net Name Normalization) - provides `NetNormalizer` with custom net support
- **Downstream**:
  - E01-F01-T05 (Parser Integration) - uses configured normalizer
- **External**:
  - PyYAML for YAML parsing

---

## 4. Acceptance Criteria

- [ ] YAML configuration file format defined and documented
- [ ] Configuration loader reads/writes YAML files
- [ ] Configuration stored in `{project}/.ink/net_classification.yaml`
- [ ] Qt dialog allows editing power/ground net names
- [ ] Qt dialog allows editing custom regex patterns
- [ ] Dialog accessible from menu (Edit > Net Classification...)
- [ ] Configuration loaded automatically when project opens
- [ ] NetNormalizer created from configuration
- [ ] Unit tests for configuration loading/saving
- [ ] UI tests for dialog functionality

---

## 5. UI Mockup

```
┌─────────────────────────────────────────────────────────────┐
│ Net Classification Settings                            [X] │
├─────────────────────────────────────────────────────────────┤
│ ┌─────────────┬──────────────┐                              │
│ │ Power Nets  │ Ground Nets  │                              │
│ └─────────────┴──────────────┘                              │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ Net Names (exact match, case-insensitive)               │ │
│ │ ┌─────────────────────────────────────────────────────┐ │ │
│ │ │ AVDD                                                │ │ │
│ │ │ DVDD                                                │ │ │
│ │ │ VDD_CORE                                            │ │ │
│ │ │ VDD_IO                                              │ │ │
│ │ └─────────────────────────────────────────────────────┘ │ │
│ │ [Add]  [Remove]  [Import from File...]                  │ │
│ └─────────────────────────────────────────────────────────┘ │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ Regex Patterns (additional)                             │ │
│ │ ┌─────────────────────────────────────────────────────┐ │ │
│ │ │ ^VDDQ[0-9]*$                                        │ │ │
│ │ │ ^PWR_.*$                                            │ │ │
│ │ └─────────────────────────────────────────────────────┘ │ │
│ │ [Add]  [Remove]                                         │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ [ ] Override default patterns (VDD*, VSS*, GND*, etc.)      │
│                                                             │
│                              [Cancel]  [OK]                 │
└─────────────────────────────────────────────────────────────┘
```

---

## Revision History

| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-12-27 | 0.1 | Claude | Initial spec creation |
