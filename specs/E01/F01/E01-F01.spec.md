# Spec: E01-F01 - CDL Parser

## Metadata
- **ID**: E01-F01
- **Type**: Feature
- **Priority**: P0 (MVP)
- **Status**: Draft
- **Parent**: [E01](../E01.spec.md)
- **Created**: 2025-12-26
- **Estimated Hours**:
- **Actual Hours**:
- **Effort**:
- **Tags**: []

---

## 1. Overview

### 1.1 Problem Statement
Engineers need to load gate-level CDL netlists into Ink for circuit analysis. CDL files use SPICE-like syntax with subcircuit definitions and cell instances. Without a robust parser, the application cannot extract the fundamental circuit structure (cells, nets, connections) required for visualization and exploration.

### 1.2 Goals
- Parse gate-level CDL (`.ckt`) netlist files with SPICE-like syntax
- Extract subcircuit definitions, cell instances, net connectivity, and port information
- Handle CDL format variations with error recovery
- Provide clear error messages for malformed input
- Support bus notation and power/ground net identification

---

## 2. User Stories

### US-E01-01: Load Netlist File
**As a** circuit designer
**I want to** load a gate-level CDL netlist file
**So that** I can begin exploring the circuit structure

**Acceptance Criteria:**
- [ ] Application accepts `.ckt` file path as input
- [ ] Parser handles `.SUBCKT` / `.ENDS` blocks for subcircuit definitions
- [ ] Parser extracts cell instances with `X` prefix
- [ ] Parser identifies power/ground nets (VDD, VSS)
- [ ] Comment lines starting with `*` are ignored
- [ ] Bus notation `<N>` is correctly parsed (e.g., `data<7>`)

---

## 3. Technical Requirements

### 3.1 CDL Syntax Support

The parser must handle the following CDL elements:

```python
# Subcircuit definitions
.SUBCKT cell_name pin1 pin2 ... pinN
.ENDS cell_name

# Cell instances (X prefix)
X<instance_name> net1 net2 ... netN cell_type

# Transistor lines (M prefix) - skip for gate-level
M<instance_name> ...

# Comments
* This is a comment

# Bus notation
net<0>, net<7>, data_bus<15>
```

### 3.2 Parser Architecture

**Location**: `src/ink/infrastructure/parsing/cdl_parser.py`

**Core Components**:
```python
class CDLParser:
    """Parser for gate-level CDL netlists"""

    def parse_file(self, file_path: Path) -> Design:
        """Parse CDL file and return Design aggregate"""
        pass

    def _parse_subcircuit_def(self, line: str) -> SubcircuitDefinition:
        """Parse .SUBCKT line"""
        pass

    def _parse_instance(self, line: str) -> CellInstance:
        """Parse X-prefixed instance line"""
        pass

    def _skip_transistor(self, line: str) -> bool:
        """Skip M-prefixed transistor lines"""
        pass

    def _normalize_net_name(self, net: str) -> str:
        """Normalize net names (handle bus notation)"""
        pass
```

### 3.3 Data Structures

**Subcircuit Definition**:
```python
@dataclass
class SubcircuitDefinition:
    name: str              # Cell type name
    ports: List[str]       # Ordered port names
```

**Cell Instance**:
```python
@dataclass
class CellInstance:
    name: str              # Instance name (e.g., "XI1")
    cell_type: str         # Cell type (e.g., "INV_X1")
    connections: Dict[str, str]  # Port -> Net mapping
```

### 3.4 Error Handling

- Graceful handling of malformed lines with clear error messages
- Line number reporting for syntax errors
- Partial loading support - continue parsing after recoverable errors
- Validation warnings for:
  - Unmatched `.SUBCKT` / `.ENDS` pairs
  - Unknown cell types
  - Missing net connections

### 3.5 Performance Requirements

- Parse 100K cell netlists in < 5 seconds
- Memory-efficient streaming for large files
- Progress reporting for long-running parses

---

## 4. Dependencies

- **Upstream**: None (reads raw `.ckt` files)
- **Downstream**:
  - E01-F03 (Graph Construction) - consumes parsed data
  - E01-F04 (Latch Identification) - requires cell type information

---

## 5. Acceptance Criteria

- [ ] Successfully parse sample CDL files from PRD Appendix A
- [ ] Handle `.SUBCKT` / `.ENDS` block nesting
- [ ] Extract all cell instances with correct net connectivity
- [ ] Identify power/ground nets (VDD, VSS)
- [ ] Support bus notation `<N>` parsing
- [ ] Ignore comment lines starting with `*`
- [ ] Skip transistor-level lines (M prefix) for gate-level parsing
- [ ] Provide clear error messages with line numbers for syntax errors
- [ ] Support partial loading - continue after recoverable errors
- [ ] Parse 100K cell netlist in < 5 seconds
- [ ] 90%+ test coverage on parser module

---

## 6. Child Specs
*To be created via `/spec_work E01-F01 --split tasks`*

| ID | Task | Status |
|----|------|--------|

---

## Revision History
| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-12-26 | 0.1 | Claude | Initial feature creation from E01 split |
