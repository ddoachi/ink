---
id: E01-F04-T01
title: Pattern Configuration for Sequential Cell Detection
type: Task
priority: P0 (MVP)
status: Completed
parent: E01-F04
created: 2025-12-26
completed: 2025-12-27
estimated_hours: 4
actual_hours: 2
effort: Small
tags:
  - configuration
  - domain-service
clickup_task_id: '86evzm2g0'
github_issue: 51
---

# Spec: E01-F04-T01 - Pattern Configuration for Sequential Cell Detection

## 1. Overview

### 1.1 Problem Statement
Sequential cell identification requires configurable pattern matching to support different cell libraries with varying naming conventions (e.g., `DFFR_X1`, `DFF_1`, `LATCH_V2`). Hard-coded patterns would limit portability and require code changes for each library.

### 1.2 Goals
- Define configurable pattern syntax for sequential cell detection
- Implement pattern storage and retrieval mechanism
- Provide default patterns for common sequential cell types
- Support case-insensitive glob-style wildcard matching
- Enable pattern updates without code modification

---

## 2. Technical Requirements

### 2.1 Pattern Format

**Glob-Style Wildcards**:
```python
DEFAULT_SEQUENTIAL_PATTERNS = [
    "*DFF*",      # Matches: DFFR_X1, SDFFR_X2, DFF_POS, etc.
    "*LATCH*",    # Matches: LATCH_X1, DLATCH_X2, etc.
    "*FF*",       # Matches: FF_X1, JKFF_X1, etc. (broader)
]
```

**Pattern Rules**:
- `*` matches any sequence of characters (including none)
- `?` matches any single character (optional support)
- Case-insensitive matching by default
- Patterns match against `cell_type` field (not cell name)

### 2.2 Configuration Storage

**Option 1: YAML Configuration File** (Recommended for MVP)
```yaml
# config/latch_patterns.yaml
latch_identification:
  patterns:
    - "*DFF*"
    - "*LATCH*"
    - "*FF*"
  case_sensitive: false
```

**Option 2: Application Settings** (P1 - future GUI)
```python
# QSettings storage for user-configurable patterns
settings = QSettings("Ink", "LatchPatterns")
settings.setValue("patterns", ["*DFF*", "*LATCH*"])
```

### 2.3 Configuration Loading

**Infrastructure Layer**: `src/ink/infrastructure/config/latch_config.py`

```python
from dataclasses import dataclass
from typing import List
import yaml
from pathlib import Path

@dataclass(frozen=True)
class LatchIdentificationConfig:
    """Configuration for sequential cell identification"""
    patterns: List[str]
    case_sensitive: bool = False

    @staticmethod
    def load_from_yaml(config_path: Path) -> "LatchIdentificationConfig":
        """Load configuration from YAML file"""
        with open(config_path) as f:
            data = yaml.safe_load(f)

        latch_config = data.get("latch_identification", {})
        return LatchIdentificationConfig(
            patterns=latch_config.get("patterns", DEFAULT_SEQUENTIAL_PATTERNS),
            case_sensitive=latch_config.get("case_sensitive", False)
        )

    @staticmethod
    def default() -> "LatchIdentificationConfig":
        """Return default configuration"""
        return LatchIdentificationConfig(
            patterns=DEFAULT_SEQUENTIAL_PATTERNS,
            case_sensitive=False
        )
```

### 2.4 File Locations

```
ink/
├── config/
│   └── latch_patterns.yaml          # Default pattern configuration
├── src/ink/infrastructure/config/
│   ├── __init__.py
│   └── latch_config.py               # Configuration loader
└── tests/unit/infrastructure/config/
    └── test_latch_config.py          # Configuration tests
```

### 2.5 Default Patterns

**Common Sequential Cell Naming Conventions**:

| Library | Example Cells | Pattern |
|---------|---------------|---------|
| Standard Cell (Generic) | `DFFR_X1`, `DFFR_X2`, `SDFFR_X1` | `*DFF*` |
| D Latches | `LATCH_X1`, `DLATCH_X2` | `*LATCH*` |
| Flip-Flops (Generic) | `FF_POS`, `FF_NEG` | `*FF*` |
| Scan Flip-Flops | `SDFF_X1`, `SCAN_DFF` | `*DFF*` (covered) |
| JK/SR Flip-Flops | `JKFF_X1`, `SRFF_X1` | `*FF*` (covered) |

**Default Pattern List**:
```python
DEFAULT_SEQUENTIAL_PATTERNS = [
    "*DFF*",      # Covers DFF, DFFR, SDFF, etc.
    "*LATCH*",    # Covers LATCH, DLATCH, etc.
    "*FF*",       # Broader fallback (includes JK, SR, generic FF)
]
```

---

## 3. Dependencies

- **Upstream**: None (configuration only)
- **Downstream**:
  - E01-F04-T02 (Latch Detector Service) - consumes configuration
  - E01-F04-T03 (Cell Tagging) - uses detector configured with patterns

---

## 4. Acceptance Criteria

- [x] `LatchIdentificationConfig` dataclass defined with `patterns` and `case_sensitive` fields
- [x] `DEFAULT_SEQUENTIAL_PATTERNS` constant defined with `*DFF*`, `*LATCH*`, `*FF*`
- [x] `load_from_yaml()` method loads patterns from YAML file
- [x] `default()` method returns default configuration
- [x] Configuration file `config/latch_patterns.yaml` created with default patterns
- [x] Invalid YAML file returns default configuration with warning log
- [x] Missing configuration file returns default configuration
- [x] 100% test coverage on configuration loading logic (26 tests)
- [x] Documentation of pattern format in configuration file comments

---

## 5. Implementation Notes

### 5.1 Error Handling
- Missing YAML file → return default configuration (log warning)
- Invalid YAML format → return default configuration (log error)
- Empty patterns list → use default patterns (log warning)

### 5.2 Future Extensions (P1+)
- GUI settings dialog for pattern editing
- Pattern validation (syntax checking)
- Per-library configuration profiles
- Regular expression support (in addition to glob)

---

## 6. Implementation Summary

### Deliverables Created

| File | Description |
|------|-------------|
| `src/ink/infrastructure/config/latch_config.py` | LatchIdentificationConfig dataclass with YAML loading |
| `config/latch_patterns.yaml` | Default configuration file with documented patterns |
| `tests/unit/infrastructure/config/test_latch_config.py` | 26 comprehensive unit tests |
| `src/ink/infrastructure/config/__init__.py` | Updated exports |

### Key Implementation Details

- **Frozen Dataclass**: Immutable configuration prevents accidental modification
- **Tuple Storage**: Patterns stored as tuple internally for immutability
- **Graceful Fallback**: All error cases return default configuration with logging
- **Comprehensive Error Handling**: Missing files, invalid YAML, empty patterns

### Test Coverage

- 26 unit tests covering all acceptance criteria
- Tests for: default patterns, dataclass structure, YAML loading, error handling, pattern formats

---

## Revision History
| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-12-26 | 0.1 | Claude | Initial task spec creation |
| 2025-12-27 | 1.0 | Claude | Implementation completed via TDD workflow |
