# Spec: E01 - Input Parsing & Data Model

## Metadata
- **ID**: E01
- **Type**: Epic
- **Priority**: P0 (MVP)
- **Status**: Draft
- **PRD Sections**: ยง3.1 Input, ยง3.2 Internal Data Model, ยง3.3 Latch Identification
- **Created**: 2025-12-26
- **Parent**: [PRD](../../docs/prd.md)

---

## 1. Overview

This epic covers the foundational data layer of Ink - parsing gate-level CDL netlists and constructing the internal graph representation that powers all schematic operations.

### 1.1 Problem Statement

Engineers need to analyze gate-level netlists containing hundreds of thousands of cells. Current tools either render the entire schematic (too slow) or provide text-only analysis (hard to visualize). Ink addresses this by building an efficient graph-based data model that enables incremental exploration.

### 1.2 Goals

- Parse gate-level CDL (`.ckt`) netlist files with SPICE-like syntax
- Parse pin direction files (`.pindir`) to determine input/output directions
- Build a NetworkX-based graph representation of the netlist
- Enable efficient graph queries for fanin/fanout traversal
- Identify sequential elements (latches, flip-flops) for semantic boundaries

---

## 2. User Stories

### US-E01-01: Load Netlist File
**As a** circuit designer
**I want to** load a gate-level CDL netlist file
**So that** I can begin exploring the circuit structure

**Acceptance Criteria:**
- [ ] Application accepts `.ckt` file path as input
- [ ] Parser handles `.SUBCKT` / `.ENDS` blocks for subcircuit definitions
- [ ] Parser extracts cell instances with `X` prefix
- [ ] Parser identifies power/ground nets (VDD, VSS)
- [ ] Comment lines starting with `*` are ignored
- [ ] Bus notation `<N>` is correctly parsed (e.g., `data<7>`)

### US-E01-02: Load Pin Direction File
**As a** circuit designer
**I want to** load a pin direction file
**So that** the tool knows which pins are inputs vs outputs

**Acceptance Criteria:**
- [ ] Application accepts `.pindir` file path
- [ ] Parser handles INPUT, OUTPUT, INOUT directions
- [ ] Pin directions apply globally to all cells by pin name matching
- [ ] Missing pin directions default to INOUT with warning

### US-E01-03: Query Cell Connectivity
**As a** circuit designer
**I want to** query which cells connect to a given net
**So that** I can trace signal paths through the design

**Acceptance Criteria:**
- [ ] API returns all cells connected to a specified net
- [ ] API returns all pins of a cell with their connected nets
- [ ] Query performance is O(1) or O(log n) for individual lookups

### US-E01-04: Identify Sequential Elements
**As a** circuit designer
**I want to** latches and flip-flops automatically identified
**So that** expansion can stop at sequential boundaries

**Acceptance Criteria:**
- [ ] Configurable naming patterns for latch detection (e.g., `*LATCH*`, `*DFF*`, `*FF*`)
- [ ] Sequential cells are tagged in the graph model
- [ ] API to query if a cell is a sequential element

---

## 3. Technical Requirements

### 3.1 CDL Parser

```python
# Core parsing capabilities
- Parse .SUBCKT name pin1 pin2 ... pinN
- Parse .ENDS name
- Parse X<instance> net1 net2 ... netN celltype
- Handle M prefix transistor lines (skip for gate-level)
- Support hierarchical comments with *
```

### 3.2 Data Model Classes

```python
@dataclass
class Cell:
    name: str           # Instance name (e.g., "XI1")
    cell_type: str      # Cell type (e.g., "INV_X1")
    pins: List[Pin]     # Connected pins
    is_sequential: bool # Latch/FF flag

@dataclass
class Pin:
    name: str           # Pin name (e.g., "A", "Y")
    direction: PinDirection  # INPUT, OUTPUT, INOUT
    net: Net            # Connected net

@dataclass
class Net:
    name: str           # Net name
    connected_pins: List[Pin]  # All pins on this net

@dataclass
class Port:
    name: str           # Top-level port name
    direction: PinDirection
    net: Net
```

### 3.3 Graph Representation

- **Nodes**: Cells, Pins, Ports
- **Edges**: Net connectivity (Pin-to-Pin through Net)
- **Library**: NetworkX (MVP), migrate to rustworkx for performance
- **Indexing**: Hash-based lookup by name for O(1) access

---

## 4. Dependencies

- **Upstream**: None (foundation epic)
- **Downstream**: E02 (Rendering), E03 (Expansion), E04 (Interaction), E05 (Search)

---

## 5. Risks & Mitigations

| Risk | Impact | Probability | Mitigation |
|------|--------|-------------|------------|
| Large netlist memory usage | High | Medium | Lazy loading, memory-mapped files |
| CDL syntax variations | Medium | High | Flexible parser with error recovery |
| NetworkX performance limits | Medium | Medium | Design for rustworkx migration |

---

## 6. Acceptance Criteria (Epic Level)

- [ ] Parse sample CDL files from Appendix A successfully
- [ ] Graph model represents all cells, pins, nets, ports
- [ ] Query performance: <10ms for single cell/net lookup
- [ ] Memory: <2GB for 100K cell netlist
- [ ] 90%+ test coverage on parser and graph modules

---

## 7. Child Specs

| ID | Feature | Status | Spec |
|----|---------|--------|------|
| E01-F01 | CDL Parser | Created | [E01-F01.spec.md](F01/E01-F01.spec.md) |
| E01-F02 | Pin Direction Parser | Created | [E01-F02.spec.md](F02/E01-F02.spec.md) |
| E01-F03 | Graph Construction | Created | [E01-F03.spec.md](F03/E01-F03.spec.md) |
| E01-F04 | Latch Identification | Created | [E01-F04.spec.md](F04/E01-F04.spec.md) |

---

## Revision History

| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-12-26 | 0.1 | Claude | Initial epic creation from PRD split |
