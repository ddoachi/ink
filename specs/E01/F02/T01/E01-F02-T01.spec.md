---
id: E01-F02-T01
title: Pin Direction File Parser
type: Task
priority: P0 (MVP)
status: Draft
parent: E01-F02
created: 2025-12-26
estimated_hours: 4
actual_hours:
effort: Medium
tags:
  - parsing
  - infrastructure
---

# Spec: E01-F02-T01 - Pin Direction File Parser

## 1. Overview

### 1.1 Problem Statement
Implement a parser for `.pindir` files that extracts pin direction information from a simple whitespace-separated text format. The parser must handle comment lines, validate direction values, and provide clear error reporting for syntax issues.

### 1.2 Goals
- Parse `.pindir` file format with whitespace-separated PIN_NAME and DIRECTION columns
- Handle comment lines (starting with `*`) and empty lines
- Validate direction values (INPUT, OUTPUT, INOUT) with case-insensitive matching
- Report parsing errors with line numbers for debugging
- Detect and warn on duplicate pin name definitions
- Return structured `PinDirectionMap` object with parsed data

---

## 2. Technical Requirements

### 2.1 File Format Specification

**Valid Format**:
```
* Pin direction file
* Format: PIN_NAME  DIRECTION
* Directions: INPUT, OUTPUT, INOUT

A       INPUT
B       INPUT
Y       OUTPUT
Q       OUTPUT
D       INPUT
CK      INPUT
RN      INPUT
SE      INPUT
SI      INPUT
ZN      OUTPUT
```

**Format Rules**:
- Lines starting with `*` are comments (ignored)
- Empty lines and whitespace-only lines are ignored
- Data lines: `<PIN_NAME> <WHITESPACE> <DIRECTION>`
- Whitespace: one or more spaces or tabs
- Direction values: `INPUT`, `OUTPUT`, `INOUT` (case-insensitive)
- Pin names: case-sensitive

### 2.2 Parser Implementation

**Location**: `src/ink/infrastructure/parsing/pindir_parser.py`

**Class Structure**:
```python
from dataclasses import dataclass
from pathlib import Path
from typing import Dict, Tuple
import logging

from ink.domain.value_objects.pin_direction import PinDirection


@dataclass
class PinDirectionMap:
    """Mapping of pin names to their directions"""
    directions: Dict[str, PinDirection]

    def get_direction(self, pin_name: str) -> PinDirection:
        """Get direction for pin name, default to INOUT if not found"""
        return self.directions.get(pin_name, PinDirection.INOUT)

    def has_pin(self, pin_name: str) -> bool:
        """Check if pin name exists in the mapping"""
        return pin_name in self.directions


class PinDirectionParseError(Exception):
    """Exception raised when pin direction file parsing fails"""
    pass


class PinDirectionParser:
    """Parser for pin direction files (.pindir format)"""

    def __init__(self):
        self.logger = logging.getLogger(__name__)

    def parse_file(self, file_path: Path) -> PinDirectionMap:
        """
        Parse .pindir file and return pin direction mapping.

        Args:
            file_path: Path to .pindir file

        Returns:
            PinDirectionMap with parsed pin directions

        Raises:
            FileNotFoundError: If file doesn't exist
            PinDirectionParseError: If parsing fails
        """
        if not file_path.exists():
            raise FileNotFoundError(f"Pin direction file not found: {file_path}")

        directions: Dict[str, PinDirection] = {}
        line_number = 0

        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                for line_number, line in enumerate(f, start=1):
                    # Skip empty lines and comments
                    stripped = line.strip()
                    if not stripped or stripped.startswith('*'):
                        continue

                    # Parse pin direction line
                    pin_name, direction = self._parse_line(stripped, line_number)

                    # Check for duplicates
                    if pin_name in directions:
                        self.logger.warning(
                            f"Duplicate pin definition '{pin_name}' at line {line_number}. "
                            f"Overwriting previous definition."
                        )

                    directions[pin_name] = direction

        except PinDirectionParseError:
            raise
        except Exception as e:
            raise PinDirectionParseError(
                f"Failed to parse pin direction file: {file_path}"
            ) from e

        self.logger.info(f"Parsed {len(directions)} pin directions from {file_path}")
        return PinDirectionMap(directions=directions)

    def _parse_line(self, line: str, line_number: int) -> Tuple[str, PinDirection]:
        """
        Parse a single pin direction line.

        Args:
            line: Stripped line content
            line_number: Line number for error reporting

        Returns:
            Tuple of (pin_name, direction)

        Raises:
            PinDirectionParseError: If line format is invalid
        """
        parts = line.split()

        if len(parts) != 2:
            raise PinDirectionParseError(
                f"Line {line_number}: Expected format 'PIN_NAME DIRECTION', got: {line}"
            )

        pin_name = parts[0]
        direction_str = parts[1]

        # Validate pin name is not empty
        if not pin_name:
            raise PinDirectionParseError(
                f"Line {line_number}: Pin name cannot be empty"
            )

        # Validate and convert direction
        direction = self._validate_direction(direction_str, line_number)

        return pin_name, direction

    def _validate_direction(self, direction_str: str, line_number: int) -> PinDirection:
        """
        Validate and convert direction string to PinDirection enum.

        Args:
            direction_str: Direction string from file
            line_number: Line number for error reporting

        Returns:
            PinDirection enum value

        Raises:
            PinDirectionParseError: If direction value is invalid
        """
        try:
            # Case-insensitive matching
            return PinDirection[direction_str.upper()]
        except KeyError:
            valid_directions = ', '.join([d.name for d in PinDirection])
            raise PinDirectionParseError(
                f"Line {line_number}: Invalid direction '{direction_str}'. "
                f"Valid values: {valid_directions}"
            )
```

### 2.3 PinDirection Value Object

**Location**: `src/ink/domain/value_objects/pin_direction.py`

```python
from enum import Enum


class PinDirection(Enum):
    """Pin direction types for circuit elements"""
    INPUT = "INPUT"
    OUTPUT = "OUTPUT"
    INOUT = "INOUT"  # Bidirectional or unknown

    def __str__(self) -> str:
        return self.value
```

### 2.4 Error Handling Requirements

- **FileNotFoundError**: Clear message with file path
- **PinDirectionParseError**: Line number and specific issue description
- **Duplicate warnings**: Log warning but continue with last definition
- **Invalid direction**: List valid directions in error message
- **Malformed line**: Show expected format in error message

### 2.5 Logging Requirements

- **Info level**: Number of pins parsed successfully
- **Warning level**: Duplicate pin definitions
- **Error level**: Parse failures with context

---

## 3. Dependencies

### 3.1 Upstream
- Domain value object: `PinDirection` enum (created in this task)

### 3.2 Downstream
- Task E01-F02-T02: Uses `PinDirectionMap` for direction lookup API
- Task E01-F02-T03: Uses `PinDirectionMap.get_direction()` for default handling

### 3.3 External Dependencies
- Python standard library: `pathlib`, `dataclasses`, `logging`, `enum`
- No third-party dependencies

---

## 4. Acceptance Criteria

### 4.1 Functional Requirements
- [ ] Successfully parse valid `.pindir` file format from PRD example
- [ ] Handle INPUT, OUTPUT, INOUT direction values
- [ ] Support case-insensitive direction matching (input, INPUT, Input all valid)
- [ ] Preserve case-sensitive pin names (A, a treated as different pins)
- [ ] Ignore comment lines starting with `*`
- [ ] Skip empty lines and whitespace-only lines
- [ ] Handle tabs and multiple spaces as whitespace separators

### 4.2 Error Handling
- [ ] Raise `FileNotFoundError` for missing files with clear message
- [ ] Raise `PinDirectionParseError` with line number for syntax errors
- [ ] Report invalid direction values with list of valid options
- [ ] Detect and warn on duplicate pin name definitions
- [ ] Handle malformed lines (wrong number of columns) with clear error

### 4.3 Performance
- [ ] Parse 1000-line `.pindir` file in < 100ms
- [ ] Memory usage scales linearly with number of unique pins

### 4.4 Testing
- [ ] Unit tests for `_parse_line()` with valid inputs
- [ ] Unit tests for `_validate_direction()` with case variations
- [ ] Error handling tests for each error condition
- [ ] Integration test parsing complete sample file
- [ ] Test duplicate pin handling with warning verification
- [ ] 90%+ code coverage on parser module

---

## 5. Implementation Notes

### 5.1 Design Decisions

**Why simple string splitting?**
- `.pindir` format is intentionally simple (whitespace-separated)
- No need for complex parsing library (regex, PLY, etc.)
- Performance: `str.split()` is fast for this use case

**Why case-insensitive direction matching?**
- Tolerates user input variations (INPUT vs input)
- Common in configuration files
- Pin names remain case-sensitive (domain-specific requirement)

**Why warn on duplicates instead of error?**
- Allows iterative development (users can override previous definitions)
- Last definition wins (predictable behavior)
- Warning provides visibility without blocking

### 5.2 Testing Strategy

**Unit Tests** (`tests/unit/infrastructure/parsing/test_pindir_parser.py`):
- Test each parsing method in isolation
- Mock file I/O for error conditions
- Verify error messages contain expected information

**Integration Tests** (`tests/integration/infrastructure/parsing/test_pindir_parser_integration.py`):
- Use actual `.pindir` files from `examples/` directory
- Test end-to-end parsing workflow
- Verify performance requirements

---

## Revision History
| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-12-26 | 0.1 | Claude | Initial task creation from E01-F02 split |
