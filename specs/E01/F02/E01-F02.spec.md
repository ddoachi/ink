# Spec: E01-F02 - Pin Direction Parser

## Metadata
- **ID**: E01-F02
- **Type**: Feature
- **Priority**: P0 (MVP)
- **Status**: Draft
- **Parent**: [E01](../E01.spec.md)
- **Created**: 2025-12-26

---

## 1. Overview

### 1.1 Problem Statement
CDL netlist files do not contain pin direction information (INPUT, OUTPUT, INOUT). This information is critical for proper signal flow visualization, layout algorithms (Sugiyama requires input/output distinction), and expansion logic (fanin vs fanout). Ink requires a separate pin direction file (`.pindir`) to augment the netlist data.

### 1.2 Goals
- Parse pin direction files (`.pindir`) with simple whitespace-separated format
- Map pin names to directions (INPUT, OUTPUT, INOUT)
- Apply pin directions globally to all cells by pin name matching
- Handle missing directions with configurable defaults and warnings
- Validate direction values and provide clear error messages

---

## 2. User Stories

### US-E01-02: Load Pin Direction File
**As a** circuit designer
**I want to** load a pin direction file
**So that** the tool knows which pins are inputs vs outputs

**Acceptance Criteria:**
- [ ] Application accepts `.pindir` file path
- [ ] Parser handles INPUT, OUTPUT, INOUT directions
- [ ] Pin directions apply globally to all cells by pin name matching
- [ ] Missing pin directions default to INOUT with warning

---

## 3. Technical Requirements

### 3.1 Pin Direction File Format

From PRD Appendix A:

```
* Pin direction file
* Format: PIN_NAME  DIRECTION
* Directions: INPUT, OUTPUT, INOUT

A       INPUT
B       INPUT
Y       OUTPUT
Q       OUTPUT
D       INPUT
CK      INPUT
RN      INPUT
SE      INPUT
SI      INPUT
ZN      OUTPUT
```

**Format Rules**:
- Whitespace-separated (spaces or tabs)
- Comment lines start with `*`
- Valid directions: `INPUT`, `OUTPUT`, `INOUT`
- Case-insensitive direction matching
- Applies globally by pin name matching

### 3.2 Parser Architecture

**Location**: `src/ink/infrastructure/parsing/pindir_parser.py`

**Core Components**:
```python
class PinDirectionParser:
    """Parser for pin direction files"""

    def parse_file(self, file_path: Path) -> PinDirectionMap:
        """Parse .pindir file and return pin direction mapping"""
        pass

    def _parse_line(self, line: str) -> Tuple[str, PinDirection]:
        """Parse single pin direction line"""
        pass

    def _validate_direction(self, direction_str: str) -> PinDirection:
        """Validate and convert direction string to enum"""
        pass
```

### 3.3 Data Structures

**PinDirection Enum** (Domain Value Object):
```python
from enum import Enum

class PinDirection(Enum):
    INPUT = "INPUT"
    OUTPUT = "OUTPUT"
    INOUT = "INOUT"
```

**PinDirectionMap**:
```python
@dataclass
class PinDirectionMap:
    directions: Dict[str, PinDirection]  # Pin name -> Direction

    def get_direction(self, pin_name: str) -> PinDirection:
        """Get direction for pin name, default to INOUT if not found"""
        return self.directions.get(pin_name, PinDirection.INOUT)
```

### 3.4 Global Pin Matching Strategy

Pin directions are applied **globally** to all cells:
- Pin name "A" maps to INPUT for all cells that have an "A" pin
- Pin name "Y" maps to OUTPUT for all cells that have a "Y" pin
- This approach works for standard cell libraries with consistent naming

### 3.5 Error Handling

- Clear error messages for invalid direction values
- Line number reporting for syntax errors
- Warning for missing pin directions with fallback to INOUT
- Validation warnings for:
  - Duplicate pin name definitions
  - Empty pin names
  - Invalid direction values

### 3.6 Performance Requirements

- Parse pin direction files in < 100ms (typically small files)
- O(1) lookup performance for pin direction queries

---

## 4. Dependencies

- **Upstream**: None (reads raw `.pindir` files)
- **Downstream**:
  - E01-F03 (Graph Construction) - applies directions to Pin entities
  - E02 (Schematic Rendering) - uses directions for symbol rendering
  - E03 (Incremental Expansion) - uses directions for fanin/fanout logic

---

## 5. Acceptance Criteria

- [ ] Successfully parse sample `.pindir` file format from PRD
- [ ] Handle INPUT, OUTPUT, INOUT direction values (case-insensitive)
- [ ] Ignore comment lines starting with `*`
- [ ] Skip empty lines and whitespace-only lines
- [ ] Default to INOUT for missing pin directions with warning
- [ ] Provide clear error messages for invalid direction values
- [ ] Report line numbers for syntax errors
- [ ] Detect and warn on duplicate pin definitions
- [ ] O(1) lookup performance for pin direction queries
- [ ] 90%+ test coverage on parser module

---

## 6. Child Specs
*To be created via `/spec_work E01-F02 --split tasks`*

| ID | Task | Status |
|----|------|--------|

---

## Revision History
| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-12-26 | 0.1 | Claude | Initial feature creation from E01 split |
