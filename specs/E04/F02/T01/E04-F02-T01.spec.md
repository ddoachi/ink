---
id: E04-F02-T01
title: PropertyPanel Widget
type: Task
priority: P0 (MVP)
status: Draft
parent: E04-F02
created: 2025-12-26
estimated_hours: 6
actual_hours:
effort: Medium
tags:
  - ui
  - presentation
  - pyside6
---

# Spec: E04-F02-T01 - PropertyPanel Widget

## 1. Overview

### 1.1 Problem Statement
Implement the PropertyPanel widget as a dockable Qt panel that displays object properties in a hierarchical, organized layout. The panel must provide a clear UI structure with sections for different property groups and support for copy-to-clipboard functionality.

### 1.2 Goals
- Create `PropertyPanel` as a `QDockWidget` that docks to the right side of the main window
- Design hierarchical layout with collapsible property groups (General, Pins, Connectivity)
- Implement copy-to-clipboard button for all displayed properties
- Support dynamic property display based on object type
- Provide "No object selected" placeholder when selection is empty
- Handle resizing and dock/undock operations gracefully

---

## 2. Technical Requirements

### 2.1 PropertyPanel Widget Structure

**Location**: `src/ink/presentation/panels/property_panel.py`

**Class Hierarchy**:
```python
from PySide6.QtWidgets import (
    QDockWidget, QWidget, QVBoxLayout, QHBoxLayout,
    QLabel, QPushButton, QScrollArea, QGroupBox, QFrame
)
from PySide6.QtCore import Signal, Qt
from PySide6.QtGui import QClipboard, QGuiApplication
from typing import Optional, Dict, List, Any
import logging


class PropertyPanel(QDockWidget):
    """
    Dockable property inspector panel for displaying object properties.

    Shows detailed properties for selected schematic objects including:
    - Cells: name, type, pins, connectivity
    - Pins: name, direction, parent, connected net
    - Nets: name, driver, fanout
    - Ports: name, direction, connection

    Supports multi-selection property display and copy-to-clipboard.
    """

    # Signal emitted when user requests navigation to a related object
    navigate_requested = Signal(str, str)  # (object_type, object_id)

    def __init__(self, parent: Optional[QWidget] = None):
        """Initialize the property panel"""
        super().__init__("Property Inspector", parent)
        self.logger = logging.getLogger(__name__)

        # Widget settings
        self.setAllowedAreas(Qt.DockWidgetArea.LeftDockWidgetArea |
                            Qt.DockWidgetArea.RightDockWidgetArea)
        self.setFeatures(QDockWidget.DockWidgetFeature.DockWidgetMovable |
                        QDockWidget.DockWidgetFeature.DockWidgetFloatable)

        # Build UI
        self._build_ui()

        # Show empty state initially
        self.show_empty_state()

    def _build_ui(self) -> None:
        """Build the property panel UI structure"""
        # Main container widget
        container = QWidget()
        self.setWidget(container)

        # Main layout
        main_layout = QVBoxLayout(container)
        main_layout.setContentsMargins(8, 8, 8, 8)
        main_layout.setSpacing(8)

        # Header with copy button
        header_layout = QHBoxLayout()
        self.header_label = QLabel("Property Inspector")
        self.header_label.setStyleSheet("font-weight: bold; font-size: 12pt;")

        self.copy_button = QPushButton("ðŸ“‹ Copy")
        self.copy_button.setToolTip("Copy all properties to clipboard")
        self.copy_button.clicked.connect(self._on_copy_clicked)
        self.copy_button.setEnabled(False)  # Disabled when no properties

        header_layout.addWidget(self.header_label)
        header_layout.addStretch()
        header_layout.addWidget(self.copy_button)
        main_layout.addLayout(header_layout)

        # Separator line
        separator = QFrame()
        separator.setFrameShape(QFrame.Shape.HLine)
        separator.setFrameShadow(QFrame.Shadow.Sunken)
        main_layout.addWidget(separator)

        # Scroll area for property content
        scroll_area = QScrollArea()
        scroll_area.setWidgetResizable(True)
        scroll_area.setFrameShape(QFrame.Shape.NoFrame)

        # Content widget inside scroll area
        self.content_widget = QWidget()
        self.content_layout = QVBoxLayout(self.content_widget)
        self.content_layout.setContentsMargins(0, 0, 0, 0)
        self.content_layout.setSpacing(12)
        self.content_layout.setAlignment(Qt.AlignmentFlag.AlignTop)

        scroll_area.setWidget(self.content_widget)
        main_layout.addWidget(scroll_area)

        # Store reference to property groups for later updates
        self.property_groups: Dict[str, QGroupBox] = {}
        self.current_properties: Dict[str, Any] = {}

    def show_empty_state(self) -> None:
        """Display empty state when no object is selected"""
        self._clear_content()

        empty_label = QLabel("No object selected")
        empty_label.setStyleSheet("color: gray; font-style: italic;")
        empty_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        self.content_layout.addWidget(empty_label)

        self.copy_button.setEnabled(False)
        self.header_label.setText("Property Inspector")

    def show_multi_selection_state(self, count: int, object_type: Optional[str] = None) -> None:
        """
        Display multi-selection state.

        Args:
            count: Number of selected objects
            object_type: Type if all objects are same type, None for mixed
        """
        self._clear_content()

        if object_type:
            label_text = f"{count} {object_type}s selected"
        else:
            label_text = f"{count} objects selected (mixed types)"

        multi_label = QLabel(label_text)
        multi_label.setStyleSheet("font-weight: bold;")
        self.content_layout.addWidget(multi_label)

        self.copy_button.setEnabled(False)
        self.header_label.setText("Property Inspector")

    def display_properties(
        self,
        object_type: str,
        object_name: str,
        properties: Dict[str, Dict[str, Any]]
    ) -> None:
        """
        Display properties organized into groups.

        Args:
            object_type: Type of object (Cell, Pin, Net, Port)
            object_name: Name of the selected object
            properties: Nested dict of property groups and their values
                        Example: {
                            "General": {"Name": "U_ALU_1", "Type": "NAND2_X1"},
                            "Pins": {"Inputs": ["A", "B"], "Outputs": ["Y"]}
                        }
        """
        self._clear_content()
        self.current_properties = properties

        # Update header
        self.header_label.setText(f"{object_type}: {object_name}")
        self.copy_button.setEnabled(True)

        # Create property groups
        for group_name, group_props in properties.items():
            group_box = self._create_property_group(group_name, group_props)
            self.property_groups[group_name] = group_box
            self.content_layout.addWidget(group_box)

        self.logger.debug(f"Displayed properties for {object_type} '{object_name}'")

    def _create_property_group(
        self,
        group_name: str,
        properties: Dict[str, Any]
    ) -> QGroupBox:
        """
        Create a collapsible property group box.

        Args:
            group_name: Name of the property group
            properties: Dict of property key-value pairs

        Returns:
            QGroupBox containing formatted properties
        """
        group_box = QGroupBox(group_name)
        group_box.setCheckable(True)
        group_box.setChecked(True)  # Expanded by default

        layout = QVBoxLayout()
        layout.setSpacing(4)
        layout.setContentsMargins(12, 8, 12, 8)

        for key, value in properties.items():
            prop_layout = QHBoxLayout()
            prop_layout.setSpacing(8)

            # Key label
            key_label = QLabel(f"{key}:")
            key_label.setStyleSheet("font-weight: bold;")
            key_label.setMinimumWidth(100)
            prop_layout.addWidget(key_label)

            # Value label
            value_str = self._format_value(value)
            value_label = QLabel(value_str)
            value_label.setWordWrap(True)
            value_label.setTextInteractionFlags(
                Qt.TextInteractionFlag.TextSelectableByMouse
            )
            prop_layout.addWidget(value_label, stretch=1)

            layout.addLayout(prop_layout)

        group_box.setLayout(layout)
        return group_box

    def _format_value(self, value: Any) -> str:
        """
        Format property value for display.

        Args:
            value: Property value (can be str, int, bool, list, etc.)

        Returns:
            Formatted string representation
        """
        if isinstance(value, bool):
            return "Yes" if value else "No"
        elif isinstance(value, list):
            if not value:
                return "(none)"
            return ", ".join(str(v) for v in value)
        elif value is None:
            return "(none)"
        else:
            return str(value)

    def _clear_content(self) -> None:
        """Clear all property content from the panel"""
        # Remove all widgets from content layout
        while self.content_layout.count():
            item = self.content_layout.takeAt(0)
            if item.widget():
                item.widget().deleteLater()

        self.property_groups.clear()
        self.current_properties.clear()

    def _on_copy_clicked(self) -> None:
        """Handle copy button click - copy all properties to clipboard"""
        if not self.current_properties:
            return

        # Format properties as plain text
        lines = [self.header_label.text(), "=" * 50]

        for group_name, group_props in self.current_properties.items():
            lines.append(f"\n{group_name}:")
            lines.append("-" * 30)
            for key, value in group_props.items():
                value_str = self._format_value(value)
                lines.append(f"  {key}: {value_str}")

        text = "\n".join(lines)

        # Copy to clipboard
        clipboard = QGuiApplication.clipboard()
        clipboard.setText(text)

        self.logger.info("Properties copied to clipboard")

        # Visual feedback (could add tooltip or status bar message)
        self.copy_button.setText("âœ“ Copied")
        QTimer.singleShot(2000, lambda: self.copy_button.setText("ðŸ“‹ Copy"))
```

### 2.2 Integration with Main Window

**Location**: `src/ink/presentation/main_window.py`

```python
# In MainWindow.__init__():
def _setup_panels(self) -> None:
    """Setup dockable panels"""
    # Property panel (right side)
    self.property_panel = PropertyPanel(self)
    self.addDockWidget(Qt.DockWidgetArea.RightDockWidgetArea, self.property_panel)
```

### 2.3 UI Layout Specifications

**Panel Dimensions**:
- Default width: 300px (when docked)
- Minimum width: 200px
- Maximum width: 600px
- Dock position: Right side by default

**Property Group Styling**:
- Collapsible `QGroupBox` with checkbox
- Bold group titles (12pt font)
- 12px spacing between groups
- 8px internal padding

**Property Row Layout**:
- Key label: Bold, left-aligned, 100px min width
- Value label: Regular, word-wrapped, selectable text
- 8px spacing between key and value
- 4px spacing between rows

**Empty State**:
- Centered gray italic text: "No object selected"
- Copy button disabled

### 2.4 Performance Requirements

- Panel initialization time: < 50ms
- Property display update: < 40ms (target from feature spec)
- Smooth resize/dock operations (60 FPS)
- Efficient widget reuse (avoid creating new widgets on every update)

---

## 3. Dependencies

### 3.1 Upstream
- PySide6 Qt framework
- Main window container (to dock into)

### 3.2 Downstream
- Task E04-F02-T02: Property formatters will provide formatted property data
- Task E04-F02-T03: Selection listener will trigger property updates
- Task E04-F02-T04: Multi-selection logic will use `show_multi_selection_state()`

### 3.3 External Dependencies
- PySide6 >= 6.5
- Python 3.10+ (for type hints)

---

## 4. Acceptance Criteria

### 4.1 Functional Requirements
- [ ] PropertyPanel inherits from `QDockWidget` and docks to right side
- [ ] Panel displays header with object type and name
- [ ] Copy button is present and functional
- [ ] Property groups are collapsible via `QGroupBox` checkboxes
- [ ] Empty state shows "No object selected" message
- [ ] Multi-selection state shows count and type information
- [ ] Property values are selectable for manual copying
- [ ] Panel supports dock/undock and floating modes

### 4.2 UI/UX Requirements
- [ ] Panel has minimum width of 200px, default 300px
- [ ] Property keys are bold, values are regular text
- [ ] Groups have 12px spacing between them
- [ ] Property rows have 4px vertical spacing
- [ ] Copy button shows visual feedback when clicked
- [ ] Long values wrap to multiple lines
- [ ] Panel is scrollable when content exceeds height

### 4.3 Performance
- [ ] Panel initialization completes in < 50ms
- [ ] Property display update completes in < 40ms
- [ ] Resize operations run at 60 FPS
- [ ] No memory leaks when switching between objects

### 4.4 Testing
- [ ] Unit tests for `_format_value()` with various types
- [ ] Unit tests for `_create_property_group()` layout
- [ ] Widget test for empty state display
- [ ] Widget test for property display with sample data
- [ ] Widget test for copy button functionality
- [ ] Widget test for multi-selection state
- [ ] 85%+ code coverage on PropertyPanel class

---

## 5. Implementation Notes

### 5.1 Design Decisions

**Why QDockWidget?**
- Native Qt support for docking/undocking
- Persistent dock state (can be saved to QSettings)
- Standard UI pattern in IDE-like applications
- Built-in resize handles and position management

**Why QGroupBox for property groups?**
- Built-in collapsible functionality via `setCheckable(True)`
- Clear visual hierarchy for grouped properties
- Standard Qt widget with good accessibility support
- Easy to style with Qt stylesheets

**Why separate content_widget with QScrollArea?**
- Handles overflow gracefully when many properties are shown
- Prevents panel from expanding beyond available space
- Maintains fixed header while scrolling content
- Standard pattern for scrollable content in docked panels

**Why disabled copy button in empty state?**
- Prevents confusion when there's nothing to copy
- Clear visual indicator that no properties are displayed
- Standard UI pattern for context-dependent actions

### 5.2 Testing Strategy

**Unit Tests** (`tests/unit/presentation/panels/test_property_panel.py`):
- Test `_format_value()` with bool, list, None, str, int
- Test `_create_property_group()` layout structure
- Test `_clear_content()` removes all widgets
- Mock clipboard for copy button tests

**Widget Tests** (`tests/ui/panels/test_property_panel_widget.py`):
- Test panel initialization and dock properties
- Test property display with sample data
- Test empty state and multi-selection state
- Test copy button interaction and clipboard content
- Test group box collapse/expand behavior
- Use `QTest` for simulating clicks and interactions

### 5.3 Future Enhancements (Out of Scope)
- Clickable links for cross-navigation (e.g., click net name to select net)
- Property editing capabilities (read-only for MVP)
- Search/filter within properties
- Customizable property group ordering
- Property history (previous/next navigation)

---

## Revision History
| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-12-26 | 0.1 | Claude | Initial task creation from E04-F02 split |
