# E04-F02-T01 - PropertyPanel Widget: Pre-Implementation Documentation

## Document Information

- **Task ID**: E04-F02-T01
- **Task Title**: PropertyPanel Widget - QDockWidget with property display
- **Document Type**: Pre-Implementation Planning
- **Created**: 2025-12-26
- **Status**: Planning
- **Estimated Hours**: 6
- **Parent Feature**: [E04-F02](../E04-F02.spec.md) - Property Panel

---

## 1. Overview

### 1.1 Problem Context

The PropertyPanel widget is the primary UI component for displaying object properties in Ink's schematic viewer. It must provide a clear, organized presentation of object attributes that updates instantly when selection changes. The panel needs to be flexible enough to display different property types (cells, pins, nets, ports) while maintaining a consistent layout and supporting user interactions like copy-to-clipboard.

### 1.2 Scope

**In Scope:**
- QDockWidget-based panel that docks to right side of main window
- Hierarchical layout with collapsible property groups
- Copy-to-clipboard functionality for all displayed properties
- Empty state, single-selection, and multi-selection display modes
- Scroll support for long property lists
- Resizing and dock/undock operations

**Out of Scope:**
- Property editing (read-only for MVP)
- Clickable property values for navigation (future)
- Property search/filtering within panel
- Custom property group ordering

### 1.3 Success Criteria

- Panel displays properties with update time < 40ms
- Clean separation between UI structure and data formatting
- Supports dynamic property groups without code duplication
- Graceful handling of resize and dock operations
- Intuitive empty state messaging

---

## 2. Implementation Approach

### 2.1 Widget Architecture

**Component Hierarchy:**
```
PropertyPanel (QDockWidget)
├── Container Widget
│   ├── Header Layout
│   │   ├── Title Label
│   │   └── Copy Button
│   ├── Separator Line
│   └── Scroll Area
│       └── Content Widget
│           └── Content Layout
│               ├── Property Group 1 (QGroupBox)
│               ├── Property Group 2 (QGroupBox)
│               └── Property Group N (QGroupBox)
```

**Key Design Choices:**
- Use `QDockWidget` for native Qt docking functionality
- Use `QGroupBox` with `setCheckable(True)` for collapsible groups
- Use `QScrollArea` to handle overflow gracefully
- Separate header (fixed) from scrollable content area

### 2.2 State Management

The panel has three distinct states:

1. **Empty State**: No selection
   - Display centered "No object selected" message
   - Disable copy button
   - Clear all property groups

2. **Single Selection State**: One object selected
   - Display object type and name in header
   - Show property groups with formatted values
   - Enable copy button

3. **Multi-Selection State**: Multiple objects selected
   - Display count and type (or "mixed types")
   - Show summary information
   - Disable copy button (no individual properties to copy)

**State Transitions:**
```python
def show_empty_state() -> None
def display_properties(object_type, object_name, properties) -> None
def show_multi_selection_state(count, object_type) -> None
```

### 2.3 Property Group Rendering

Each property group is a `QGroupBox` containing:
- Key-value pairs with bold labels and regular values
- Selectable text for manual copying
- Word-wrapping for long values
- Consistent spacing and alignment

**Dynamic Group Creation:**
- Groups are created from dictionary input
- No hardcoded property layouts
- Supports arbitrary number of groups
- Efficient widget reuse via `_clear_content()`

### 2.4 Copy Functionality

**Copy Button Behavior:**
- Aggregates all visible properties into plain text
- Formats as hierarchical structure with group headers
- Copies to system clipboard via `QGuiApplication.clipboard()`
- Shows visual feedback ("✓ Copied" for 2 seconds)
- Only enabled when properties are displayed

**Text Format:**
```
Cell: U_NAND_1
==================================================

General:
------------------------------
  Name: U_NAND_1
  Cell Type: NAND2_X1
  Sequential: No
  Pin Count: 3

Pins:
------------------------------
  Inputs: A, B
  Outputs: Y
```

---

## 3. Key Design Decisions

### 3.1 Why QDockWidget?

**Decision**: Use `QDockWidget` as base class

**Rationale:**
- Native Qt support for docking/undocking
- Built-in resize handles and drag-to-dock functionality
- Persistent dock state can be saved to QSettings
- Standard pattern in IDE-like applications
- Integrates seamlessly with Qt main window

**Alternatives Considered:**
- Custom floating widget: More control but reinventing Qt functionality
- Fixed panel in main layout: Less flexible, no user customization

### 3.2 Why QGroupBox for Property Groups?

**Decision**: Use `QGroupBox` with `setCheckable(True)` for collapsible sections

**Rationale:**
- Built-in collapse/expand functionality
- Clear visual hierarchy
- Standard Qt widget with accessibility support
- Easy to style with Qt stylesheets
- Minimal code for collapsible behavior

**Alternatives Considered:**
- Custom collapsible widget: More work, less standard
- Flat list: No organization for many properties
- Tree widget: Overkill for shallow hierarchy

### 3.3 Why Separate Content Widget with Scroll Area?

**Decision**: Use `QScrollArea` containing a separate content widget

**Rationale:**
- Handles property overflow gracefully
- Prevents panel from expanding beyond screen
- Maintains fixed header while scrolling content
- Standard pattern for scrollable panels
- Automatic scrollbar management

**Alternatives Considered:**
- Fixed height with manual scrollbar: More complex
- No scrolling: Unusable with many properties

### 3.4 Why Disabled Copy Button in Empty State?

**Decision**: Disable copy button when no properties displayed

**Rationale:**
- Clear visual indicator of panel state
- Prevents confusion about what would be copied
- Standard UI pattern for context-dependent actions
- Accessibility: Screen readers announce disabled state

**Alternative**: Hide button - Less clear that feature exists

---

## 4. Dependencies and Integration Points

### 4.1 Upstream Dependencies

**Qt Framework (PySide6):**
- `QDockWidget`: Base class for panel
- `QWidget`, `QVBoxLayout`, `QHBoxLayout`: Layout management
- `QLabel`, `QPushButton`: Basic widgets
- `QScrollArea`, `QGroupBox`, `QFrame`: Container widgets
- `QClipboard`, `QGuiApplication`: Clipboard access
- `Signal`, `Qt`: Qt core functionality

**Main Window Integration:**
- Panel must be added to main window via `addDockWidget()`
- Requires main window to have dock widget areas enabled
- Default position: `Qt.DockWidgetArea.RightDockWidgetArea`

### 4.2 Downstream Dependencies

**Task E04-F02-T02 (Property Formatters):**
- Provides `FormattedProperties` dataclass
- Supplies formatted property dictionaries
- Handles data transformation from domain to presentation

**Task E04-F02-T03 (Selection Listener):**
- Triggers panel updates via `display_properties()`
- Calls appropriate state methods based on selection
- Provides formatted data from formatter service

**Task E04-F02-T04 (Multi-Selection Summary):**
- Uses `show_multi_selection_state()` method
- May enhance with additional summary display

### 4.3 No External Library Dependencies

- Uses only Python standard library (logging, typing)
- No third-party UI libraries required
- Fully Qt-based implementation

---

## 5. Testing Strategy

### 5.1 Unit Tests

**File**: `tests/unit/presentation/panels/test_property_panel.py`

**Test Coverage:**

1. **Initialization Tests**
   - Panel creates with correct dock widget features
   - Initial state is empty
   - Copy button starts disabled
   - Widget hierarchy is correct

2. **Value Formatting Tests**
   - `_format_value()` handles boolean (True/False → Yes/No)
   - `_format_value()` handles lists (comma-separated)
   - `_format_value()` handles None (→ "(none)")
   - `_format_value()` handles empty list (→ "(none)")

3. **State Transition Tests**
   - `show_empty_state()` clears content and disables copy
   - `display_properties()` populates groups and enables copy
   - `show_multi_selection_state()` shows count message
   - Multiple state changes clean up properly

4. **Property Group Tests**
   - `_create_property_group()` creates correct layout
   - Group box is checkable (collapsible)
   - Property keys are bold
   - Property values are selectable

5. **Cleanup Tests**
   - `_clear_content()` removes all widgets
   - No memory leaks when switching states
   - Widget deletion is proper (deleteLater)

**Example Test:**
```python
def test_format_value_with_boolean():
    panel = PropertyPanel()
    assert panel._format_value(True) == "Yes"
    assert panel._format_value(False) == "No"

def test_format_value_with_list():
    panel = PropertyPanel()
    assert panel._format_value(["A", "B", "C"]) == "A, B, C"
    assert panel._format_value([]) == "(none)"

def test_display_properties_creates_groups():
    panel = PropertyPanel()
    properties = {
        "General": {"Name": "U1", "Type": "NAND2"},
        "Pins": {"Inputs": ["A", "B"], "Outputs": ["Y"]}
    }

    panel.display_properties("Cell", "U1", properties)

    assert len(panel.property_groups) == 2
    assert "General" in panel.property_groups
    assert "Pins" in panel.property_groups
    assert panel.copy_button.isEnabled()
```

### 5.2 Widget Tests

**File**: `tests/ui/panels/test_property_panel_widget.py`

**Test Coverage:**

1. **UI Layout Tests**
   - Panel docks to right side by default
   - Header contains title label and copy button
   - Scroll area is present and resizable
   - Minimum width is 200px

2. **Interaction Tests**
   - Copy button click copies to clipboard
   - Copy button shows visual feedback (text change)
   - Group box collapse/expand works
   - Text selection works for property values

3. **Visual State Tests**
   - Empty state shows centered message
   - Single selection shows correct header
   - Multi-selection shows count
   - Long property lists trigger scrollbar

**Example Widget Test:**
```python
def test_copy_button_copies_to_clipboard(qtbot):
    panel = PropertyPanel()
    qtbot.addWidget(panel)

    properties = {
        "General": {"Name": "U1", "Type": "NAND2"}
    }
    panel.display_properties("Cell", "U1", properties)

    # Click copy button
    qtbot.mouseClick(panel.copy_button, Qt.LeftButton)

    # Check clipboard content
    clipboard = QGuiApplication.clipboard()
    text = clipboard.text()

    assert "Cell: U1" in text
    assert "Name: U1" in text
    assert "Type: NAND2" in text
```

### 5.3 Performance Tests

**Benchmarks:**
- Panel initialization: < 50ms
- Property display with 5 groups: < 40ms
- Copy operation: < 10ms
- Resize operations: 60 FPS

### 5.4 Coverage Target

- **Unit tests**: 90%+ coverage on PropertyPanel class
- **Widget tests**: All user interactions covered
- **Edge cases**: Empty properties, None values, large property sets

---

## 6. Risks and Considerations

### 6.1 Technical Risks

| Risk | Impact | Probability | Mitigation |
|------|--------|-------------|------------|
| **Qt version compatibility issues** | Medium | Low | Use Qt 6.5+ features only, test on target platforms |
| **Memory leaks from widget deletion** | High | Medium | Use `deleteLater()`, test with repeated state changes |
| **Slow rendering with many groups** | Medium | Low | Limit property count, implement lazy loading if needed |
| **Copy button state sync issues** | Low | Medium | Strictly manage enabled state in all state methods |

### 6.2 UI/UX Risks

| Risk | Impact | Mitigation |
|------|--------|------------|
| **Property text too long for panel** | Medium | Word wrapping, scrolling, tooltip for full text |
| **Unclear collapsible group affordance** | Low | QGroupBox provides standard checkable UI |
| **Copy feedback not noticeable** | Low | Button text change + consider tooltip/status message |
| **Empty state too subtle** | Low | Centered, styled text with clear message |

### 6.3 Integration Risks

| Risk | Impact | Mitigation |
|------|--------|------------|
| **Main window doesn't support docking** | High | Verify main window setup early, coordinate with UI team |
| **Property format from T02 incompatible** | High | Define `FormattedProperties` contract clearly, share between tasks |
| **Selection updates too frequent** | Medium | Panel handles rapid updates, no debouncing needed for MVP |

### 6.4 Performance Considerations

**Potential Bottlenecks:**
- Creating many QLabel widgets for large property sets
- Layout recalculation on every update
- Clipboard text formatting for large property sets

**Optimization Strategies:**
- Widget reuse: Clear and repopulate instead of recreate
- Lazy layout: Don't layout invisible groups
- Incremental updates: Only update changed groups (P1)

---

## 7. Implementation Checklist

### 7.1 Core Implementation

- [ ] Create `PropertyPanel` class inheriting from `QDockWidget`
- [ ] Implement `_build_ui()` to construct widget hierarchy
- [ ] Implement `show_empty_state()` method
- [ ] Implement `display_properties()` method
- [ ] Implement `show_multi_selection_state()` method
- [ ] Implement `_create_property_group()` for group boxes
- [ ] Implement `_format_value()` for value formatting
- [ ] Implement `_clear_content()` for cleanup
- [ ] Implement `_on_copy_clicked()` for clipboard copy

### 7.2 Integration

- [ ] Add panel to main window's dock widget areas
- [ ] Set default dock position to right side
- [ ] Configure panel features (movable, floatable)
- [ ] Set minimum/maximum width constraints

### 7.3 Testing

- [ ] Write unit tests for value formatting
- [ ] Write unit tests for state transitions
- [ ] Write widget tests for UI interactions
- [ ] Write widget test for copy functionality
- [ ] Test panel resize and dock operations
- [ ] Test with empty, single, and multi-selection states

### 7.4 Documentation

- [ ] Add docstrings to all public methods
- [ ] Document expected property dictionary format
- [ ] Document state transition contract
- [ ] Add code comments for complex layouts

---

## 8. Open Questions

### 8.1 Resolved Questions

**Q**: Should property keys have minimum width?
**A**: Yes, 100px minimum for alignment

**Q**: Should groups be expanded by default?
**A**: Yes, all groups checked/expanded initially

**Q**: Should copy button be at top or bottom?
**A**: Top, in header next to title

### 8.2 Pending Questions

**Q**: Should panel remember collapsed state of groups?
**A**: Not for MVP, consider for P1 with QSettings persistence

**Q**: Should long values be truncated with "show more"?
**A**: No truncation for MVP, rely on word wrap and scrolling

**Q**: Should panel support theming/custom colors?
**A**: Not for MVP, use default Qt styling

---

## 9. References

### 9.1 Specifications

- [E04-F02 Feature Spec](../E04-F02.spec.md) - Property Panel feature
- [E04-F02-T01 Task Spec](./E04-F02-T01.spec.md) - This task specification

### 9.2 Qt Documentation

- [QDockWidget Class](https://doc.qt.io/qt-6/qdockwidget.html)
- [QGroupBox Class](https://doc.qt.io/qt-6/qgroupbox.html)
- [QScrollArea Class](https://doc.qt.io/qt-6/qscrollarea.html)
- [QClipboard Class](https://doc.qt.io/qt-6/qclipboard.html)

### 9.3 Design Patterns

- **Model-View-Controller**: Panel is View, receives formatted data from Controller
- **State Pattern**: Panel has distinct states (empty, single, multi)
- **Template Method**: `display_properties()` orchestrates group creation

---

**End of Pre-Implementation Documentation**
