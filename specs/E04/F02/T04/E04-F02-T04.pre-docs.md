# E04-F02-T04 - Multi-Selection Summary: Pre-Implementation Documentation

## Document Information

- **Task ID**: E04-F02-T04
- **Task Title**: Multi-Selection Summary - Aggregate info for multiple selections
- **Document Type**: Pre-Implementation Planning
- **Created**: 2025-12-26
- **Status**: Planning
- **Estimated Hours**: 3
- **Parent Feature**: [E04-F02](../E04-F02.spec.md) - Property Panel

---

## 1. Overview

### 1.1 Problem Context

When users select multiple objects simultaneously in the schematic viewer, the PropertyPanel cannot meaningfully display individual properties (since there are multiple objects with potentially different values). Instead, the panel should provide an informative summary that helps users understand what they have selected.

This task enhances the PropertyPanel and PropertyFormatterService to handle multi-selection scenarios by:
- Displaying the count of selected objects
- Showing the object type if all selections are the same type
- Indicating "mixed types" when different object types are selected
- Listing individual object names (with truncation for large selections)
- Providing clear visual distinction from single-selection view

### 1.2 Scope

**In Scope:**
- Enhanced `show_multi_selection_summary()` method in PropertyPanel
- `MultiSelectionSummary` dataclass in PropertyFormatterService
- `format_multi_selection_summary()` method in PropertyFormatterService
- Alphabetical sorting of object names
- Name list truncation for large selections (> 20 objects)
- Same-type vs. mixed-type detection and display
- Integration with PropertyPanelController

**Out of Scope:**
- Group-by-type statistics for mixed selections (P1 enhancement)
- Clickable object names for navigation (P1 enhancement)
- Common property display for same-type selections (P1)
- Configurable truncation limits (fixed at 20 for MVP)
- Copy-to-clipboard for name list (button disabled for multi-selection)

### 1.3 Success Criteria

- Multi-selection summary displays within < 50ms
- Clear visual distinction from single-selection view
- Accurate object counting and type detection
- Alphabetically sorted name list for easy scanning
- Graceful handling of large selections (100+ objects)
- Consistent UI behavior across all multi-selection scenarios

---

## 2. Implementation Approach

### 2.1 UI Enhancement (PropertyPanel)

**New Method: `show_multi_selection_summary()`**

Replaces the simpler `show_multi_selection_state()` with a more detailed summary view.

**Layout Structure:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Property Inspector            [ðŸ“‹]  â”‚  â† Header (copy disabled)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 5 Cells Selected                    â”‚  â† Prominent header label
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Selection Summary                   â”‚  â† QGroupBox
â”‚   Total: 5 object(s)                â”‚
â”‚   Type: Cell                        â”‚
â”‚                                     â”‚
â”‚ Selected Objects                    â”‚  â† QGroupBox
â”‚   â€¢ U_ALU_ADD_1                     â”‚  â† Bulleted list
â”‚   â€¢ U_ALU_ADD_2                     â”‚
â”‚   â€¢ U_MUX_0                         â”‚
â”‚   â€¢ U_MUX_1                         â”‚
â”‚   â€¢ U_REG_3                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key UI Elements:**
- Header label: Bold, 11pt, shows count and type
- Selection Summary: QGroupBox with count and type info
- Selected Objects: QGroupBox with bulleted name list
- Name labels: Selectable text, bullet prefix
- Truncation message: "... and N more" at end of list
- Disabled copy button (no individual properties)

### 2.2 Data Structure Enhancement (PropertyFormatterService)

**New Dataclass: `MultiSelectionSummary`**

```python
@dataclass
class MultiSelectionSummary:
    count: int                      # Total number of selected objects
    object_type: Optional[str]      # "Cell"/"Pin"/"Net"/"Port" or None
    object_names: List[str]         # Sorted, possibly truncated list
    is_truncated: bool              # True if names were truncated
    total_truncated: int            # Number of names not shown
```

**New Method: `format_multi_selection_summary()`**

```python
def format_multi_selection_summary(
    selected_ids: List[Any],
    max_names: int = 20
) -> MultiSelectionSummary:
    """
    Format multi-selection summary with name list.

    Args:
        selected_ids: List of object IDs (CellId, PinId, NetId, PortId)
        max_names: Maximum names to include before truncation

    Returns:
        MultiSelectionSummary with formatted data
    """
```

**Processing Steps:**
1. Count total objects
2. Detect if all same type (via `isinstance()` checks)
3. Extract names from object IDs
4. Sort names alphabetically
5. Truncate if exceeds max_names
6. Add "... and N more" suffix if truncated

### 2.3 Controller Integration

**PropertyPanelController Enhancement:**

Update `_handle_multi_selection()` to use the new formatter method and panel method:

```python
def _handle_multi_selection(self, object_ids: List[Any]) -> None:
    # Format multi-selection summary with name list
    summary = self.property_formatter.format_multi_selection_summary(
        selected_ids=object_ids,
        max_names=20
    )

    # Update panel with detailed summary
    self.property_panel.show_multi_selection_summary(
        count=summary.count,
        object_type=summary.object_type,
        object_names=summary.object_names
    )
```

### 2.4 Name Extraction Strategy

**From Object IDs:**
- Assume IDs have `.value` attribute containing string representation
- Fallback to `str(id)` if no `.value` attribute
- Handle potential edge cases (None, empty string)

**Sorting:**
- Alphabetical sort (case-sensitive for consistency)
- Standard Python `sorted()` function
- O(n log n) complexity, acceptable for typical counts

**Truncation:**
- If count > max_names:
  - Take first `max_names` items
  - Append "... and {remaining} more" as final item
  - Set `is_truncated = True`

---

## 3. Key Design Decisions

### 3.1 Why Show Object Names?

**Decision**: Include list of object names in multi-selection summary

**Rationale:**
- Provides context for what user selected
- Helps verify selection is correct
- Useful for confirming multi-select operations
- Enables manual copying of names if needed
- Standard pattern in multi-selection UIs

**Alternatives Considered:**
- Just show count: Less informative, harder to verify selection
- Show in status bar: Too limited space for list

### 3.2 Why Truncate at 20 Names?

**Decision**: Limit name list to 20 items with "... and N more" suffix

**Rationale:**
- Prevents UI overflow with large selections (100+ objects)
- 20 items typically fit on screen without scrolling
- Provides meaningful context without clutter
- Clear indication of total selection size
- Balance between information and usability

**Alternatives Considered:**
- No truncation: Can't fit on screen, poor UX
- Truncate at 10: May be too limited
- Scrollable list: More complex, less obvious at a glance

### 3.3 Why Alphabetical Sorting?

**Decision**: Sort object names alphabetically

**Rationale:**
- Predictable, consistent ordering
- Easy to scan for specific names
- No domain-specific ordering requirement
- Standard convention for name lists
- Minimal performance overhead

**Alternatives Considered:**
- Selection order: Not meaningful to users
- Type-then-name: More complex for mixed selections

### 3.4 Why Disable Copy Button?

**Decision**: Disable copy button for multi-selection

**Rationale:**
- No individual properties to copy
- Name list is simple enough to manually select/copy
- Prevents confusion about what would be copied
- Consistent with empty state behavior
- Could enable in P1 to copy name list

**Alternatives Considered:**
- Copy name list: Possible P1 enhancement
- Copy summary stats: Limited utility

### 3.5 Why MultiSelectionSummary Dataclass?

**Decision**: Create dedicated dataclass for multi-selection data

**Rationale:**
- Type-safe contract between formatter and UI
- Clear structure for summary data
- Easy to extend with additional fields (stats, etc.)
- Separates data structure from presentation logic
- Consistent with FormattedProperties pattern

**Alternatives Considered:**
- Raw tuple: No type safety or named fields
- Dictionary: Less structured, error-prone

---

## 4. Dependencies and Integration Points

### 4.1 Upstream Dependencies

**Task E04-F02-T01 (PropertyPanel):**
- Provides base `show_multi_selection_state()` method
- Will be enhanced with `show_multi_selection_summary()` method
- Provides `_clear_content()` and layout infrastructure

**Task E04-F02-T02 (PropertyFormatterService):**
- Provides base service structure
- Will be enhanced with `MultiSelectionSummary` dataclass
- Will be enhanced with `format_multi_selection_summary()` method
- Provides `_get_type_name()` utility method

**Task E04-F02-T03 (PropertyPanelController):**
- Calls formatter to get multi-selection summary
- Calls panel to display summary
- Handles multi-selection events from SelectionService

### 4.2 Downstream Dependencies

None - This is an enhancement to existing tasks, no new downstream dependencies.

### 4.3 External Dependencies

- PySide6 Qt widgets (QLabel, QGroupBox, QVBoxLayout)
- Python standard library (dataclasses, typing)
- No third-party libraries

---

## 5. Testing Strategy

### 5.1 Unit Tests (Formatter)

**File**: `tests/unit/application/services/test_property_formatter_service_multi.py`

**Test Coverage:**

1. **Same-Type Selection Tests**
   - Format 5 cells â†’ type="Cell", names sorted
   - Format 10 pins â†’ type="Pin", names sorted
   - Format 3 nets â†’ type="Net", names sorted

2. **Mixed-Type Selection Tests**
   - Format cells + nets â†’ type=None, mixed=True
   - Format cells + pins + nets â†’ type=None, mixed=True

3. **Truncation Tests**
   - Format 15 objects (< 20) â†’ not truncated
   - Format exactly 20 objects â†’ not truncated
   - Format 25 objects (> 20) â†’ truncated, "... and 5 more"
   - Format 100 objects â†’ truncated, "... and 80 more"

4. **Edge Cases**
   - Format 1 object (should use single-selection, but test anyway)
   - Format empty list (edge case)
   - Format objects with identical names (sorting stable)

**Example Test:**
```python
def test_format_multi_selection_summary_same_type():
    formatter = PropertyFormatterService()

    # Create 5 CellIds
    selected_ids = [
        CellId("U_MUX_1"),
        CellId("U_ALU_ADD_2"),
        CellId("U_ALU_ADD_1"),
        CellId("U_MUX_0"),
        CellId("U_REG_3"),
    ]

    summary = formatter.format_multi_selection_summary(
        selected_ids, max_names=20
    )

    assert summary.count == 5
    assert summary.object_type == "Cell"
    assert summary.is_truncated is False
    assert summary.total_truncated == 0
    # Verify alphabetical sorting
    assert summary.object_names == [
        "U_ALU_ADD_1",
        "U_ALU_ADD_2",
        "U_MUX_0",
        "U_MUX_1",
        "U_REG_3",
    ]

def test_format_multi_selection_summary_truncated():
    formatter = PropertyFormatterService()

    # Create 25 CellIds
    selected_ids = [CellId(f"U_CELL_{i:03d}") for i in range(25)]

    summary = formatter.format_multi_selection_summary(
        selected_ids, max_names=20
    )

    assert summary.count == 25
    assert summary.object_type == "Cell"
    assert summary.is_truncated is True
    assert summary.total_truncated == 5
    assert len(summary.object_names) == 21  # 20 names + truncation msg
    assert "... and 5 more" in summary.object_names[-1]
```

### 5.2 Widget Tests (PropertyPanel)

**File**: `tests/ui/panels/test_property_panel_multi_selection.py`

**Test Coverage:**

1. **UI Layout Tests**
   - `show_multi_selection_summary()` creates correct widgets
   - Header label shows count and type
   - Selection Summary group exists with correct labels
   - Selected Objects group exists with name list
   - Names have bullet prefixes
   - Copy button is disabled

2. **Visual State Tests**
   - Same-type header: "5 Cells Selected"
   - Mixed-type header: "8 Objects Selected (Mixed Types)"
   - Truncated list shows "... and N more"
   - Empty name list handled gracefully

3. **Interaction Tests**
   - Names are selectable for manual copying
   - Group boxes are collapsible (if enabled)
   - Panel scrolls if content exceeds height

**Example Widget Test:**
```python
def test_show_multi_selection_summary_same_type(qtbot):
    panel = PropertyPanel()
    qtbot.addWidget(panel)

    names = ["U_ALU_1", "U_ALU_2", "U_MUX_0"]

    panel.show_multi_selection_summary(
        count=3,
        object_type="Cell",
        object_names=names
    )

    # Verify header
    assert "3 Cells Selected" in panel.header_label.text()

    # Verify groups created
    assert len(panel.property_groups) == 2  # Summary + Objects

    # Verify copy button disabled
    assert not panel.copy_button.isEnabled()

def test_show_multi_selection_summary_truncated(qtbot):
    panel = PropertyPanel()
    qtbot.addWidget(panel)

    names = [f"U_CELL_{i:03d}" for i in range(20)]
    names.append("... and 30 more")

    panel.show_multi_selection_summary(
        count=50,
        object_type="Cell",
        object_names=names
    )

    # Verify truncation message in UI
    # (Would need to search through labels in Selected Objects group)
```

### 5.3 Integration Tests

**File**: `tests/integration/presentation/test_multi_selection_integration.py`

**Test Coverage:**
- End-to-end: SelectionChangedEvent â†’ Controller â†’ Formatter â†’ Panel
- Real PropertyPanel widget
- Mock SelectionService and DesignRepository
- Verify summary displayed correctly

### 5.4 Performance Tests

**Benchmarks:**
- Format 100 objects: < 10ms
- UI rendering: < 30ms
- Name sorting: < 5ms
- Total update time: < 50ms (within feature target)

### 5.5 Coverage Target

- **Formatter unit tests**: 90%+ coverage on multi-selection methods
- **Widget tests**: All UI states covered
- **Edge cases**: Empty, single (shouldn't happen), 20, 21, 100 objects

---

## 6. Risks and Considerations

### 6.1 Technical Risks

| Risk | Impact | Probability | Mitigation |
|------|--------|-------------|------------|
| **Large selections slow UI** | Medium | Low | Truncation at 20, test with 1000 objects |
| **Name extraction fails for some IDs** | Low | Medium | Fallback to `str(id)`, handle None |
| **Sorting large lists slow** | Low | Low | O(n log n) acceptable, test with 1000 names |
| **UI overflow with long names** | Medium | Low | Word wrap, scrolling, tooltip for full names |

### 6.2 UI/UX Risks

| Risk | Impact | Mitigation |
|------|--------|------------|
| **Truncation not obvious** | Low | Clear "... and N more" message |
| **Mixed selection confusing** | Low | Explicit "Mixed Types" label |
| **No copy button feedback** | Low | Disabled state is clear visual indicator |
| **Names not helpful without context** | Medium | Show type info, future: show object details on hover (P1) |

### 6.3 Performance Risks

| Risk | Impact | Mitigation |
|------|--------|------------|
| **Creating many QLabel widgets** | Low | Limited to 20 max, acceptable overhead |
| **Sorting on every selection** | Low | Fast enough for typical counts |
| **UI layout recalculation** | Low | Qt handles efficiently |

---

## 7. Implementation Checklist

### 7.1 PropertyFormatterService Enhancement

- [ ] Create `MultiSelectionSummary` dataclass
- [ ] Implement `format_multi_selection_summary()` method
- [ ] Implement type detection logic (same vs. mixed)
- [ ] Implement name extraction from object IDs
- [ ] Implement alphabetical sorting
- [ ] Implement truncation logic
- [ ] Add "... and N more" suffix when truncated

### 7.2 PropertyPanel Enhancement

- [ ] Implement `show_multi_selection_summary()` method
- [ ] Create header label with count and type
- [ ] Create Selection Summary QGroupBox
- [ ] Add count and type labels to summary
- [ ] Create Selected Objects QGroupBox
- [ ] Add name labels with bullet prefixes
- [ ] Make name labels selectable
- [ ] Handle truncation message display
- [ ] Disable copy button

### 7.3 PropertyPanelController Enhancement

- [ ] Update `_handle_multi_selection()` to use new formatter method
- [ ] Update `_handle_multi_selection()` to call new panel method
- [ ] Pass all required parameters (count, type, names)

### 7.4 Testing

- [ ] Unit tests for `format_multi_selection_summary()`
- [ ] Unit tests for same-type detection
- [ ] Unit tests for mixed-type detection
- [ ] Unit tests for truncation logic
- [ ] Unit tests for name sorting
- [ ] Widget tests for `show_multi_selection_summary()`
- [ ] Widget tests for UI layout and content
- [ ] Integration test for end-to-end flow
- [ ] Performance test with 100 objects

### 7.5 Documentation

- [ ] Docstring for `MultiSelectionSummary`
- [ ] Docstring for `format_multi_selection_summary()`
- [ ] Docstring for `show_multi_selection_summary()`
- [ ] Document truncation behavior
- [ ] Document name extraction assumptions

---

## 8. Open Questions

### 8.1 Resolved Questions

**Q**: Should we show statistics for mixed selections (e.g., "3 Cells, 2 Nets")?
**A**: Not for MVP. Simple "Mixed Types" indicator sufficient. Consider for P1.

**Q**: Should we enable copy button to copy name list?
**A**: Not for MVP. Names are selectable for manual copy. Consider for P1.

**Q**: Should truncation limit be configurable?
**A**: Not for MVP. Fixed at 20 items. Consider QSettings preference in P1.

**Q**: How to handle very long object names?
**A**: Word wrap in UI, rely on scrolling. Tooltip for full name (P1).

### 8.2 Pending Questions

**Q**: Should we highlight what type(s) are in mixed selection?
**A**: Defer to P1. Would require grouping by type in formatter.

**Q**: Should name list be clickable for navigation?
**A**: Defer to P1. Requires navigation system integration.

**Q**: Should we remember which groups are collapsed?
**A**: Defer to P1. Would require QSettings persistence.

---

## 9. References

### 9.1 Specifications

- [E04-F02 Feature Spec](../E04-F02.spec.md) - Property Panel feature
- [E04-F02-T04 Task Spec](./E04-F02-T04.spec.md) - This task specification
- [E04-F02-T01 Task Spec](../T01/E04-F02-T01.spec.md) - PropertyPanel Widget
- [E04-F02-T02 Task Spec](../T02/E04-F02-T02.spec.md) - Property Formatters

### 9.2 Design Patterns

- **Data Transfer Object (DTO)**: MultiSelectionSummary
- **Template Method**: Summary generation and display
- **Facade**: Simplified multi-selection interface

---

**End of Pre-Implementation Documentation**
