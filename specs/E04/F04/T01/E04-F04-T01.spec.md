---
id: E04-F04-T01
title: Shortcut Manager (Central Registry)
type: Task
priority: P0 (MVP)
status: Draft
parent: E04-F04
created: 2025-12-26
estimated_hours: 4
actual_hours:
effort: Medium
tags:
  - keyboard
  - infrastructure
clickup_task_id: ''
---

# Spec: E04-F04-T01 - Shortcut Manager (Central Registry)

## 1. Overview

### 1.1 Problem Statement

The application needs a centralized keyboard shortcut management system to register, enable/disable, and document shortcuts across all UI components. Without a central registry, shortcuts would be scattered across individual widgets, leading to conflicts, duplication, and maintenance difficulties.

### 1.2 Goals

- Create a central `ShortcutManager` class to register and manage all keyboard shortcuts
- Define a standard shortcut configuration with platform-aware key sequences
- Support multiple key sequences for the same action (e.g., `Delete` and `Backspace`)
- Provide shortcut enable/disable capability
- Enable programmatic access to shortcut text for UI display

---

## 2. Technical Requirements

### 2.1 Shortcut Manager Class

**Location**: `src/ink/presentation/shortcuts/shortcut_manager.py`

```python
from typing import Dict, List, Union, Callable
from PySide6.QtWidgets import QMainWindow
from PySide6.QtGui import QShortcut, QKeySequence
from PySide6.QtCore import Qt


class ShortcutManager:
    """Centralized keyboard shortcut management for the application"""

    def __init__(self, main_window: QMainWindow):
        """
        Initialize the shortcut manager.

        Args:
            main_window: The main application window where shortcuts are registered
        """
        self._window = main_window
        self._shortcuts: Dict[str, List[QShortcut]] = {}

    def register_shortcut(
        self,
        name: str,
        key_sequence: Union[QKeySequence, QKeySequence.StandardKey, List[Union[QKeySequence, QKeySequence.StandardKey]]],
        callback: Callable[[], None],
        context: Qt.ShortcutContext = Qt.ShortcutContext.WindowShortcut
    ) -> None:
        """
        Register a keyboard shortcut.

        Args:
            name: Unique identifier for the shortcut (e.g., "search", "undo")
            key_sequence: Key sequence(s) to trigger the action
            callback: Function to call when shortcut is activated
            context: Shortcut context (WindowShortcut, ApplicationShortcut, etc.)
        """
        sequences = [key_sequence] if not isinstance(key_sequence, list) else key_sequence
        shortcuts = []

        for seq in sequences:
            # Handle StandardKey enum
            if isinstance(seq, QKeySequence.StandardKey):
                shortcut = QShortcut(QKeySequence(seq), self._window)
            else:
                shortcut = QShortcut(seq, self._window)

            shortcut.setContext(context)
            shortcut.activated.connect(callback)
            shortcuts.append(shortcut)

        self._shortcuts[name] = shortcuts

    def enable_shortcut(self, name: str, enabled: bool = True) -> None:
        """
        Enable or disable a registered shortcut.

        Args:
            name: Shortcut identifier
            enabled: True to enable, False to disable
        """
        if name in self._shortcuts:
            for shortcut in self._shortcuts[name]:
                shortcut.setEnabled(enabled)

    def disable_shortcut(self, name: str) -> None:
        """
        Disable a registered shortcut.

        Args:
            name: Shortcut identifier
        """
        self.enable_shortcut(name, enabled=False)

    def get_shortcut_text(self, name: str) -> str:
        """
        Get human-readable shortcut text for UI display.

        Args:
            name: Shortcut identifier

        Returns:
            Formatted shortcut text (e.g., "Ctrl+F", "Delete, Backspace")
        """
        if name not in self._shortcuts:
            return ""

        sequences = [sc.key().toString() for sc in self._shortcuts[name]]
        return ", ".join(sequences)

    def get_all_shortcuts(self) -> Dict[str, str]:
        """
        Get all registered shortcuts as name-to-text mapping.

        Returns:
            Dictionary mapping shortcut names to formatted text
        """
        return {name: self.get_shortcut_text(name) for name in self._shortcuts}

    def unregister_shortcut(self, name: str) -> None:
        """
        Unregister and delete a shortcut.

        Args:
            name: Shortcut identifier
        """
        if name in self._shortcuts:
            for shortcut in self._shortcuts[name]:
                shortcut.setEnabled(False)
                shortcut.deleteLater()
            del self._shortcuts[name]
```

### 2.2 Shortcut Configuration

**Location**: `src/ink/presentation/shortcuts/shortcut_config.py`

```python
from PySide6.QtGui import QKeySequence
from PySide6.QtCore import Qt
from typing import Union, List

# Type alias for shortcut definitions
ShortcutDef = Union[QKeySequence, QKeySequence.StandardKey, List[Union[QKeySequence, QKeySequence.StandardKey]]]

# Global shortcut configuration
SHORTCUTS: dict[str, ShortcutDef] = {
    # Search and navigation
    "search": QKeySequence("Ctrl+F"),
    "navigate_forward": QKeySequence("Alt+Right"),
    "navigate_back": QKeySequence("Alt+Left"),

    # Undo/Redo
    "undo": QKeySequence.StandardKey.Undo,  # Ctrl+Z (platform-aware)
    "redo": QKeySequence.StandardKey.Redo,  # Ctrl+Shift+Z or Ctrl+Y

    # Selection
    "select_all": QKeySequence.StandardKey.SelectAll,  # Ctrl+A
    "deselect": QKeySequence(Qt.Key.Key_Escape),

    # Expansion/Collapse
    "collapse_selected": [
        QKeySequence.StandardKey.Delete,
        QKeySequence(Qt.Key.Key_Backspace)
    ],
    "expand_selected": QKeySequence(Qt.Key.Key_Return),

    # View controls
    "fit_selection": QKeySequence(Qt.Key.Key_Space),
    "fit_all": QKeySequence("Ctrl+0"),
    "zoom_in": [
        QKeySequence.StandardKey.ZoomIn,    # Ctrl+=
        QKeySequence(Qt.Key.Key_Plus)
    ],
    "zoom_out": [
        QKeySequence.StandardKey.ZoomOut,   # Ctrl+-
        QKeySequence(Qt.Key.Key_Minus)
    ],
    "zoom_100": QKeySequence("Ctrl+1"),

    # Pan (arrow keys)
    "pan_up": QKeySequence(Qt.Key.Key_Up),
    "pan_down": QKeySequence(Qt.Key.Key_Down),
    "pan_left": QKeySequence(Qt.Key.Key_Left),
    "pan_right": QKeySequence(Qt.Key.Key_Right),

    # File operations
    "open": QKeySequence.StandardKey.Open,       # Ctrl+O
    "save_session": QKeySequence.StandardKey.Save,  # Ctrl+S
    "quit": QKeySequence.StandardKey.Quit,       # Ctrl+Q

    # Copy
    "copy_properties": QKeySequence.StandardKey.Copy,  # Ctrl+C
}

# Shortcut descriptions for help dialog
SHORTCUT_DESCRIPTIONS: dict[str, str] = {
    "search": "Open search dialog",
    "navigate_forward": "Navigate forward in history",
    "navigate_back": "Navigate back in history",
    "undo": "Undo last action",
    "redo": "Redo last undone action",
    "select_all": "Select all visible objects",
    "deselect": "Clear selection",
    "collapse_selected": "Collapse selected objects",
    "expand_selected": "Expand selected cell/pin/net",
    "fit_selection": "Fit view to selection",
    "fit_all": "Fit view to all visible objects",
    "zoom_in": "Zoom in",
    "zoom_out": "Zoom out",
    "zoom_100": "Reset zoom to 100%",
    "pan_up": "Pan view up",
    "pan_down": "Pan view down",
    "pan_left": "Pan view left",
    "pan_right": "Pan view right",
    "open": "Open netlist file",
    "save_session": "Save current session",
    "quit": "Quit application",
    "copy_properties": "Copy properties to clipboard",
}

# Shortcut categories for help dialog
SHORTCUT_CATEGORIES = {
    "Navigation": ["search", "navigate_forward", "navigate_back"],
    "Editing": ["undo", "redo", "collapse_selected", "expand_selected"],
    "Selection": ["select_all", "deselect"],
    "View": ["fit_selection", "fit_all", "zoom_in", "zoom_out", "zoom_100", "pan_up", "pan_down", "pan_left", "pan_right"],
    "File": ["open", "save_session", "quit"],
    "Copy": ["copy_properties"],
}
```

### 2.3 Integration with Main Window

**Update**: `src/ink/presentation/main_window.py`

```python
from ink.presentation.shortcuts.shortcut_manager import ShortcutManager
from ink.presentation.shortcuts.shortcut_config import SHORTCUTS

class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        self.shortcut_manager = ShortcutManager(self)
        self._register_shortcuts()

    def _register_shortcuts(self) -> None:
        """Register all application shortcuts"""
        # Implementation will be done in subsequent tasks
        # This is just the framework for now
        pass
```

---

## 3. Dependencies

- **Upstream**:
  - PySide6 Qt framework
- **Downstream**:
  - E04-F04-T02 (Navigation Shortcuts - uses ShortcutManager)
  - E04-F04-T03 (Action Shortcuts - uses ShortcutManager)
  - E04-F04-T04 (Shortcut Configuration - extends ShortcutManager)

---

## 4. Acceptance Criteria

- [ ] `ShortcutManager` class created in `src/ink/presentation/shortcuts/shortcut_manager.py`
- [ ] `SHORTCUTS` configuration defined in `src/ink/presentation/shortcuts/shortcut_config.py`
- [ ] `SHORTCUT_DESCRIPTIONS` and `SHORTCUT_CATEGORIES` defined
- [ ] `ShortcutManager` supports registering single and multiple key sequences
- [ ] `ShortcutManager` supports enable/disable functionality
- [ ] `get_shortcut_text()` returns human-readable shortcut text
- [ ] `get_all_shortcuts()` returns complete mapping of shortcuts
- [ ] Platform-aware shortcuts use `QKeySequence.StandardKey`
- [ ] `ShortcutManager` initialized in `MainWindow`
- [ ] Unit tests verify shortcut registration and enable/disable
- [ ] Unit tests verify shortcut text formatting

---

## 5. Implementation Notes

### 5.1 Design Decisions

- **Centralized Configuration**: All shortcut definitions in one place for easy maintenance
- **Platform Awareness**: Use `QKeySequence.StandardKey` for Undo, Redo, Copy, etc.
- **Multiple Sequences**: Support multiple key bindings for same action (Delete/Backspace)
- **Context Scoping**: Default to `WindowShortcut` context to avoid global interference

### 5.2 Testing Strategy

```python
# tests/unit/presentation/shortcuts/test_shortcut_manager.py
def test_register_single_shortcut():
    # Test registering a single key sequence

def test_register_multiple_shortcuts():
    # Test registering multiple key sequences for same action

def test_enable_disable_shortcut():
    # Test enabling and disabling shortcuts

def test_get_shortcut_text():
    # Test shortcut text formatting

def test_standard_key_shortcuts():
    # Test platform-aware StandardKey shortcuts
```

### 5.3 Future Enhancements

- User-configurable shortcut customization (P1)
- Shortcut conflict detection
- Persistence of custom shortcuts to settings
- Import/export shortcut configurations

---

## 6. Testing Checklist

- [ ] Unit tests for `ShortcutManager.register_shortcut()`
- [ ] Unit tests for `ShortcutManager.enable_shortcut()`
- [ ] Unit tests for `ShortcutManager.get_shortcut_text()`
- [ ] Unit tests for multiple key sequences
- [ ] Unit tests for StandardKey shortcuts
- [ ] Manual test: Shortcuts registered without errors
- [ ] Manual test: Shortcut text formatted correctly

---

## Revision History

| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-12-26 | 0.1 | Claude | Initial task creation from E04-F04 auto-split |
