---
id: E04-F04-T03
title: Action Shortcuts
type: Task
priority: P0 (MVP)
status: Draft
parent: E04-F04
created: 2025-12-26
estimated_hours: 3
actual_hours:
effort: Small
tags:
  - keyboard
  - undo-redo
  - selection
  - expansion
---

# Spec: E04-F04-T03 - Action Shortcuts

## 1. Overview

### 1.1 Problem Statement

Users need keyboard shortcuts for editing and selection operations including undo/redo, expand/collapse, selection management, and file operations. These actions are frequently used during schematic exploration and benefit from quick keyboard access.

### 1.2 Goals

- Implement undo/redo shortcuts (`Ctrl+Z`, `Ctrl+Shift+Z`)
- Implement expand/collapse shortcuts (`Enter`, `Delete`, `Backspace`)
- Implement selection shortcuts (`Escape`, `Ctrl+A`)
- Implement file operation shortcuts (`Ctrl+O`, `Ctrl+S`, `Ctrl+Q`)
- Implement copy shortcut (`Ctrl+C` for property panel)
- Ensure shortcuts are registered via `ShortcutManager`

---

## 2. Technical Requirements

### 2.1 Undo/Redo Shortcuts

**Implementation in**: `src/ink/presentation/main_window.py`

```python
def _register_shortcuts(self) -> None:
    """Register all application shortcuts"""
    # Undo/Redo
    self.shortcut_manager.register_shortcut(
        "undo",
        SHORTCUTS["undo"],  # Ctrl+Z (platform-aware)
        self._on_undo
    )

    self.shortcut_manager.register_shortcut(
        "redo",
        SHORTCUTS["redo"],  # Ctrl+Shift+Z or Ctrl+Y (platform-aware)
        self._on_redo
    )

def _on_undo(self) -> None:
    """Handle undo shortcut"""
    if self.undo_stack.canUndo():
        self.undo_stack.undo()

def _on_redo(self) -> None:
    """Handle redo shortcut"""
    if self.undo_stack.canRedo():
        self.undo_stack.redo()
```

### 2.2 Expand/Collapse Shortcuts

**Implementation in**: `src/ink/presentation/main_window.py`

```python
def _register_shortcuts(self) -> None:
    # Expand/Collapse
    self.shortcut_manager.register_shortcut(
        "expand_selected",
        SHORTCUTS["expand_selected"],  # Enter
        self._on_expand_selected
    )

    self.shortcut_manager.register_shortcut(
        "collapse_selected",
        SHORTCUTS["collapse_selected"],  # [Delete, Backspace]
        self._on_collapse_selected
    )

def _on_expand_selected(self) -> None:
    """Handle Enter - expand selected cell/pin/net"""
    selected_items = self.canvas.scene().selectedItems()
    if not selected_items:
        return

    # Get first selected item
    item = selected_items[0]

    # Determine expansion target
    if isinstance(item, CellItem):
        self._expand_cell(item.cell)
    elif isinstance(item, PinItem):
        self._expand_pin(item.pin)
    elif isinstance(item, NetItem):
        self._expand_net(item.net)

def _on_collapse_selected(self) -> None:
    """Handle Delete/Backspace - collapse selected objects"""
    selected_items = self.canvas.scene().selectedItems()
    if not selected_items:
        return

    # Collect all cells to collapse
    cells_to_collapse = set()
    for item in selected_items:
        if isinstance(item, CellItem):
            cells_to_collapse.add(item.cell)

    if cells_to_collapse:
        self._collapse_cells(cells_to_collapse)
```

### 2.3 Selection Shortcuts

**Implementation in**: `src/ink/presentation/main_window.py`

```python
def _register_shortcuts(self) -> None:
    # Selection
    self.shortcut_manager.register_shortcut(
        "select_all",
        SHORTCUTS["select_all"],  # Ctrl+A
        self._on_select_all
    )

    self.shortcut_manager.register_shortcut(
        "deselect",
        SHORTCUTS["deselect"],  # Escape
        self._on_deselect
    )

def _on_select_all(self) -> None:
    """Handle Ctrl+A - select all visible objects"""
    scene = self.canvas.scene()
    for item in scene.items():
        if item.flags() & QGraphicsItem.ItemIsSelectable:
            item.setSelected(True)

def _on_deselect(self) -> None:
    """Handle Escape - clear selection"""
    self.canvas.scene().clearSelection()
```

### 2.4 File Operation Shortcuts

**Implementation in**: `src/ink/presentation/main_window.py`

```python
def _register_shortcuts(self) -> None:
    # File operations
    self.shortcut_manager.register_shortcut(
        "open",
        SHORTCUTS["open"],  # Ctrl+O
        self._on_open_file
    )

    self.shortcut_manager.register_shortcut(
        "save_session",
        SHORTCUTS["save_session"],  # Ctrl+S
        self._on_save_session
    )

    self.shortcut_manager.register_shortcut(
        "quit",
        SHORTCUTS["quit"],  # Ctrl+Q
        self._on_quit
    )

def _on_open_file(self) -> None:
    """Handle Ctrl+O - open file dialog"""
    file_path, _ = QFileDialog.getOpenFileName(
        self,
        "Open Netlist",
        "",
        "CDL Files (*.ckt *.cdl);;All Files (*)"
    )
    if file_path:
        self._load_netlist(file_path)

def _on_save_session(self) -> None:
    """Handle Ctrl+S - save current session"""
    # Implementation depends on session management feature
    # For now, show a message or placeholder
    if hasattr(self, 'session_manager'):
        self.session_manager.save_session()
    else:
        # Placeholder for MVP
        pass

def _on_quit(self) -> None:
    """Handle Ctrl+Q - quit application"""
    self.close()
```

### 2.5 Copy Properties Shortcut

**Implementation in**: `src/ink/presentation/main_window.py`

```python
def _register_shortcuts(self) -> None:
    # Copy
    self.shortcut_manager.register_shortcut(
        "copy_properties",
        SHORTCUTS["copy_properties"],  # Ctrl+C
        self._on_copy_properties
    )

def _on_copy_properties(self) -> None:
    """Handle Ctrl+C - copy property panel contents to clipboard"""
    if self.property_panel.isVisible():
        self.property_panel.copy_to_clipboard()
```

**Update**: `src/ink/presentation/panels/property_panel.py`

```python
from PySide6.QtWidgets import QApplication

def copy_to_clipboard(self) -> None:
    """Copy property panel contents to clipboard as formatted text"""
    properties = self._get_current_properties()
    if not properties:
        return

    # Format as key-value pairs
    text_lines = []
    for key, value in properties.items():
        text_lines.append(f"{key}: {value}")

    text = "\n".join(text_lines)
    QApplication.clipboard().setText(text)

def _get_current_properties(self) -> dict[str, str]:
    """Get current properties from the displayed object"""
    # Implementation depends on property panel structure
    # Return dict of property name to value
    pass
```

---

## 3. Dependencies

- **Upstream**:
  - E04-F04-T01 (Shortcut Manager - provides registration framework)
  - E04-F03 (Undo/Redo - undo stack exists)
  - E03 (Expansion - expand/collapse methods exist)
  - E04-F01 (Selection - selection management exists)
- **Downstream**:
  - None

---

## 4. Acceptance Criteria

- [ ] `Ctrl+Z` triggers undo action
- [ ] `Ctrl+Shift+Z` (or `Ctrl+Y` on Windows) triggers redo action
- [ ] Undo/redo only enabled when actions available
- [ ] `Enter` expands selected cell/pin/net
- [ ] `Delete` collapses selected cells
- [ ] `Backspace` collapses selected cells
- [ ] Expand/collapse only works when objects selected
- [ ] `Ctrl+A` selects all visible objects
- [ ] `Escape` clears current selection
- [ ] `Ctrl+O` opens file dialog
- [ ] `Ctrl+S` saves current session (or shows placeholder)
- [ ] `Ctrl+Q` quits application
- [ ] `Ctrl+C` copies property panel contents to clipboard
- [ ] Clipboard content is formatted as key-value pairs
- [ ] All shortcuts work in relevant contexts
- [ ] No conflicts with Qt default shortcuts

---

## 5. Implementation Notes

### 5.1 Design Decisions

- **Platform Awareness**: Use `QKeySequence.StandardKey` for Undo/Redo to handle platform differences
- **Multi-Key Support**: Both `Delete` and `Backspace` trigger collapse
- **Context-Aware**: Copy only works when property panel visible and has content
- **Selection Priority**: When multiple items selected, `Enter` expands first item
- **File Dialog**: Standard Qt file dialog for file operations

### 5.2 Testing Strategy

```python
# tests/unit/presentation/test_action_shortcuts.py
def test_undo_shortcut():
    # Test Ctrl+Z triggers undo

def test_redo_shortcut():
    # Test Ctrl+Shift+Z triggers redo

def test_expand_selected_shortcut():
    # Test Enter expands selected item

def test_collapse_selected_shortcut():
    # Test Delete/Backspace collapse selected cells

def test_select_all_shortcut():
    # Test Ctrl+A selects all items

def test_deselect_shortcut():
    # Test Escape clears selection

def test_copy_properties_shortcut():
    # Test Ctrl+C copies properties

def test_file_shortcuts():
    # Test Ctrl+O, Ctrl+S, Ctrl+Q
```

### 5.3 Edge Cases

- Undo/redo when stack empty: Shortcuts have no effect
- Expand when no selection: No action
- Collapse when no cells selected: No action
- Copy when property panel empty: No action
- `Ctrl+A` in empty scene: No action

### 5.4 Integration Points

- **Undo Stack**: Must be initialized in main window
- **Expansion Service**: Used by expand/collapse shortcuts
- **Property Panel**: Must implement `copy_to_clipboard()`
- **File Service**: Used by file operation shortcuts

---

## 6. Testing Checklist

- [ ] Unit test: Undo shortcut triggers undo
- [ ] Unit test: Redo shortcut triggers redo
- [ ] Unit test: Expand shortcut expands selected item
- [ ] Unit test: Collapse shortcuts collapse selected cells
- [ ] Unit test: Select all shortcut selects all items
- [ ] Unit test: Deselect shortcut clears selection
- [ ] Unit test: Copy shortcut copies properties
- [ ] Unit test: File shortcuts open dialogs
- [ ] Manual test: Undo/redo only enabled when available
- [ ] Manual test: Platform-specific redo key works (Ctrl+Y on Windows)
- [ ] Manual test: Both Delete and Backspace collapse
- [ ] Manual test: Copied properties format correctly

---

## Revision History

| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-12-26 | 0.1 | Claude | Initial task creation from E04-F04 auto-split |
