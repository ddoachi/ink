# E04-F04-T03 - Action Shortcuts: Pre-Implementation Documentation

## Document Information

- **Task ID**: E04-F04-T03
- **Task Title**: Action Shortcuts
- **Document Type**: Pre-Implementation Planning
- **Created**: 2025-12-26
- **Status**: Planning
- **Target Release**: MVP (P0)
- **Estimated Hours**: 3
- **Effort**: Small

---

## 1. Overview

### 1.1 Executive Summary

This task implements keyboard shortcuts for editing and manipulation actions including undo/redo, expand/collapse, selection management, and file operations. These are core workflow actions that benefit significantly from keyboard access, enabling users to work efficiently without constantly switching between keyboard and mouse.

Action shortcuts are essential for power users who perform repetitive operations during schematic exploration and analysis. Quick access to undo/redo enables confident experimentation, while expand/collapse shortcuts streamline the incremental exploration workflow.

### 1.2 Problem Context

During schematic analysis, users frequently need to:
- **Undo/Redo** exploration steps to backtrack or retry (`Ctrl+Z`, `Ctrl+Shift+Z`)
- **Expand** selected cells/nets to reveal connections (`Enter`)
- **Collapse** selected cells to simplify the view (`Delete`, `Backspace`)
- **Select/Deselect** objects for bulk operations (`Ctrl+A`, `Escape`)
- **Open/Save** files and sessions (`Ctrl+O`, `Ctrl+S`)
- **Copy** property information for documentation (`Ctrl+C`)

Without keyboard shortcuts, these operations require:
- Clicking toolbar buttons (slow, requires mouse)
- Using context menus (right-click + navigate)
- Mouse-only selection (imprecise for bulk operations)
- Menu navigation for file operations (multiple clicks)

This workflow friction slows down analysis and increases cognitive load, especially during iterative exploration where undo/redo and expand/collapse are used frequently.

### 1.3 Scope

**In Scope:**
- Undo/redo shortcuts (`Ctrl+Z`, `Ctrl+Shift+Z`/`Ctrl+Y`) with platform awareness
- Expand shortcut (`Enter`) for selected cell/pin/net
- Collapse shortcuts (`Delete`, `Backspace`) for selected cells
- Selection shortcuts (`Ctrl+A` select all, `Escape` clear selection)
- File operation shortcuts (`Ctrl+O`, `Ctrl+S`, `Ctrl+Q`)
- Copy properties shortcut (`Ctrl+C`) when property panel active
- Context-aware enable/disable based on application state

**Out of Scope (Future Work):**
- Redo variants (Ctrl+Shift+Z vs Ctrl+Y) customization
- Macro recording/playback
- Custom user-defined shortcuts
- Clipboard operations beyond property copying (paste, cut)
- Bulk expand/collapse with modifier keys (e.g., Shift+Enter for recursive)

---

## 2. Architecture Decisions

### 2.1 Undo/Redo Integration

#### Decision: Use QUndoStack for undo/redo state management

**Rationale:**
- Qt's `QUndoStack` is battle-tested and feature-complete
- Automatic enable/disable of undo/redo actions based on stack state
- Support for command pattern and macro commands
- Built-in signals for state changes
- This decision should align with E04-F03 (Undo/Redo feature)

**Design:**

```python
# src/ink/presentation/main_window.py
from PySide6.QtGui import QUndoStack

class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        self.undo_stack = QUndoStack(self)
        # ... other initialization

    def _register_shortcuts(self) -> None:
        # Undo/Redo
        self.shortcut_manager.register_shortcut(
            "undo",
            SHORTCUTS["undo"],  # QKeySequence.StandardKey.Undo
            self._on_undo
        )

        self.shortcut_manager.register_shortcut(
            "redo",
            SHORTCUTS["redo"],  # QKeySequence.StandardKey.Redo
            self._on_redo
        )

    def _on_undo(self) -> None:
        """Handle Ctrl+Z - undo last action."""
        if self.undo_stack.canUndo():
            self.undo_stack.undo()

    def _on_redo(self) -> None:
        """Handle Ctrl+Shift+Z or Ctrl+Y - redo last undone action."""
        if self.undo_stack.canRedo():
            self.undo_stack.redo()
```

**Platform Differences:**

| Platform | Undo | Redo |
|----------|------|------|
| Windows | Ctrl+Z | Ctrl+Y |
| Linux | Ctrl+Z | Ctrl+Shift+Z |
| macOS | Cmd+Z | Cmd+Shift+Z |

Qt's `QKeySequence.StandardKey.Redo` handles this automatically.

### 2.2 Expand/Collapse Logic

#### Decision: Implement expand/collapse handlers in MainWindow

**Rationale:**
- MainWindow has access to expansion service, canvas, and selection
- Centralizes expansion logic rather than distributing across components
- Easy to extend with different expansion modes (fanin/fanout/both)
- Clean separation between shortcut handling and domain logic

**Design:**

```python
def _on_expand_selected(self) -> None:
    """Handle Enter - expand selected cell/pin/net."""
    selected_items = self.canvas.scene().selectedItems()
    if not selected_items:
        return

    # Get first selected item (if multiple, expand first)
    item = selected_items[0]

    # Determine expansion target based on item type
    if isinstance(item, CellItem):
        self._expand_cell(item.cell)
    elif isinstance(item, PinItem):
        self._expand_pin(item.pin)
    elif isinstance(item, NetItem):
        self._expand_net(item.net)

def _expand_cell(self, cell: Cell) -> None:
    """Expand cell's fanout (application-specific logic)."""
    # Delegate to expansion service
    self.expansion_service.expand_fanout(cell, hops=1)

def _on_collapse_selected(self) -> None:
    """Handle Delete/Backspace - collapse selected cells."""
    selected_items = self.canvas.scene().selectedItems()
    if not selected_items:
        return

    # Collect all cells to collapse
    cells_to_collapse = set()
    for item in selected_items:
        if isinstance(item, CellItem):
            cells_to_collapse.add(item.cell)

    if cells_to_collapse:
        self._collapse_cells(cells_to_collapse)

def _collapse_cells(self, cells: set[Cell]) -> None:
    """Collapse multiple cells."""
    # Delegate to expansion service
    self.expansion_service.collapse_cells(cells)
```

**Alternatives Considered:**

1. **Canvas handles expand/collapse directly**
   - ❌ Violates separation of concerns (canvas is just rendering)
   - ❌ Tight coupling between view and domain logic

2. **Expansion service as Qt action target**
   - ✅ Clean separation
   - ❌ Service doesn't have access to selection state
   - ❌ Requires passing selection to service every time

3. **MainWindow as coordinator (chosen)**
   - ✅ Has access to all components (canvas, selection, service)
   - ✅ Clean delegation to services
   - ✅ Easy to test with mocks

### 2.3 Selection Shortcuts

#### Decision: Operate on QGraphicsScene selection directly

**Rationale:**
- `SchematicCanvas` wraps `QGraphicsScene` which manages selection
- `selectAll()` and `clearSelection()` are built-in Qt methods
- Simple, efficient, and leverages Qt's selection framework
- No need for custom selection manager for these operations

**Design:**

```python
def _on_select_all(self) -> None:
    """Handle Ctrl+A - select all visible objects."""
    scene = self.canvas.scene()
    for item in scene.items():
        if item.flags() & QGraphicsItem.ItemIsSelectable:
            item.setSelected(True)

def _on_deselect(self) -> None:
    """Handle Escape - clear selection."""
    self.canvas.scene().clearSelection()
```

**Note**: If E04-F01 (Selection) implements a custom `SelectionManager`, this code may need to delegate to that manager instead of directly manipulating `QGraphicsScene`.

### 2.4 Property Copying

#### Decision: Copy property panel contents as formatted text

**Rationale:**
- Users want to document object properties (for reports, tickets, etc.)
- Text format is universally pasteable (Excel, Word, text editors)
- Key-value format is human-readable
- Simple to implement, no complex serialization needed

**Design:**

```python
# src/ink/presentation/panels/property_panel.py
from PySide6.QtWidgets import QApplication

class PropertyPanel(QWidget):
    def copy_to_clipboard(self) -> None:
        """Copy property panel contents to clipboard as formatted text."""
        properties = self._get_current_properties()
        if not properties:
            return

        # Format as key-value pairs
        text_lines = []
        for key, value in properties.items():
            text_lines.append(f"{key}: {value}")

        text = "\n".join(text_lines)
        QApplication.clipboard().setText(text)

    def _get_current_properties(self) -> dict[str, str]:
        """Get current properties from displayed object."""
        # Implementation depends on property panel structure
        # Return dict of property name to value
        pass
```

**Output Format Example:**
```
Name: U1_AND2
Type: AND2_X1
Is Sequential: False
Pin Count: 3
Input Pins: A, B
Output Pins: Y
```

---

## 3. Implementation Approach

### 3.1 Development Phases

#### Phase 1: Undo/Redo Shortcuts (0.5 hour)

**Deliverables:**
- `QUndoStack` initialized in `MainWindow`
- Undo/redo shortcut handlers implemented
- Platform-aware `QKeySequence.StandardKey` usage
- Context-aware enable/disable (optional, may be automatic with Qt)

**Implementation Steps:**
1. Add `self.undo_stack = QUndoStack(self)` to `MainWindow.__init__()`
2. Register undo shortcut with `QKeySequence.StandardKey.Undo`
3. Register redo shortcut with `QKeySequence.StandardKey.Redo`
4. Implement `_on_undo()` and `_on_redo()` handlers
5. Test on target platform (Linux)

**Key Code Sections:**

```python
def __init__(self):
    super().__init__()
    self.undo_stack = QUndoStack(self)
    # Connect to enable/disable actions (optional, for menu items)
    self.undo_stack.canUndoChanged.connect(self._update_undo_action_state)
    self.undo_stack.canRedoChanged.connect(self._update_redo_action_state)
```

#### Phase 2: Expand/Collapse Shortcuts (1 hour)

**Deliverables:**
- Expand shortcut (`Enter`) implemented
- Collapse shortcuts (`Delete`, `Backspace`) implemented
- Type-based expansion logic (cell vs pin vs net)
- Multi-select collapse support

**Implementation Steps:**
1. Register `expand_selected` shortcut (Enter key)
2. Register `collapse_selected` shortcut (Delete + Backspace keys)
3. Implement `_on_expand_selected()` with type checking
4. Implement `_on_collapse_selected()` with multi-select support
5. Stub expansion service methods if not yet implemented
6. Test with different object types

**Key Design Decision: Multi-Select Behavior**

For expand:
- If multiple objects selected, expand the **first** one
- Rationale: Expanding all could be overwhelming, unclear what user wants

For collapse:
- Collapse **all selected cells**
- Rationale: Batch collapse is useful for cleanup, clear intent

#### Phase 3: Selection Shortcuts (0.5 hour)

**Deliverables:**
- Select all shortcut (`Ctrl+A`) implemented
- Deselect shortcut (`Escape`) implemented
- Only selectable items selected (respect `ItemIsSelectable` flag)

**Implementation Steps:**
1. Register `select_all` shortcut
2. Register `deselect` shortcut
3. Implement handlers using `QGraphicsScene` API
4. Test with scenes containing selectable and non-selectable items

#### Phase 4: File and Copy Shortcuts (1 hour)

**Deliverables:**
- Open file shortcut (`Ctrl+O`) implemented
- Save session shortcut (`Ctrl+S`) implemented (or placeholder)
- Quit shortcut (`Ctrl+Q`) implemented
- Copy properties shortcut (`Ctrl+C`) implemented
- Property panel `copy_to_clipboard()` method

**Implementation Steps:**
1. Register file operation shortcuts
2. Implement `_on_open_file()` with Qt file dialog
3. Implement `_on_save_session()` (may be stub for MVP)
4. Implement `_on_quit()` (calls `self.close()`)
5. Implement `PropertyPanel.copy_to_clipboard()`
6. Register copy shortcut
7. Test clipboard contents

**Key Code Sections:**

```python
def _on_open_file(self) -> None:
    """Handle Ctrl+O - open netlist file."""
    file_path, _ = QFileDialog.getOpenFileName(
        self,
        "Open Netlist",
        "",
        "CDL Files (*.ckt *.cdl);;All Files (*)"
    )
    if file_path:
        self._load_netlist(file_path)

def _on_save_session(self) -> None:
    """Handle Ctrl+S - save current session."""
    # May be stub if session management not implemented
    if hasattr(self, 'session_manager'):
        self.session_manager.save_session()
    else:
        # Placeholder or show "not implemented" message
        pass
```

### 3.2 Key Design Decisions

**1. Undo/Redo Stack Limits**

Decision: Use Qt default (no limit for MVP)

**Rationale:**
- Modern systems have sufficient memory
- Users may need deep undo history for complex exploration
- Can add limit later if memory becomes an issue
- Qt manages memory efficiently

**2. Expand Priority (Multi-Select)**

Decision: Expand first selected item only

**Rationale:**
- Expanding all could create massive schematic
- User intent unclear with multi-select expand
- Can add "expand all" with modifier key in P1 (Shift+Enter)

**3. Collapse Behavior (Multi-Select)**

Decision: Collapse all selected cells

**Rationale:**
- Clear intent: "I want to remove these cells"
- Useful for bulk cleanup
- Consistent with other graphics applications

**4. Copy Shortcut Scope**

Decision: Copy property panel when panel visible

**Rationale:**
- `Ctrl+C` is standard for copy
- Context-aware: only works when property panel has content
- Different from "copy object" which isn't in MVP scope

### 3.3 Integration Points

**With E04-F04-T01 (Shortcut Manager):**
- Uses `ShortcutManager.register_shortcut()` for all shortcuts
- Uses `SHORTCUTS` config for key sequences
- Multiple shortcuts for collapse (Delete + Backspace)

**With E04-F03 (Undo/Redo):**
- Assumes `QUndoStack` is used for undo/redo
- Shortcuts trigger undo/redo operations
- May need to coordinate on stack initialization

**With E03 (Expansion):**
- Assumes expansion service exists with methods:
  - `expand_fanout(cell, hops)`
  - `expand_fanin(cell, hops)`
  - `expand_net(net)`
  - `collapse_cells(cells)`
- If not implemented, stub these methods

**With E04-F01 (Selection):**
- Uses `QGraphicsScene` selection API
- May need to adapt if custom `SelectionManager` exists
- Property panel assumes selection state is available

**With E05 (Search):**
- Copy shortcut may be used with search results
- No direct dependency

---

## 4. Testing Strategy

### 4.1 Unit Tests

**Test Coverage Target**: >85%

**Key Test Cases:**

```python
# tests/unit/presentation/test_action_shortcuts.py
from PySide6.QtGui import QUndoStack, QUndoCommand
from PySide6.QtWidgets import QGraphicsRectItem
import pytest

class TestActionShortcuts:
    @pytest.fixture
    def main_window(self, qtbot):
        window = MainWindow()
        qtbot.addWidget(window)
        return window

    def test_undo_shortcut_when_stack_empty(self, main_window):
        """Test undo shortcut does nothing when stack empty."""
        # Ensure stack is empty
        assert not main_window.undo_stack.canUndo()

        # Trigger undo (should not crash)
        main_window._on_undo()

        # Stack still empty
        assert not main_window.undo_stack.canUndo()

    def test_undo_shortcut_triggers_undo(self, main_window):
        """Test undo shortcut triggers undo operation."""
        # Push a dummy command
        class DummyCommand(QUndoCommand):
            def __init__(self):
                super().__init__("Dummy")
                self.undone = False

            def undo(self):
                self.undone = True

        cmd = DummyCommand()
        main_window.undo_stack.push(cmd)

        # Trigger undo
        main_window._on_undo()

        # Command should have been undone
        assert cmd.undone

    def test_expand_selected_with_no_selection(self, main_window):
        """Test expand shortcut does nothing when no selection."""
        # Clear selection
        main_window.canvas.scene().clearSelection()

        # Should not crash
        main_window._on_expand_selected()

    def test_expand_selected_expands_cell(self, main_window, mocker):
        """Test expand shortcut expands selected cell."""
        # Mock expansion service
        mock_expand = mocker.patch.object(main_window, '_expand_cell')

        # Create and select a cell item
        cell_item = CellItem(create_test_cell("U1"))
        main_window.canvas.scene().addItem(cell_item)
        cell_item.setSelected(True)

        # Trigger expand
        main_window._on_expand_selected()

        # Expand should have been called
        mock_expand.assert_called_once()

    def test_collapse_selected_with_multiple_cells(self, main_window, mocker):
        """Test collapse shortcut collapses all selected cells."""
        # Mock collapse service
        mock_collapse = mocker.patch.object(main_window, '_collapse_cells')

        # Create and select multiple cell items
        cells = [create_test_cell(f"U{i}") for i in range(3)]
        cell_items = [CellItem(cell) for cell in cells]
        for item in cell_items:
            main_window.canvas.scene().addItem(item)
            item.setSelected(True)

        # Trigger collapse
        main_window._on_collapse_selected()

        # Collapse should have been called with all cells
        mock_collapse.assert_called_once()
        called_cells = mock_collapse.call_args[0][0]
        assert len(called_cells) == 3

    def test_select_all_selects_all_items(self, main_window):
        """Test Ctrl+A selects all selectable items."""
        # Add some items
        for i in range(5):
            item = QGraphicsRectItem(i * 100, 0, 50, 50)
            item.setFlag(QGraphicsItem.ItemIsSelectable)
            main_window.canvas.scene().addItem(item)

        # Clear selection
        main_window.canvas.scene().clearSelection()

        # Trigger select all
        main_window._on_select_all()

        # All items should be selected
        selected = main_window.canvas.scene().selectedItems()
        assert len(selected) == 5

    def test_deselect_clears_selection(self, main_window):
        """Test Escape clears selection."""
        # Add and select items
        for i in range(3):
            item = QGraphicsRectItem(i * 100, 0, 50, 50)
            item.setFlag(QGraphicsItem.ItemIsSelectable)
            item.setSelected(True)
            main_window.canvas.scene().addItem(item)

        assert len(main_window.canvas.scene().selectedItems()) == 3

        # Trigger deselect
        main_window._on_deselect()

        # Selection should be empty
        assert len(main_window.canvas.scene().selectedItems()) == 0

    def test_copy_properties_copies_to_clipboard(self, main_window, qtbot):
        """Test Ctrl+C copies property panel to clipboard."""
        from PySide6.QtWidgets import QApplication

        # Set up property panel with test data
        test_properties = {
            "Name": "U1",
            "Type": "AND2_X1",
            "Pin Count": "3"
        }
        main_window.property_panel._current_properties = test_properties

        # Trigger copy
        main_window._on_copy_properties()

        # Check clipboard
        clipboard_text = QApplication.clipboard().text()
        assert "Name: U1" in clipboard_text
        assert "Type: AND2_X1" in clipboard_text
        assert "Pin Count: 3" in clipboard_text
```

### 4.2 Integration Tests

**Test Scenarios:**

```python
# tests/integration/presentation/test_action_shortcuts_integration.py
from PySide6.QtCore import Qt
from PySide6.QtTest import QTest

class TestActionShortcutsIntegration:
    def test_ctrl_z_triggers_undo(self, main_window, qtbot):
        """Test Ctrl+Z keyboard shortcut triggers undo."""
        # Set up undo stack with command
        # ... setup

        # Press Ctrl+Z
        QTest.keyClick(main_window, Qt.Key.Key_Z, Qt.KeyboardModifier.ControlModifier)

        # Verify undo was triggered
        # ... assertions

    def test_delete_key_collapses_selected(self, main_window, qtbot):
        """Test Delete key collapses selected cells."""
        # Select cells
        # ... setup

        initial_count = len(main_window.canvas.scene().items())

        # Press Delete
        QTest.keyClick(main_window, Qt.Key.Key_Delete)

        # Cells should be collapsed
        # ... assertions

    def test_enter_expands_selected(self, main_window, qtbot):
        """Test Enter expands selected cell."""
        # Select cell
        # ... setup

        # Press Enter
        QTest.keyClick(main_window, Qt.Key.Key_Return)

        # Expansion should have occurred
        # ... assertions
```

### 4.3 Manual Testing Checklist

- [ ] `Ctrl+Z` undoes last action (when undo available)
- [ ] `Ctrl+Z` does nothing when undo stack empty
- [ ] `Ctrl+Shift+Z` redoes last action (Linux/macOS)
- [ ] `Ctrl+Y` redoes last action (Windows, if applicable)
- [ ] Undo/redo work correctly after multiple operations
- [ ] `Enter` expands selected cell
- [ ] `Enter` expands selected pin
- [ ] `Enter` expands selected net
- [ ] `Enter` does nothing when no selection
- [ ] `Delete` collapses selected cells
- [ ] `Backspace` collapses selected cells
- [ ] Collapse works with multiple cells selected
- [ ] Collapse does nothing when no cells selected
- [ ] `Ctrl+A` selects all visible objects
- [ ] `Escape` clears selection
- [ ] `Ctrl+O` opens file dialog
- [ ] `Ctrl+S` saves session (or shows placeholder)
- [ ] `Ctrl+Q` quits application
- [ ] `Ctrl+C` copies property panel contents
- [ ] Copied properties paste correctly into text editor
- [ ] Copied properties format is readable

---

## 5. Risks and Considerations

### 5.1 Technical Risks

| Risk | Impact | Probability | Mitigation |
|------|--------|-------------|------------|
| **Undo/redo not implemented in E04-F03** | High | Medium | Coordinate with E04-F03 implementation, stub if needed |
| **Expansion service API not finalized** | High | Medium | Define required API early, coordinate with E03 team |
| **Platform-specific redo key issues** | Low | Low | Use `QKeySequence.StandardKey.Redo`, test on Linux |
| **Multiple Delete/Backspace shortcuts conflict** | Low | Low | Qt handles multiple sequences cleanly, test both keys |

### 5.2 UX Risks

| Risk | Impact | Probability | Mitigation |
|------|--------|-------------|------------|
| **Expand with multi-select confusing** | Medium | Medium | Document behavior: expands first item only |
| **Collapse with multi-select destructive** | Medium | Low | Undo immediately available to recover |
| **Copy format not user-friendly** | Low | Medium | Use simple key-value format, test with users |
| **No visual feedback for undo/redo** | Low | High | Qt undo stack can emit signals for status bar (P1) |

### 5.3 Integration Risks

| Risk | Impact | Probability | Mitigation |
|------|--------|-------------|------------|
| **QUndoStack not initialized** | High | Low | Add to MainWindow init early, test integration |
| **Expansion service not implemented** | High | Medium | Stub methods for MVP, coordinate with E03 |
| **Property panel structure unknown** | Medium | Medium | Define minimal API: `_get_current_properties()` |
| **Selection manager conflicts** | Low | Low | Use Qt's built-in selection or adapt to custom manager |

### 5.4 Assumptions

1. **QUndoStack is the chosen undo/redo mechanism**: Aligns with E04-F03
2. **Expansion service provides required methods**: API contract defined
3. **Property panel can be queried for current properties**: Minimal interface
4. **CellItem, PinItem, NetItem classes exist**: Part of E02 rendering
5. **File operations are out of scope for most features**: Ctrl+O/S are stubs

---

## 6. Dependencies

### 6.1 Upstream Dependencies

**Hard Dependencies:**
- E04-F04-T01 (Shortcut Manager): Must be complete
- `MainWindow` class exists
- `SchematicCanvas` and `QGraphicsScene` exist
- `QUndoStack` initialized in `MainWindow`

**Soft Dependencies:**
- E04-F03 (Undo/Redo): Undo stack may be stub
- E03 (Expansion): Expansion service may be stubbed
- E04-F01 (Selection): May use custom manager or Qt built-in
- Property panel: May be minimal implementation

### 6.2 Downstream Dependencies

**This task is a dependency for:**
- E04-F04-T04 (Documentation): Action shortcuts need to be documented

**Interfaces Required from Other Components:**

From Expansion Service (E03):
```python
class ExpansionService:
    def expand_fanout(self, cell: Cell, hops: int) -> None: ...
    def expand_fanin(self, cell: Cell, hops: int) -> None: ...
    def expand_net(self, net: Net) -> None: ...
    def collapse_cells(self, cells: set[Cell]) -> None: ...
```

From Property Panel:
```python
class PropertyPanel:
    def copy_to_clipboard(self) -> None: ...
    def _get_current_properties(self) -> dict[str, str]: ...
```

---

## 7. Success Criteria

### 7.1 Functional Completeness

- [ ] All action shortcuts work as specified
- [ ] Undo/redo shortcuts trigger undo stack operations
- [ ] Expand/collapse shortcuts work for all object types
- [ ] Selection shortcuts select/deselect appropriately
- [ ] File operation shortcuts show dialogs or placeholders
- [ ] Copy shortcut copies properties to clipboard
- [ ] No crashes when pressing any shortcut

### 7.2 Quality Criteria

- [ ] Unit test coverage >85%
- [ ] All integration tests passing
- [ ] No type errors (mypy passes)
- [ ] No linting errors (ruff passes)
- [ ] Manual testing checklist complete

### 7.3 Platform Compatibility

- [ ] Undo works on Linux (Ctrl+Z)
- [ ] Redo works on Linux (Ctrl+Shift+Z)
- [ ] All shortcuts work on Linux (primary platform)
- [ ] No conflicts with window manager shortcuts

### 7.4 Context Awareness

- [ ] Undo/redo only enabled when stack has items (if using actions)
- [ ] Expand/collapse gracefully handle no selection
- [ ] Copy only works when property panel has content
- [ ] No errors when shortcuts pressed in invalid states

---

## 8. Open Questions

### 8.1 Technical Questions

1. **Q: Should undo/redo be enabled/disabled via shortcuts or just no-op?**
   - A: No-op is fine for MVP. Qt actions can show enabled/disabled in menus (P1).

2. **Q: What expansion mode to use for Enter key (fanout, fanin, both)?**
   - A: Default to fanout for cells, net expansion for nets. Configurable in P1.

3. **Q: Should collapsed cells be removed from scene or hidden?**
   - A: Depends on E03 implementation. Assume removal for MVP.

### 8.2 UX Questions

1. **Q: Should there be confirmation for quit (Ctrl+Q)?**
   - A: No for MVP. Standard apps don't confirm on Ctrl+Q if no unsaved changes.

2. **Q: Should multi-select expand expand all or just first?**
   - A: First item only for MVP. Expanding all could be overwhelming.

3. **Q: What to show when Ctrl+S pressed but session save not implemented?**
   - A: Silent no-op for MVP. Status bar message in P1.

### 8.3 Integration Questions

1. **Q: Is E04-F03 (Undo/Redo) implemented?**
   - A: Coordinate with E04 team. May need to stub for MVP.

2. **Q: Is expansion service API stable?**
   - A: Define API contract in this pre-docs. Coordinate with E03.

---

## 9. Implementation Checklist

### 9.1 Pre-Implementation

- [ ] Review E04-F04-T03 task spec
- [ ] Confirm QUndoStack usage (coordinate with E04-F03)
- [ ] Define expansion service API
- [ ] Confirm property panel interface
- [ ] Review CellItem, PinItem, NetItem classes

### 9.2 Implementation

- [ ] Initialize QUndoStack in MainWindow
- [ ] Implement undo/redo shortcut handlers
- [ ] Implement expand shortcut handler
- [ ] Implement collapse shortcut handler
- [ ] Implement selection shortcut handlers
- [ ] Implement file operation shortcuts
- [ ] Implement property copy functionality
- [ ] Register all shortcuts with ShortcutManager

### 9.3 Testing

- [ ] Write unit tests for all shortcut handlers
- [ ] Write integration tests with QTest
- [ ] Manual testing of all shortcuts
- [ ] Test multi-select scenarios
- [ ] Test edge cases (empty stack, no selection)
- [ ] Test clipboard functionality

### 9.4 Documentation

- [ ] Add docstrings to all handler methods
- [ ] Document shortcut behavior
- [ ] Document multi-select behavior
- [ ] Update post-docs
- [ ] Note any deviations from spec

### 9.5 Review and Cleanup

- [ ] Run mypy type checking
- [ ] Run ruff linting
- [ ] Code review
- [ ] Address feedback
- [ ] Final testing pass

---

## 10. References

### 10.1 Internal Documents

- [E04-F04 Feature Spec](../E04-F04.spec.md)
- [E04-F04-T03 Task Spec](./E04-F04-T03.spec.md)
- [E04-F04-T01 Pre-Docs](../T01/E04-F04-T01.pre-docs.md)
- [E04-F03 Spec - Undo/Redo](../../F03/E04-F03.spec.md)
- [E03 Spec - Expansion](../../../E03/E03.spec.md)
- [PRD Section 7.3 - Keyboard Shortcuts](../../../../docs/prd.md)

### 10.2 Qt Documentation

- [QUndoStack Class](https://doc.qt.io/qt-6/qundostack.html)
- [QUndoCommand Class](https://doc.qt.io/qt-6/qundocommand.html)
- [QKeySequence.StandardKey](https://doc.qt.io/qt-6/qkeysequence.html#StandardKey-enum)
- [QGraphicsScene Selection](https://doc.qt.io/qt-6/qgraphicsscene.html#selection)
- [QClipboard Class](https://doc.qt.io/qt-6/qclipboard.html)

### 10.3 Design Patterns

- **Command Pattern**: Undo/redo operations
- **Facade Pattern**: MainWindow coordinates multiple components
- **Strategy Pattern**: Different expansion strategies for different object types

---

**End of Pre-Implementation Documentation**
