# Spec: E04-F03 - Undo/Redo System

## Metadata
- **ID**: E04-F03
- **Type**: Feature
- **Priority**: P0 (MVP)
- **Status**: Draft
- **Parent**: [E04](../E04.spec.md)
- **Created**: 2025-12-26

---

## 1. Overview

### 1.1 Problem Statement

During schematic exploration, users perform expansion and collapse operations that modify the visible circuit structure. Without undo/redo capability, mistakes or exploratory actions cannot be easily reversed, forcing users to manually reconstruct previous states. This inhibits experimental workflows and increases cognitive load.

### 1.2 Goals

- Provide full undo/redo support for expansion and collapse operations
- Support Ctrl+Z (undo) and Ctrl+Shift+Z (redo) keyboard shortcuts
- Maintain undo stack with minimum depth of 50 actions
- Execute undo/redo operations within 100ms
- Preserve exploration state consistency across undo/redo

---

## 2. User Stories

### US-E04-04: Undo/Redo
**As a** circuit designer
**I want to** undo and redo my actions
**So that** I can experiment without fear

**Acceptance Criteria:**
- [ ] Ctrl+Z undoes last expansion or collapse
- [ ] Ctrl+Shift+Z redoes last undone action
- [ ] Undo stack depth of at least 50 actions
- [ ] Undo/redo updates view immediately

---

## 3. Technical Requirements

### 3.1 Command Pattern Architecture

```python
class UndoableCommand(ABC):
    """Base class for all undoable commands"""

    @abstractmethod
    def execute(self) -> bool:
        """Execute the command, return success"""

    @abstractmethod
    def undo(self) -> bool:
        """Undo the command, return success"""

    @abstractmethod
    def redo(self) -> bool:
        """Redo the command (default: call execute)"""

class UndoStack:
    """Manages undo/redo history"""

    def __init__(self, max_depth: int = 50):
        self._undo_stack: List[UndoableCommand] = []
        self._redo_stack: List[UndoableCommand] = []
        self._max_depth = max_depth

    def push(self, command: UndoableCommand):
        """Execute and push command to undo stack"""
        if command.execute():
            self._undo_stack.append(command)
            self._redo_stack.clear()  # Clear redo on new action
            if len(self._undo_stack) > self._max_depth:
                self._undo_stack.pop(0)  # Remove oldest

    def undo(self) -> bool:
        """Undo last command, return success"""
        if not self._undo_stack:
            return False
        command = self._undo_stack.pop()
        if command.undo():
            self._redo_stack.append(command)
            return True
        return False

    def redo(self) -> bool:
        """Redo last undone command, return success"""
        if not self._redo_stack:
            return False
        command = self._redo_stack.pop()
        if command.redo():
            self._undo_stack.append(command)
            return True
        return False

    @property
    def can_undo(self) -> bool:
        return len(self._undo_stack) > 0

    @property
    def can_redo(self) -> bool:
        return len(self._redo_stack) > 0
```

### 3.2 Expansion Command

```python
class ExpansionCommand(UndoableCommand):
    """Undoable expansion action"""

    def __init__(
        self,
        expansion_service: ExpansionService,
        target: Union[CellId, PinId, NetId],
        expansion_params: ExpansionParams
    ):
        self._service = expansion_service
        self._target = target
        self._params = expansion_params
        self._cells_added: Set[CellId] = set()
        self._nets_added: Set[NetId] = set()

    def execute(self) -> bool:
        """Perform expansion and record changes"""
        result = self._service.expand(self._target, self._params)
        self._cells_added = result.cells_added
        self._nets_added = result.nets_added
        return result.success

    def undo(self) -> bool:
        """Remove added cells/nets"""
        return self._service.collapse_specific(
            self._cells_added, self._nets_added
        )

    def redo(self) -> bool:
        """Re-add cells/nets"""
        return self._service.expand_specific(
            self._cells_added, self._nets_added
        )
```

### 3.3 Collapse Command

```python
class CollapseCommand(UndoableCommand):
    """Undoable collapse action"""

    def __init__(
        self,
        expansion_service: ExpansionService,
        target: Union[CellId, Set[CellId]]
    ):
        self._service = expansion_service
        self._target = target
        self._cells_removed: Set[CellId] = set()
        self._nets_removed: Set[NetId] = set()

    def execute(self) -> bool:
        """Perform collapse and record changes"""
        result = self._service.collapse(self._target)
        self._cells_removed = result.cells_removed
        self._nets_removed = result.nets_removed
        return result.success

    def undo(self) -> bool:
        """Restore removed cells/nets"""
        return self._service.expand_specific(
            self._cells_removed, self._nets_removed
        )

    def redo(self) -> bool:
        """Re-remove cells/nets"""
        return self._service.collapse_specific(
            self._cells_removed, self._nets_removed
        )
```

### 3.4 Performance Targets

- Undo/redo execution time: < 100ms
- Stack depth: minimum 50 actions, configurable up to 200
- Memory per command: < 1KB (store IDs, not full objects)
- State consistency validation: < 10ms

### 3.5 Integration Points

- **Application Layer**: `UndoStack` managed by main application service
- **Expansion Service**: All expansion/collapse operations wrapped in commands
- **UI**: Keyboard shortcuts (Ctrl+Z, Ctrl+Shift+Z) trigger undo/redo
- **Menu/Toolbar**: Undo/Redo actions with enabled/disabled state
- **Status Bar**: Display "Undone" / "Redone" messages

---

## 4. Dependencies

- **Upstream**:
  - E03 (Expansion - expansion/collapse operations to undo)
  - E01 (Data Model - object identifiers)
- **Downstream**:
  - E04-F04 (Keyboard Shortcuts - Ctrl+Z/Ctrl+Shift+Z)

---

## 5. Acceptance Criteria

- [ ] Ctrl+Z undoes last expansion operation
- [ ] Ctrl+Z undoes last collapse operation
- [ ] Ctrl+Shift+Z redoes last undone expansion
- [ ] Ctrl+Shift+Z redoes last undone collapse
- [ ] Undo stack maintains minimum 50 actions
- [ ] New action clears redo stack
- [ ] Undo/redo operations complete within 100ms
- [ ] Menu items show enabled/disabled state based on stack
- [ ] Status bar displays undo/redo feedback
- [ ] State consistency maintained across all undo/redo operations
- [ ] Undo/redo works correctly after multiple sequential operations
- [ ] Undo restores exact previous visual state (cells, nets, layout)

---

## 6. Child Specs
*To be created via `/spec_work E04-F03 --split tasks`*

| ID | Task | Status |
|----|------|--------|

---

## Revision History

| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-12-26 | 0.1 | Claude | Initial feature creation from E04 split |
