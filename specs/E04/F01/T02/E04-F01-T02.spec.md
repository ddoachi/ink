---
id: E04-F01-T02
title: Single Selection
type: Task
priority: P0 (MVP)
status: Draft
parent: E04-F01
created: 2025-12-26
estimated_hours: 3
actual_hours:
effort: Medium
tags:
  - selection
  - interaction
  - ui
---

# Spec: E04-F01-T02 - Single Selection

## 1. Overview

### 1.1 Problem Statement

Circuit designers need to click on schematic objects (cells, pins, nets) to select them for property inspection. Single-click selection should clear any previous selection and select only the clicked object, providing immediate visual feedback and triggering property panel updates.

### 1.2 Goals

- Handle mouse click events on schematic objects
- Integrate with `SelectionService` for state management
- Use REPLACE mode for single-click behavior
- Provide immediate visual feedback (<16ms response time)
- Support selection of all object types (cells, pins, nets, ports)

---

## 2. User Story

### US-E04-01: Single Selection
**As a** circuit designer
**I want to** click on a cell/pin/net to select it
**So that** I can inspect its properties

**Acceptance Criteria:**
- [ ] Single click selects object
- [ ] Previous selection is cleared
- [ ] Visual highlight indicates selection
- [ ] Property panel updates with object details

---

## 3. Technical Requirements

### 3.1 Canvas Mouse Event Handling

**Location**: `src/ink/presentation/canvas/schematic_canvas.py`

```python
class SchematicCanvas(QGraphicsView):
    """Main schematic canvas view"""

    def __init__(self, selection_service: SelectionService):
        super().__init__()
        self._selection_service = selection_service
        self._scene = QGraphicsScene()
        self.setScene(self._scene)

    def mousePressEvent(self, event: QMouseEvent) -> None:
        """Handle mouse press for object selection"""
        if event.button() == Qt.LeftButton:
            # Get clicked item
            item = self.itemAt(event.pos())

            if item and hasattr(item, 'object_id'):
                # Determine selection mode based on modifiers
                if event.modifiers() & Qt.ControlModifier:
                    mode = SelectMode.ADD
                else:
                    mode = SelectMode.REPLACE

                # Delegate to selection service
                self._selection_service.select(item.object_id, mode)
            else:
                # Click on empty space clears selection
                self._selection_service.clear()

        super().mousePressEvent(event)
```

### 3.2 Schematic Item Base Class

**Location**: `src/ink/presentation/canvas/schematic_item.py`

```python
from PySide6.QtWidgets import QGraphicsItem

class SchematicItem(QGraphicsItem):
    """Base class for all schematic graphical items"""

    def __init__(self, object_id: str):
        super().__init__()
        self.object_id = object_id  # Unique identifier
        self.setFlag(QGraphicsItem.ItemIsSelectable, True)
        self.setAcceptHoverEvents(True)
```

### 3.3 Integration Points

1. **Canvas Construction**: Pass `SelectionService` instance to canvas
2. **Item Identification**: All schematic items must have `object_id` attribute
3. **Event Propagation**: Click events handled at canvas level before propagating to items
4. **Modifier Keys**: Check for Ctrl modifier to distinguish single vs. multi-select

### 3.4 Design Decisions

1. **Canvas-Level Handling**: Mouse events handled at `SchematicCanvas` level for centralized control
2. **Service Injection**: `SelectionService` injected via constructor (dependency injection)
3. **Item Protocol**: All schematic items expose `object_id` attribute for identification
4. **Empty Click Behavior**: Clicking empty canvas area clears selection
5. **Event Bubbling**: Call `super().mousePressEvent()` to allow Qt's default behavior

---

## 4. Implementation Steps

1. Add `object_id` attribute to `SchematicItem` base class
2. Update `CellItem`, `PinItem`, `NetItem` to inherit from `SchematicItem`
3. Modify `SchematicCanvas.__init__()` to accept `SelectionService` parameter
4. Implement `mousePressEvent()` in `SchematicCanvas`
5. Add item detection logic using `itemAt()`
6. Add modifier key detection for Ctrl+click
7. Call `selection_service.select()` or `selection_service.clear()`
8. Update composition root to inject `SelectionService` into canvas

---

## 5. Testing Requirements

### 5.1 Unit Tests

**Location**: `tests/ui/canvas/test_selection_interaction.py`

```python
def test_single_click_selects_object(qtbot):
    """Test single click selects object in REPLACE mode"""
    selection_service = SelectionService()
    canvas = SchematicCanvas(selection_service)

    # Create test item
    item = CellItem(object_id="cell1", ...)
    canvas.scene().addItem(item)

    # Simulate click
    click_pos = canvas.mapFromScene(item.pos())
    QTest.mouseClick(canvas.viewport(), Qt.LeftButton, pos=click_pos)

    assert selection_service.is_selected("cell1")
    assert selection_service.get_selection_count() == 1

def test_single_click_clears_previous_selection(qtbot):
    """Test single click clears previous selection"""
    selection_service = SelectionService()
    canvas = SchematicCanvas(selection_service)

    # Setup two items
    item1 = CellItem(object_id="cell1", ...)
    item2 = CellItem(object_id="cell2", ...)
    canvas.scene().addItem(item1)
    canvas.scene().addItem(item2)

    # Select first item
    selection_service.select("cell1", SelectMode.REPLACE)

    # Click second item
    click_pos = canvas.mapFromScene(item2.pos())
    QTest.mouseClick(canvas.viewport(), Qt.LeftButton, pos=click_pos)

    assert not selection_service.is_selected("cell1")
    assert selection_service.is_selected("cell2")

def test_click_empty_space_clears_selection(qtbot):
    """Test clicking empty canvas clears selection"""
    selection_service = SelectionService()
    canvas = SchematicCanvas(selection_service)

    # Setup item and select it
    item = CellItem(object_id="cell1", ...)
    canvas.scene().addItem(item)
    selection_service.select("cell1", SelectMode.REPLACE)

    # Click empty space
    QTest.mouseClick(canvas.viewport(), Qt.LeftButton, pos=QPoint(10, 10))

    assert selection_service.get_selection_count() == 0
```

### 5.2 Integration Tests

- Test selection with real `CellItem`, `PinItem`, `NetItem` instances
- Verify property panel receives `selection_changed` signal
- Test selection persistence during pan/zoom operations

### 5.3 Performance Tests

- Measure click-to-selection latency (target: <16ms)
- Verify no lag with 100+ items on canvas

---

## 6. Acceptance Criteria

- [ ] Single left-click selects clicked object
- [ ] Previous selection automatically cleared on single click
- [ ] Clicking empty canvas area clears all selections
- [ ] `SchematicItem` base class has `object_id` attribute
- [ ] All schematic items (`CellItem`, `PinItem`, `NetItem`) inherit from `SchematicItem`
- [ ] `SchematicCanvas` accepts `SelectionService` in constructor
- [ ] `mousePressEvent()` implemented in `SchematicCanvas`
- [ ] Selection service called with correct mode (REPLACE for single click)
- [ ] All unit tests pass
- [ ] Click-to-selection response time <16ms

---

## 7. Dependencies

- **Upstream**:
  - E04-F01-T01 (SelectionManager - provides `SelectionService`)
  - E02 (Rendering - schematic items must exist)
- **Downstream**:
  - E04-F01-T04 (Selection Highlighting - visual feedback for selection)
  - E04-F02 (Property Panel - receives selection events)

---

## Revision History

| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-12-26 | 0.1 | Claude | Initial task creation from E04-F01 split |
