---
id: E02-F04-T03
title: Pin and Net LOD Rendering
type: Task
priority: P0 (MVP)
status: Draft
parent: E02-F04
created: 2025-12-26
estimated_hours: 8
actual_hours:
effort: High
tags:
  - presentation
  - rendering
  - graphics
  - performance
---

# Spec: E02-F04-T03 - Pin and Net LOD Rendering

## 1. Overview

### 1.1 Problem Statement
Implement LOD-aware rendering for pins and nets to reduce visual clutter at low zoom levels. Pins should show full names and direction arrows only when zoomed in, small indicators at medium zoom, and be hidden at low zoom. Nets should simplify to straight lines between cells at low zoom instead of detailed orthogonal routing.

### 1.2 Goals
- Implement three LOD levels for pin rendering: hidden, indicator dots, full labels
- Implement two LOD levels for net routing: simplified lines, full orthogonal routing
- Subscribe to LOD manager and update pin/net graphics dynamically
- Ensure readable pin names at HIGH LOD, clear indicators at MEDIUM LOD
- Measure performance improvement from simplified net routing at LOW LOD

---

## 2. Technical Requirements

### 2.1 Pin Graphics Item LOD Support

**Location**: `src/ink/presentation/canvas/pin_item.py`

```python
from PySide6.QtWidgets import QGraphicsEllipseItem, QGraphicsTextItem, QGraphicsItemGroup
from PySide6.QtCore import QRectF, QPointF, Qt
from PySide6.QtGui import QPainter, QPen, QBrush, QColor

from ink.domain.model.pin import Pin
from ink.domain.value_objects.pin_direction import PinDirection
from .lod_level import LODLevel


class PinGraphicsItem(QGraphicsItemGroup):
    """
    Graphics item representing a circuit pin with LOD support.

    LOD Levels:
    - LOW: Hidden (no visual representation)
    - MEDIUM: Small dot indicator only (no text)
    - HIGH: Full detail (name label, direction arrow, connection point)
    """

    # Pin indicator sizes
    INDICATOR_RADIUS_MEDIUM = 3.0  # Small dot at MEDIUM LOD
    INDICATOR_RADIUS_HIGH = 5.0    # Larger dot at HIGH LOD

    # Colors by direction
    INPUT_COLOR = QColor(100, 150, 255)   # Blue for inputs
    OUTPUT_COLOR = QColor(255, 150, 100)  # Orange for outputs
    INOUT_COLOR = QColor(150, 150, 150)   # Gray for bidirectional

    def __init__(self, pin: Pin, parent=None):
        super().__init__(parent)
        self._pin = pin
        self._current_lod = LODLevel.HIGH

        # Child graphics items
        self._indicator_dot: QGraphicsEllipseItem = None
        self._name_label: QGraphicsTextItem = None
        self._direction_arrow: QGraphicsItem = None  # TODO: implement in HIGH LOD

        self._setup_graphics()
        self.setPos(pin.position.x, pin.position.y)

    def _setup_graphics(self):
        """Create child graphics items for each LOD level"""
        # Indicator dot (MEDIUM and HIGH)
        color = self._get_pin_color()
        self._indicator_dot = QGraphicsEllipseItem(self)
        self._indicator_dot.setPen(QPen(Qt.black, 1.0))
        self._indicator_dot.setBrush(QBrush(color))

        # Name label (HIGH only)
        self._name_label = QGraphicsTextItem(self._pin.name, self)
        self._name_label.setDefaultTextColor(Qt.black)
        font = self._name_label.font()
        font.setPointSize(8)
        self._name_label.setFont(font)

        # Position name label next to indicator
        label_offset = 8.0
        if self._pin.direction == PinDirection.INPUT:
            self._name_label.setPos(-self._name_label.boundingRect().width() - label_offset, -5)
        else:  # OUTPUT or INOUT
            self._name_label.setPos(label_offset, -5)

    def _get_pin_color(self) -> QColor:
        """Determine pin color based on direction"""
        if self._pin.direction == PinDirection.INPUT:
            return self.INPUT_COLOR
        elif self._pin.direction == PinDirection.OUTPUT:
            return self.OUTPUT_COLOR
        else:  # INOUT
            return self.INOUT_COLOR

    def set_lod_level(self, lod_level: LODLevel) -> None:
        """
        Update rendering detail based on LOD level.

        Args:
            lod_level: Target LOD level
        """
        if lod_level == self._current_lod:
            return

        self._current_lod = lod_level

        if lod_level == LODLevel.LOW:
            self._render_low_detail()
        elif lod_level == LODLevel.MEDIUM:
            self._render_medium_detail()
        else:  # HIGH
            self._render_high_detail()

        self.update()

    def _render_low_detail(self) -> None:
        """
        LOD Level 0: Hidden.
        - No visual representation of pins
        - Nets connect directly to cell bounding boxes
        """
        self.setVisible(False)

    def _render_medium_detail(self) -> None:
        """
        LOD Level 1: Pin indicator only.
        - Small colored dot showing pin position
        - No text labels (too cluttered)
        - Color indicates direction
        """
        self.setVisible(True)

        # Show small indicator dot
        radius = self.INDICATOR_RADIUS_MEDIUM
        self._indicator_dot.setRect(-radius, -radius, radius * 2, radius * 2)
        self._indicator_dot.setVisible(True)

        # Hide text
        self._name_label.setVisible(False)

    def _render_high_detail(self) -> None:
        """
        LOD Level 2: Full detail.
        - Larger colored indicator dot
        - Pin name label
        - Direction arrow (future enhancement)
        """
        self.setVisible(True)

        # Show larger indicator dot
        radius = self.INDICATOR_RADIUS_HIGH
        self._indicator_dot.setRect(-radius, -radius, radius * 2, radius * 2)
        self._indicator_dot.setVisible(True)

        # Show name label
        self._name_label.setVisible(True)

    @property
    def pin(self) -> Pin:
        """Access to underlying domain pin"""
        return self._pin

    @property
    def current_lod(self) -> LODLevel:
        """Current LOD level for this item"""
        return self._current_lod
```

### 2.2 Net Graphics Item LOD Support

**Location**: `src/ink/presentation/canvas/net_item.py`

```python
from PySide6.QtWidgets import QGraphicsPathItem
from PySide6.QtCore import QPointF, Qt
from PySide6.QtGui import QPainterPath, QPen, QColor

from ink.domain.model.net import Net
from .lod_level import LODLevel


class NetGraphicsItem(QGraphicsPathItem):
    """
    Graphics item representing a circuit net with LOD support.

    LOD Levels:
    - LOW: Simplified straight line between cell centers
    - MEDIUM/HIGH: Full orthogonal routing with junction dots
    """

    # Net rendering styles
    NET_COLOR = QColor(0, 0, 0)      # Black for normal nets
    NET_WIDTH_LOW = 1.0              # Thin line at LOW LOD
    NET_WIDTH_HIGH = 2.0             # Thicker line at MEDIUM/HIGH LOD
    JUNCTION_RADIUS = 3.0            # Dot at wire junctions

    def __init__(self, net: Net, routing_points: list[QPointF], parent=None):
        super().__init__(parent)
        self._net = net
        self._routing_points = routing_points  # Full orthogonal path
        self._current_lod = LODLevel.HIGH

        self.setPen(QPen(self.NET_COLOR, self.NET_WIDTH_HIGH))
        self._update_path()

    def set_lod_level(self, lod_level: LODLevel) -> None:
        """
        Update net rendering based on LOD level.

        Args:
            lod_level: Target LOD level
        """
        if lod_level == self._current_lod:
            return

        self._current_lod = lod_level
        self._update_path()
        self.update()

    def _update_path(self) -> None:
        """Regenerate path based on current LOD level"""
        if self._current_lod == LODLevel.LOW:
            self._render_simplified_path()
        else:  # MEDIUM or HIGH
            self._render_full_path()

    def _render_simplified_path(self) -> None:
        """
        LOD Level 0: Simplified routing.
        - Straight line from source cell center to sink cell center
        - No orthogonal routing details
        - Thin line width for performance
        """
        self.setPen(QPen(self.NET_COLOR, self.NET_WIDTH_LOW))

        # Simplified path: just start and end points
        if len(self._routing_points) >= 2:
            start = self._routing_points[0]
            end = self._routing_points[-1]

            path = QPainterPath()
            path.moveTo(start)
            path.lineTo(end)
            self.setPath(path)

    def _render_full_path(self) -> None:
        """
        LOD Level 1/2: Full orthogonal routing.
        - Complete path through all routing points
        - Thicker lines for visibility
        - Junction dots at branch points (MEDIUM/HIGH)
        """
        self.setPen(QPen(self.NET_COLOR, self.NET_WIDTH_HIGH))

        # Full orthogonal path
        if not self._routing_points:
            return

        path = QPainterPath()
        path.moveTo(self._routing_points[0])

        for point in self._routing_points[1:]:
            path.lineTo(point)

        # Add junction dots at intermediate points (if 3+ way junction)
        # TODO: Implement junction detection in E02-F03

        self.setPath(path)

    def update_routing(self, routing_points: list[QPointF]) -> None:
        """
        Update net routing path (called after re-routing).

        Args:
            routing_points: New routing points
        """
        self._routing_points = routing_points
        self._update_path()

    @property
    def net(self) -> Net:
        """Access to underlying domain net"""
        return self._net

    @property
    def current_lod(self) -> LODLevel:
        """Current LOD level for this item"""
        return self._current_lod
```

### 2.3 Integration with Canvas LOD Manager

**Location**: `src/ink/presentation/canvas/schematic_canvas.py` (modifications)

```python
class SchematicCanvas(QGraphicsView):
    """Schematic canvas with LOD support for all graphics items"""

    def __init__(self, parent=None):
        super().__init__(parent)
        self._lod_manager = LODManager()
        self._cell_items: list[CellGraphicsItem] = []
        self._pin_items: list[PinGraphicsItem] = []
        self._net_items: list[NetGraphicsItem] = []

        self._lod_manager.add_listener(self._on_lod_changed)

    def add_pin_item(self, pin_item: PinGraphicsItem) -> None:
        """Add pin item to scene and track for LOD updates"""
        self.scene().addItem(pin_item)
        self._pin_items.append(pin_item)
        pin_item.set_lod_level(self._lod_manager.current_level)

    def add_net_item(self, net_item: NetGraphicsItem) -> None:
        """Add net item to scene and track for LOD updates"""
        self.scene().addItem(net_item)
        self._net_items.append(net_item)
        net_item.set_lod_level(self._lod_manager.current_level)

    def _on_lod_changed(self, new_level: LODLevel) -> None:
        """Update all graphics items when LOD level changes"""
        # Update cells
        for cell_item in self._cell_items:
            cell_item.set_lod_level(new_level)

        # Update pins
        for pin_item in self._pin_items:
            pin_item.set_lod_level(new_level)

        # Update nets
        for net_item in self._net_items:
            net_item.set_lod_level(new_level)
```

### 2.4 Performance Impact

**Rendering Complexity per Net**:

| LOD Level | Path Segments | Junction Dots | Render Time |
|-----------|--------------|---------------|-------------|
| LOW | 1 line | 0 | ~0.005ms |
| MEDIUM/HIGH | 5-10 lines avg | 0-3 | ~0.02ms |

**Performance Targets**:
- 1000 nets at LOW LOD: <5ms total
- 500 nets at MEDIUM/HIGH LOD: <10ms total
- 100 pins at MEDIUM LOD: <1ms (dots only)
- 100 pins at HIGH LOD: <5ms (dots + text)

---

## 3. Dependencies

### 3.1 Upstream
- Task E02-F04-T01: `LODManager` and `LODLevel` definitions
- Task E02-F04-T02: Cell items provide parent for pin items
- E02-F03: Net routing provides routing points

### 3.2 Downstream
- E04-F01: Selection highlighting for pins and nets at all LOD levels

### 3.3 External Dependencies
- PySide6 graphics classes
- Domain models: `Pin`, `Net`, `PinDirection`

---

## 4. Acceptance Criteria

### 4.1 Functional Requirements - Pins
- [ ] Pins hidden at LOD LOW
- [ ] Pins show as small colored dots at LOD MEDIUM
- [ ] Pins show full detail (dot + name) at LOD HIGH
- [ ] Pin color reflects direction (blue=input, orange=output, gray=inout)
- [ ] Pin name label positioned correctly relative to cell edge
- [ ] Pin LOD changes synchronize with cell LOD changes

### 4.2 Functional Requirements - Nets
- [ ] Nets render as simplified straight lines at LOD LOW
- [ ] Nets render full orthogonal routing at LOD MEDIUM/HIGH
- [ ] Net line width adjusted per LOD level
- [ ] Simplified path connects correct start/end points
- [ ] Full path follows all routing points

### 4.3 Performance
- [ ] 1000 nets render at LOW LOD in <5ms
- [ ] 500 nets render at HIGH LOD in <10ms
- [ ] 100 pins render at MEDIUM LOD in <1ms
- [ ] 100 pins render at HIGH LOD in <5ms
- [ ] LOD transition for 500 pins + 1000 nets completes in <16ms

### 4.4 Testing
- [ ] Unit tests for pin LOD level changes
- [ ] Unit tests for net path simplification
- [ ] Visual tests verifying pin colors and sizes
- [ ] Integration test: LOD manager triggers pin/net updates
- [ ] Performance benchmark: measure render times
- [ ] 85%+ code coverage on `PinGraphicsItem` and `NetGraphicsItem`

---

## 5. Implementation Notes

### 5.1 Design Decisions

**Why hide pins at LOW LOD?**
- Too small to see at <25% zoom anyway
- Significant performance improvement (no text rendering)
- Nets connect to cell bounding boxes instead

**Why straight line nets at LOW LOD?**
- Orthogonal routing details invisible at low zoom
- 5-10x faster rendering (1 line vs 5-10 segments)
- Still shows connectivity clearly

**Why color-code pins by direction?**
- Visual cue at MEDIUM LOD (no text labels)
- Helps distinguish inputs from outputs quickly
- Standard in circuit schematic viewers

**Why QGraphicsItemGroup for pins?**
- Manages multiple child items (dot, label, arrow) as one unit
- Simplifies coordinate transforms
- Supports future enhancements (direction arrows, hover tooltips)

### 5.2 Testing Strategy

**Unit Tests**:
- `tests/unit/presentation/canvas/test_pin_item_lod.py`: Pin LOD transitions
- `tests/unit/presentation/canvas/test_net_item_lod.py`: Net path simplification

**Visual Tests**:
- Render pins at MEDIUM and HIGH LOD, verify appearance
- Render nets at LOW and HIGH LOD, compare routing

**Performance Tests**:
- Benchmark pin rendering: 1000 pins at each LOD level
- Benchmark net rendering: 2000 nets at each LOD level
- Profile paint() methods to identify bottlenecks

### 5.3 Future Enhancements (P1)
- Direction arrows on pins at HIGH LOD
- Junction dots on net branch points
- Configurable pin indicator size per zoom level
- Smart label placement to avoid overlaps
- Highlight critical nets (e.g., clock) at all LOD levels

---

## Revision History
| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-12-26 | 0.1 | Claude | Initial task creation from E02-F04 split |
