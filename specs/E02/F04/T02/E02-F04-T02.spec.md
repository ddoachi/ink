---
id: E02-F04-T02
title: Cell LOD Rendering
type: Task
priority: P0 (MVP)
status: Draft
parent: E02-F04
created: 2025-12-26
estimated_hours: 8
actual_hours:
effort: High
tags:
  - presentation
  - rendering
  - graphics
  - performance
clickup_task_id: ''
---

# Spec: E02-F04-T02 - Cell LOD Rendering

## 1. Overview

### 1.1 Problem Statement
Implement multi-level rendering for cell graphics items that adapts detail based on LOD level. At low zoom, cells should render as simple bounding boxes for performance. At medium zoom, add cell names. At high zoom, show full cell symbol details. This optimization is critical for rendering large schematics with hundreds of cells efficiently.

### 1.2 Goals
- Implement LOD-aware cell rendering in `CellGraphicsItem`
- Define three rendering modes: bounding box only, box + name, full detail
- Subscribe to LOD manager changes and update rendering dynamically
- Ensure smooth transitions between LOD levels (<16ms per frame)
- Measure and validate performance improvement at LOW LOD

---

## 2. Technical Requirements

### 2.1 Cell Graphics Item LOD Support

**Location**: `src/ink/presentation/canvas/cell_item.py`

```python
from PySide6.QtWidgets import QGraphicsRectItem, QGraphicsTextItem
from PySide6.QtCore import QRectF, Qt
from PySide6.QtGui import QPainter, QPen, QBrush, QColor

from ink.domain.model.cell import Cell
from .lod_level import LODLevel


class CellGraphicsItem(QGraphicsRectItem):
    """
    Graphics item representing a circuit cell with LOD support.

    LOD Levels:
    - LOW: Bounding box only (solid rectangle)
    - MEDIUM: Bounding box + cell name label
    - HIGH: Full cell symbol (box, pins, internal details)
    """

    # Rendering constants
    BBOX_COLOR_LOW = QColor(180, 180, 180)      # Gray for LOW LOD
    BBOX_COLOR_MEDIUM = QColor(200, 220, 240)   # Light blue for MEDIUM
    BBOX_COLOR_HIGH = QColor(220, 240, 255)     # Lighter blue for HIGH
    BORDER_COLOR = QColor(80, 80, 80)
    BORDER_WIDTH = 1.5

    def __init__(self, cell: Cell, parent=None):
        super().__init__(parent)
        self._cell = cell
        self._current_lod = LODLevel.HIGH  # Default to full detail

        # Child items for different LOD levels
        self._name_label: QGraphicsTextItem = None
        self._pin_items: list[QGraphicsItem] = []

        # Setup geometry
        self._setup_geometry()
        self._setup_children()

        # Enable caching for performance
        self.setCacheMode(QGraphicsRectItem.DeviceCoordinateCache)

    def _setup_geometry(self):
        """Initialize bounding box from cell dimensions"""
        # Assume cell has position and size from layout
        x, y = self._cell.position.x, self._cell.position.y
        width, height = self._cell.size.width, self._cell.size.height

        self.setRect(QRectF(x, y, width, height))
        self.setPen(QPen(self.BORDER_COLOR, self.BORDER_WIDTH))
        self.setBrush(QBrush(self.BBOX_COLOR_HIGH))

    def _setup_children(self):
        """Create child graphics items for MEDIUM and HIGH LOD"""
        # Name label (visible in MEDIUM and HIGH)
        self._name_label = QGraphicsTextItem(self._cell.name, self)
        self._name_label.setDefaultTextColor(Qt.black)

        # Center name label in cell
        rect = self.rect()
        label_rect = self._name_label.boundingRect()
        x_offset = rect.center().x() - label_rect.width() / 2
        y_offset = rect.center().y() - label_rect.height() / 2
        self._name_label.setPos(x_offset, y_offset)

        # Pin items will be added by pin rendering system (HIGH LOD only)
        # For now, placeholder for integration with T03

    def set_lod_level(self, lod_level: LODLevel) -> None:
        """
        Update rendering detail based on LOD level.

        Args:
            lod_level: Target LOD level
        """
        if lod_level == self._current_lod:
            return  # No change needed

        self._current_lod = lod_level

        # Update visibility and appearance
        if lod_level == LODLevel.LOW:
            self._render_low_detail()
        elif lod_level == LODLevel.MEDIUM:
            self._render_medium_detail()
        else:  # HIGH
            self._render_high_detail()

        # Force redraw
        self.update()

    def _render_low_detail(self) -> None:
        """
        LOD Level 0: Minimal detail.
        - Simple bounding box rectangle
        - No text or pin details
        - Solid fill for visibility
        """
        self.setBrush(QBrush(self.BBOX_COLOR_LOW))

        # Hide all child items
        self._name_label.setVisible(False)
        for pin_item in self._pin_items:
            pin_item.setVisible(False)

    def _render_medium_detail(self) -> None:
        """
        LOD Level 1: Moderate detail.
        - Bounding box with cell name
        - No pin details (pin indicators added in T03)
        """
        self.setBrush(QBrush(self.BBOX_COLOR_MEDIUM))

        # Show name label
        self._name_label.setVisible(True)

        # Hide pins (too cluttered at this zoom)
        for pin_item in self._pin_items:
            pin_item.setVisible(False)

    def _render_high_detail(self) -> None:
        """
        LOD Level 2: Full detail.
        - Complete cell symbol
        - Cell name
        - All pin graphics (names, directions, connections)
        """
        self.setBrush(QBrush(self.BBOX_COLOR_HIGH))

        # Show all details
        self._name_label.setVisible(True)
        for pin_item in self._pin_items:
            pin_item.setVisible(True)

    def add_pin_item(self, pin_item: QGraphicsItem) -> None:
        """
        Add a pin graphics item as a child (called by pin rendering system).

        Args:
            pin_item: Pin graphics item to add
        """
        self._pin_items.append(pin_item)
        pin_item.setParentItem(self)

        # Set initial visibility based on current LOD
        if self._current_lod != LODLevel.HIGH:
            pin_item.setVisible(False)

    def paint(self, painter: QPainter, option, widget=None):
        """
        Custom paint for optimization at LOW LOD.

        At LOW LOD, skip detailed rendering and draw simple rectangle.
        """
        if self._current_lod == LODLevel.LOW:
            # Fast path: simple filled rectangle
            painter.setPen(self.pen())
            painter.setBrush(self.brush())
            painter.drawRect(self.rect())
        else:
            # Default Qt rendering for MEDIUM/HIGH
            super().paint(painter, option, widget)

    @property
    def cell(self) -> Cell:
        """Access to underlying domain cell"""
        return self._cell

    @property
    def current_lod(self) -> LODLevel:
        """Current LOD level for this item"""
        return self._current_lod
```

### 2.2 Integration with LOD Manager

**Location**: `src/ink/presentation/canvas/schematic_canvas.py` (modifications)

```python
class SchematicCanvas(QGraphicsView):
    """Schematic canvas with LOD support"""

    def __init__(self, parent=None):
        super().__init__(parent)
        self._lod_manager = LODManager()
        self._cell_items: list[CellGraphicsItem] = []

        # Register LOD update callback
        self._lod_manager.add_listener(self._on_lod_changed)

    def add_cell_item(self, cell_item: CellGraphicsItem) -> None:
        """Add cell item to scene and track for LOD updates"""
        self.scene().addItem(cell_item)
        self._cell_items.append(cell_item)

        # Set initial LOD level
        cell_item.set_lod_level(self._lod_manager.current_level)

    def _on_lod_changed(self, new_level: LODLevel) -> None:
        """Update all cell items when LOD level changes"""
        for cell_item in self._cell_items:
            cell_item.set_lod_level(new_level)
```

### 2.3 Performance Optimization

**Rendering Complexity per Cell**:

| LOD Level | Operations | Render Time |
|-----------|-----------|-------------|
| LOW | 1 rectangle | ~0.01ms |
| MEDIUM | 1 rectangle + 1 text | ~0.05ms |
| HIGH | 1 rectangle + 1 text + N pins | ~0.2ms (N=10 pins) |

**Target Performance**:
- 500 cells at LOW LOD: <5ms total (100 fps capable)
- 200 cells at MEDIUM LOD: <10ms total (100 fps capable)
- 50 cells at HIGH LOD: <10ms total (100 fps capable)

---

## 3. Dependencies

### 3.1 Upstream
- Task E02-F04-T01: `LODManager` and `LODLevel` definitions
- E02-F01: Base cell rendering without LOD
- E02-F02: Layout provides cell position and size

### 3.2 Downstream
- Task E02-F04-T03: Pin graphics items use same LOD system
- E04-F01: Selection highlighting works at all LOD levels

### 3.3 External Dependencies
- PySide6 `QGraphicsRectItem`, `QGraphicsTextItem`
- Domain model: `Cell` entity

---

## 4. Acceptance Criteria

### 4.1 Functional Requirements
- [ ] Cell renders as bounding box only at LOD LOW
- [ ] Cell renders box + name at LOD MEDIUM
- [ ] Cell renders full detail at LOD HIGH
- [ ] LOD level changes update rendering immediately
- [ ] Child pin items hidden/shown based on LOD
- [ ] Cell name label centered in bounding box
- [ ] Different background colors for each LOD level (visual debugging)

### 4.2 Visual Quality
- [ ] No visual artifacts during LOD transitions
- [ ] Border remains visible at all LOD levels
- [ ] Text readable at MEDIUM and HIGH LOD
- [ ] Bounding box matches cell layout dimensions

### 4.3 Performance
- [ ] 500 cells render at LOW LOD in <5ms
- [ ] 200 cells render at MEDIUM LOD in <10ms
- [ ] 50 cells render at HIGH LOD in <10ms
- [ ] LOD transition for 200 cells completes in <16ms
- [ ] No memory leaks when switching LOD levels repeatedly

### 4.4 Testing
- [ ] Unit tests for `set_lod_level()` state changes
- [ ] Unit tests for `_render_*_detail()` methods
- [ ] Visual regression tests for each LOD level
- [ ] Integration test: LOD manager triggers cell updates
- [ ] Performance benchmark: measure render times at each LOD
- [ ] 85%+ code coverage on `CellGraphicsItem`

---

## 5. Implementation Notes

### 5.1 Design Decisions

**Why QGraphicsRectItem base class?**
- Provides built-in bounding box rendering
- Efficient for simple rectangle drawing
- Supports child items (pins) naturally

**Why different colors per LOD level?**
- MVP: Visual debugging to confirm LOD is working
- P1: Remove color differences or make configurable via theme

**Why DeviceCoordinateCache?**
- Caches rendered item in device pixels
- Faster redraws when panning (no re-rendering)
- Trade-off: invalidated on zoom (but LOD change redraws anyway)

**Why hide children instead of removing?**
- Faster than destroying/recreating pin items
- Preserves state (selection, hover) across LOD changes
- Qt handles visibility efficiently in scene graph

### 5.2 Testing Strategy

**Unit Tests** (`tests/unit/presentation/canvas/test_cell_item_lod.py`):
- Mock `Cell` domain object
- Test LOD level transitions
- Verify child item visibility states
- Test paint optimization at LOW LOD

**Visual Tests** (`tests/visual/cell_rendering_lod.py`):
- Render cell at each LOD level
- Capture screenshots for regression comparison
- Verify no visual artifacts

**Performance Tests** (`tests/performance/cell_lod_benchmark.py`):
- Create scene with 500 cells
- Measure render time at each LOD level
- Profile paint() calls to identify bottlenecks

### 5.3 Future Enhancements (P1)
- Interpolate opacity during LOD transitions (fade in/out)
- Custom cell symbols per cell type (not just rectangles)
- Configurable LOD thresholds per cell complexity
- GPU-accelerated rendering for very large schematics

---

## Revision History
| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-12-26 | 0.1 | Claude | Initial task creation from E02-F04 split |
