# Spec: E02-F04-T02 - Graphics Item LOD Integration

## Metadata
- **ID**: E02-F04-T02
- **Type**: Task
- **Priority**: P0 (MVP)
- **Status**: Draft
- **Parent**: [E02-F04](../E02-F04.spec.md)
- **Created**: 2025-12-26
- **Estimated Hours**: 4
- **Actual Hours**:
- **Effort**: Small
- **Tags**: [lod, qt-graphics, integration]

---

## 1. Overview

### 1.1 Problem Statement

QGraphicsItems (cells, pins, nets) need to respond to LOD level changes by showing/hiding detail components. The integration layer connects the LOD manager to the graphics scene and ensures all items update their visibility correctly.

### 1.2 Goals

- Integrate LOD manager with QGraphicsScene
- Propagate LOD changes to all graphics items
- Implement LOD-aware base class for graphics items
- Ensure smooth LOD transitions without rendering glitches
- Support item-level LOD configuration

---

## 2. Technical Requirements

### 2.1 LOD-Aware Graphics Item Base Class

```python
from PySide6.QtWidgets import QGraphicsItem
from typing import Protocol

class LODAware(Protocol):
    """Protocol for graphics items that support LOD."""

    def update_lod(self, lod_level: LODLevel) -> None:
        """
        Update item's visual detail based on LOD level.

        Args:
            lod_level: New level of detail
        """
        ...

    def get_detail_items(self) -> dict[str, QGraphicsItem]:
        """
        Get child items that can be shown/hidden for LOD.

        Returns:
            Dictionary mapping detail names to graphics items
            Example: {'pin_names': pin_name_text, 'pin_arrows': arrow_group}
        """
        ...
```

### 2.2 LOD Scene Manager

```python
from PySide6.QtWidgets import QGraphicsScene
from PySide6.QtCore import QObject

class LODSceneManager(QObject):
    """Manages LOD for all items in a QGraphicsScene."""

    def __init__(self, scene: QGraphicsScene, lod_manager: LODManager):
        """
        Initialize LOD scene manager.

        Args:
            scene: The graphics scene to manage
            lod_manager: LOD manager providing LOD level
        """
        super().__init__()
        self._scene = scene
        self._lod_manager = lod_manager
        self._lod_items: list[LODAware] = []

        # Connect to LOD changes
        lod_manager.lod_changed.connect(self._on_lod_changed)

    def register_item(self, item: LODAware) -> None:
        """Register a graphics item for LOD updates."""
        self._lod_items.append(item)
        # Apply current LOD level
        item.update_lod(self._lod_manager.current_lod)

    def unregister_item(self, item: LODAware) -> None:
        """Unregister a graphics item from LOD updates."""
        if item in self._lod_items:
            self._lod_items.remove(item)

    def _on_lod_changed(self, lod_level: LODLevel) -> None:
        """Handle LOD level change by updating all registered items."""
        for item in self._lod_items:
            item.update_lod(lod_level)
```

### 2.3 Scene Zoom Integration

```python
from PySide6.QtWidgets import QGraphicsView

class SchematicCanvas(QGraphicsView):
    """Graphics view with LOD support."""

    def __init__(self):
        super().__init__()
        self._lod_manager = LODManager()
        self._lod_scene_manager = LODSceneManager(self.scene(), self._lod_manager)
        self._zoom_factor = 1.0

    def zoom(self, factor: float) -> None:
        """
        Zoom the view and update LOD.

        Args:
            factor: Zoom factor (1.0 = 100%, 2.0 = 200%, 0.5 = 50%)
        """
        # Apply zoom transform
        self.resetTransform()
        self.scale(factor, factor)

        # Update LOD manager
        self._zoom_factor = factor
        self._lod_manager.update_zoom(factor)

    def wheelEvent(self, event):
        """Handle mouse wheel zoom."""
        # Calculate new zoom factor
        zoom_delta = 1.15 if event.angleDelta().y() > 0 else 1/1.15
        new_zoom = self._zoom_factor * zoom_delta

        # Clamp zoom range
        new_zoom = max(0.1, min(10.0, new_zoom))

        self.zoom(new_zoom)
```

### 2.4 Item Registration Pattern

Graphics items register themselves with LOD scene manager:

```python
class CellItem(QGraphicsItem):
    """Cell graphics item with LOD support."""

    def __init__(self, cell, lod_scene_manager: LODSceneManager):
        super().__init__()
        self._cell = cell
        self._current_lod = LODLevel.HIGH

        # Create detail items
        self._detail_items = {
            'name_text': QGraphicsTextItem(cell.name, self),
            'pin_names': QGraphicsItemGroup(self),
            'pin_indicators': QGraphicsItemGroup(self)
        }

        # Register for LOD updates
        lod_scene_manager.register_item(self)

    def update_lod(self, lod_level: LODLevel) -> None:
        """Update visibility based on LOD level."""
        self._current_lod = lod_level

        if lod_level == LODLevel.LOW:
            # Show only bounding box
            self._detail_items['name_text'].setVisible(False)
            self._detail_items['pin_names'].setVisible(False)
            self._detail_items['pin_indicators'].setVisible(False)

        elif lod_level == LODLevel.MEDIUM:
            # Show box + name + pin indicators
            self._detail_items['name_text'].setVisible(True)
            self._detail_items['pin_names'].setVisible(False)
            self._detail_items['pin_indicators'].setVisible(True)

        else:  # LODLevel.HIGH
            # Show all details
            self._detail_items['name_text'].setVisible(True)
            self._detail_items['pin_names'].setVisible(True)
            self._detail_items['pin_indicators'].setVisible(True)

    def get_detail_items(self) -> dict[str, QGraphicsItem]:
        """Get dictionary of detail items."""
        return self._detail_items
```

### 2.5 File Locations

- **Module**: `src/ink/presentation/canvas/lod_scene_manager.py`
- **Integration**: `src/ink/presentation/canvas/schematic_canvas.py`
- **Tests**: `tests/unit/presentation/canvas/test_lod_scene_manager.py`

---

## 3. Acceptance Criteria

- [ ] `LODAware` protocol defined with `update_lod()` and `get_detail_items()`
- [ ] `LODSceneManager` class implemented
- [ ] Item registration/unregistration working correctly
- [ ] LOD changes propagate to all registered items
- [ ] Scene manager connects to LOD manager's `lod_changed` signal
- [ ] Zoom integration triggers LOD updates
- [ ] No performance degradation when updating 1000+ items
- [ ] LOD transitions complete within 16ms (60 FPS)
- [ ] Items added after LOD change get current LOD level
- [ ] Items removed from scene are unregistered automatically
- [ ] Unit tests for registration, propagation, and zoom integration

---

## 4. Testing Strategy

### 4.1 Unit Tests

```python
def test_item_registration():
    """Test registering items for LOD updates."""
    scene = QGraphicsScene()
    lod_manager = LODManager()
    scene_manager = LODSceneManager(scene, lod_manager)

    item = MockLODAwareItem()
    scene_manager.register_item(item)

    # Change LOD - item should be updated
    lod_manager.update_zoom(0.20)
    assert item.last_lod == LODLevel.LOW

def test_lod_propagation():
    """Test LOD changes propagate to all items."""
    scene = QGraphicsScene()
    lod_manager = LODManager()
    scene_manager = LODSceneManager(scene, lod_manager)

    items = [MockLODAwareItem() for _ in range(10)]
    for item in items:
        scene_manager.register_item(item)

    # Change LOD level
    lod_manager.update_zoom(0.50)

    # All items should receive update
    assert all(item.last_lod == LODLevel.MEDIUM for item in items)

def test_item_unregistration():
    """Test unregistering items stops LOD updates."""
    scene_manager = LODSceneManager(QGraphicsScene(), LODManager())
    item = MockLODAwareItem()

    scene_manager.register_item(item)
    scene_manager.unregister_item(item)

    # Change LOD - item should NOT be updated
    item.last_lod = None
    scene_manager._lod_manager.update_zoom(0.20)
    assert item.last_lod is None

def test_zoom_integration():
    """Test zoom changes trigger LOD updates."""
    canvas = SchematicCanvas()
    item = MockLODAwareItem()
    canvas._lod_scene_manager.register_item(item)

    # Zoom out - should trigger LOW LOD
    canvas.zoom(0.20)
    assert item.last_lod == LODLevel.LOW

    # Zoom in - should trigger HIGH LOD
    canvas.zoom(1.00)
    assert item.last_lod == LODLevel.HIGH
```

### 4.2 Integration Tests

```python
def test_scene_with_real_items():
    """Test LOD updates with real QGraphicsItem instances."""
    scene = QGraphicsScene()
    lod_manager = LODManager()
    scene_manager = LODSceneManager(scene, lod_manager)

    # Create real cell item
    cell_item = CellItem(cell=MockCell(), lod_scene_manager=scene_manager)
    scene.addItem(cell_item)

    # Change LOD and verify visibility
    lod_manager.update_zoom(0.20)  # LOW
    assert not cell_item._detail_items['name_text'].isVisible()

    lod_manager.update_zoom(1.00)  # HIGH
    assert cell_item._detail_items['name_text'].isVisible()
```

---

## 5. Dependencies

- **Upstream**:
  - E02-F04-T01 (LOD Manager provides LOD levels)
- **Downstream**:
  - E02-F04-T03 (Cell items implement LODAware protocol)
  - E02-F04-T04 (Net items implement LODAware protocol)

---

## 6. Implementation Notes

### 6.1 Design Decisions

1. **Protocol over inheritance**: LODAware as protocol allows flexibility
2. **Scene manager pattern**: Centralizes LOD logic, items stay simple
3. **Automatic registration**: Items register themselves in constructor
4. **Signal-based updates**: Leverages Qt's signal/slot for loose coupling

### 6.2 Performance Considerations

- **Batch updates**: All items updated in single pass when LOD changes
- **Visibility over deletion**: Use `setVisible()` rather than create/destroy
- **Early exit**: Items check if LOD actually changed before updating
- **View frustum culling**: Qt handles off-screen items automatically

### 6.3 Future Enhancements

- **Progressive LOD**: Gradual detail reduction during zoom animation
- **Selective updates**: Only update items visible in viewport
- **LOD groups**: Apply different LOD rules to different item types
- **Custom LOD policies**: Per-item LOD behavior overrides

---

## Revision History

| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-12-26 | 0.1 | Claude | Initial task spec creation |
