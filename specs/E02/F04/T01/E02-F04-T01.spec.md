# Spec: E02-F04-T01 - LOD Manager Implementation

## Metadata
- **ID**: E02-F04-T01
- **Type**: Task
- **Priority**: P0 (MVP)
- **Status**: Draft
- **Parent**: [E02-F04](../E02-F04.spec.md)
- **Created**: 2025-12-26
- **Estimated Hours**: 3
- **Actual Hours**:
- **Effort**: Small
- **Tags**: [lod, core-logic]

---

## 1. Overview

### 1.1 Problem Statement

The LOD system needs a central manager to calculate and determine the appropriate level of detail based on the current zoom factor. This component provides the foundation for all LOD-based rendering decisions.

### 1.2 Goals

- Implement LODManager class with zoom-to-LOD calculation
- Define LOD level enumeration (LOW, MEDIUM, HIGH)
- Provide threshold-based LOD determination
- Support hysteresis to prevent flickering at boundaries
- Emit signals when LOD level changes

---

## 2. Technical Requirements

### 2.1 LOD Level Enumeration

```python
from enum import Enum

class LODLevel(Enum):
    """Level of detail for rendering."""
    LOW = 0      # Zoom < 25%: Bounding boxes only
    MEDIUM = 1   # Zoom 25-75%: Boxes + names + pin indicators
    HIGH = 2     # Zoom > 75%: Full detail
```

### 2.2 LOD Manager Interface

```python
from typing import Protocol
from PySide6.QtCore import QObject, Signal

class LODManager(QObject):
    """Manages level of detail based on zoom factor."""

    # Signal emitted when LOD level changes
    lod_changed = Signal(LODLevel)

    def __init__(self, hysteresis: float = 0.05):
        """
        Initialize LOD manager.

        Args:
            hysteresis: Buffer zone around thresholds to prevent flickering (default 5%)
        """
        super().__init__()
        self._current_lod = LODLevel.HIGH
        self._hysteresis = hysteresis
        self._thresholds = {
            'low_to_medium': 0.25,
            'medium_to_high': 0.75
        }

    def get_lod_level(self, zoom_factor: float) -> LODLevel:
        """
        Determine LOD level based on zoom factor.

        Args:
            zoom_factor: Current zoom level (1.0 = 100%)

        Returns:
            Appropriate LOD level for the zoom factor
        """
        pass

    def update_zoom(self, zoom_factor: float) -> None:
        """
        Update current zoom and emit signal if LOD level changes.

        Args:
            zoom_factor: New zoom level
        """
        pass

    @property
    def current_lod(self) -> LODLevel:
        """Get current LOD level."""
        return self._current_lod
```

### 2.3 Threshold Calculation with Hysteresis

**Without Hysteresis (flickering problem):**
```
Zoom 24.9% -> LOW
Zoom 25.1% -> MEDIUM
Zoom 24.9% -> LOW  (flicker!)
```

**With Hysteresis (5% buffer):**
```
Threshold zones:
- LOW:    zoom < 22.5%  (25% - 2.5%)
- MEDIUM: 27.5% < zoom < 72.5%  (25% + 2.5% to 75% - 2.5%)
- HIGH:   zoom > 77.5%  (75% + 2.5%)

Buffer zones (maintain current LOD):
- 22.5% - 27.5%: Keep current if transitioning
- 72.5% - 77.5%: Keep current if transitioning
```

### 2.4 Implementation Algorithm

```python
def get_lod_level(self, zoom_factor: float) -> LODLevel:
    """Calculate LOD level with hysteresis."""
    low_threshold = self._thresholds['low_to_medium']
    high_threshold = self._thresholds['medium_to_high']

    # Calculate hysteresis bounds
    low_min = low_threshold - self._hysteresis
    low_max = low_threshold + self._hysteresis
    high_min = high_threshold - self._hysteresis
    high_max = high_threshold + self._hysteresis

    # Determine new LOD level
    if zoom_factor < low_min:
        return LODLevel.LOW
    elif zoom_factor > high_max:
        return LODLevel.HIGH
    elif low_max < zoom_factor < high_min:
        return LODLevel.MEDIUM
    else:
        # In hysteresis zone - maintain current level
        return self._current_lod
```

### 2.5 File Location

- **Module**: `src/ink/presentation/canvas/lod_manager.py`
- **Tests**: `tests/unit/presentation/canvas/test_lod_manager.py`

---

## 3. Acceptance Criteria

- [ ] `LODLevel` enum defined with LOW, MEDIUM, HIGH values
- [ ] `LODManager` class implemented as QObject
- [ ] `get_lod_level()` correctly calculates LOD from zoom factor
- [ ] Hysteresis prevents flickering at threshold boundaries
- [ ] `lod_changed` signal emitted when LOD level changes
- [ ] `update_zoom()` updates current LOD and emits signal if changed
- [ ] Thresholds configurable (25%, 75% default)
- [ ] Hysteresis configurable (5% default)
- [ ] Unit tests cover all threshold transitions
- [ ] Unit tests verify hysteresis behavior
- [ ] Documentation includes usage examples

---

## 4. Testing Strategy

### 4.1 Unit Tests

```python
def test_lod_thresholds():
    """Test LOD level calculation at exact thresholds."""
    manager = LODManager(hysteresis=0.0)  # Disable for exact testing

    assert manager.get_lod_level(0.20) == LODLevel.LOW
    assert manager.get_lod_level(0.25) == LODLevel.MEDIUM
    assert manager.get_lod_level(0.50) == LODLevel.MEDIUM
    assert manager.get_lod_level(0.75) == LODLevel.HIGH
    assert manager.get_lod_level(1.00) == LODLevel.HIGH

def test_hysteresis_prevents_flickering():
    """Test hysteresis maintains current LOD in buffer zones."""
    manager = LODManager(hysteresis=0.05)

    # Start at LOW, move into buffer zone
    manager.update_zoom(0.20)  # LOW
    manager.update_zoom(0.23)  # Still LOW (in buffer)
    assert manager.current_lod == LODLevel.LOW

    # Cross buffer to MEDIUM
    manager.update_zoom(0.28)  # MEDIUM
    assert manager.current_lod == LODLevel.MEDIUM

    # Move back into buffer - should stay MEDIUM
    manager.update_zoom(0.26)  # Still MEDIUM (in buffer)
    assert manager.current_lod == LODLevel.MEDIUM

def test_lod_changed_signal():
    """Test signal emission on LOD level change."""
    manager = LODManager()
    signal_spy = []

    manager.lod_changed.connect(lambda lod: signal_spy.append(lod))

    manager.update_zoom(0.20)  # LOW
    assert signal_spy[-1] == LODLevel.LOW

    manager.update_zoom(0.50)  # MEDIUM
    assert signal_spy[-1] == LODLevel.MEDIUM

    manager.update_zoom(0.51)  # Still MEDIUM - no signal
    assert len(signal_spy) == 2  # No new signal
```

---

## 5. Dependencies

- **Upstream**: None (foundational component)
- **Downstream**:
  - E02-F04-T02 (Graphics Item LOD Integration uses this manager)
  - E02-F04-T03 (Cell LOD Rendering queries LOD level)
  - E02-F04-T04 (Net LOD Rendering queries LOD level)

---

## 6. Implementation Notes

### 6.1 Design Decisions

1. **QObject inheritance**: Enables Qt signal/slot mechanism for LOD changes
2. **Hysteresis default (5%)**: Empirically tested to prevent flicker without noticeable delay
3. **Separate get vs update**: Allows querying LOD without side effects

### 6.2 Future Enhancements

- Per-object-type LOD thresholds (cells vs nets vs text)
- Custom LOD levels beyond LOW/MEDIUM/HIGH
- Performance metrics tracking (render time per LOD level)
- User-configurable thresholds via settings

---

## Revision History

| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-12-26 | 0.1 | Claude | Initial task spec creation |
