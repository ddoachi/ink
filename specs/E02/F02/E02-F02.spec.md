# Spec: E02-F02 - Sugiyama Layout Engine

## Metadata
- **ID**: E02-F02
- **Type**: Feature
- **Priority**: P0 (MVP)
- **Status**: Draft
- **Parent**: [E02](../E02.spec.md)
- **Created**: 2025-12-26

---

## 1. Overview

### 1.1 Problem Statement

Large gate-level netlists require automatic layout algorithms to position cells in a way that reveals signal flow and logical structure. Manual positioning is impractical for circuits with hundreds or thousands of gates. The Sugiyama hierarchical layout algorithm provides left-to-right signal flow visualization with minimal edge crossings.

### 1.2 Goals

- Implement Sugiyama (hierarchical/layered) layout algorithm
- Assign cells to layers based on logic depth from primary inputs
- Minimize edge crossings between layers
- Produce left-to-right signal flow (inputs left, outputs right)
- Provide sufficient spacing between cells and layers for readability

---

## 2. User Stories

### US-E02-02: Automatic Layout
**As a** circuit designer
**I want to** have cells automatically positioned
**So that** signal flow is clear without manual arrangement

**Acceptance Criteria:**
- [ ] Sugiyama algorithm assigns cells to layers by logic depth
- [ ] Signal flows left-to-right (inputs left, outputs right)
- [ ] Edge crossings minimized within each layer
- [ ] Sufficient spacing between cells and layers

---

## 3. Technical Requirements

### 3.1 Sugiyama Algorithm Phases

1. **Cycle Removal**: Reverse edges to make DAG (if cycles exist)
2. **Layer Assignment**: Assign nodes to horizontal layers based on longest path from sources
3. **Crossing Reduction**: Reorder nodes within layers to minimize edge crossings
4. **Coordinate Assignment**: Calculate x/y positions for each cell
5. **Edge Routing**: Determine edge paths between layers

### 3.2 Implementation Options

**Option A: Use grandalf library**
- Python library with Sugiyama implementation
- Pros: Ready-made, tested implementation
- Cons: Additional dependency, may need customization

**Option B: Custom implementation using NetworkX**
- Build on top of NetworkX graph structure
- Pros: Full control, no extra dependency beyond NetworkX
- Cons: More implementation effort

**Recommendation**: Start with grandalf for MVP, migrate to custom if needed

### 3.3 Layout Engine Interface

```python
class LayoutEngine(Protocol):
    def compute_layout(self, graph: Graph) -> Dict[CellId, Position]:
        """
        Compute positions for all cells in the graph.

        Args:
            graph: The circuit graph to layout

        Returns:
            Dictionary mapping cell IDs to (x, y) positions
        """
        pass
```

### 3.4 Configuration Parameters

- **Layer Spacing**: Horizontal distance between layers (default: 200px)
- **Cell Spacing**: Vertical distance between cells in same layer (default: 100px)
- **Direction**: Left-to-right (default), could support top-to-bottom
- **Crossing Minimization Iterations**: Number of iterations for crossing reduction (default: 10)

### 3.5 Performance Requirements

- Layout computation for 1000 cells: <2 seconds
- Layout computation for 10,000 cells: <30 seconds
- Incremental layout updates when cells are added/removed
- Caching of layout results to avoid re-computation

---

## 4. Dependencies

- **Upstream**:
  - E01-F02 (Graph construction - provides graph structure)
  - E02-F01 (Cell symbol dimensions for spacing calculations)
- **Downstream**:
  - E02-F03 (Net routing uses layer information)
  - E03 (Expansion needs incremental layout updates)
- **External**:
  - NetworkX (graph structure)
  - grandalf (optional, for Sugiyama implementation)

---

## 5. Acceptance Criteria

- [ ] Algorithm assigns cells to layers based on topological order
- [ ] Primary inputs placed in leftmost layer
- [ ] Primary outputs placed in rightmost layer
- [ ] Cells with no incoming edges placed near input side
- [ ] Edge crossings reduced by >50% compared to random placement
- [ ] Layout produces readable left-to-right signal flow
- [ ] No cell overlaps in final layout
- [ ] Layer spacing and cell spacing configurable
- [ ] Layout computation completes within performance requirements
- [ ] Support for incremental layout updates (add/remove cells)

---

## 6. Child Specs

*To be created via `/spec_work E02-F02 --split tasks`*

| ID | Task | Status |
|----|------|--------|

---

## Revision History

| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-12-26 | 0.1 | Claude | Initial feature creation from E02 split |
