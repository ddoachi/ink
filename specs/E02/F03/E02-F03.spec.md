# Spec: E02-F03 - Orthogonal Net Routing

## Metadata
- **ID**: E02-F03
- **Type**: Feature
- **Priority**: P0 (MVP)
- **Status**: Draft
- **Parent**: [E02](../E02.spec.md)
- **Created**: 2025-12-26
- **Estimated Hours**:
- **Actual Hours**:
- **Effort**:
- **Tags**: []

---

## 1. Overview

### 1.1 Problem Statement

Net connectivity in schematics must be visually clear and readable. Direct point-to-point lines create visual clutter and make it difficult to trace signals. Orthogonal (Manhattan) routing with horizontal and vertical segments provides clean, professional-looking schematics that are easy to follow.

### 1.2 Goals

- Route all nets using only horizontal and vertical line segments
- Minimize total wire length and number of bends
- Reduce net crossings where possible
- Provide visual distinction for multi-fanout nets (junction dots)
- Support both simple point-to-point and multi-fanout routing

---

## 2. User Stories

### US-E02-03: Net Routing
**As a** circuit designer
**I want to** see nets routed as orthogonal lines
**So that** connections are clear and readable

**Acceptance Criteria:**
- [ ] All net segments are horizontal or vertical (orthogonal)
- [ ] Multi-fanout nets show junction dots at branch points
- [ ] Routing minimizes total wire length
- [ ] Net crossings use visual distinction (e.g., arc or dot)

---

## 3. Technical Requirements

### 3.1 Routing Algorithm

**For MVP: Channel Routing Between Layers**
- Use horizontal channels between Sugiyama layers
- Route nets from source pin to destination pin(s)
- Vertical segments at pin connection points
- Horizontal segments in inter-layer channels

**Algorithm Steps:**
1. Identify source pin and destination pin(s) for each net
2. Route vertical segment from source pin to channel
3. Route horizontal segment across layers in channel
4. Route vertical segment from channel to destination pin
5. For multi-fanout: create branching structure with junction dots

**Future Enhancement: A* or Similar Pathfinding**
- More sophisticated routing with obstacle avoidance
- Better handling of complex multi-fanout topologies

### 3.2 Net Router Interface

```python
class NetRouter(Protocol):
    def route_net(self, net: Net, cell_positions: Dict[CellId, Position]) -> NetGeometry:
        """
        Route a net between connected pins.

        Args:
            net: The net to route
            cell_positions: Position of each cell (from layout engine)

        Returns:
            NetGeometry containing line segments and junction points
        """
        pass
```

### 3.3 Net Geometry Data Structure

```python
@dataclass
class NetGeometry:
    segments: List[LineSegment]  # All horizontal and vertical segments
    junctions: List[Point]  # Branch points for multi-fanout
    crossings: List[Point]  # Where this net crosses other nets
```

### 3.4 Visual Rendering

- **Net Segments**: Solid lines connecting pins
- **Junction Dots**: Filled circles at branching points (multi-fanout)
- **Crossing Indicators**: Small arc or bridge where nets cross
- **Color Coding**: Nets can be color-coded by type or selection state
- **Width**: Configurable line width (thinner when zoomed out)

### 3.5 Routing Constraints

- All segments must be horizontal or vertical (no diagonal)
- Net segments should not overlap cell symbols
- Minimize total Manhattan distance
- Prefer routing in channels between layers
- Junction dots placed where >2 segments meet

---

## 4. Dependencies

- **Upstream**:
  - E01-F03 (Net domain model)
  - E02-F01 (Pin connection points)
  - E02-F02 (Cell positions from layout engine)
- **Downstream**:
  - E04 (Net selection and highlighting)
  - E03 (Incremental routing when cells expand/collapse)

---

## 5. Acceptance Criteria

- [ ] All net segments are strictly horizontal or vertical
- [ ] Point-to-point nets routed correctly with minimal bends
- [ ] Multi-fanout nets show junction dots at branch points
- [ ] Net crossings visually distinguished (arc or bridge)
- [ ] Routing minimizes total wire length
- [ ] No net segments overlap cell symbol bodies
- [ ] Net segments connect precisely to pin connection points
- [ ] Routing performance: 1000+ nets routed in <3 seconds
- [ ] Net geometry cached for performance
- [ ] Support for incremental re-routing when layout changes

---

## 6. Child Specs

| ID | Task | Status | Estimated Hours |
|----|------|--------|-----------------|
| [E02-F03-T01](T01/E02-F03-T01.spec.md) | Net Geometry Data Structure | Draft | 6 |
| [E02-F03-T02](T02/E02-F03-T02.spec.md) | Orthogonal Router Implementation | Draft | 16 |
| [E02-F03-T03](T03/E02-F03-T03.spec.md) | Multi-Fanout Net Handling | Draft | 8 |
| [E02-F03-T04](T04/E02-F03-T04.spec.md) | Net Graphics Item (QGraphicsItem) | Draft | 10 |

---

## Revision History

| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-12-26 | 0.1 | Claude | Initial feature creation from E02 split |
