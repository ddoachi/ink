---
id: E02-F01-T04
title: Zoom Level of Detail
type: Task
priority: P0 (MVP)
status: Draft
parent: E02-F01
created: 2025-12-26
estimated_hours: 5
actual_hours:
effort: Medium
tags:
  - zoom
  - performance
  - presentation-layer
---

# Spec: E02-F01-T04 - Zoom Level of Detail

## 1. Overview

### 1.1 Problem Statement

Rendering all pin details (names, arrows, labels) at low zoom levels clutters the view and degrades performance. A zoom-based level of detail (LOD) system is needed to progressively show/hide information based on the current zoom level, maintaining visual clarity and rendering performance.

### 1.2 Goals

- Implement zoom level detection in schematic canvas
- Define three detail levels (MINIMAL, BASIC, FULL)
- Automatically adjust pin and cell rendering based on zoom
- Maintain smooth transitions between detail levels
- Ensure performance remains at 60fps with 1000+ cells

---

## 2. Technical Requirements

### 2.1 Detail Level Enumeration

**Location**: `src/ink/presentation/canvas/detail_level.py`

```python
from enum import Enum

class DetailLevel(Enum):
    """Level of detail for schematic rendering based on zoom."""

    MINIMAL = 0   # <25% zoom: Minimal detail
    BASIC = 1     # 25-75% zoom: Medium detail
    FULL = 2      # >75% zoom: Full detail

    @classmethod
    def from_zoom(cls, zoom_factor: float) -> 'DetailLevel':
        """
        Determine detail level from zoom factor.

        Args:
            zoom_factor: Current zoom (1.0 = 100%, 0.5 = 50%, 2.0 = 200%)

        Returns:
            Appropriate detail level
        """
        if zoom_factor < 0.25:
            return cls.MINIMAL
        elif zoom_factor < 0.75:
            return cls.BASIC
        else:
            return cls.FULL
```

### 2.2 Rendering Behavior by Level

| Element | MINIMAL (<25%) | BASIC (25-75%) | FULL (>75%) |
|---------|----------------|----------------|-------------|
| Cell body | Bounding box only | Box + name | Box + name |
| Cell name | Hidden | Visible | Visible |
| Pin indicator | Hidden | Dot only | Dot + name + arrow |
| Pin name | Hidden | Hidden | Visible |
| Pin direction | Hidden | Hidden | Visible (arrow) |
| Net lines | Simplified | Standard | Standard |

### 2.3 Canvas Integration

**Location**: `src/ink/presentation/canvas/schematic_canvas.py`

```python
class SchematicCanvas(QGraphicsView):
    """Main schematic viewing canvas with zoom LOD support."""

    def __init__(self, parent=None):
        super().__init__(parent)
        self._current_zoom = 1.0
        self._current_detail_level = DetailLevel.FULL

    def zoom_in(self):
        """Zoom in and update detail level."""
        self._current_zoom *= 1.25
        self._apply_zoom()

    def zoom_out(self):
        """Zoom out and update detail level."""
        self._current_zoom /= 1.25
        self._apply_zoom()

    def _apply_zoom(self):
        """Apply zoom transform and update detail level."""
        self.resetTransform()
        self.scale(self._current_zoom, self._current_zoom)

        # Check if detail level changed
        new_level = DetailLevel.from_zoom(self._current_zoom)
        if new_level != self._current_detail_level:
            self._current_detail_level = new_level
            self._update_item_detail_levels()

    def _update_item_detail_levels(self):
        """Update all graphics items with new detail level."""
        for item in self.scene().items():
            if isinstance(item, PinItem):
                item.set_detail_level(self._current_detail_level)
            elif isinstance(item, CellItem):
                item.set_detail_level(self._current_detail_level)
```

### 2.4 Item-Level Implementation

**CellItem LOD**:
```python
class CellItem(QGraphicsItem):
    def set_detail_level(self, level: DetailLevel):
        """Update rendering detail level."""
        self._detail_level = level
        self.update()  # Trigger repaint

    def paint(self, painter, option, widget):
        if self._detail_level == DetailLevel.MINIMAL:
            # Draw bounding box only
            painter.drawRect(self.boundingRect())
        else:
            # Draw full symbol with name
            self._draw_full_symbol(painter)
```

**PinItem LOD**:
```python
class PinItem(QGraphicsItem):
    def set_detail_level(self, level: DetailLevel):
        """Update rendering detail level."""
        self._detail_level = level
        self.setVisible(level != DetailLevel.MINIMAL)
        self.update()

    def paint(self, painter, option, widget):
        if self._detail_level == DetailLevel.BASIC:
            # Draw pin dot only
            painter.drawEllipse(self._pin_rect)
        elif self._detail_level == DetailLevel.FULL:
            # Draw dot + name + arrow
            painter.drawEllipse(self._pin_rect)
            painter.drawText(self._label_rect, self._pin.name)
            self._draw_direction_arrow(painter)
```

### 2.5 Performance Optimizations

**Visibility Culling**:
- Hide items completely at MINIMAL level
- Use `QGraphicsItem.setVisible(False)` to skip rendering

**Batch Updates**:
- Update all items in single pass when zoom changes
- Avoid per-frame detail level checks

**Caching**:
- Cache rendered items using `DeviceCoordinateCache`
- Invalidate cache only when detail level changes

---

## 3. Dependencies

- **Upstream**:
  - T01: `CellItem` implements `set_detail_level()`
  - T02: `PinItem` implements `set_detail_level()`
  - Qt QGraphicsView zoom/transform system

- **Downstream**:
  - E04: Interaction handlers respect detail levels
  - E02-F03: Net routing may simplify at low zoom

---

## 4. Acceptance Criteria

- [ ] `DetailLevel` enum implemented with zoom thresholds
- [ ] `SchematicCanvas` tracks current zoom factor
- [ ] Zoom in/out triggers detail level updates
- [ ] Cell items show bounding box only at <25% zoom
- [ ] Pin items hidden at <25% zoom
- [ ] Pin dots (no names) visible at 25-75% zoom
- [ ] Full pin details (name + arrow) visible at >75% zoom
- [ ] Detail level transitions occur smoothly
- [ ] Performance remains at 60fps with 1000 cells
- [ ] Unit tests verify detail level calculation from zoom
- [ ] Integration test demonstrates zoom LOD behavior

---

## 5. Implementation Notes

### 5.1 Example Usage

```python
# In SchematicCanvas
def wheelEvent(self, event: QWheelEvent):
    """Handle mouse wheel for zooming."""
    if event.angleDelta().y() > 0:
        self.zoom_in()
    else:
        self.zoom_out()

# Zoom levels trigger LOD updates automatically
# At 50% zoom: Pins show dots only
# At 100% zoom: Pins show full details
```

### 5.2 Zoom Factor Management

```python
MIN_ZOOM = 0.1   # 10% - Far out view
MAX_ZOOM = 5.0   # 500% - Close inspection

def _clamp_zoom(self, zoom: float) -> float:
    """Clamp zoom to valid range."""
    return max(MIN_ZOOM, min(MAX_ZOOM, zoom))
```

### 5.3 Testing Approach

**Unit Tests**:
- Verify `DetailLevel.from_zoom()` thresholds
- Test zoom clamping (min/max)
- Verify detail level change detection

**Integration Tests**:
- Render scene at different zoom levels
- Capture screenshots at 20%, 50%, 100% zoom
- Verify visual differences in pin rendering
- Measure frame rate with 1000 cells at various zooms

**Performance Tests**:
- Benchmark rendering at each detail level
- Verify <16ms frame time (60fps) at all zoom levels
- Profile update overhead when changing detail levels

---

## Revision History

| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-12-26 | 0.1 | Claude | Initial task creation from E02-F01 split |
