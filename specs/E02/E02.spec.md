# Spec: E02 - Schematic Rendering

## Metadata
- **ID**: E02
- **Type**: Epic
- **Priority**: P0 (MVP)
- **Status**: Draft
- **PRD Sections**: §4.1 Basic Rendering, §4.2 Zoom-Based Rendering, §4.3 Layout Algorithm, §4.4 Net Routing
- **Created**: 2025-12-26
- **Parent**: [PRD](../../docs/prd.md)

---

## 1. Overview

This epic covers the visual rendering of schematics in Ink - from drawing cell symbols and pins to laying out the schematic hierarchically and routing nets with orthogonal connections.

### 1.1 Problem Statement

Engineers need to visualize circuit connectivity in a way that reveals signal flow and structure. Traditional schematic views render everything at once, causing performance issues with large designs. Ink renders only visible and user-requested portions incrementally.

### 1.2 Goals

- Render cell symbols with pins as primary visual elements
- Implement Sugiyama (hierarchical) layout algorithm for left-to-right signal flow
- Route nets orthogonally with minimal crossings and bends
- Support zoom-based level of detail (LOD) for performance
- Enable smooth pan/zoom interactions

---

## 2. User Stories

### US-E02-01: View Cell Symbols
**As a** circuit designer
**I want to** see cells rendered as symbols with visible pins
**So that** I can understand the circuit structure

**Acceptance Criteria:**
- [ ] Cells render as rectangular symbols with name label
- [ ] Input pins displayed on left side of symbol
- [ ] Output pins displayed on right side of symbol
- [ ] Pin names visible at default zoom level
- [ ] Different visual styles for sequential vs combinational cells

### US-E02-02: Automatic Layout
**As a** circuit designer
**I want to** have cells automatically positioned
**So that** signal flow is clear without manual arrangement

**Acceptance Criteria:**
- [ ] Sugiyama algorithm assigns cells to layers by logic depth
- [ ] Signal flows left-to-right (inputs left, outputs right)
- [ ] Edge crossings minimized within each layer
- [ ] Sufficient spacing between cells and layers

### US-E02-03: Net Routing
**As a** circuit designer
**I want to** see nets routed as orthogonal lines
**So that** connections are clear and readable

**Acceptance Criteria:**
- [ ] All net segments are horizontal or vertical (orthogonal)
- [ ] Multi-fanout nets show junction dots at branch points
- [ ] Routing minimizes total wire length
- [ ] Net crossings use visual distinction (e.g., arc or dot)

### US-E02-04: Zoom Level of Detail
**As a** circuit designer
**I want to** see less detail when zoomed out
**So that** I can view large portions without clutter

**Acceptance Criteria:**
- [ ] Zoomed out: cells as simple boxes, no pin names
- [ ] Medium zoom: cell names visible, pin indicators
- [ ] Zoomed in: full pin names and directions visible
- [ ] Smooth transitions between LOD levels

### US-E02-05: Pan and Zoom
**As a** circuit designer
**I want to** pan and zoom the schematic view
**So that** I can navigate to areas of interest

**Acceptance Criteria:**
- [ ] Mouse wheel zooms in/out centered on cursor
- [ ] Click-drag pans the view
- [ ] Fit-to-view command shows all visible content
- [ ] Zoom levels from 10% to 500%

---

## 3. Technical Requirements

### 3.1 Rendering Pipeline

```
Graph Model → Layout Engine → Render Tree → Qt Graphics Scene
     ↓              ↓              ↓              ↓
  Cells/Nets   Positions    Draw Commands   Visual Output
```

### 3.2 Symbol Rendering

```python
class CellSymbol:
    - bounding_rect: QRectF
    - name_label: str
    - pin_graphics: List[PinGraphic]
    - is_sequential: bool  # For visual styling

class PinGraphic:
    - position: QPointF (relative to cell)
    - direction: PinDirection
    - name_label: str
    - connection_point: QPointF
```

### 3.3 Sugiyama Layout Algorithm

1. **Cycle Removal**: Reverse edges to make DAG (if cycles exist)
2. **Layer Assignment**: Assign nodes to horizontal layers
3. **Crossing Reduction**: Reorder nodes within layers
4. **Coordinate Assignment**: Calculate x/y positions
5. **Edge Routing**: Route edges between layers

**Library Options:**
- grandalf (Python, Sugiyama implementation)
- Custom implementation using NetworkX

### 3.4 Orthogonal Routing

- Use channel routing between layers
- A* or similar pathfinding for individual nets
- Minimize crossings with other nets
- Support for bus routing (parallel nets)

### 3.5 Level of Detail Thresholds

| Zoom Level | Cell Display | Pin Display | Net Display |
|------------|-------------|-------------|-------------|
| <25% | Bounding box | Hidden | Simplified |
| 25-75% | Box + name | Indicators | Full |
| >75% | Full detail | Names + direction | Full |

---

## 4. Dependencies

- **Upstream**: E01 (Data Model - provides graph structure)
- **Downstream**: E03 (Expansion), E04 (Interaction)
- **External**: PySide6 (Qt6 Graphics Framework)

---

## 5. Risks & Mitigations

| Risk | Impact | Probability | Mitigation |
|------|--------|-------------|------------|
| Layout performance on large graphs | High | High | Incremental layout, caching |
| Qt rendering bottlenecks | Medium | Medium | Graphics scene optimization |
| Routing complexity | Medium | Medium | Simplify for MVP, enhance later |

---

## 6. Acceptance Criteria (Epic Level)

- [ ] Render 1000+ cells without UI lag
- [ ] Sugiyama layout produces readable left-to-right flow
- [ ] Orthogonal routing with <5% visible crossings
- [ ] LOD transitions smooth at 60fps
- [ ] Pan/zoom responsive with <16ms frame time

---

## 7. Child Specs

*To be created via `/spec_work E02 --split features`*

| ID | Feature | Status |
|----|---------|--------|
| E02-F01 | Cell Symbol Rendering | Draft |
| E02-F02 | Sugiyama Layout Engine | Draft |
| E02-F03 | Orthogonal Net Routing | Draft |
| E02-F04 | Zoom Level of Detail | Draft |
| E02-F05 | Pan/Zoom Controls | Draft |

---

## Revision History

| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-12-26 | 0.1 | Claude | Initial epic creation from PRD split |
